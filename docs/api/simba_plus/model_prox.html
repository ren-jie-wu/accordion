<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 16.0.0"/>
    <title>simba_plus.model_prox API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:27px;vertical-align:bottom;width:50px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../simba_plus.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;simba_plus</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#AuxParams">AuxParams</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#AuxParams.__init__">AuxParams</a>
                        </li>
                        <li>
                                <a class="variable" href="#AuxParams.edgetype_specific">edgetype_specific</a>
                        </li>
                        <li>
                                <a class="variable" href="#AuxParams.use_noise">use_noise</a>
                        </li>
                        <li>
                                <a class="variable" href="#AuxParams.multi_sample">multi_sample</a>
                        </li>
                        <li>
                                <a class="variable" href="#AuxParams.use_batch">use_batch</a>
                        </li>
                        <li>
                                <a class="variable" href="#AuxParams.bias_dict">bias_dict</a>
                        </li>
                        <li>
                                <a class="variable" href="#AuxParams.logscale_dict">logscale_dict</a>
                        </li>
                        <li>
                                <a class="variable" href="#AuxParams.std_dict">std_dict</a>
                        </li>
                        <li>
                                <a class="variable" href="#AuxParams.bias_logstd_dict">bias_logstd_dict</a>
                        </li>
                        <li>
                                <a class="variable" href="#AuxParams.logscale_logstd_dict">logscale_logstd_dict</a>
                        </li>
                        <li>
                                <a class="variable" href="#AuxParams.std_logstd_dict">std_logstd_dict</a>
                        </li>
                        <li>
                                <a class="variable" href="#AuxParams.bias_dict_per_sample">bias_dict_per_sample</a>
                        </li>
                        <li>
                                <a class="variable" href="#AuxParams.logscale_dict_per_sample">logscale_dict_per_sample</a>
                        </li>
                        <li>
                                <a class="variable" href="#AuxParams.std_dict_per_sample">std_dict_per_sample</a>
                        </li>
                        <li>
                                <a class="function" href="#AuxParams.batched">batched</a>
                        </li>
                        <li>
                                <a class="function" href="#AuxParams.forward">forward</a>
                        </li>
                        <li>
                                <a class="function" href="#AuxParams.get_keys">get_keys</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#LightningProxModel">LightningProxModel</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#LightningProxModel.__init__">LightningProxModel</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.data">data</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.logger2">logger2</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.learning_rate">learning_rate</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.encoder">encoder</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.decoder">decoder</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.hsic">hsic</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.kl_lambda">kl_lambda</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.kl_n_no">kl_n_no</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.kl_n_warmup">kl_n_warmup</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.cell_weights">cell_weights</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.reweight_rarecell">reweight_rarecell</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.edgetype_loss_weight_dict">edgetype_loss_weight_dict</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.node_weights_dict">node_weights_dict</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.herit_loss">herit_loss</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.herit_loss_lam">herit_loss_lam</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.num_neg_samples_fold">num_neg_samples_fold</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.validation_step_outputs">validation_step_outputs</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.use_aux">use_aux</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.use_aux_noise">use_aux_noise</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.aux_params">aux_params</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.verbose">verbose</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.batch_negative">batch_negative</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.monitor_key">monitor_key</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.gene_align_lambda">gene_align_lambda</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.gene_align_n_no">gene_align_n_no</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.gene_align_n_warmup">gene_align_n_warmup</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.ot_cs_lambda">ot_cs_lambda</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.ot_cs_n_no">ot_cs_n_no</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.ot_cs_n_warmup">ot_cs_n_warmup</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.ot_cs_k">ot_cs_k</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.ot_cb_lambda">ot_cb_lambda</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.ot_cb_n_no">ot_cb_n_no</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.ot_cb_n_warmup">ot_cb_n_warmup</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.ot_cb_k">ot_cb_k</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.ot_eps">ot_eps</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.ot_iter">ot_iter</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.ot_plan_every_n_epochs">ot_plan_every_n_epochs</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.ot_loss_every_n_steps">ot_loss_every_n_steps</a>
                        </li>
                        <li>
                                <a class="variable" href="#LightningProxModel.log_every_n_steps">log_every_n_steps</a>
                        </li>
                        <li>
                                <a class="function" href="#LightningProxModel.on_train_start">on_train_start</a>
                        </li>
                        <li>
                                <a class="function" href="#LightningProxModel.encode">encode</a>
                        </li>
                        <li>
                                <a class="function" href="#LightningProxModel.reparametrize">reparametrize</a>
                        </li>
                        <li>
                                <a class="function" href="#LightningProxModel.relational_recon_loss">relational_recon_loss</a>
                        </li>
                        <li>
                                <a class="function" href="#LightningProxModel.relational_kl_divergence">relational_kl_divergence</a>
                        </li>
                        <li>
                                <a class="function" href="#LightningProxModel.kl_div_loss">kl_div_loss</a>
                        </li>
                        <li>
                                <a class="function" href="#LightningProxModel.nll_loss">nll_loss</a>
                        </li>
                        <li>
                                <a class="function" href="#LightningProxModel.gene_alignment_loss">gene_alignment_loss</a>
                        </li>
                        <li>
                                <a class="function" href="#LightningProxModel.ot_alignment_loss">ot_alignment_loss</a>
                        </li>
                        <li>
                                <a class="function" href="#LightningProxModel.training_step">training_step</a>
                        </li>
                        <li>
                                <a class="function" href="#LightningProxModel.on_after_backward">on_after_backward</a>
                        </li>
                        <li>
                                <a class="function" href="#LightningProxModel.validation_step">validation_step</a>
                        </li>
                        <li>
                                <a class="function" href="#LightningProxModel.mean_cell_neighbor_distance">mean_cell_neighbor_distance</a>
                        </li>
                        <li>
                                <a class="function" href="#LightningProxModel.on_train_epoch_start">on_train_epoch_start</a>
                        </li>
                        <li>
                                <a class="function" href="#LightningProxModel.on_train_batch_start">on_train_batch_start</a>
                        </li>
                        <li>
                                <a class="function" href="#LightningProxModel.on_train_batch_end">on_train_batch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#LightningProxModel.on_validation_epoch_start">on_validation_epoch_start</a>
                        </li>
                        <li>
                                <a class="function" href="#LightningProxModel.configure_optimizers">configure_optimizers</a>
                        </li>
                        <li>
                                <a class="function" href="#LightningProxModel.lr_scheduler_step">lr_scheduler_step</a>
                        </li>
                        <li>
                                <a class="function" href="#LightningProxModel.on_save_checkpoint">on_save_checkpoint</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22160%22%20viewBox%3D%220%200%20150%2080%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M132.316%2048.886c.276-4.679%202.342-6.698%204.409-7.982s4.27-1.165%206.751-1.055c1.586.07%203.044.156%204.222-.482%201.142-.619%202.026-1.932%202.162-3.739.268-3.576-1.929-5.368-5.006-5.551s-7.599.524-10.517%201.606c-4.455%201.652-8.588%206.606-9.552%208.992s-2.342%206.193-1.745%2010.873%202.664%209.221%205.878%2011.79%205.878%203.808%2010.103%204.312%203.444.229%206.062.229%205.006-2.202%204.914-4.909-2.296-5.001-4.501-4.863-3.077.505-5.281.229-7.715-2.064-7.899-9.451z%22%20fill%3D%22%23198754%22/%3E%3Ccircle%20cx%3D%22101.504%22%20cy%3D%2248.943%22%20r%3D%2214.208%22%20fill%3D%22none%22%20stroke%3D%22%23198754%22%20stroke-width%3D%229.354%22/%3E%3Cpath%20d%3D%22M87.81.002c-3.637.065-5.001.454-7.014%201.232s-3.443%201.363-6.3%204.282c-1.723%201.76-3.148%205.019-3.776%207.329-.413%201.521-.316%202.63-.316%202.63l-.195%2034.612c.065%205.774-6.755%208.305-9.612%208.37s-9.678-1.038-9.743-9.408%207.128-9.521%208.362-9.521c1.413-.13%202.526-.021%203.718-.016%202.071.009%204.157-.778%204.092-4.671s-4.157-4.736-4.157-4.736c-6.3-.843-11.43%202.206-11.43%202.206S40.917%2038.15%2041.372%2049.634%2051.568%2068.19%2061.311%2068.125s18.316-7.007%2018.445-17.193l.13-22.772c.046-2.291%202.683-3.644%204.476-4.203.745-.232%201.694-.274%201.694-.274l10.457-.13s4.871-.324%207.729-3.114%204.352-6.294%204.352-6.294.974-3.049.13-4.606-.195-1.233-2.792-3.309-8.573-4.477-8.573-4.477S91.447-.063%2087.81.002zM0%2047.169l.065%2028.417S0%2080.127%204.481%2079.997s5.072-3.866%205.049-4.152l-.113-28.482s1.624-7.656%209.937-7.721%2010.002%206.942%2010.002%208.499-.909%2010.51-9.093%2010.51c-.948%200-2.99-.567-4.145-.272-3.919%201-3.194%204.554-3.194%204.554s.065%205.061%207.404%204.996%2018.575-6.034%2018.575-19.074S26.953%2030.04%2019.549%2029.91%201.234%2035.296%200%2047.169z%22%20fill%3D%22%23198754%22/%3E%3Cg%20transform%3D%22matrix%28.325601%200%200%20.325256%20-10.32669%20-45.802786%29%22%3E%3Ccircle%20cx%3D%22297.554%22%20cy%3D%22172.286%22%20r%3D%2216.5%22%20fill%3D%22%23fff%22/%3E%3Cellipse%20cx%3D%22297.709%22%20cy%3D%22172.642%22%20rx%3D%2211.071%22%20ry%3D%2210.871%22%20fill%3D%22%23105a48%22/%3E%3Ccircle%20cx%3D%22304.104%22%20cy%3D%22167.667%22%20r%3D%224.5%22%20fill%3D%22%23fff%22/%3E%3C/g%3E%3Cpath%20d%3D%22M94.661%2017.032l.893-1.476s.99.714%201.916.925%201.575.114%202.955.114l14.565-.162c1.283-.032%203.085-.762%203.02-3.293s-.373-3.503-.373-3.503l1.283-.487s.52.503.877%201.573.309%201.995.292%202.66-.227%201.541-.227%201.541%201.564-.308%202.359-1.038.823-.779%201.489-1.508.812-.86.812-.86.552-.13.877.26.341.957.065%201.46-1.672%202.206-3.247%203.066-2.76%201.427-3.929%201.768-3.848.73-7.063.714l-10.944-.114s-2.143-.081-3.02-.373-2.241-.973-2.598-1.265z%22%20fill%3D%22%23d36d49%22/%3E%3Cg%20fill%3D%22%23105a48%22%3E%3Cellipse%20cx%3D%2293.052%22%20cy%3D%2243.567%22%20rx%3D%22.869%22%20ry%3D%221.014%22%20transform%3D%22rotate%28341.022%29%22/%3E%3Cellipse%20cx%3D%22104.3%22%20cy%3D%22-16.184%22%20rx%3D%22.865%22%20ry%3D%221.009%22%20transform%3D%22rotate%2814.786%29%22/%3E%3C/g%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../simba_plus.html">simba_plus</a><wbr>.model_prox    </h1>

                
                        <input id="mod-model_prox-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-model_prox-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">List</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tensor</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.optim.lr_scheduler</span><span class="w"> </span><span class="kn">import</span> <span class="n">ReduceLROnPlateau</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">lightning</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">L</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.distributions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Distribution</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch_geometric.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">HeteroData</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch_geometric.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">EdgeType</span><span class="p">,</span> <span class="n">NodeType</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch_geometric.transforms.remove_isolated_nodes</span><span class="w"> </span><span class="kn">import</span> <span class="n">RemoveIsolatedNodes</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch_geometric.transforms.to_device</span><span class="w"> </span><span class="kn">import</span> <span class="n">ToDevice</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch_geometric.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">negative_sampling</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">simba_plus.encoders</span><span class="w"> </span><span class="kn">import</span> <span class="n">TransEncoder</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">simba_plus.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">MIN_LOGSTD</span><span class="p">,</span> <span class="n">MAX_LOGSTD</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a><span class="c1"># from simba_plus.utils import negative_sampling</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a><span class="c1"># from torch_geometric.utils import negative_sampling</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">simba_plus.loss.hsic</span><span class="w"> </span><span class="kn">import</span> <span class="n">bernoulli_kl_loss</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">simba_plus.decoders</span><span class="w"> </span><span class="kn">import</span> <span class="n">RelationalEdgeDistributionDecoder</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">simba_plus._utils</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a>    <span class="n">add_cov_to_latent</span><span class="p">,</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a>    <span class="n">make_key</span><span class="p">,</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a>    <span class="n">update_lr</span><span class="p">,</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a><span class="p">)</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">simba_plus.util_modules</span><span class="w"> </span><span class="kn">import</span> <span class="n">BufferDict</span><span class="p">,</span> <span class="n">_CheckHeteroDataCodes</span> <span class="k">as</span> <span class="n">chk</span><span class="p">,</span> <span class="n">_logger</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">simba_plus.negative_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">negative_sampling_same_sample_bipartite</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">simba_plus.loss.gene_alignment</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a>    <span class="n">TwoSampleGenePairs</span><span class="p">,</span> 
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a>    <span class="n">build_two_sample_gene_pairs</span><span class="p">,</span> 
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a>    <span class="n">MultiSampleGenePairs</span><span class="p">,</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a>    <span class="n">build_multi_sample_gene_pairs</span><span class="p">,</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a>    <span class="n">gene_alignment_msd_loss</span><span class="p">,</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a><span class="p">)</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">simba_plus.loss.ot_alignment</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a>    <span class="n">build_two_sample_cell_index</span><span class="p">,</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a>    <span class="n">compute_two_sample_ot_state</span><span class="p">,</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a>    <span class="n">ot_cost_two</span><span class="p">,</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a>    <span class="n">TwoSampleOTState</span><span class="p">,</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a>    <span class="n">PairOTState</span><span class="p">,</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a>    <span class="n">build_sample_cell_index</span><span class="p">,</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a>    <span class="n">make_all_sample_pairs</span><span class="p">,</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a>    <span class="n">compute_multi_sample_ot_states</span><span class="p">,</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a>    <span class="n">ot_cost_multi</span><span class="p">,</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a>    <span class="n">PairOTStateKeyed</span><span class="p">,</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a>    <span class="n">build_sample_batch_cell_index</span><span class="p">,</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a>    <span class="n">make_all_sample_batch_pairs</span><span class="p">,</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a>    <span class="n">compute_multi_batch_ot_states</span><span class="p">,</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a><span class="p">)</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a><span class="k">class</span><span class="w"> </span><span class="nc">_PerSampleBatchedParam</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a><span class="sd">    Store per-sample batched parameters:</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a><span class="sd">      - param[s]: (B_s, N_s)</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a><span class="sd">      - param_logstd[s]: (B_s, N_s)</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a>        <span class="n">n_batches_per_sample</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a>        <span class="n">n_nodes_per_sample</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a>        <span class="n">sample_ids</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a>        <span class="n">has_logstd</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a>        <span class="n">init</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span> <span class="o">=</span> <span class="n">sample_ids</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sample_to_listidx</span> <span class="o">=</span> <span class="p">{</span><span class="n">sid</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sample_ids</span><span class="p">)}</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">param</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ParameterList</span><span class="p">()</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">has_logstd</span> <span class="o">=</span> <span class="n">has_logstd</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_logstd</span><span class="p">:</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">param_logstd</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ParameterList</span><span class="p">()</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a>        <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="n">sample_ids</span><span class="p">:</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a>            <span class="n">B</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_batches_per_sample</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a>            <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_nodes_per_sample</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">B</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">init</span><span class="p">))))</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_logstd</span><span class="p">:</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">param_logstd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">B</span><span class="p">,</span> <span class="n">N</span><span class="p">))))</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a>        <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_to_listidx</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">sample_id</span><span class="p">)]</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_logstd</span><span class="p">:</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_logstd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a><span class="k">class</span><span class="w"> </span><span class="nc">AuxParams</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">HeteroData</span><span class="p">,</span> <span class="n">edgetype_specific</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">check_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">use_noise</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a><span class="sd">        Prepare parameter dictionaries with batch correction for RNA-seq data</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a><span class="sd">        </span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a><span class="sd">        Args:</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a><span class="sd">            data (HeteroData): The data object containing the graph data.</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a><span class="sd">            edgetype_specific (bool): Whether to use different parameters for different edge types.</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a><span class="sd">        </span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a><span class="sd">        Notes:</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a><span class="sd">            An example keylist for a parameter dictionary when edgetype_specific is True is:</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a><span class="sd">            [</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a><span class="sd">                &quot;cell__cell_expresses_gene&quot;,      # value shape: (num_cells,)</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a><span class="sd">                &quot;cell__cell_has_accessible_peak&quot;, # value shape: (num_cells,)</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a><span class="sd">                &quot;gene__cell_expresses_gene&quot;,      # value shape: (num_batches, num_genes) if use_batch else (num_genes,)</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a><span class="sd">                &quot;peak__cell_has_accessible_peak&quot;  # value shape: (num_batches, num_peaks) if use_batch else (num_peaks,)</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a><span class="sd">            ]</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a><span class="sd">            But for *_logstd_dict, there is only destination node type in the key.</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a><span class="sd">            [</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a><span class="sd">                &quot;gene__cell_expresses_gene&quot;,</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a><span class="sd">                &quot;peak__cell_has_accessible_peak&quot;</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a><span class="sd">            ]</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">edgetype_specific</span> <span class="o">=</span> <span class="n">edgetype_specific</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">use_noise</span> <span class="o">=</span> <span class="n">use_noise</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a>        <span class="n">srcs</span><span class="p">,</span> <span class="n">dsts</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span> <span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dst</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_types</span><span class="p">])</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a>        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">srcs</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">{</span><span class="s2">&quot;cell&quot;</span><span class="p">}</span> <span class="ow">and</span> <span class="nb">set</span><span class="p">(</span><span class="n">dsts</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">{</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span> <span class="s2">&quot;peak&quot;</span><span class="p">},</span> <span class="s2">&quot;Only cell-gene and cell-peak edges are supported&quot;</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a>        <span class="k">if</span> <span class="n">check_data</span><span class="p">:</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a>            <span class="n">ok</span><span class="p">,</span> <span class="n">msgs</span> <span class="o">=</span> <span class="n">chk</span><span class="o">.</span><span class="n">check_heterodata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid heterodata: </span><span class="si">{</span><span class="n">msgs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;HeteroData codes are valid: </span><span class="si">{</span><span class="n">msgs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a>        <span class="c1"># multi-sample detection</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">],</span> <span class="s2">&quot;sample&quot;</span><span class="p">):</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a>                <span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a>            <span class="p">))</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">multi_sample</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a>        <span class="c1"># if there are more than one batch, turn on use_batch</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">use_batch</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a>            <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">],</span> <span class="s2">&quot;batch_local&quot;</span><span class="p">)</span> 
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a>            <span class="ow">and</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">batch_local</span><span class="p">)</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a>            <span class="ow">or</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">],</span> <span class="s2">&quot;batch&quot;</span><span class="p">)</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a>            <span class="ow">and</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">batch</span><span class="p">)</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">))</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a>        <span class="p">)</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a>        <span class="c1"># Batch correction for RNA-seq data</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ParameterDict</span><span class="p">()</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logscale_dict</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ParameterDict</span><span class="p">()</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ParameterDict</span><span class="p">()</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bias_logstd_dict</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ParameterDict</span><span class="p">()</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logscale_logstd_dict</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ParameterDict</span><span class="p">()</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">std_logstd_dict</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ParameterDict</span><span class="p">()</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict_per_sample</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">()</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logscale_dict_per_sample</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">()</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">std_dict_per_sample</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">()</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_sample</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_batch</span><span class="p">:</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a>            <span class="c1"># precompute n_batches per sample</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a>            <span class="n">n_batches_per_sample</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">sid</span><span class="p">:</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">}</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a>            <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">:</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span> <span class="o">==</span> <span class="n">sid</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a>                <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a>                    <span class="n">bmax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">batch_local</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a>                    <span class="n">n_batches_per_sample</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">=</span> <span class="n">bmax</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a>                    <span class="n">n_batches_per_sample</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a>            
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a>            <span class="c1"># precompute n_nodes per sample for each feature node type</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a>            <span class="n">n_nodes_per_sample_per_type</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a>            <span class="k">for</span> <span class="n">node_type</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">node_types</span><span class="p">:</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a>                <span class="k">if</span> <span class="n">node_type</span> <span class="o">==</span> <span class="s2">&quot;cell&quot;</span><span class="p">:</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a>                    <span class="k">continue</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">node_type</span><span class="p">],</span> <span class="s2">&quot;sample&quot;</span><span class="p">):</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Node type </span><span class="si">{</span><span class="n">node_type</span><span class="si">}</span><span class="s2"> does not have sample attribute while there are multiple samples&quot;</span><span class="p">)</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a>                <span class="n">n_nodes_per_sample_per_type</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">sid</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">}</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a>                <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">:</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a>                    <span class="n">mask</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span> <span class="o">==</span> <span class="n">sid</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a>                    <span class="n">n_nodes_per_sample_per_type</span><span class="p">[</span><span class="n">node_type</span><span class="p">][</span><span class="n">sid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a>        
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a>        <span class="c1"># build parameter containers per edge type</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a>        <span class="k">for</span> <span class="n">edge_type</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_types</span><span class="p">:</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a>            <span class="n">src</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dst</span> <span class="o">=</span> <span class="n">edge_type</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a>            <span class="n">src_key</span><span class="p">,</span> <span class="n">dst_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_keys</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">edge_type</span><span class="p">)</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a>            <span class="n">num_src_nodes</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">src</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a>            <span class="n">num_dst_nodes</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a>            <span class="c1"># src params: always per-node</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a>            <span class="k">if</span> <span class="n">src_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">:</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">[</span><span class="n">src_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_src_nodes</span><span class="p">))</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logscale_dict</span><span class="p">[</span><span class="n">src_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_src_nodes</span><span class="p">))</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span><span class="p">[</span><span class="n">src_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_src_nodes</span><span class="p">))</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a>            
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a>            <span class="c1"># dst params: depending on use_batch and multi_sample</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_batch</span><span class="p">:</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a>                <span class="k">if</span> <span class="n">dst_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">:</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_dst_nodes</span><span class="p">))</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">logscale_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_dst_nodes</span><span class="p">))</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_dst_nodes</span><span class="p">))</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a>            <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_sample</span><span class="p">:</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>                <span class="n">_batch</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">batch</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">],</span> <span class="s2">&quot;batch&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">batch_local</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a>                <span class="n">n_batches</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">_batch</span><span class="p">)</span><span class="o">.</span><span class="n">numel</span><span class="p">())</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a>                <span class="k">if</span> <span class="n">dst_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">:</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">num_dst_nodes</span><span class="p">))</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">logscale_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">num_dst_nodes</span><span class="p">))</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">num_dst_nodes</span><span class="p">))</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">bias_logstd_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">num_dst_nodes</span><span class="p">))</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">logscale_logstd_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">num_dst_nodes</span><span class="p">))</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">std_logstd_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">num_dst_nodes</span><span class="p">))</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a>            <span class="k">else</span><span class="p">:</span> <span class="c1"># multi-sample and use_batch</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a>                <span class="k">if</span> <span class="n">dst_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict_per_sample</span><span class="p">:</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict_per_sample</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_PerSampleBatchedParam</span><span class="p">(</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a>                        <span class="n">n_batches_per_sample</span><span class="o">=</span><span class="n">n_batches_per_sample</span><span class="p">,</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a>                        <span class="n">n_nodes_per_sample</span><span class="o">=</span><span class="n">n_nodes_per_sample_per_type</span><span class="p">[</span><span class="n">dst</span><span class="p">],</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a>                        <span class="n">sample_ids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">,</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>                        <span class="n">init</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a>                    <span class="p">)</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">logscale_dict_per_sample</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_PerSampleBatchedParam</span><span class="p">(</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a>                        <span class="n">n_batches_per_sample</span><span class="o">=</span><span class="n">n_batches_per_sample</span><span class="p">,</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a>                        <span class="n">n_nodes_per_sample</span><span class="o">=</span><span class="n">n_nodes_per_sample_per_type</span><span class="p">[</span><span class="n">dst</span><span class="p">],</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a>                        <span class="n">sample_ids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">,</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a>                        <span class="n">init</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a>                    <span class="p">)</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">std_dict_per_sample</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_PerSampleBatchedParam</span><span class="p">(</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>                        <span class="n">n_batches_per_sample</span><span class="o">=</span><span class="n">n_batches_per_sample</span><span class="p">,</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a>                        <span class="n">n_nodes_per_sample</span><span class="o">=</span><span class="n">n_nodes_per_sample_per_type</span><span class="p">[</span><span class="n">dst</span><span class="p">],</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a>                        <span class="n">sample_ids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">,</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>                        <span class="n">init</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>                    <span class="p">)</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">batched</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">param_logstd</span><span class="p">):</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a><span class="sd">        Generate a batch of stochastic parameters based on baseline parameters, offsets, and deviations.</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a><span class="sd">        Args:</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a><span class="sd">            param: Baseline and offset parameters, shape: (num_batches, num_nodes)</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a><span class="sd">            param_logstd: Log standard deviations, shape: (num_batches, num_nodes)</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a><span class="sd">        Returns:</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a><span class="sd">            Stochastic parameters, shape: (num_batches, num_nodes)</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_noise</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_batch</span><span class="p">:</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>            <span class="k">assert</span> <span class="n">param</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;param must be a 2D tensor when use_batch is True, but got </span><span class="si">{</span><span class="n">param</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span><span class="si">}</span><span class="s2">D tensor&quot;</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>                <span class="k">return</span> <span class="n">param</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>            <span class="n">return_param</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>                <span class="p">[</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>                    <span class="n">param</span><span class="p">[[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:],</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>                    <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">param</span><span class="p">[[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">param_logstd</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:])</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">param_logstd</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]),</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>                <span class="p">],</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a>                <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a>            <span class="p">)</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>            <span class="k">return</span> <span class="n">return_param</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>        <span class="k">return</span> <span class="n">param</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_dst_values_per_edge</span><span class="p">(</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">HeteroData</span><span class="p">,</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a>        <span class="n">edge_index</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a>        <span class="n">dst_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a>        <span class="n">dst_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a>        <span class="n">which</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a><span class="sd">        Return a (num_edges,) tensor of dst parameters for this edge_type.</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a><span class="sd">        which in {&quot;logscale&quot;,&quot;bias&quot;,&quot;std&quot;}.</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a>        <span class="n">device</span> <span class="o">=</span> <span class="n">edge_index</span><span class="o">.</span><span class="n">device</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a>        <span class="n">num_edges</span> <span class="o">=</span> <span class="n">edge_index</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a>        <span class="c1"># not use_batch</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_batch</span><span class="p">:</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a>            <span class="n">dst_global</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="n">dst_type</span><span class="p">]</span><span class="o">.</span><span class="n">n_id</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a>            <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s2">&quot;logscale&quot;</span><span class="p">:</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">logscale_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">][</span><span class="n">dst_global</span><span class="p">]</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a>            <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s2">&quot;bias&quot;</span><span class="p">:</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">][</span><span class="n">dst_global</span><span class="p">]</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a>            <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s2">&quot;std&quot;</span><span class="p">:</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">][</span><span class="n">dst_global</span><span class="p">]</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown which=</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a>        <span class="c1"># use_batch and multi_sample</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_sample</span><span class="p">:</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a>            <span class="c1"># Per-sample: index by (cell.sample, cell.batch_local, dst.local_id)</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a>            <span class="n">samples</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a>            <span class="n">b_local</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">batch_local</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a>            <span class="n">dst_local</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="n">dst_type</span><span class="p">]</span><span class="o">.</span><span class="n">local_id</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a>            <span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">num_edges</span><span class="p">,),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>            <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s2">&quot;logscale&quot;</span><span class="p">:</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a>                <span class="n">mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logscale_dict_per_sample</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a>            <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s2">&quot;bias&quot;</span><span class="p">:</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a>                <span class="n">mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict_per_sample</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>            <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s2">&quot;std&quot;</span><span class="p">:</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a>                <span class="n">mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">std_dict_per_sample</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown which=</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a>            <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a>                <span class="n">sid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">samples</span> <span class="o">==</span> <span class="n">sid</span><span class="p">)</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">mask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>                    <span class="k">continue</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a>                <span class="n">p</span><span class="p">,</span> <span class="n">p_logstd</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a>                <span class="n">p_eff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batched</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p_logstd</span><span class="p">)</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a>                <span class="n">out</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_eff</span><span class="p">[</span><span class="n">b_local</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">dst_local</span><span class="p">[</span><span class="n">mask</span><span class="p">]]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a>            <span class="k">return</span> <span class="n">out</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a>        <span class="c1"># use_batch and not multi_sample</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a>        <span class="n">dst_global</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="n">dst_type</span><span class="p">]</span><span class="o">.</span><span class="n">n_id</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a>        <span class="n">_batch</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">batch</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">],</span> <span class="s2">&quot;batch&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">batch_local</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a>        <span class="n">b</span> <span class="o">=</span> <span class="n">_batch</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a>        <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s2">&quot;logscale&quot;</span><span class="p">:</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">batched</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logscale_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">logscale_logstd_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">])[</span><span class="n">b</span><span class="p">,</span> <span class="n">dst_global</span><span class="p">]</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a>        <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s2">&quot;bias&quot;</span><span class="p">:</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">batched</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_logstd_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">])[</span><span class="n">b</span><span class="p">,</span> <span class="n">dst_global</span><span class="p">]</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a>        <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s2">&quot;std&quot;</span><span class="p">:</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">batched</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">std_logstd_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">])[</span><span class="n">b</span><span class="p">,</span> <span class="n">dst_global</span><span class="p">]</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown which=</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">edge_index_dict</span><span class="p">):</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a><span class="sd">        Get the parameters for the given batch and edge index dictionary.</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a><span class="sd">        Args:</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a><span class="sd">            batch: Batch object, providing</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a><span class="sd">                - batch[node_type].n_id: help convert local node IDs in `edge_index_dict` to global node IDs</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a><span class="sd">                - batch[&quot;cell&quot;].batch: provide batch information for the cells</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a><span class="sd">            edge_index_dict: Edge index dictionary, each value is a tensor of shape (2, num_edges) with local node IDs</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a><span class="sd">        Returns:</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a><span class="sd">            Dictionary of parameters for the given batch and edge index dictionary</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a>        <span class="n">src_logscale_dict</span><span class="p">,</span> <span class="n">src_bias_dict</span><span class="p">,</span> <span class="n">src_std_dict</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a>        <span class="n">dst_logscale_dict</span><span class="p">,</span> <span class="n">dst_bias_dict</span><span class="p">,</span> <span class="n">dst_std_dict</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>        <span class="k">for</span> <span class="n">edge_type</span><span class="p">,</span> <span class="n">edge_index</span> <span class="ow">in</span> <span class="n">edge_index_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a>            <span class="n">src_type</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dst_type</span> <span class="o">=</span> <span class="n">edge_type</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a>            <span class="n">src_key</span><span class="p">,</span> <span class="n">dst_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_keys</span><span class="p">(</span><span class="n">src_type</span><span class="p">,</span> <span class="n">dst_type</span><span class="p">,</span> <span class="n">edge_type</span><span class="p">)</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a>            <span class="n">src_node_id</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="n">src_type</span><span class="p">]</span><span class="o">.</span><span class="n">n_id</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="c1"># local id to global id</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a>            <span class="n">src_logscale_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logscale_dict</span><span class="p">[</span><span class="n">src_key</span><span class="p">][</span><span class="n">src_node_id</span><span class="p">]</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>            <span class="n">src_bias_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">[</span><span class="n">src_key</span><span class="p">][</span><span class="n">src_node_id</span><span class="p">]</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>            <span class="n">src_std_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span><span class="p">[</span><span class="n">src_key</span><span class="p">][</span><span class="n">src_node_id</span><span class="p">]</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>            <span class="n">dst_logscale_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dst_values_per_edge</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">dst_type</span><span class="p">,</span> <span class="n">dst_key</span><span class="p">,</span> <span class="s2">&quot;logscale&quot;</span><span class="p">)</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a>            <span class="n">dst_bias_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dst_values_per_edge</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">dst_type</span><span class="p">,</span> <span class="n">dst_key</span><span class="p">,</span> <span class="s2">&quot;bias&quot;</span><span class="p">)</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a>            <span class="n">dst_std_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dst_values_per_edge</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">dst_type</span><span class="p">,</span> <span class="n">dst_key</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">)</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a>        
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a>            <span class="s2">&quot;src_logscale_dict&quot;</span><span class="p">:</span> <span class="n">src_logscale_dict</span><span class="p">,</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>            <span class="s2">&quot;src_bias_dict&quot;</span><span class="p">:</span> <span class="n">src_bias_dict</span><span class="p">,</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a>            <span class="s2">&quot;src_std_dict&quot;</span><span class="p">:</span> <span class="n">src_std_dict</span><span class="p">,</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a>            <span class="s2">&quot;dst_logscale_dict&quot;</span><span class="p">:</span> <span class="n">dst_logscale_dict</span><span class="p">,</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>            <span class="s2">&quot;dst_bias_dict&quot;</span><span class="p">:</span> <span class="n">dst_bias_dict</span><span class="p">,</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>            <span class="s2">&quot;dst_std_dict&quot;</span><span class="p">:</span> <span class="n">dst_std_dict</span><span class="p">,</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>        <span class="p">}</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_type</span><span class="p">,</span> <span class="n">dst_type</span><span class="p">,</span> <span class="n">edge_type</span><span class="p">):</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">edgetype_specific</span><span class="p">:</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a>            <span class="n">src_key</span> <span class="o">=</span> <span class="n">make_key</span><span class="p">(</span><span class="n">src_type</span><span class="p">,</span> <span class="n">edge_type</span><span class="p">)</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a>            <span class="n">dst_key</span> <span class="o">=</span> <span class="n">make_key</span><span class="p">(</span><span class="n">dst_type</span><span class="p">,</span> <span class="n">edge_type</span><span class="p">)</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a>            <span class="n">src_key</span> <span class="o">=</span> <span class="n">src_type</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a>            <span class="n">dst_key</span> <span class="o">=</span> <span class="n">dst_type</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a>            <span class="n">src_key</span><span class="p">,</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a>            <span class="n">dst_key</span><span class="p">,</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a>        <span class="p">)</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a><span class="k">class</span><span class="w"> </span><span class="nc">LightningProxModel</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">):</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a>        <span class="n">data</span><span class="p">:</span> <span class="n">HeteroData</span><span class="p">,</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a>        <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a>        <span class="n">encoder_class</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span> <span class="o">=</span> <span class="n">TransEncoder</span><span class="p">,</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a>        <span class="n">n_latent_dims</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a>        <span class="n">decoder_class</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span> <span class="o">=</span> <span class="n">RelationalEdgeDistributionDecoder</span><span class="p">,</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a>        <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a>        <span class="n">num_neg_samples_fold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a>        <span class="n">edgetype_specific</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a>        <span class="n">edge_types</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a>        <span class="n">hsic</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a>        <span class="n">herit_loss</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a>        <span class="n">herit_loss_lam</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a>        <span class="n">kl_lambda</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a>        <span class="n">kl_n_no</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a>        <span class="n">kl_n_warmup</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a>        <span class="c1"># nll_scale: float = 1.0,</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a>        <span class="c1"># val_nll_scale: float = 1.0,</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a>        <span class="n">learning_rate</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a>        <span class="n">node_weights_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a>        <span class="c1"># nonneg=False, #not used</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a>        <span class="n">reweight_rarecell</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a>        <span class="n">reweight_rarecell_neighbors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a>        <span class="n">batch_negative</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># make the default same as in the CLI</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a>        <span class="n">monitor_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a>        <span class="n">gene_align_lambda</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a>        <span class="n">gene_align_n_no</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a>        <span class="n">gene_align_n_warmup</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a>        <span class="n">ot_cs_lambda</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a>        <span class="n">ot_cs_n_no</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a>        <span class="n">ot_cs_n_warmup</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a>        <span class="n">ot_cs_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a>        <span class="n">ot_cb_lambda</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a>        <span class="n">ot_cb_n_no</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a>        <span class="n">ot_cb_n_warmup</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a>        <span class="n">ot_cb_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a>        <span class="n">ot_eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a>        <span class="n">ot_iter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a>        <span class="n">ot_plan_every_n_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="c1"># invalid if 0</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a>        <span class="n">ot_loss_every_n_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># if 0, once per epoch (first batch)</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a>        <span class="c1"># DEBUG</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a>        <span class="n">use_aux</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a>        <span class="n">use_aux_noise</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a>    <span class="p">):</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a>            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;device is deprecated and will be removed in future versions.&quot;</span>\
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a>                <span class="s2">&quot;Please use `model.to(device)` to move the model to the desired device instead.&quot;</span><span class="p">)</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a>        
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">save_hyperparameters</span><span class="p">()</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a>        <span class="c1"># self.nonneg = nonneg</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span> <span class="o">=</span> <span class="n">logger</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a>        
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span> <span class="o">=</span> <span class="n">_logger</span><span class="p">()</span> <span class="c1"># fallback to print</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a>        
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a>        <span class="n">ok</span><span class="p">,</span> <span class="n">msgs</span> <span class="o">=</span> <span class="n">chk</span><span class="o">.</span><span class="n">check_heterodata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid heterodata: </span><span class="si">{</span><span class="n">msgs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;HeteroData codes are valid: </span><span class="si">{</span><span class="n">msgs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="n">learning_rate</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">encoder_class</span><span class="p">(</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a>            <span class="n">data</span><span class="p">,</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a>            <span class="n">n_latent_dims</span><span class="p">,</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a>        <span class="p">)</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">decoder_class</span><span class="p">(</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a>            <span class="n">data</span><span class="p">,</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a>        <span class="p">)</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span> <span class="o">=</span> <span class="n">hsic</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">hsic_optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">hsic</span><span class="o">.</span><span class="n">lam</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a>            <span class="p">)</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">kl_lambda</span> <span class="o">=</span> <span class="n">kl_lambda</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">kl_n_no</span> <span class="o">=</span> <span class="n">kl_n_no</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">kl_n_warmup</span> <span class="o">=</span> <span class="n">kl_n_warmup</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a>        <span class="c1"># self.nll_scale = nll_scale</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a>        <span class="c1"># self.val_nll_scale = val_nll_scale</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a>        <span class="c1"># self.num_nodes_dict = data.num_nodes_dict</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cell_weights</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">)</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reweight_rarecell</span> <span class="o">=</span> <span class="n">reweight_rarecell</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reweight_rarecell</span><span class="p">:</span> <span class="c1"># not used</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a>            <span class="k">if</span> <span class="n">reweight_rarecell_neighbors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a>                <span class="n">reweight_rarecell_neighbors</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reweight_rarecell_neighbors</span> <span class="o">=</span> <span class="n">reweight_rarecell_neighbors</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a>        <span class="k">if</span> <span class="n">edge_types</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">edge_types</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_types</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">edge_types</span> <span class="o">=</span> <span class="n">edge_types</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">edgetype_loss_weight_dict</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a>            <span class="n">edgetype</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edge_types</span><span class="p">))</span> 
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a>            <span class="k">for</span> <span class="n">edgetype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_types</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a>        <span class="p">}</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">node_weights_dict</span> <span class="o">=</span> <span class="n">node_weights_dict</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">herit_loss</span> <span class="o">=</span> <span class="n">herit_loss</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">herit_loss_lam</span> <span class="o">=</span> <span class="n">herit_loss_lam</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_neg_samples_fold</span> <span class="o">=</span> <span class="n">num_neg_samples_fold</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">validation_step_outputs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">use_aux</span> <span class="o">=</span> <span class="n">use_aux</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">use_aux_noise</span> <span class="o">=</span> <span class="n">use_aux_noise</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">aux_params</span> <span class="o">=</span> <span class="n">AuxParams</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">edgetype_specific</span><span class="o">=</span><span class="n">edgetype_specific</span><span class="p">,</span> 
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a>                                    <span class="n">check_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># already checked above</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a>                                    <span class="n">use_noise</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_aux_noise</span>    <span class="c1"># DEBUG</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a>        <span class="p">)</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_aux</span><span class="p">:</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_freeze_aux_params</span><span class="p">()</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_negative</span> <span class="o">=</span> <span class="n">batch_negative</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">monitor_key</span> <span class="o">=</span> <span class="n">monitor_key</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gene_align_lambda</span> <span class="o">=</span> <span class="n">gene_align_lambda</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gene_align_n_no</span> <span class="o">=</span> <span class="n">gene_align_n_no</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gene_align_n_warmup</span> <span class="o">=</span> <span class="n">gene_align_n_warmup</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ot_cs_lambda</span> <span class="o">=</span> <span class="n">ot_cs_lambda</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ot_cs_n_no</span> <span class="o">=</span> <span class="n">ot_cs_n_no</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ot_cs_n_warmup</span> <span class="o">=</span> <span class="n">ot_cs_n_warmup</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ot_cs_k</span> <span class="o">=</span> <span class="n">ot_cs_k</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ot_cb_lambda</span> <span class="o">=</span> <span class="n">ot_cb_lambda</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ot_cb_n_no</span> <span class="o">=</span> <span class="n">ot_cb_n_no</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ot_cb_n_warmup</span> <span class="o">=</span> <span class="n">ot_cb_n_warmup</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ot_cb_k</span> <span class="o">=</span> <span class="n">ot_cb_k</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ot_eps</span> <span class="o">=</span> <span class="n">ot_eps</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ot_iter</span> <span class="o">=</span> <span class="n">ot_iter</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ot_plan_every_n_epochs</span> <span class="o">=</span> <span class="n">ot_plan_every_n_epochs</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ot_loss_every_n_steps</span> <span class="o">=</span> <span class="n">ot_loss_every_n_steps</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_register_gene_pairs</span><span class="p">()</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_register_ot_state</span><span class="p">()</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_register_others</span><span class="p">()</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log_every_n_steps</span> <span class="o">=</span> <span class="mi">50</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a>    
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_freeze_aux_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a>        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aux_params</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a>            <span class="n">param</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a>    
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_register_gene_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gene_align_lambda</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">],</span> <span class="s2">&quot;sample&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">],</span> <span class="s2">&quot;gene_id&quot;</span><span class="p">)):</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>                    <span class="s2">&quot;gene_align_lambda &gt; 0 requires data[&#39;gene&#39;].sample and data[&#39;gene&#39;].gene_id &quot;</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>                    <span class="s2">&quot;(constructed in make_sc_HetData_multi_rna).&quot;</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>                <span class="p">)</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>            
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>            <span class="n">pairs</span> <span class="o">=</span> <span class="n">build_multi_sample_gene_pairs</span><span class="p">(</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>                <span class="n">gene_sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">,</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>                <span class="n">gene_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">gene_id</span><span class="p">,</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>            <span class="p">)</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>            
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;gene_align_idx0&quot;</span><span class="p">,</span> <span class="n">pairs</span><span class="o">.</span><span class="n">idx0</span><span class="p">,</span> <span class="n">persistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;gene_align_idx1&quot;</span><span class="p">,</span> <span class="n">pairs</span><span class="o">.</span><span class="n">idx1</span><span class="p">,</span> <span class="n">persistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_gene_pairs</span> <span class="o">=</span> <span class="n">MultiSampleGenePairs</span><span class="p">(</span><span class="n">idx0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_align_idx0</span><span class="p">,</span> <span class="n">idx1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_align_idx1</span><span class="p">)</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>    
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_register_ot_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a>        <span class="c1"># cross-sample OT state</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_cs_lambda</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">],</span> <span class="s2">&quot;sample&quot;</span><span class="p">):</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ot_cs_lambda &gt; 0 requires data[&#39;cell&#39;].sample&quot;</span><span class="p">)</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a>            
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a>            <span class="c1"># not buffers; we&#39;ll compute OT related variables on the fly</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_ot_cs_groups</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="n">build_sample_cell_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">)</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_ot_cs_pairs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="n">make_all_sample_pairs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ot_cs_groups</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;all_pairs&quot;</span><span class="p">)</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_ot_cs_states</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PairOTState</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>        
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>        <span class="c1"># cross-batch OT state</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_cb_lambda</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">],</span> <span class="s2">&quot;batch_local&quot;</span><span class="p">):</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">],</span> <span class="s2">&quot;batch&quot;</span><span class="p">):</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ot_cb_lambda &gt; 0 requires data[&#39;cell&#39;].batch_local or data[&#39;cell&#39;].batch&quot;</span><span class="p">)</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">],</span> <span class="s2">&quot;sample&quot;</span><span class="p">):</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">batch</span><span class="p">)</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">batch_local</span> <span class="o">=</span> <span class="n">chk</span><span class="o">.</span><span class="n">_make_batch_local_from_global</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">batch</span><span class="p">)</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_ot_cb_groups</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="n">build_sample_batch_cell_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">batch_local</span><span class="p">)</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_ot_cb_pairs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">make_all_sample_batch_pairs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ot_cb_groups</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;all_pairs&quot;</span><span class="p">)</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_ot_cb_states</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PairOTStateKeyed</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_register_others</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a>        <span class="c1"># self.register_buffer(&quot;cell_weights&quot;, self.cell_weights) # not used</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">edgetype_loss_weight_dict</span> <span class="o">=</span> <span class="n">BufferDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edgetype_loss_weight_dict</span><span class="p">)</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_weights_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">node_weights_dict</span> <span class="o">=</span> <span class="n">BufferDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_weights_dict</span><span class="p">)</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_stage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a>        <span class="k">return</span> <span class="s2">&quot;train&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="k">else</span> <span class="s2">&quot;val&quot;</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a>    
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_num_edges_in_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="s2">&quot;edge_index_dict&quot;</span><span class="p">):</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a>            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a>        <span class="k">return</span> <span class="mi">1</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a>    
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_edge_type_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edge_type</span><span class="p">:</span> <span class="n">EdgeType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a>            <span class="k">return</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">edge_type</span><span class="p">)</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a>        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a>            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">edge_type</span><span class="p">)</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a>    
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_log_metric</span><span class="p">(</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a>        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a>        <span class="n">value</span><span class="p">,</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a>        <span class="o">*</span><span class="p">,</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a>        <span class="n">stage</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a>        <span class="n">on_step</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a>        <span class="n">on_epoch</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a>        <span class="n">prog_bar</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a>        <span class="n">stage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stage</span><span class="p">()</span> <span class="k">if</span> <span class="n">stage</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">stage</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a>        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stage</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">batch_size</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>        <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">math</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="k">else</span> <span class="n">value</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a>            <span class="n">key</span><span class="p">,</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a>            <span class="n">value</span><span class="p">,</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a>            <span class="n">on_step</span><span class="o">=</span><span class="n">on_step</span><span class="p">,</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="n">on_epoch</span><span class="p">,</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a>            <span class="n">prog_bar</span><span class="o">=</span><span class="n">prog_bar</span><span class="p">,</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>            <span class="n">logger</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a>        <span class="p">)</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a>    
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_log_perf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">seconds</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">on_step</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">/perf&quot;</span><span class="p">,</span> <span class="n">seconds</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="n">on_step</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="ow">not</span> <span class="n">on_step</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a>    
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a>            <span class="n">update_lr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hsic_optimizer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span><span class="o">.</span><span class="n">lam</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Runs the encoder and computes node-wise latent variables.&quot;&quot;&quot;</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reparametrize</span><span class="p">(</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a>        <span class="n">mu_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a>        <span class="n">logstd_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate random z from mu, logstd&quot;&quot;&quot;</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>        <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>        <span class="k">assert</span> <span class="n">mu_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="n">logstd_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>        <span class="k">for</span> <span class="n">node_type</span> <span class="ow">in</span> <span class="n">mu_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">kl_n_no</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>            <span class="p">):</span>  <span class="c1"># Start reparameterization later</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>                <span class="n">out_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">mu_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>                    <span class="n">logstd_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a>                <span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logstd_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">])</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a>                <span class="n">out_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">mu_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span>  <span class="c1"># Use mean only initially</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a>        <span class="k">return</span> <span class="n">out_dict</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">relational_recon_loss</span><span class="p">(</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">HeteroData</span><span class="p">,</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a>        <span class="n">z_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a>        <span class="n">pos_edge_index_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a>        <span class="n">pos_edge_weight_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a>        <span class="n">neg_edge_index_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a>        <span class="n">batch_alledges</span><span class="p">:</span> <span class="n">HeteroData</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a>        <span class="n">neg_sample</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a>        <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a>        <span class="n">get_metric</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span> <span class="n">Dict</span><span class="p">]:</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate reconstruction loss by maximizing log_prob of observing edge weight in pos_edge_index_dict and 0 weight in neg_edge_index_dict</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a><span class="sd">        Args</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a><span class="sd">        z_dict: encoded vector</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a><span class="sd">        pos_edge_index_dict: Dictionary of Tensors with shape (2, n_pos_edges)</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a><span class="sd">        pos_edge_weight_dict: Dictionary of Tensors with shape (n_pos_edges,) encoding the weight of each edges.</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a><span class="sd">        neg_edge_index_dict: Dictionary of Tensors with shape (2, n_neg_edges) to be used as negative edges</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a><span class="sd">        num_neg_samples: If neg_edge_index is None and</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a><span class="sd">            num_neg_samples is None, This number of negative edges are sampled. Otherwise, the same number as the positive edges are sample.</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a>        <span class="n">pos_dist_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Distribution</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a>            <span class="n">batch</span><span class="p">,</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>            <span class="n">z_dict</span><span class="p">,</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a>            <span class="n">pos_edge_index_dict</span><span class="p">,</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">aux_params</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">pos_edge_index_dict</span><span class="p">),</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a>        <span class="p">)</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a>        <span class="k">if</span> <span class="n">neg_sample</span><span class="p">:</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a>            <span class="k">if</span> <span class="n">neg_edge_index_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a>                <span class="n">neg_edge_index_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a>                <span class="k">for</span> <span class="n">edge_type</span> <span class="ow">in</span> <span class="n">pos_edge_index_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a>                    <span class="n">src</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dst</span> <span class="o">=</span> <span class="n">edge_type</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a>                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="n">src</span><span class="p">],</span> <span class="s2">&quot;sample&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="n">dst</span><span class="p">],</span> <span class="s2">&quot;sample&quot;</span><span class="p">):</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a>                        <span class="n">neg_edge_index</span> <span class="o">=</span> <span class="n">negative_sampling_same_sample_bipartite</span><span class="p">(</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a>                            <span class="n">pos_edge_index_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">],</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a>                            <span class="n">src_sample</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="n">src</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">,</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a>                            <span class="n">dst_sample</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">,</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a>                            <span class="n">num_neg_samples_fold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_neg_samples_fold</span><span class="p">,</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a>                            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;sparse&quot;</span><span class="p">,</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a>                        <span class="p">)</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a>                        <span class="n">n_pos_edges</span> <span class="o">=</span> <span class="n">pos_edge_index_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a>                        <span class="n">neg_edge_index</span> <span class="o">=</span> <span class="n">negative_sampling</span><span class="p">(</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a>                            <span class="n">batch</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span><span class="o">.</span><span class="n">edge_index</span><span class="p">,</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a>                            <span class="n">num_nodes</span><span class="o">=</span><span class="p">(</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a>                                <span class="n">batch</span><span class="p">[</span><span class="n">src</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>                                <span class="n">batch</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a>                            <span class="p">),</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a>                            <span class="n">num_neg_samples</span><span class="o">=</span><span class="n">n_pos_edges</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_neg_samples_fold</span><span class="p">,</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a>                        <span class="p">)</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a>                    <span class="n">neg_edge_index_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">neg_edge_index</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a>            <span class="n">neg_dist_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Distribution</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a>                <span class="n">batch</span><span class="p">,</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a>                <span class="n">z_dict</span><span class="p">,</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a>                <span class="n">neg_edge_index_dict</span><span class="p">,</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a>                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">aux_params</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">neg_edge_index_dict</span><span class="p">),</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a>            <span class="p">)</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>        <span class="n">loss_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a>        <span class="n">metric_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a>        <span class="n">fold_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_neg_samples_fold</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a>        <span class="n">weight_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_neg_samples_fold</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a>        <span class="k">for</span> <span class="n">edge_type</span><span class="p">,</span> <span class="n">pos_dist</span> <span class="ow">in</span> <span class="n">pos_dist_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a>            <span class="n">src_type</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dst_type</span> <span class="o">=</span> <span class="n">edge_type</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a>            <span class="n">pos_edge_weights</span> <span class="o">=</span> <span class="n">pos_edge_weight_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a>            <span class="n">pos_loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">pos_dist</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">pos_edge_weights</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>            <span class="n">loss_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos_loss</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a>            <span class="k">if</span> <span class="n">neg_sample</span><span class="p">:</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a>                <span class="n">neg_dist</span> <span class="o">=</span> <span class="n">neg_dist_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a>                <span class="n">neg_edge_weights</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a>                    <span class="n">neg_dist</span><span class="o">.</span><span class="n">event_shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a>                <span class="p">)</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a>                <span class="n">neg_loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">neg_dist</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">neg_edge_weights</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a>                <span class="n">loss_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">loss_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">+</span> <span class="n">neg_loss</span> <span class="o">*</span> <span class="n">fold_tensor</span><span class="p">)</span> <span class="o">*</span> <span class="n">weight_tensor</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a>        <span class="k">return</span> <span class="n">loss_dict</span><span class="p">,</span> <span class="n">neg_edge_index_dict</span><span class="p">,</span> <span class="n">metric_dict</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_kl_loss</span><span class="p">(</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a>        <span class="n">mu</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>        <span class="n">logstd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>        <span class="n">weight</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Computes the KL loss, either for the passed arguments :obj:`mu`</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a><span class="sd">        and :obj:`logstd`, or based on latent variables from last encoding.</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a><span class="sd">        Args:</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a><span class="sd">            mu (Tensor, optional): The latent space for :math:`\mu`. If set to</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a><span class="sd">                :obj:`None`, uses the last computation of :math:`mu`.</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a><span class="sd">                (default: :obj:`None`)</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a><span class="sd">            logstd (Tensor, optional): The latent space for</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a><span class="sd">                :math:`\log\sigma`.  If set to :obj:`None`, uses the last</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a><span class="sd">                computation of :math:`\log\sigma^2`.(default: :obj:`None`)</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a><span class="sd">            weight (Tensor, optional): weights of each position in the tensor.</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">weighted_mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a>            <span class="c1"># if not w.any():</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a>            <span class="c1">#     return 0</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a>            <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a>                <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1e-12</span><span class="p">)</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a>        <span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mu__</span> <span class="k">if</span> <span class="n">mu</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">mu</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>        <span class="n">logstd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__logstd__</span> <span class="k">if</span> <span class="n">logstd</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">logstd</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a>        <span class="n">kls</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">logstd</span> <span class="o">-</span> <span class="n">mu</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">logstd</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a>        <span class="k">return</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">weighted_mean</span><span class="p">(</span><span class="n">kls</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">relational_kl_divergence</span><span class="p">(</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a>        <span class="n">mu_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a>        <span class="n">logstd_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a>        <span class="n">node_index_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a>        <span class="n">node_weights_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Sums KL divergence across relations.</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a><span class="sd">        Args</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a><span class="sd">            z_dict: encoded vector</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>        <span class="n">loss_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>        <span class="k">if</span> <span class="n">node_weights_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>            <span class="n">node_weights_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">node_type</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">mu_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">node_type</span> <span class="ow">in</span> <span class="n">mu_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>        <span class="k">for</span> <span class="n">node_type</span> <span class="ow">in</span> <span class="n">mu_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>            <span class="n">weight</span> <span class="o">=</span> <span class="n">node_weights_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">][</span><span class="n">node_index_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]]</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>            <span class="n">loss_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kl_loss</span><span class="p">(</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>                <span class="n">mu_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">],</span> <span class="n">logstd_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">],</span> <span class="n">weight</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>            <span class="p">)</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>        <span class="k">return</span> <span class="n">loss_dict</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">kl_div_loss</span><span class="p">(</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>        <span class="n">batch</span><span class="p">,</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>        <span class="n">mu_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>        <span class="n">logstd_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>        <span class="n">node_index_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>        <span class="n">node_weights_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>        <span class="n">nodetype_loss_weight_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a><span class="sd">        Args</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a><span class="sd">        mu_dict: mu of encoded batch</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a><span class="sd">        logstd_dict: logstd of encoded batch</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a><span class="sd">        node_index_dict: node index of the batch</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a><span class="sd">        node_counts_dict: For entire dataset, counts how many times each node is used for KL div calculation. If None, assume no node has been used for the calculation.</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>        <span class="n">kl_div_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relational_kl_divergence</span><span class="p">(</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a>            <span class="n">mu_dict</span><span class="p">,</span> <span class="n">logstd_dict</span><span class="p">,</span> <span class="n">node_index_dict</span><span class="p">,</span> <span class="n">node_weights_dict</span><span class="o">=</span><span class="n">node_weights_dict</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a>        <span class="p">)</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>        <span class="n">l</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>        <span class="k">if</span> <span class="n">nodetype_loss_weight_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>            <span class="n">nodetype_loss_weight_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">node_type</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">kl_div_dict</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">node_type</span> <span class="ow">in</span> <span class="n">kl_div_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>            <span class="n">s</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">nodetype_loss_weight_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span> <span class="k">for</span> <span class="n">node_type</span> <span class="ow">in</span> <span class="n">kl_div_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>            <span class="n">nodetype_loss_weight_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">node_type</span><span class="p">:</span> <span class="n">nodetype_loss_weight_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span> <span class="o">/</span> <span class="n">s</span> <span class="k">for</span> <span class="n">node_type</span> <span class="ow">in</span> <span class="n">kl_div_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a>        <span class="k">for</span> <span class="n">node_type</span><span class="p">,</span> <span class="n">kl_div</span> <span class="ow">in</span> <span class="n">kl_div_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a>            <span class="n">l</span> <span class="o">+=</span> <span class="n">kl_div</span> <span class="o">*</span> <span class="n">nodetype_loss_weight_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a>        <span class="k">return</span> <span class="n">l</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">nll_loss</span><span class="p">(</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">HeteroData</span><span class="p">,</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a>        <span class="n">z_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a>        <span class="n">pos_edge_index_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a>        <span class="n">pos_edge_weight_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a>        <span class="n">neg_edge_index_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a>        <span class="c1"># num_neg_samples_fold: Optional[int] = 1,</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a>        <span class="n">edgetype_loss_weight_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a>        <span class="n">batch_alledges</span><span class="p">:</span> <span class="n">HeteroData</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a>        <span class="n">neg_sample</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a>    <span class="p">):</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a>        <span class="n">nll_dict</span><span class="p">,</span> <span class="n">neg_edge_index_dict</span><span class="p">,</span> <span class="n">metric_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relational_recon_loss</span><span class="p">(</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a>            <span class="n">batch</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a>            <span class="n">z_dict</span><span class="o">=</span><span class="n">z_dict</span><span class="p">,</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a>            <span class="n">pos_edge_index_dict</span><span class="o">=</span><span class="n">pos_edge_index_dict</span><span class="p">,</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a>            <span class="n">pos_edge_weight_dict</span><span class="o">=</span><span class="n">pos_edge_weight_dict</span><span class="p">,</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>            <span class="n">neg_edge_index_dict</span><span class="o">=</span><span class="n">neg_edge_index_dict</span><span class="p">,</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a>            <span class="n">batch_alledges</span><span class="o">=</span><span class="n">batch_alledges</span><span class="p">,</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a>            <span class="n">neg_sample</span><span class="o">=</span><span class="n">neg_sample</span><span class="p">,</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a>        <span class="p">)</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>        <span class="n">l</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>        <span class="n">weighted_nll_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>        <span class="k">if</span> <span class="n">edgetype_loss_weight_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>            <span class="n">edgetype_loss_weight_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">edge_type</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">nll_dict</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">edge_type</span> <span class="ow">in</span> <span class="n">nll_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>            <span class="n">s</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">edgetype_loss_weight_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="k">for</span> <span class="n">edge_type</span> <span class="ow">in</span> <span class="n">nll_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a>            <span class="n">edgetype_loss_weight_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">edge_type</span><span class="p">:</span> <span class="n">edgetype_loss_weight_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">/</span> <span class="n">s</span> <span class="k">for</span> <span class="n">edge_type</span> <span class="ow">in</span> <span class="n">nll_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a>        <span class="k">for</span> <span class="n">edge_type</span><span class="p">,</span> <span class="n">nll</span> <span class="ow">in</span> <span class="n">nll_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>            <span class="n">l</span> <span class="o">+=</span> <span class="n">nll</span> <span class="o">*</span> <span class="n">edgetype_loss_weight_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a>            <span class="n">weighted_nll_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">nll</span> <span class="o">*</span> <span class="n">edgetype_loss_weight_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a>        <span class="k">return</span> <span class="n">l</span><span class="p">,</span> <span class="n">weighted_nll_dict</span><span class="p">,</span> <span class="n">neg_edge_index_dict</span><span class="p">,</span> <span class="n">metric_dict</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">gene_alignment_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>        
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a>        <span class="n">gene_mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">__mu_dict__</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">]</span> <span class="c1"># (n_genes, n_latent_dims)</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>        <span class="n">pairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gene_pairs</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a>        <span class="k">return</span> <span class="n">gene_alignment_msd_loss</span><span class="p">(</span><span class="n">gene_mu</span><span class="p">,</span> <span class="n">pairs</span><span class="p">)</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">ot_alignment_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a>        <span class="c1"># current trainable mu (NOT detach) =&gt; gradients flow to those cells</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a>        <span class="n">cell_mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">__mu_dict__</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a>        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;cs&quot;</span><span class="p">:</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a>            <span class="k">return</span> <span class="n">ot_cost_multi</span><span class="p">(</span><span class="n">cell_mu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ot_cs_states</span><span class="p">,</span> <span class="n">P_detach</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a>        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;cb&quot;</span><span class="p">:</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a>            <span class="k">return</span> <span class="n">ot_cost_multi</span><span class="p">(</span><span class="n">cell_mu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ot_cb_states</span><span class="p">,</span> <span class="n">P_detach</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown OT type=</span><span class="si">{</span><span class="nb">type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">training_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a>        <span class="c1"># batch = batch.to(self.device)</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a>        
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a>        <span class="n">t_all0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a>        <span class="n">mu_dict</span><span class="p">,</span> <span class="n">logstd_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a>        <span class="n">z_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reparametrize</span><span class="p">(</span><span class="n">mu_dict</span><span class="p">,</span> <span class="n">logstd_dict</span><span class="p">)</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a>        <span class="n">bs_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_edges_in_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a>        <span class="c1"># ---- NLL ----</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a>        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a>        <span class="n">batch_nll_loss</span><span class="p">,</span> <span class="n">weighted_nll_dict</span><span class="p">,</span> <span class="n">neg_edge_index_dict</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nll_loss</span><span class="p">(</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>            <span class="n">batch</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a>            <span class="n">z_dict</span><span class="o">=</span><span class="n">z_dict</span><span class="p">,</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a>            <span class="n">pos_edge_index_dict</span><span class="o">=</span><span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="p">,</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a>            <span class="n">pos_edge_weight_dict</span><span class="o">=</span><span class="n">batch</span><span class="o">.</span><span class="n">edge_attr_dict</span><span class="p">,</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a>            <span class="n">edgetype_loss_weight_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">edgetype_loss_weight_dict</span><span class="p">,</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a>            <span class="n">neg_sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_negative</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a>        <span class="p">)</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;nll&quot;</span><span class="p">,</span> <span class="n">batch_nll_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a>        <span class="c1"># self._log_perf(&quot;nll&quot;, time.time() - t0, on_step=True)</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">weighted_nll_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a>            <span class="k">for</span> <span class="n">edge_type</span><span class="p">,</span> <span class="n">nll_w</span> <span class="ow">in</span> <span class="n">weighted_nll_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a>                <span class="n">edge_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edge_type_key</span><span class="p">(</span><span class="n">edge_type</span><span class="p">)</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a>                <span class="n">edge_bs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span><span class="o">.</span><span class="n">edge_index</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;nll/</span><span class="si">{</span><span class="n">edge_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">nll_w</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">edge_bs</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a>        
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a>        <span class="c1"># ---- KL ----</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>        <span class="n">compute_kl_now</span><span class="p">,</span> <span class="n">kl_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_kl_now</span><span class="p">(</span><span class="n">return_weight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>        <span class="n">batch_kl_div_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a>        <span class="k">if</span> <span class="n">compute_kl_now</span><span class="p">:</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a>            <span class="n">batch_kl_div_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kl_div_loss</span><span class="p">(</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a>                <span class="n">batch</span><span class="p">,</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a>                <span class="n">mu_dict</span><span class="p">,</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a>                <span class="n">logstd_dict</span><span class="p">,</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>                <span class="n">batch</span><span class="o">.</span><span class="n">n_id_dict</span><span class="p">,</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>                <span class="n">node_weights_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node_weights_dict</span><span class="p">,</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a>            <span class="p">)</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;kl&quot;</span><span class="p">,</span> <span class="n">batch_kl_div_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;kl_weighted&quot;</span><span class="p">,</span> <span class="n">kl_weight</span> <span class="o">*</span> <span class="n">batch_kl_div_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a>        
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a>        <span class="c1"># ---- Herit Loss ----</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">herit_loss</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a>            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a>            <span class="k">if</span> <span class="s2">&quot;peak&quot;</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">node_types</span><span class="p">:</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a>                <span class="n">pid</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;peak&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">n_id</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>                <span class="n">herit_loss_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">herit_loss_lam</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">herit_loss</span><span class="p">(</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a>                    <span class="n">mu_dict</span><span class="p">[</span><span class="s2">&quot;peak&quot;</span><span class="p">],</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a>                    <span class="n">pid</span><span class="p">,</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a>                <span class="p">)</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a>                <span class="n">herit_loss_value</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;herit_loss&quot;</span><span class="p">,</span> <span class="n">herit_loss_value</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a>            <span class="c1"># self._log_perf(&quot;herit_loss&quot;, time.time() - t0, on_step=True)</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a>            <span class="n">herit_loss_value</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>        
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>        <span class="c1"># ---- Gene Alignment ----</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>        <span class="n">compute_gene_align_now</span><span class="p">,</span> <span class="n">gene_align_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_gene_align_now</span><span class="p">(</span><span class="n">return_weight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>        <span class="n">gene_align_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>        <span class="k">if</span> <span class="n">compute_gene_align_now</span><span class="p">:</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>            <span class="n">gene_align_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gene_alignment_loss</span><span class="p">()</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;gene_align&quot;</span><span class="p">,</span> <span class="n">gene_align_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;gene_align_weighted&quot;</span><span class="p">,</span> <span class="n">gene_align_weight</span> <span class="o">*</span> <span class="n">gene_align_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>        <span class="c1"># ---- OT loss ----</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a>        <span class="n">compute_ot_cs_now</span><span class="p">,</span> <span class="n">ot_cs_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_ot_cs_now</span><span class="p">(</span><span class="n">return_weight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a>        <span class="n">ot_cs_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a>        <span class="k">if</span> <span class="n">compute_ot_cs_now</span><span class="p">:</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a>            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a>            <span class="n">ot_cs_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_alignment_loss</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;cs&quot;</span><span class="p">)</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;ot_cs_loss&quot;</span><span class="p">,</span> <span class="n">ot_cs_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;ot_cs_weighted&quot;</span><span class="p">,</span> <span class="n">ot_cs_weight</span> <span class="o">*</span> <span class="n">ot_cs_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a>            <span class="c1"># self._log_perf(&quot;ot_cs_loss&quot;, time.time() - t0, on_step=True)</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a>        
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a>        <span class="n">compute_ot_cb_now</span><span class="p">,</span> <span class="n">ot_cb_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_ot_cb_now</span><span class="p">(</span><span class="n">return_weight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a>        <span class="n">ot_cb_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a>        <span class="k">if</span> <span class="n">compute_ot_cb_now</span><span class="p">:</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a>            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a>            <span class="n">ot_cb_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_alignment_loss</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;cb&quot;</span><span class="p">)</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;ot_cb_loss&quot;</span><span class="p">,</span> <span class="n">ot_cb_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;ot_cb_weighted&quot;</span><span class="p">,</span> <span class="n">ot_cb_weight</span> <span class="o">*</span> <span class="n">ot_cb_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a>            <span class="c1"># self._log_perf(&quot;ot_cb_loss&quot;, time.time() - t0, on_step=True)</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a>        
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a>        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a>            <span class="n">batch_nll_loss</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a>            <span class="o">+</span> <span class="n">kl_weight</span> <span class="o">*</span> <span class="n">batch_kl_div_loss</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a>            <span class="c1"># + aux_kl_div_loss / self.nll_scale</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a>            <span class="o">+</span> <span class="n">herit_loss_value</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a>            <span class="c1"># + aux_reg_loss</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a>            <span class="o">+</span> <span class="n">gene_align_weight</span> <span class="o">*</span> <span class="n">gene_align_loss</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a>            <span class="o">+</span> <span class="n">ot_cs_weight</span> <span class="o">*</span> <span class="n">ot_cs_loss</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a>            <span class="o">+</span> <span class="n">ot_cb_weight</span> <span class="o">*</span> <span class="n">ot_cb_loss</span>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a>        <span class="p">)</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;loss&quot;</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a>        <span class="c1"># self._log_perf(&quot;step_total&quot;, time.time() - t_all0, on_step=True)</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a>        <span class="c1"># Debug: Monitor gradients and embeddings every 10 steps</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_step</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_debug_embeddings_only</span><span class="p">(</span><span class="n">mu_dict</span><span class="p">,</span> <span class="n">logstd_dict</span><span class="p">)</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">local_step</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a>        <span class="k">return</span> <span class="n">loss</span>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_after_backward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Called after loss.backward() and before optimizers are stepped.&quot;&quot;&quot;</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a>        <span class="c1"># Gradient clipping to prevent aux_params from dominating</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a>        <span class="c1"># torch.nn.utils.clip_grad_norm_(self.aux_params.parameters(), max_norm=1.0)</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_step</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_debug_gradients</span><span class="p">()</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_debug_embeddings_only</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu_dict</span><span class="p">,</span> <span class="n">logstd_dict</span><span class="p">):</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Debug method to monitor embedding quality only (no gradients).&quot;&quot;&quot;</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== EMBEDDING DEBUG - Epoch </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="si">}</span><span class="s2">, Step </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">global_step</span><span class="si">}</span><span class="s2"> ===&quot;</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a>        <span class="p">)</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a>        <span class="c1"># 1. Check KL Divergence and Variance</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a>        <span class="k">for</span> <span class="n">node_type</span> <span class="ow">in</span> <span class="n">mu_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a>            <span class="n">mu_std</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">mu_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a>            <span class="n">logstd_mean</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">logstd_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node_type</span><span class="si">}</span><span class="s2"> - mu std: </span><span class="si">{</span><span class="n">mu_std</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, logstd mean: </span><span class="si">{</span><span class="n">logstd_mean</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a>            <span class="p">)</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>            <span class="c1"># Check for collapse</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a>            <span class="k">if</span> <span class="n">mu_std</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: Potential mu collapse in </span><span class="si">{</span><span class="n">node_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>            <span class="k">if</span> <span class="n">logstd_mean</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">5</span><span class="p">:</span>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a>                    <span class="sa">f</span><span class="s2">&quot;WARNING: Potential variance collapse in </span><span class="si">{</span><span class="n">node_type</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a>                <span class="p">)</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a>        <span class="c1"># 2. Check latent representation quality</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a>            <span class="n">z_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reparametrize</span><span class="p">(</span><span class="n">mu_dict</span><span class="p">,</span> <span class="n">logstd_dict</span><span class="p">)</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a>            <span class="k">for</span> <span class="n">node_type</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">z_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a>                <span class="c1"># Check variance across dimensions</span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a>                <span class="n">dim_vars</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a>                <span class="n">active_dims</span> <span class="o">=</span> <span class="p">(</span><span class="n">dim_vars</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a>                <span class="n">total_dims</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node_type</span><span class="si">}</span><span class="s2"> - Active dims: </span><span class="si">{</span><span class="n">active_dims</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_dims</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a>                <span class="p">)</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a>                    <span class="sa">f</span><span class="s2">&quot;  Min/Max variance: </span><span class="si">{</span><span class="n">dim_vars</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">dim_vars</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a>                <span class="p">)</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a>                <span class="k">if</span> <span class="n">active_dims</span> <span class="o">&lt;</span> <span class="n">total_dims</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">:</span>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a>                        <span class="sa">f</span><span class="s2">&quot;WARNING: Very few active dimensions in </span><span class="si">{</span><span class="n">node_type</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a>                    <span class="p">)</span>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_debug_gradients</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Debug method to monitor gradients after backward pass.&quot;&quot;&quot;</span>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== GRADIENT DEBUG - Epoch </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="si">}</span><span class="s2">, Step </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">global_step</span><span class="si">}</span><span class="s2"> ===&quot;</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a>        <span class="p">)</span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a>        <span class="c1"># Check gradient norms after backward pass</span>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a>        <span class="n">encoder_grad_norm</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a>        <span class="n">decoder_grad_norm</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a>        <span class="n">aux_grad_norm</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a>        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a>            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">grad</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a>                <span class="n">grad_norm</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a>                <span class="k">if</span> <span class="s2">&quot;encoder&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a>                    <span class="n">encoder_grad_norm</span> <span class="o">+=</span> <span class="n">grad_norm</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a>                <span class="k">elif</span> <span class="s2">&quot;decoder&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a>                    <span class="n">decoder_grad_norm</span> <span class="o">+=</span> <span class="n">grad_norm</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a>                <span class="k">elif</span> <span class="s2">&quot;aux_params&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a>                    <span class="n">aux_grad_norm</span> <span class="o">+=</span> <span class="n">grad_norm</span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No gradient for: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a>        <span class="n">encoder_grad_norm</span> <span class="o">=</span> <span class="n">encoder_grad_norm</span><span class="o">**</span><span class="mf">0.5</span>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a>        <span class="n">decoder_grad_norm</span> <span class="o">=</span> <span class="n">decoder_grad_norm</span><span class="o">**</span><span class="mf">0.5</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a>        <span class="n">aux_grad_norm</span> <span class="o">=</span> <span class="n">aux_grad_norm</span><span class="o">**</span><span class="mf">0.5</span>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Encoder grad norm: </span><span class="si">{</span><span class="n">encoder_grad_norm</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Decoder grad norm: </span><span class="si">{</span><span class="n">decoder_grad_norm</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Aux params grad norm: </span><span class="si">{</span><span class="n">aux_grad_norm</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a>        <span class="c1"># Check gradient ratios</span>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a>        <span class="n">total_grad_norm</span> <span class="o">=</span> <span class="n">encoder_grad_norm</span> <span class="o">+</span> <span class="n">decoder_grad_norm</span> <span class="o">+</span> <span class="n">aux_grad_norm</span>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a>        <span class="k">if</span> <span class="n">total_grad_norm</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a>                <span class="sa">f</span><span class="s2">&quot;Encoder grad %: </span><span class="si">{</span><span class="mi">100</span><span class="o">*</span><span class="n">encoder_grad_norm</span><span class="o">/</span><span class="n">total_grad_norm</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a>            <span class="p">)</span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a>                <span class="sa">f</span><span class="s2">&quot;Decoder grad %: </span><span class="si">{</span><span class="mi">100</span><span class="o">*</span><span class="n">decoder_grad_norm</span><span class="o">/</span><span class="n">total_grad_norm</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a>            <span class="p">)</span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a>                <span class="sa">f</span><span class="s2">&quot;Aux params grad %: </span><span class="si">{</span><span class="mi">100</span><span class="o">*</span><span class="n">aux_grad_norm</span><span class="o">/</span><span class="n">total_grad_norm</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a>            <span class="p">)</span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a>            <span class="k">if</span> <span class="n">encoder_grad_norm</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">decoder_grad_norm</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a>                <span class="n">ratio</span> <span class="o">=</span> <span class="n">encoder_grad_norm</span> <span class="o">/</span> <span class="n">decoder_grad_norm</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Encoder/Decoder grad ratio: </span><span class="si">{</span><span class="n">ratio</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a>                <span class="k">if</span> <span class="n">ratio</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a>                        <span class="s2">&quot;WARNING: Encoder gradients much smaller than decoder&quot;</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a>                    <span class="p">)</span>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;WARNING: No gradients found!&quot;</span><span class="p">)</span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validation_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a>        <span class="c1"># batch = batch.to(self.device)</span>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a>        
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a>        <span class="n">mu_dict</span><span class="p">,</span> <span class="n">logstd_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a>        <span class="n">z_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reparametrize</span><span class="p">(</span><span class="n">mu_dict</span><span class="p">,</span> <span class="n">logstd_dict</span><span class="p">)</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a>        
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a>        <span class="n">bs_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_edges_in_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a>        <span class="c1"># ---- NLL ----</span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a>        <span class="n">batch_nll_loss</span><span class="p">,</span> <span class="n">weighted_nll_dict</span><span class="p">,</span> <span class="n">neg_edge_index_dict</span><span class="p">,</span> <span class="n">metric_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nll_loss</span><span class="p">(</span>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a>            <span class="n">batch</span><span class="p">,</span>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a>            <span class="n">z_dict</span><span class="p">,</span>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a>            <span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="p">,</span>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a>            <span class="n">batch</span><span class="o">.</span><span class="n">edge_attr_dict</span><span class="p">,</span>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a>            <span class="n">edgetype_loss_weight_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">edgetype_loss_weight_dict</span><span class="p">,</span>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a>            <span class="n">neg_sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_negative</span>
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a>        <span class="p">)</span>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;nll&quot;</span><span class="p">,</span> <span class="n">batch_nll_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">weighted_nll_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a>            <span class="k">for</span> <span class="n">edge_type</span><span class="p">,</span> <span class="n">nll_w</span> <span class="ow">in</span> <span class="n">weighted_nll_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a>                <span class="n">edge_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edge_type_key</span><span class="p">(</span><span class="n">edge_type</span><span class="p">)</span>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a>                <span class="n">edge_bs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span><span class="o">.</span><span class="n">edge_index</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;nll/</span><span class="si">{</span><span class="n">edge_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">nll_w</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">edge_bs</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a>        <span class="c1"># ---- KL ----</span>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a>        <span class="n">compute_kl_now</span><span class="p">,</span> <span class="n">kl_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_kl_now</span><span class="p">(</span><span class="n">return_weight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a>        <span class="n">batch_kl_div_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a>        <span class="k">if</span> <span class="n">compute_kl_now</span><span class="p">:</span>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a>            <span class="n">batch_kl_div_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kl_div_loss</span><span class="p">(</span>
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a>                <span class="n">batch</span><span class="p">,</span>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a>                <span class="n">mu_dict</span><span class="p">,</span>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos">1112</span></a>                <span class="n">logstd_dict</span><span class="p">,</span>
</span><span id="L-1113"><a href="#L-1113"><span class="linenos">1113</span></a>                <span class="n">batch</span><span class="o">.</span><span class="n">n_id_dict</span><span class="p">,</span>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos">1114</span></a>                <span class="n">node_weights_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node_weights_dict</span><span class="p">,</span>
</span><span id="L-1115"><a href="#L-1115"><span class="linenos">1115</span></a>            <span class="p">)</span>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos">1116</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;kl&quot;</span><span class="p">,</span> <span class="n">batch_kl_div_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos">1117</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;kl_weighted&quot;</span><span class="p">,</span> <span class="n">kl_weight</span> <span class="o">*</span> <span class="n">batch_kl_div_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1118"><a href="#L-1118"><span class="linenos">1118</span></a>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos">1119</span></a>        <span class="c1"># ---- Herit Loss ----</span>
</span><span id="L-1120"><a href="#L-1120"><span class="linenos">1120</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">herit_loss</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1121"><a href="#L-1121"><span class="linenos">1121</span></a>            <span class="k">if</span> <span class="s2">&quot;peak&quot;</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">node_types</span><span class="p">:</span>
</span><span id="L-1122"><a href="#L-1122"><span class="linenos">1122</span></a>                <span class="n">pid</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;peak&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">n_id</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="L-1123"><a href="#L-1123"><span class="linenos">1123</span></a>                <span class="n">herit_loss_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">herit_loss_lam</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">herit_loss</span><span class="p">(</span>
</span><span id="L-1124"><a href="#L-1124"><span class="linenos">1124</span></a>                    <span class="n">mu_dict</span><span class="p">[</span><span class="s2">&quot;peak&quot;</span><span class="p">],</span>
</span><span id="L-1125"><a href="#L-1125"><span class="linenos">1125</span></a>                    <span class="n">pid</span><span class="p">,</span>
</span><span id="L-1126"><a href="#L-1126"><span class="linenos">1126</span></a>                <span class="p">)</span>
</span><span id="L-1127"><a href="#L-1127"><span class="linenos">1127</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1128"><a href="#L-1128"><span class="linenos">1128</span></a>                <span class="n">herit_loss_value</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1129"><a href="#L-1129"><span class="linenos">1129</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;herit_loss&quot;</span><span class="p">,</span> <span class="n">herit_loss_value</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos">1130</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos">1131</span></a>            <span class="n">herit_loss_value</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1132"><a href="#L-1132"><span class="linenos">1132</span></a>        
</span><span id="L-1133"><a href="#L-1133"><span class="linenos">1133</span></a>        <span class="c1"># ---- Gene Alignment ----</span>
</span><span id="L-1134"><a href="#L-1134"><span class="linenos">1134</span></a>        <span class="n">compute_gene_align_now</span><span class="p">,</span> <span class="n">gene_align_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_gene_align_now</span><span class="p">(</span><span class="n">return_weight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1135"><a href="#L-1135"><span class="linenos">1135</span></a>
</span><span id="L-1136"><a href="#L-1136"><span class="linenos">1136</span></a>        <span class="n">gene_align_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos">1137</span></a>        <span class="k">if</span> <span class="n">compute_gene_align_now</span><span class="p">:</span>
</span><span id="L-1138"><a href="#L-1138"><span class="linenos">1138</span></a>            <span class="n">gene_align_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gene_alignment_loss</span><span class="p">()</span>
</span><span id="L-1139"><a href="#L-1139"><span class="linenos">1139</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;gene_align&quot;</span><span class="p">,</span> <span class="n">gene_align_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos">1140</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;gene_align_weighted&quot;</span><span class="p">,</span> <span class="n">gene_align_weight</span> <span class="o">*</span> <span class="n">gene_align_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos">1141</span></a>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos">1142</span></a>        <span class="c1"># ---- OT loss ----</span>
</span><span id="L-1143"><a href="#L-1143"><span class="linenos">1143</span></a>        <span class="n">compute_ot_cs_now</span><span class="p">,</span> <span class="n">ot_cs_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_ot_cs_now</span><span class="p">(</span><span class="n">return_weight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos">1144</span></a>
</span><span id="L-1145"><a href="#L-1145"><span class="linenos">1145</span></a>        <span class="n">ot_cs_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos">1146</span></a>        <span class="k">if</span> <span class="n">compute_ot_cs_now</span><span class="p">:</span>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos">1147</span></a>            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-1148"><a href="#L-1148"><span class="linenos">1148</span></a>            <span class="n">ot_cs_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_alignment_loss</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;cs&quot;</span><span class="p">)</span>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos">1149</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;ot_cs_loss&quot;</span><span class="p">,</span> <span class="n">ot_cs_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos">1150</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;ot_cs_weighted&quot;</span><span class="p">,</span> <span class="n">ot_cs_weight</span> <span class="o">*</span> <span class="n">ot_cs_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1151"><a href="#L-1151"><span class="linenos">1151</span></a>        
</span><span id="L-1152"><a href="#L-1152"><span class="linenos">1152</span></a>        <span class="n">compute_ot_cb_now</span><span class="p">,</span> <span class="n">ot_cb_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_ot_cb_now</span><span class="p">(</span><span class="n">return_weight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1153"><a href="#L-1153"><span class="linenos">1153</span></a>        <span class="n">ot_cb_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="L-1154"><a href="#L-1154"><span class="linenos">1154</span></a>        <span class="k">if</span> <span class="n">compute_ot_cb_now</span><span class="p">:</span>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos">1155</span></a>            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-1156"><a href="#L-1156"><span class="linenos">1156</span></a>            <span class="n">ot_cb_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_alignment_loss</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;cb&quot;</span><span class="p">)</span>
</span><span id="L-1157"><a href="#L-1157"><span class="linenos">1157</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;ot_cb_loss&quot;</span><span class="p">,</span> <span class="n">ot_cb_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1158"><a href="#L-1158"><span class="linenos">1158</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;ot_cb_weighted&quot;</span><span class="p">,</span> <span class="n">ot_cb_weight</span> <span class="o">*</span> <span class="n">ot_cb_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1159"><a href="#L-1159"><span class="linenos">1159</span></a>
</span><span id="L-1160"><a href="#L-1160"><span class="linenos">1160</span></a>        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1161"><a href="#L-1161"><span class="linenos">1161</span></a>            <span class="n">batch_nll_loss</span> <span class="o">+</span> 
</span><span id="L-1162"><a href="#L-1162"><span class="linenos">1162</span></a>            <span class="n">kl_weight</span> <span class="o">*</span> <span class="n">batch_kl_div_loss</span> <span class="o">+</span> 
</span><span id="L-1163"><a href="#L-1163"><span class="linenos">1163</span></a>            <span class="n">herit_loss_value</span>
</span><span id="L-1164"><a href="#L-1164"><span class="linenos">1164</span></a>            <span class="o">+</span> <span class="n">gene_align_weight</span> <span class="o">*</span> <span class="n">gene_align_loss</span>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos">1165</span></a>            <span class="o">+</span> <span class="n">ot_cs_weight</span> <span class="o">*</span> <span class="n">ot_cs_loss</span>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos">1166</span></a>            <span class="o">+</span> <span class="n">ot_cb_weight</span> <span class="o">*</span> <span class="n">ot_cb_loss</span>
</span><span id="L-1167"><a href="#L-1167"><span class="linenos">1167</span></a>        <span class="p">)</span>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos">1168</span></a>
</span><span id="L-1169"><a href="#L-1169"><span class="linenos">1169</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;loss&quot;</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1170"><a href="#L-1170"><span class="linenos">1170</span></a>
</span><span id="L-1171"><a href="#L-1171"><span class="linenos">1171</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">validation_step_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos">1172</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">local_step_val</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-1173"><a href="#L-1173"><span class="linenos">1173</span></a>
</span><span id="L-1174"><a href="#L-1174"><span class="linenos">1174</span></a>        <span class="k">return</span> <span class="n">loss</span>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos">1175</span></a>
</span><span id="L-1176"><a href="#L-1176"><span class="linenos">1176</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">mean_cell_neighbor_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
</span><span id="L-1177"><a href="#L-1177"><span class="linenos">1177</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1178"><a href="#L-1178"><span class="linenos">1178</span></a><span class="sd">        Calculates the mean distance between each cell node and its k nearest neighbors.</span>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos">1179</span></a><span class="sd">        Returns a tensor of mean distances for each cell.</span>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos">1180</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1181"><a href="#L-1181"><span class="linenos">1181</span></a>        <span class="n">cell_mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">__mu_dict__</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>  <span class="c1"># (num_cells, latent_dim)</span>
</span><span id="L-1182"><a href="#L-1182"><span class="linenos">1182</span></a>        <span class="c1"># Compute pairwise Euclidean distances</span>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos">1183</span></a>        <span class="n">dist_matrix</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cdist</span><span class="p">(</span><span class="n">cell_mu</span><span class="p">,</span> <span class="n">cell_mu</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># (num_cells, num_cells)</span>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos">1184</span></a>        <span class="c1"># Exclude self-distance by setting diagonal to infinity</span>
</span><span id="L-1185"><a href="#L-1185"><span class="linenos">1185</span></a>        <span class="n">dist_matrix</span><span class="o">.</span><span class="n">fill_diagonal_</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">))</span>
</span><span id="L-1186"><a href="#L-1186"><span class="linenos">1186</span></a>        <span class="c1"># Find k nearest neighbors for each cell</span>
</span><span id="L-1187"><a href="#L-1187"><span class="linenos">1187</span></a>        <span class="n">knn_distances</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">dist_matrix</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">largest</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1188"><a href="#L-1188"><span class="linenos">1188</span></a>        <span class="c1"># Mean distance to k nearest neighbors for each cell</span>
</span><span id="L-1189"><a href="#L-1189"><span class="linenos">1189</span></a>        <span class="n">mean_distances</span> <span class="o">=</span> <span class="n">knn_distances</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1190"><a href="#L-1190"><span class="linenos">1190</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">mean_distances</span> <span class="o">/</span> <span class="n">mean_distances</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="L-1191"><a href="#L-1191"><span class="linenos">1191</span></a>        <span class="k">return</span> <span class="n">weights</span>  <span class="c1"># shape: (num_cells,)</span>
</span><span id="L-1192"><a href="#L-1192"><span class="linenos">1192</span></a>    
</span><span id="L-1193"><a href="#L-1193"><span class="linenos">1193</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_kl_now</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">return_weight</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-1194"><a href="#L-1194"><span class="linenos">1194</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Decide whether to compute KL loss for this training/validation step.&quot;&quot;&quot;</span>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos">1195</span></a>        <span class="n">kl_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kl_lambda</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_linear_warmup_scale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kl_n_no</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kl_n_warmup</span><span class="p">)</span>
</span><span id="L-1196"><a href="#L-1196"><span class="linenos">1196</span></a>        <span class="n">compute_kl_now</span> <span class="o">=</span> <span class="n">kl_weight</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="L-1197"><a href="#L-1197"><span class="linenos">1197</span></a>        <span class="k">if</span> <span class="n">return_weight</span><span class="p">:</span>
</span><span id="L-1198"><a href="#L-1198"><span class="linenos">1198</span></a>            <span class="k">return</span> <span class="n">compute_kl_now</span><span class="p">,</span> <span class="n">kl_weight</span>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos">1199</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1200"><a href="#L-1200"><span class="linenos">1200</span></a>            <span class="k">return</span> <span class="n">compute_kl_now</span>
</span><span id="L-1201"><a href="#L-1201"><span class="linenos">1201</span></a>    
</span><span id="L-1202"><a href="#L-1202"><span class="linenos">1202</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_gene_align_now</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">return_weight</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-1203"><a href="#L-1203"><span class="linenos">1203</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Decide whether to compute gene alignment loss for this training/validation step.&quot;&quot;&quot;</span>
</span><span id="L-1204"><a href="#L-1204"><span class="linenos">1204</span></a>        <span class="n">gene_align_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gene_align_lambda</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_linear_warmup_scale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_align_n_no</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gene_align_n_warmup</span><span class="p">)</span>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos">1205</span></a>        <span class="n">compute_gene_align_now</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1206"><a href="#L-1206"><span class="linenos">1206</span></a>        <span class="k">if</span> <span class="n">gene_align_weight</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_gene_pairs&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gene_pairs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos">1207</span></a>            <span class="n">compute_gene_align_now</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-1208"><a href="#L-1208"><span class="linenos">1208</span></a>        <span class="k">if</span> <span class="n">return_weight</span><span class="p">:</span>
</span><span id="L-1209"><a href="#L-1209"><span class="linenos">1209</span></a>            <span class="k">return</span> <span class="n">compute_gene_align_now</span><span class="p">,</span> <span class="n">gene_align_weight</span>
</span><span id="L-1210"><a href="#L-1210"><span class="linenos">1210</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos">1211</span></a>            <span class="k">return</span> <span class="n">compute_gene_align_now</span>
</span><span id="L-1212"><a href="#L-1212"><span class="linenos">1212</span></a>
</span><span id="L-1213"><a href="#L-1213"><span class="linenos">1213</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_ot_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1214"><a href="#L-1214"><span class="linenos">1214</span></a>        <span class="n">need_plan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_plan_every_n_epochs</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="L-1215"><a href="#L-1215"><span class="linenos">1215</span></a>        <span class="n">ot_cs_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_cs_lambda</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_linear_warmup_scale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ot_cs_n_no</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_cs_n_warmup</span><span class="p">)</span>
</span><span id="L-1216"><a href="#L-1216"><span class="linenos">1216</span></a>        <span class="n">ot_cb_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_cb_lambda</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_linear_warmup_scale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ot_cb_n_no</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_cb_n_warmup</span><span class="p">)</span>
</span><span id="L-1217"><a href="#L-1217"><span class="linenos">1217</span></a>
</span><span id="L-1218"><a href="#L-1218"><span class="linenos">1218</span></a>        <span class="k">if</span> <span class="n">ot_cs_weight</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">need_plan</span><span class="p">:</span>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos">1219</span></a>            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-1220"><a href="#L-1220"><span class="linenos">1220</span></a>            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="L-1221"><a href="#L-1221"><span class="linenos">1221</span></a>                <span class="n">cell_mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">__mu_dict__</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos">1222</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_ot_cs_states</span> <span class="o">=</span> <span class="n">compute_multi_sample_ot_states</span><span class="p">(</span>
</span><span id="L-1223"><a href="#L-1223"><span class="linenos">1223</span></a>                    <span class="n">cell_mu</span><span class="o">=</span><span class="n">cell_mu</span><span class="p">,</span>
</span><span id="L-1224"><a href="#L-1224"><span class="linenos">1224</span></a>                    <span class="n">groups</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ot_cs_groups</span><span class="p">,</span>
</span><span id="L-1225"><a href="#L-1225"><span class="linenos">1225</span></a>                    <span class="n">pairs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ot_cs_pairs</span><span class="p">,</span>
</span><span id="L-1226"><a href="#L-1226"><span class="linenos">1226</span></a>                    <span class="n">subset_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ot_cs_k</span><span class="p">,</span>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos">1227</span></a>                    <span class="n">eps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ot_eps</span><span class="p">,</span>
</span><span id="L-1228"><a href="#L-1228"><span class="linenos">1228</span></a>                    <span class="n">n_iters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ot_iter</span><span class="p">,</span>
</span><span id="L-1229"><a href="#L-1229"><span class="linenos">1229</span></a>                <span class="p">)</span>
</span><span id="L-1230"><a href="#L-1230"><span class="linenos">1230</span></a>            <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos">1231</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;time:ot_cs_plan&quot;</span><span class="p">,</span> <span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos">1232</span></a>        
</span><span id="L-1233"><a href="#L-1233"><span class="linenos">1233</span></a>        <span class="k">if</span> <span class="n">ot_cb_weight</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">need_plan</span><span class="p">:</span>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos">1234</span></a>            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-1235"><a href="#L-1235"><span class="linenos">1235</span></a>            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos">1236</span></a>                <span class="n">cell_mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">__mu_dict__</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</span><span id="L-1237"><a href="#L-1237"><span class="linenos">1237</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_ot_cb_states</span> <span class="o">=</span> <span class="n">compute_multi_batch_ot_states</span><span class="p">(</span>
</span><span id="L-1238"><a href="#L-1238"><span class="linenos">1238</span></a>                    <span class="n">cell_mu</span><span class="o">=</span><span class="n">cell_mu</span><span class="p">,</span>
</span><span id="L-1239"><a href="#L-1239"><span class="linenos">1239</span></a>                    <span class="n">groups_sb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ot_cb_groups</span><span class="p">,</span>
</span><span id="L-1240"><a href="#L-1240"><span class="linenos">1240</span></a>                    <span class="n">pairs_sb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ot_cb_pairs</span><span class="p">,</span>
</span><span id="L-1241"><a href="#L-1241"><span class="linenos">1241</span></a>                    <span class="n">subset_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ot_cb_k</span><span class="p">,</span>
</span><span id="L-1242"><a href="#L-1242"><span class="linenos">1242</span></a>                    <span class="n">eps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ot_eps</span><span class="p">,</span>
</span><span id="L-1243"><a href="#L-1243"><span class="linenos">1243</span></a>                    <span class="n">n_iters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ot_iter</span><span class="p">,</span>
</span><span id="L-1244"><a href="#L-1244"><span class="linenos">1244</span></a>                <span class="p">)</span>
</span><span id="L-1245"><a href="#L-1245"><span class="linenos">1245</span></a>            <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-1246"><a href="#L-1246"><span class="linenos">1246</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;time:ot_cb_plan&quot;</span><span class="p">,</span> <span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1247"><a href="#L-1247"><span class="linenos">1247</span></a>
</span><span id="L-1248"><a href="#L-1248"><span class="linenos">1248</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_ot_cs_now</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">return_weight</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-1249"><a href="#L-1249"><span class="linenos">1249</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Decide whether to compute cross-sample OT loss for this training/validation step.&quot;&quot;&quot;</span>
</span><span id="L-1250"><a href="#L-1250"><span class="linenos">1250</span></a>        <span class="n">ot_cs_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_cs_lambda</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_linear_warmup_scale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ot_cs_n_no</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_cs_n_warmup</span><span class="p">)</span>
</span><span id="L-1251"><a href="#L-1251"><span class="linenos">1251</span></a>        <span class="n">compute_ot_cs_now</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1252"><a href="#L-1252"><span class="linenos">1252</span></a>        <span class="k">if</span> <span class="n">ot_cs_weight</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_ot_cs_states&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ot_cs_states</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ot_cs_states</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1253"><a href="#L-1253"><span class="linenos">1253</span></a>            <span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_step</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_step_val</span>
</span><span id="L-1254"><a href="#L-1254"><span class="linenos">1254</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_loss_every_n_steps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1255"><a href="#L-1255"><span class="linenos">1255</span></a>                <span class="n">compute_ot_cs_now</span> <span class="o">=</span> <span class="p">(</span><span class="n">step</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_loss_every_n_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-1256"><a href="#L-1256"><span class="linenos">1256</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1257"><a href="#L-1257"><span class="linenos">1257</span></a>                <span class="c1"># default: once per epoch (first batch)</span>
</span><span id="L-1258"><a href="#L-1258"><span class="linenos">1258</span></a>                <span class="n">compute_ot_cs_now</span> <span class="o">=</span> <span class="p">(</span><span class="n">step</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-1259"><a href="#L-1259"><span class="linenos">1259</span></a>        <span class="k">if</span> <span class="n">return_weight</span><span class="p">:</span>
</span><span id="L-1260"><a href="#L-1260"><span class="linenos">1260</span></a>            <span class="k">return</span> <span class="n">compute_ot_cs_now</span><span class="p">,</span> <span class="n">ot_cs_weight</span>
</span><span id="L-1261"><a href="#L-1261"><span class="linenos">1261</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1262"><a href="#L-1262"><span class="linenos">1262</span></a>            <span class="k">return</span> <span class="n">compute_ot_cs_now</span>
</span><span id="L-1263"><a href="#L-1263"><span class="linenos">1263</span></a>    
</span><span id="L-1264"><a href="#L-1264"><span class="linenos">1264</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_ot_cb_now</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">return_weight</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-1265"><a href="#L-1265"><span class="linenos">1265</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Decide whether to compute cross-batch OT loss for this training/validation step.&quot;&quot;&quot;</span>
</span><span id="L-1266"><a href="#L-1266"><span class="linenos">1266</span></a>        <span class="n">ot_cb_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_cb_lambda</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_linear_warmup_scale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ot_cb_n_no</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_cb_n_warmup</span><span class="p">)</span>
</span><span id="L-1267"><a href="#L-1267"><span class="linenos">1267</span></a>        <span class="n">compute_ot_cb_now</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1268"><a href="#L-1268"><span class="linenos">1268</span></a>        <span class="k">if</span> <span class="n">ot_cb_weight</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_ot_cb_states&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ot_cb_states</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ot_cb_states</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1269"><a href="#L-1269"><span class="linenos">1269</span></a>            <span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_step</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_step_val</span>
</span><span id="L-1270"><a href="#L-1270"><span class="linenos">1270</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_loss_every_n_steps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1271"><a href="#L-1271"><span class="linenos">1271</span></a>                <span class="n">compute_ot_cb_now</span> <span class="o">=</span> <span class="p">(</span><span class="n">step</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_loss_every_n_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-1272"><a href="#L-1272"><span class="linenos">1272</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1273"><a href="#L-1273"><span class="linenos">1273</span></a>                <span class="c1"># default: once per epoch (first batch)</span>
</span><span id="L-1274"><a href="#L-1274"><span class="linenos">1274</span></a>                <span class="n">compute_ot_cb_now</span> <span class="o">=</span> <span class="p">(</span><span class="n">step</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-1275"><a href="#L-1275"><span class="linenos">1275</span></a>        <span class="k">if</span> <span class="n">return_weight</span><span class="p">:</span>
</span><span id="L-1276"><a href="#L-1276"><span class="linenos">1276</span></a>            <span class="k">return</span> <span class="n">compute_ot_cb_now</span><span class="p">,</span> <span class="n">ot_cb_weight</span>
</span><span id="L-1277"><a href="#L-1277"><span class="linenos">1277</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1278"><a href="#L-1278"><span class="linenos">1278</span></a>            <span class="k">return</span> <span class="n">compute_ot_cb_now</span>
</span><span id="L-1279"><a href="#L-1279"><span class="linenos">1279</span></a>
</span><span id="L-1280"><a href="#L-1280"><span class="linenos">1280</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_epoch_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1281"><a href="#L-1281"><span class="linenos">1281</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">validation_step_outputs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1282"><a href="#L-1282"><span class="linenos">1282</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">is_last_batch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1283"><a href="#L-1283"><span class="linenos">1283</span></a>            <span class="n">hsic_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span><span class="o">.</span><span class="n">custom_train</span><span class="p">(</span>
</span><span id="L-1284"><a href="#L-1284"><span class="linenos">1284</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">__mu_dict__</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">],</span> <span class="n">optimizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hsic_optimizer</span>
</span><span id="L-1285"><a href="#L-1285"><span class="linenos">1285</span></a>            <span class="p">)</span>
</span><span id="L-1286"><a href="#L-1286"><span class="linenos">1286</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;hsic_loss&quot;</span><span class="p">,</span> <span class="n">hsic_loss</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1287"><a href="#L-1287"><span class="linenos">1287</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1288"><a href="#L-1288"><span class="linenos">1288</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;hsic_lr&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic_optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;lr&quot;</span><span class="p">],</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1289"><a href="#L-1289"><span class="linenos">1289</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reweight_rarecell</span><span class="p">:</span>
</span><span id="L-1290"><a href="#L-1290"><span class="linenos">1290</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cell_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean_cell_neighbor_distance</span><span class="p">(</span>
</span><span id="L-1291"><a href="#L-1291"><span class="linenos">1291</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">reweight_rarecell_neighbors</span>
</span><span id="L-1292"><a href="#L-1292"><span class="linenos">1292</span></a>            <span class="p">)</span>
</span><span id="L-1293"><a href="#L-1293"><span class="linenos">1293</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">local_step</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1294"><a href="#L-1294"><span class="linenos">1294</span></a>        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-1295"><a href="#L-1295"><span class="linenos">1295</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_ot_plan</span><span class="p">()</span>
</span><span id="L-1296"><a href="#L-1296"><span class="linenos">1296</span></a>        <span class="c1"># self._log_perf(&quot;ot_plan&quot;, time.time() - t0, on_step=False)</span>
</span><span id="L-1297"><a href="#L-1297"><span class="linenos">1297</span></a>
</span><span id="L-1298"><a href="#L-1298"><span class="linenos">1298</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_batch_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
</span><span id="L-1299"><a href="#L-1299"><span class="linenos">1299</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">):</span>
</span><span id="L-1300"><a href="#L-1300"><span class="linenos">1300</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;data_loading_time&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
</span><span id="L-1301"><a href="#L-1301"><span class="linenos">1301</span></a>
</span><span id="L-1302"><a href="#L-1302"><span class="linenos">1302</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_batch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
</span><span id="L-1303"><a href="#L-1303"><span class="linenos">1303</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-1304"><a href="#L-1304"><span class="linenos">1304</span></a>
</span><span id="L-1305"><a href="#L-1305"><span class="linenos">1305</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_validation_epoch_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1306"><a href="#L-1306"><span class="linenos">1306</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">local_step_val</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1307"><a href="#L-1307"><span class="linenos">1307</span></a>    
</span><span id="L-1308"><a href="#L-1308"><span class="linenos">1308</span></a>    <span class="c1"># def on_validation_epoch_end(self):</span>
</span><span id="L-1309"><a href="#L-1309"><span class="linenos">1309</span></a>    <span class="c1">#     # record distance for each gene pair</span>
</span><span id="L-1310"><a href="#L-1310"><span class="linenos">1310</span></a>    <span class="c1">#     pairs = self._gene_pairs if hasattr(self, &quot;_gene_pairs&quot;) else None</span>
</span><span id="L-1311"><a href="#L-1311"><span class="linenos">1311</span></a>    <span class="c1">#     if pairs is not None and hasattr(pairs, &quot;idx0&quot;) and pairs.idx0 is not None:</span>
</span><span id="L-1312"><a href="#L-1312"><span class="linenos">1312</span></a>    <span class="c1">#         gene_mu = self.encoder.__mu_dict__[&quot;gene&quot;]</span>
</span><span id="L-1313"><a href="#L-1313"><span class="linenos">1313</span></a>    <span class="c1">#         gene_id = self.data[&quot;gene&quot;].gene_id[pairs.idx0]</span>
</span><span id="L-1314"><a href="#L-1314"><span class="linenos">1314</span></a>    <span class="c1">#         dist = (gene_mu[pairs.idx0] - gene_mu[pairs.idx1]).pow(2).sum(dim=-1).sqrt()</span>
</span><span id="L-1315"><a href="#L-1315"><span class="linenos">1315</span></a>
</span><span id="L-1316"><a href="#L-1316"><span class="linenos">1316</span></a>    <span class="c1">#         gene_id = gene_id.detach().cpu().numpy()</span>
</span><span id="L-1317"><a href="#L-1317"><span class="linenos">1317</span></a>    <span class="c1">#         dist = dist.detach().cpu().numpy()</span>
</span><span id="L-1318"><a href="#L-1318"><span class="linenos">1318</span></a>
</span><span id="L-1319"><a href="#L-1319"><span class="linenos">1319</span></a>    <span class="c1">#         col = f&quot;dist_{self.current_epoch}&quot;</span>
</span><span id="L-1320"><a href="#L-1320"><span class="linenos">1320</span></a>    <span class="c1">#         if not hasattr(self, &quot;_gene_align_dist_cols&quot;):</span>
</span><span id="L-1321"><a href="#L-1321"><span class="linenos">1321</span></a>    <span class="c1">#             self._gene_align_dist_cols = {}</span>
</span><span id="L-1322"><a href="#L-1322"><span class="linenos">1322</span></a>            
</span><span id="L-1323"><a href="#L-1323"><span class="linenos">1323</span></a>    <span class="c1">#         self._gene_align_dist_cols[col] = pd.Series(dist, index=gene_id, name=col)</span>
</span><span id="L-1324"><a href="#L-1324"><span class="linenos">1324</span></a>
</span><span id="L-1325"><a href="#L-1325"><span class="linenos">1325</span></a>    <span class="c1"># def on_fit_end(self):</span>
</span><span id="L-1326"><a href="#L-1326"><span class="linenos">1326</span></a>    <span class="c1">#     if not hasattr(self, &quot;_gene_align_dist_cols&quot;):</span>
</span><span id="L-1327"><a href="#L-1327"><span class="linenos">1327</span></a>    <span class="c1">#         return</span>
</span><span id="L-1328"><a href="#L-1328"><span class="linenos">1328</span></a>    <span class="c1">#     df = pd.concat(self._gene_align_dist_cols.values(), axis=1)</span>
</span><span id="L-1329"><a href="#L-1329"><span class="linenos">1329</span></a>
</span><span id="L-1330"><a href="#L-1330"><span class="linenos">1330</span></a>    <span class="c1">#     log_dir = None</span>
</span><span id="L-1331"><a href="#L-1331"><span class="linenos">1331</span></a>    <span class="c1">#     if self.trainer is not None:</span>
</span><span id="L-1332"><a href="#L-1332"><span class="linenos">1332</span></a>    <span class="c1">#         log_dir = getattr(self.trainer, &quot;log_dir&quot;, None)</span>
</span><span id="L-1333"><a href="#L-1333"><span class="linenos">1333</span></a>    <span class="c1">#     if log_dir is None and getattr(self, &quot;logger&quot;, None) is not None:</span>
</span><span id="L-1334"><a href="#L-1334"><span class="linenos">1334</span></a>    <span class="c1">#         log_dir = getattr(self.logger, &quot;log_dir&quot;, None)</span>
</span><span id="L-1335"><a href="#L-1335"><span class="linenos">1335</span></a>    <span class="c1">#     if log_dir is None:</span>
</span><span id="L-1336"><a href="#L-1336"><span class="linenos">1336</span></a>    <span class="c1">#         log_dir = &quot;.&quot;</span>
</span><span id="L-1337"><a href="#L-1337"><span class="linenos">1337</span></a>        
</span><span id="L-1338"><a href="#L-1338"><span class="linenos">1338</span></a>    <span class="c1">#     os.makedirs(log_dir, exist_ok=True)</span>
</span><span id="L-1339"><a href="#L-1339"><span class="linenos">1339</span></a>    <span class="c1">#     timestamp = datetime.now().strftime(&quot;%Y%m%d_%H%M%S&quot;)</span>
</span><span id="L-1340"><a href="#L-1340"><span class="linenos">1340</span></a>    <span class="c1">#     filename = os.path.join(log_dir, f&quot;gene_align_dist_df_{timestamp}.csv&quot;)</span>
</span><span id="L-1341"><a href="#L-1341"><span class="linenos">1341</span></a>    <span class="c1">#     df.to_csv(filename)</span>
</span><span id="L-1342"><a href="#L-1342"><span class="linenos">1342</span></a>    <span class="c1">#     self.logger2.info(f&quot;Gene alignment distance dataframe saved to {filename}&quot;)</span>
</span><span id="L-1343"><a href="#L-1343"><span class="linenos">1343</span></a>
</span><span id="L-1344"><a href="#L-1344"><span class="linenos">1344</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">configure_optimizers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1345"><a href="#L-1345"><span class="linenos">1345</span></a>        <span class="c1"># Different learning rates for encoder vs aux_params</span>
</span><span id="L-1346"><a href="#L-1346"><span class="linenos">1346</span></a>        <span class="n">all_params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
</span><span id="L-1347"><a href="#L-1347"><span class="linenos">1347</span></a>        <span class="n">encoder_params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
</span><span id="L-1348"><a href="#L-1348"><span class="linenos">1348</span></a>        <span class="n">aux_params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aux_params</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
</span><span id="L-1349"><a href="#L-1349"><span class="linenos">1349</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">encoder_params</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">aux_params</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_params</span><span class="p">),</span> <span class="s2">&quot;Parameters other than encoder and aux_params exist in the model&quot;</span> <span class="c1"># sanity check</span>
</span><span id="L-1350"><a href="#L-1350"><span class="linenos">1350</span></a>
</span><span id="L-1351"><a href="#L-1351"><span class="linenos">1351</span></a>        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span>
</span><span id="L-1352"><a href="#L-1352"><span class="linenos">1352</span></a>            <span class="c1"># currently there are only encoder and aux parameters, no decoder parameters</span>
</span><span id="L-1353"><a href="#L-1353"><span class="linenos">1353</span></a>            <span class="p">[</span>
</span><span id="L-1354"><a href="#L-1354"><span class="linenos">1354</span></a>                <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">encoder_params</span><span class="p">,</span> <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">},</span>
</span><span id="L-1355"><a href="#L-1355"><span class="linenos">1355</span></a>                <span class="p">{</span>
</span><span id="L-1356"><a href="#L-1356"><span class="linenos">1356</span></a>                    <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">aux_params</span><span class="p">,</span>
</span><span id="L-1357"><a href="#L-1357"><span class="linenos">1357</span></a>                    <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">,</span>
</span><span id="L-1358"><a href="#L-1358"><span class="linenos">1358</span></a>                <span class="p">},</span>  <span class="c1"># 10x smaller LR for aux params</span>
</span><span id="L-1359"><a href="#L-1359"><span class="linenos">1359</span></a>            <span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_aux</span> <span class="k">else</span>
</span><span id="L-1360"><a href="#L-1360"><span class="linenos">1360</span></a>            <span class="p">[{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">encoder_params</span><span class="p">,</span> <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">}]</span>
</span><span id="L-1361"><a href="#L-1361"><span class="linenos">1361</span></a>        <span class="p">)</span>
</span><span id="L-1362"><a href="#L-1362"><span class="linenos">1362</span></a>
</span><span id="L-1363"><a href="#L-1363"><span class="linenos">1363</span></a>        <span class="n">scheduler</span> <span class="o">=</span> <span class="n">ReduceLROnPlateau</span><span class="p">(</span>
</span><span id="L-1364"><a href="#L-1364"><span class="linenos">1364</span></a>            <span class="n">optimizer</span><span class="p">,</span>
</span><span id="L-1365"><a href="#L-1365"><span class="linenos">1365</span></a>            <span class="n">patience</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
</span><span id="L-1366"><a href="#L-1366"><span class="linenos">1366</span></a>        <span class="p">)</span>
</span><span id="L-1367"><a href="#L-1367"><span class="linenos">1367</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">optimizer</span><span class="p">],</span> <span class="p">[</span>
</span><span id="L-1368"><a href="#L-1368"><span class="linenos">1368</span></a>            <span class="p">{</span>
</span><span id="L-1369"><a href="#L-1369"><span class="linenos">1369</span></a>                <span class="s2">&quot;scheduler&quot;</span><span class="p">:</span> <span class="n">scheduler</span><span class="p">,</span>
</span><span id="L-1370"><a href="#L-1370"><span class="linenos">1370</span></a>                <span class="s2">&quot;interval&quot;</span><span class="p">:</span> <span class="s2">&quot;epoch&quot;</span><span class="p">,</span>
</span><span id="L-1371"><a href="#L-1371"><span class="linenos">1371</span></a>                <span class="s2">&quot;frequency&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-1372"><a href="#L-1372"><span class="linenos">1372</span></a>                <span class="s2">&quot;monitor&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor_key</span><span class="p">,</span>
</span><span id="L-1373"><a href="#L-1373"><span class="linenos">1373</span></a>                <span class="s2">&quot;strict&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-1374"><a href="#L-1374"><span class="linenos">1374</span></a>            <span class="p">}</span>
</span><span id="L-1375"><a href="#L-1375"><span class="linenos">1375</span></a>        <span class="p">]</span>
</span><span id="L-1376"><a href="#L-1376"><span class="linenos">1376</span></a>
</span><span id="L-1377"><a href="#L-1377"><span class="linenos">1377</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">lr_scheduler_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">,</span> <span class="n">metric</span><span class="p">):</span>
</span><span id="L-1378"><a href="#L-1378"><span class="linenos">1378</span></a>        <span class="k">if</span> <span class="n">metric</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1379"><a href="#L-1379"><span class="linenos">1379</span></a>            <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="L-1380"><a href="#L-1380"><span class="linenos">1380</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1381"><a href="#L-1381"><span class="linenos">1381</span></a>            <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
</span><span id="L-1382"><a href="#L-1382"><span class="linenos">1382</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1383"><a href="#L-1383"><span class="linenos">1383</span></a>            <span class="n">update_lr</span><span class="p">(</span>
</span><span id="L-1384"><a href="#L-1384"><span class="linenos">1384</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">hsic_optimizer</span><span class="p">,</span>
</span><span id="L-1385"><a href="#L-1385"><span class="linenos">1385</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span><span class="o">.</span><span class="n">lam</span>
</span><span id="L-1386"><a href="#L-1386"><span class="linenos">1386</span></a>                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">lr_scheduler_configs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span>
</span><span id="L-1387"><a href="#L-1387"><span class="linenos">1387</span></a>                    <span class="mi">0</span>
</span><span id="L-1388"><a href="#L-1388"><span class="linenos">1388</span></a>                <span class="p">][</span><span class="s2">&quot;lr&quot;</span><span class="p">],</span>
</span><span id="L-1389"><a href="#L-1389"><span class="linenos">1389</span></a>            <span class="p">)</span>
</span><span id="L-1390"><a href="#L-1390"><span class="linenos">1390</span></a>    
</span><span id="L-1391"><a href="#L-1391"><span class="linenos">1391</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_linear_warmup_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_no</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n_warmup</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-1392"><a href="#L-1392"><span class="linenos">1392</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span> <span class="o">&lt;</span> <span class="n">n_no</span><span class="p">:</span>
</span><span id="L-1393"><a href="#L-1393"><span class="linenos">1393</span></a>            <span class="k">return</span> <span class="mf">0.0</span>
</span><span id="L-1394"><a href="#L-1394"><span class="linenos">1394</span></a>        <span class="k">if</span> <span class="n">n_warmup</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1395"><a href="#L-1395"><span class="linenos">1395</span></a>            <span class="k">return</span> <span class="mf">1.0</span>
</span><span id="L-1396"><a href="#L-1396"><span class="linenos">1396</span></a>        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">n_no</span><span class="p">,</span> <span class="n">n_warmup</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_warmup</span><span class="p">)</span>
</span><span id="L-1397"><a href="#L-1397"><span class="linenos">1397</span></a>
</span><span id="L-1398"><a href="#L-1398"><span class="linenos">1398</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_save_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checkpoint</span><span class="p">):</span>
</span><span id="L-1399"><a href="#L-1399"><span class="linenos">1399</span></a>        <span class="c1"># Remove the argument from the checkpoint before it is saved</span>
</span><span id="L-1400"><a href="#L-1400"><span class="linenos">1400</span></a>        <span class="n">checkpoint</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;train_data_dict&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span></pre></div>


            </section>
                <section id="AuxParams">
                            <input id="AuxParams-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">AuxParams</span><wbr>(<span class="base">torch.nn.modules.module.Module</span>):

                <label class="view-source-button" for="AuxParams-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AuxParams"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AuxParams-97"><a href="#AuxParams-97"><span class="linenos"> 97</span></a><span class="k">class</span><span class="w"> </span><span class="nc">AuxParams</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="AuxParams-98"><a href="#AuxParams-98"><span class="linenos"> 98</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">HeteroData</span><span class="p">,</span> <span class="n">edgetype_specific</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">check_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">use_noise</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AuxParams-99"><a href="#AuxParams-99"><span class="linenos"> 99</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AuxParams-100"><a href="#AuxParams-100"><span class="linenos">100</span></a><span class="sd">        Prepare parameter dictionaries with batch correction for RNA-seq data</span>
</span><span id="AuxParams-101"><a href="#AuxParams-101"><span class="linenos">101</span></a><span class="sd">        </span>
</span><span id="AuxParams-102"><a href="#AuxParams-102"><span class="linenos">102</span></a><span class="sd">        Args:</span>
</span><span id="AuxParams-103"><a href="#AuxParams-103"><span class="linenos">103</span></a><span class="sd">            data (HeteroData): The data object containing the graph data.</span>
</span><span id="AuxParams-104"><a href="#AuxParams-104"><span class="linenos">104</span></a><span class="sd">            edgetype_specific (bool): Whether to use different parameters for different edge types.</span>
</span><span id="AuxParams-105"><a href="#AuxParams-105"><span class="linenos">105</span></a><span class="sd">        </span>
</span><span id="AuxParams-106"><a href="#AuxParams-106"><span class="linenos">106</span></a><span class="sd">        Notes:</span>
</span><span id="AuxParams-107"><a href="#AuxParams-107"><span class="linenos">107</span></a><span class="sd">            An example keylist for a parameter dictionary when edgetype_specific is True is:</span>
</span><span id="AuxParams-108"><a href="#AuxParams-108"><span class="linenos">108</span></a><span class="sd">            [</span>
</span><span id="AuxParams-109"><a href="#AuxParams-109"><span class="linenos">109</span></a><span class="sd">                &quot;cell__cell_expresses_gene&quot;,      # value shape: (num_cells,)</span>
</span><span id="AuxParams-110"><a href="#AuxParams-110"><span class="linenos">110</span></a><span class="sd">                &quot;cell__cell_has_accessible_peak&quot;, # value shape: (num_cells,)</span>
</span><span id="AuxParams-111"><a href="#AuxParams-111"><span class="linenos">111</span></a><span class="sd">                &quot;gene__cell_expresses_gene&quot;,      # value shape: (num_batches, num_genes) if use_batch else (num_genes,)</span>
</span><span id="AuxParams-112"><a href="#AuxParams-112"><span class="linenos">112</span></a><span class="sd">                &quot;peak__cell_has_accessible_peak&quot;  # value shape: (num_batches, num_peaks) if use_batch else (num_peaks,)</span>
</span><span id="AuxParams-113"><a href="#AuxParams-113"><span class="linenos">113</span></a><span class="sd">            ]</span>
</span><span id="AuxParams-114"><a href="#AuxParams-114"><span class="linenos">114</span></a><span class="sd">            But for *_logstd_dict, there is only destination node type in the key.</span>
</span><span id="AuxParams-115"><a href="#AuxParams-115"><span class="linenos">115</span></a><span class="sd">            [</span>
</span><span id="AuxParams-116"><a href="#AuxParams-116"><span class="linenos">116</span></a><span class="sd">                &quot;gene__cell_expresses_gene&quot;,</span>
</span><span id="AuxParams-117"><a href="#AuxParams-117"><span class="linenos">117</span></a><span class="sd">                &quot;peak__cell_has_accessible_peak&quot;</span>
</span><span id="AuxParams-118"><a href="#AuxParams-118"><span class="linenos">118</span></a><span class="sd">            ]</span>
</span><span id="AuxParams-119"><a href="#AuxParams-119"><span class="linenos">119</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AuxParams-120"><a href="#AuxParams-120"><span class="linenos">120</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="AuxParams-121"><a href="#AuxParams-121"><span class="linenos">121</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">edgetype_specific</span> <span class="o">=</span> <span class="n">edgetype_specific</span>
</span><span id="AuxParams-122"><a href="#AuxParams-122"><span class="linenos">122</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">use_noise</span> <span class="o">=</span> <span class="n">use_noise</span>
</span><span id="AuxParams-123"><a href="#AuxParams-123"><span class="linenos">123</span></a>
</span><span id="AuxParams-124"><a href="#AuxParams-124"><span class="linenos">124</span></a>        <span class="n">srcs</span><span class="p">,</span> <span class="n">dsts</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span> <span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dst</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_types</span><span class="p">])</span>
</span><span id="AuxParams-125"><a href="#AuxParams-125"><span class="linenos">125</span></a>        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">srcs</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">{</span><span class="s2">&quot;cell&quot;</span><span class="p">}</span> <span class="ow">and</span> <span class="nb">set</span><span class="p">(</span><span class="n">dsts</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">{</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span> <span class="s2">&quot;peak&quot;</span><span class="p">},</span> <span class="s2">&quot;Only cell-gene and cell-peak edges are supported&quot;</span>
</span><span id="AuxParams-126"><a href="#AuxParams-126"><span class="linenos">126</span></a>
</span><span id="AuxParams-127"><a href="#AuxParams-127"><span class="linenos">127</span></a>        <span class="k">if</span> <span class="n">check_data</span><span class="p">:</span>
</span><span id="AuxParams-128"><a href="#AuxParams-128"><span class="linenos">128</span></a>            <span class="n">ok</span><span class="p">,</span> <span class="n">msgs</span> <span class="o">=</span> <span class="n">chk</span><span class="o">.</span><span class="n">check_heterodata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="AuxParams-129"><a href="#AuxParams-129"><span class="linenos">129</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
</span><span id="AuxParams-130"><a href="#AuxParams-130"><span class="linenos">130</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid heterodata: </span><span class="si">{</span><span class="n">msgs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AuxParams-131"><a href="#AuxParams-131"><span class="linenos">131</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="AuxParams-132"><a href="#AuxParams-132"><span class="linenos">132</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;HeteroData codes are valid: </span><span class="si">{</span><span class="n">msgs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AuxParams-133"><a href="#AuxParams-133"><span class="linenos">133</span></a>
</span><span id="AuxParams-134"><a href="#AuxParams-134"><span class="linenos">134</span></a>        <span class="c1"># multi-sample detection</span>
</span><span id="AuxParams-135"><a href="#AuxParams-135"><span class="linenos">135</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">],</span> <span class="s2">&quot;sample&quot;</span><span class="p">):</span>
</span><span id="AuxParams-136"><a href="#AuxParams-136"><span class="linenos">136</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span>
</span><span id="AuxParams-137"><a href="#AuxParams-137"><span class="linenos">137</span></a>                <span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="AuxParams-138"><a href="#AuxParams-138"><span class="linenos">138</span></a>            <span class="p">))</span>
</span><span id="AuxParams-139"><a href="#AuxParams-139"><span class="linenos">139</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="AuxParams-140"><a href="#AuxParams-140"><span class="linenos">140</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span>
</span><span id="AuxParams-141"><a href="#AuxParams-141"><span class="linenos">141</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">multi_sample</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
</span><span id="AuxParams-142"><a href="#AuxParams-142"><span class="linenos">142</span></a>
</span><span id="AuxParams-143"><a href="#AuxParams-143"><span class="linenos">143</span></a>        <span class="c1"># if there are more than one batch, turn on use_batch</span>
</span><span id="AuxParams-144"><a href="#AuxParams-144"><span class="linenos">144</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">use_batch</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="AuxParams-145"><a href="#AuxParams-145"><span class="linenos">145</span></a>            <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">],</span> <span class="s2">&quot;batch_local&quot;</span><span class="p">)</span> 
</span><span id="AuxParams-146"><a href="#AuxParams-146"><span class="linenos">146</span></a>            <span class="ow">and</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">batch_local</span><span class="p">)</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="AuxParams-147"><a href="#AuxParams-147"><span class="linenos">147</span></a>            <span class="ow">or</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">],</span> <span class="s2">&quot;batch&quot;</span><span class="p">)</span>
</span><span id="AuxParams-148"><a href="#AuxParams-148"><span class="linenos">148</span></a>            <span class="ow">and</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">batch</span><span class="p">)</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">))</span>
</span><span id="AuxParams-149"><a href="#AuxParams-149"><span class="linenos">149</span></a>        <span class="p">)</span>
</span><span id="AuxParams-150"><a href="#AuxParams-150"><span class="linenos">150</span></a>
</span><span id="AuxParams-151"><a href="#AuxParams-151"><span class="linenos">151</span></a>        <span class="c1"># Batch correction for RNA-seq data</span>
</span><span id="AuxParams-152"><a href="#AuxParams-152"><span class="linenos">152</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ParameterDict</span><span class="p">()</span>
</span><span id="AuxParams-153"><a href="#AuxParams-153"><span class="linenos">153</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logscale_dict</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ParameterDict</span><span class="p">()</span>
</span><span id="AuxParams-154"><a href="#AuxParams-154"><span class="linenos">154</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ParameterDict</span><span class="p">()</span>
</span><span id="AuxParams-155"><a href="#AuxParams-155"><span class="linenos">155</span></a>
</span><span id="AuxParams-156"><a href="#AuxParams-156"><span class="linenos">156</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bias_logstd_dict</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ParameterDict</span><span class="p">()</span>
</span><span id="AuxParams-157"><a href="#AuxParams-157"><span class="linenos">157</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logscale_logstd_dict</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ParameterDict</span><span class="p">()</span>
</span><span id="AuxParams-158"><a href="#AuxParams-158"><span class="linenos">158</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">std_logstd_dict</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ParameterDict</span><span class="p">()</span>
</span><span id="AuxParams-159"><a href="#AuxParams-159"><span class="linenos">159</span></a>
</span><span id="AuxParams-160"><a href="#AuxParams-160"><span class="linenos">160</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict_per_sample</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">()</span>
</span><span id="AuxParams-161"><a href="#AuxParams-161"><span class="linenos">161</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logscale_dict_per_sample</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">()</span>
</span><span id="AuxParams-162"><a href="#AuxParams-162"><span class="linenos">162</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">std_dict_per_sample</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">()</span>
</span><span id="AuxParams-163"><a href="#AuxParams-163"><span class="linenos">163</span></a>
</span><span id="AuxParams-164"><a href="#AuxParams-164"><span class="linenos">164</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_sample</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_batch</span><span class="p">:</span>
</span><span id="AuxParams-165"><a href="#AuxParams-165"><span class="linenos">165</span></a>            <span class="c1"># precompute n_batches per sample</span>
</span><span id="AuxParams-166"><a href="#AuxParams-166"><span class="linenos">166</span></a>            <span class="n">n_batches_per_sample</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">sid</span><span class="p">:</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">}</span>
</span><span id="AuxParams-167"><a href="#AuxParams-167"><span class="linenos">167</span></a>            <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">:</span>
</span><span id="AuxParams-168"><a href="#AuxParams-168"><span class="linenos">168</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span> <span class="o">==</span> <span class="n">sid</span>
</span><span id="AuxParams-169"><a href="#AuxParams-169"><span class="linenos">169</span></a>                <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
</span><span id="AuxParams-170"><a href="#AuxParams-170"><span class="linenos">170</span></a>                    <span class="n">bmax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">batch_local</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</span><span id="AuxParams-171"><a href="#AuxParams-171"><span class="linenos">171</span></a>                    <span class="n">n_batches_per_sample</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">=</span> <span class="n">bmax</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="AuxParams-172"><a href="#AuxParams-172"><span class="linenos">172</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="AuxParams-173"><a href="#AuxParams-173"><span class="linenos">173</span></a>                    <span class="n">n_batches_per_sample</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="AuxParams-174"><a href="#AuxParams-174"><span class="linenos">174</span></a>            
</span><span id="AuxParams-175"><a href="#AuxParams-175"><span class="linenos">175</span></a>            <span class="c1"># precompute n_nodes per sample for each feature node type</span>
</span><span id="AuxParams-176"><a href="#AuxParams-176"><span class="linenos">176</span></a>            <span class="n">n_nodes_per_sample_per_type</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="AuxParams-177"><a href="#AuxParams-177"><span class="linenos">177</span></a>            <span class="k">for</span> <span class="n">node_type</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">node_types</span><span class="p">:</span>
</span><span id="AuxParams-178"><a href="#AuxParams-178"><span class="linenos">178</span></a>                <span class="k">if</span> <span class="n">node_type</span> <span class="o">==</span> <span class="s2">&quot;cell&quot;</span><span class="p">:</span>
</span><span id="AuxParams-179"><a href="#AuxParams-179"><span class="linenos">179</span></a>                    <span class="k">continue</span>
</span><span id="AuxParams-180"><a href="#AuxParams-180"><span class="linenos">180</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">node_type</span><span class="p">],</span> <span class="s2">&quot;sample&quot;</span><span class="p">):</span>
</span><span id="AuxParams-181"><a href="#AuxParams-181"><span class="linenos">181</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Node type </span><span class="si">{</span><span class="n">node_type</span><span class="si">}</span><span class="s2"> does not have sample attribute while there are multiple samples&quot;</span><span class="p">)</span>
</span><span id="AuxParams-182"><a href="#AuxParams-182"><span class="linenos">182</span></a>                <span class="n">n_nodes_per_sample_per_type</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">sid</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">}</span>
</span><span id="AuxParams-183"><a href="#AuxParams-183"><span class="linenos">183</span></a>                <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">:</span>
</span><span id="AuxParams-184"><a href="#AuxParams-184"><span class="linenos">184</span></a>                    <span class="n">mask</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span> <span class="o">==</span> <span class="n">sid</span>
</span><span id="AuxParams-185"><a href="#AuxParams-185"><span class="linenos">185</span></a>                    <span class="n">n_nodes_per_sample_per_type</span><span class="p">[</span><span class="n">node_type</span><span class="p">][</span><span class="n">sid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</span><span id="AuxParams-186"><a href="#AuxParams-186"><span class="linenos">186</span></a>        
</span><span id="AuxParams-187"><a href="#AuxParams-187"><span class="linenos">187</span></a>        <span class="c1"># build parameter containers per edge type</span>
</span><span id="AuxParams-188"><a href="#AuxParams-188"><span class="linenos">188</span></a>        <span class="k">for</span> <span class="n">edge_type</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_types</span><span class="p">:</span>
</span><span id="AuxParams-189"><a href="#AuxParams-189"><span class="linenos">189</span></a>            <span class="n">src</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dst</span> <span class="o">=</span> <span class="n">edge_type</span>
</span><span id="AuxParams-190"><a href="#AuxParams-190"><span class="linenos">190</span></a>            <span class="n">src_key</span><span class="p">,</span> <span class="n">dst_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_keys</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">edge_type</span><span class="p">)</span>
</span><span id="AuxParams-191"><a href="#AuxParams-191"><span class="linenos">191</span></a>
</span><span id="AuxParams-192"><a href="#AuxParams-192"><span class="linenos">192</span></a>            <span class="n">num_src_nodes</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">src</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span>
</span><span id="AuxParams-193"><a href="#AuxParams-193"><span class="linenos">193</span></a>            <span class="n">num_dst_nodes</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span>
</span><span id="AuxParams-194"><a href="#AuxParams-194"><span class="linenos">194</span></a>
</span><span id="AuxParams-195"><a href="#AuxParams-195"><span class="linenos">195</span></a>            <span class="c1"># src params: always per-node</span>
</span><span id="AuxParams-196"><a href="#AuxParams-196"><span class="linenos">196</span></a>            <span class="k">if</span> <span class="n">src_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">:</span>
</span><span id="AuxParams-197"><a href="#AuxParams-197"><span class="linenos">197</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">[</span><span class="n">src_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_src_nodes</span><span class="p">))</span>
</span><span id="AuxParams-198"><a href="#AuxParams-198"><span class="linenos">198</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logscale_dict</span><span class="p">[</span><span class="n">src_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_src_nodes</span><span class="p">))</span>
</span><span id="AuxParams-199"><a href="#AuxParams-199"><span class="linenos">199</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span><span class="p">[</span><span class="n">src_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_src_nodes</span><span class="p">))</span>
</span><span id="AuxParams-200"><a href="#AuxParams-200"><span class="linenos">200</span></a>            
</span><span id="AuxParams-201"><a href="#AuxParams-201"><span class="linenos">201</span></a>            <span class="c1"># dst params: depending on use_batch and multi_sample</span>
</span><span id="AuxParams-202"><a href="#AuxParams-202"><span class="linenos">202</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_batch</span><span class="p">:</span>
</span><span id="AuxParams-203"><a href="#AuxParams-203"><span class="linenos">203</span></a>                <span class="k">if</span> <span class="n">dst_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">:</span>
</span><span id="AuxParams-204"><a href="#AuxParams-204"><span class="linenos">204</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_dst_nodes</span><span class="p">))</span>
</span><span id="AuxParams-205"><a href="#AuxParams-205"><span class="linenos">205</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">logscale_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_dst_nodes</span><span class="p">))</span>
</span><span id="AuxParams-206"><a href="#AuxParams-206"><span class="linenos">206</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_dst_nodes</span><span class="p">))</span>
</span><span id="AuxParams-207"><a href="#AuxParams-207"><span class="linenos">207</span></a>            <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_sample</span><span class="p">:</span>
</span><span id="AuxParams-208"><a href="#AuxParams-208"><span class="linenos">208</span></a>                <span class="n">_batch</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">batch</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">],</span> <span class="s2">&quot;batch&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">batch_local</span>
</span><span id="AuxParams-209"><a href="#AuxParams-209"><span class="linenos">209</span></a>                <span class="n">n_batches</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">_batch</span><span class="p">)</span><span class="o">.</span><span class="n">numel</span><span class="p">())</span>
</span><span id="AuxParams-210"><a href="#AuxParams-210"><span class="linenos">210</span></a>                <span class="k">if</span> <span class="n">dst_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">:</span>
</span><span id="AuxParams-211"><a href="#AuxParams-211"><span class="linenos">211</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">num_dst_nodes</span><span class="p">))</span>
</span><span id="AuxParams-212"><a href="#AuxParams-212"><span class="linenos">212</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">logscale_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">num_dst_nodes</span><span class="p">))</span>
</span><span id="AuxParams-213"><a href="#AuxParams-213"><span class="linenos">213</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">num_dst_nodes</span><span class="p">))</span>
</span><span id="AuxParams-214"><a href="#AuxParams-214"><span class="linenos">214</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">bias_logstd_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">num_dst_nodes</span><span class="p">))</span>
</span><span id="AuxParams-215"><a href="#AuxParams-215"><span class="linenos">215</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">logscale_logstd_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">num_dst_nodes</span><span class="p">))</span>
</span><span id="AuxParams-216"><a href="#AuxParams-216"><span class="linenos">216</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">std_logstd_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">num_dst_nodes</span><span class="p">))</span>
</span><span id="AuxParams-217"><a href="#AuxParams-217"><span class="linenos">217</span></a>            <span class="k">else</span><span class="p">:</span> <span class="c1"># multi-sample and use_batch</span>
</span><span id="AuxParams-218"><a href="#AuxParams-218"><span class="linenos">218</span></a>                <span class="k">if</span> <span class="n">dst_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict_per_sample</span><span class="p">:</span>
</span><span id="AuxParams-219"><a href="#AuxParams-219"><span class="linenos">219</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict_per_sample</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_PerSampleBatchedParam</span><span class="p">(</span>
</span><span id="AuxParams-220"><a href="#AuxParams-220"><span class="linenos">220</span></a>                        <span class="n">n_batches_per_sample</span><span class="o">=</span><span class="n">n_batches_per_sample</span><span class="p">,</span>
</span><span id="AuxParams-221"><a href="#AuxParams-221"><span class="linenos">221</span></a>                        <span class="n">n_nodes_per_sample</span><span class="o">=</span><span class="n">n_nodes_per_sample_per_type</span><span class="p">[</span><span class="n">dst</span><span class="p">],</span>
</span><span id="AuxParams-222"><a href="#AuxParams-222"><span class="linenos">222</span></a>                        <span class="n">sample_ids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">,</span>
</span><span id="AuxParams-223"><a href="#AuxParams-223"><span class="linenos">223</span></a>                        <span class="n">init</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="AuxParams-224"><a href="#AuxParams-224"><span class="linenos">224</span></a>                    <span class="p">)</span>
</span><span id="AuxParams-225"><a href="#AuxParams-225"><span class="linenos">225</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">logscale_dict_per_sample</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_PerSampleBatchedParam</span><span class="p">(</span>
</span><span id="AuxParams-226"><a href="#AuxParams-226"><span class="linenos">226</span></a>                        <span class="n">n_batches_per_sample</span><span class="o">=</span><span class="n">n_batches_per_sample</span><span class="p">,</span>
</span><span id="AuxParams-227"><a href="#AuxParams-227"><span class="linenos">227</span></a>                        <span class="n">n_nodes_per_sample</span><span class="o">=</span><span class="n">n_nodes_per_sample_per_type</span><span class="p">[</span><span class="n">dst</span><span class="p">],</span>
</span><span id="AuxParams-228"><a href="#AuxParams-228"><span class="linenos">228</span></a>                        <span class="n">sample_ids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">,</span>
</span><span id="AuxParams-229"><a href="#AuxParams-229"><span class="linenos">229</span></a>                        <span class="n">init</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="AuxParams-230"><a href="#AuxParams-230"><span class="linenos">230</span></a>                    <span class="p">)</span>
</span><span id="AuxParams-231"><a href="#AuxParams-231"><span class="linenos">231</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">std_dict_per_sample</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_PerSampleBatchedParam</span><span class="p">(</span>
</span><span id="AuxParams-232"><a href="#AuxParams-232"><span class="linenos">232</span></a>                        <span class="n">n_batches_per_sample</span><span class="o">=</span><span class="n">n_batches_per_sample</span><span class="p">,</span>
</span><span id="AuxParams-233"><a href="#AuxParams-233"><span class="linenos">233</span></a>                        <span class="n">n_nodes_per_sample</span><span class="o">=</span><span class="n">n_nodes_per_sample_per_type</span><span class="p">[</span><span class="n">dst</span><span class="p">],</span>
</span><span id="AuxParams-234"><a href="#AuxParams-234"><span class="linenos">234</span></a>                        <span class="n">sample_ids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">,</span>
</span><span id="AuxParams-235"><a href="#AuxParams-235"><span class="linenos">235</span></a>                        <span class="n">init</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="AuxParams-236"><a href="#AuxParams-236"><span class="linenos">236</span></a>                    <span class="p">)</span>
</span><span id="AuxParams-237"><a href="#AuxParams-237"><span class="linenos">237</span></a>
</span><span id="AuxParams-238"><a href="#AuxParams-238"><span class="linenos">238</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">batched</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">param_logstd</span><span class="p">):</span>
</span><span id="AuxParams-239"><a href="#AuxParams-239"><span class="linenos">239</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AuxParams-240"><a href="#AuxParams-240"><span class="linenos">240</span></a><span class="sd">        Generate a batch of stochastic parameters based on baseline parameters, offsets, and deviations.</span>
</span><span id="AuxParams-241"><a href="#AuxParams-241"><span class="linenos">241</span></a>
</span><span id="AuxParams-242"><a href="#AuxParams-242"><span class="linenos">242</span></a><span class="sd">        Args:</span>
</span><span id="AuxParams-243"><a href="#AuxParams-243"><span class="linenos">243</span></a><span class="sd">            param: Baseline and offset parameters, shape: (num_batches, num_nodes)</span>
</span><span id="AuxParams-244"><a href="#AuxParams-244"><span class="linenos">244</span></a><span class="sd">            param_logstd: Log standard deviations, shape: (num_batches, num_nodes)</span>
</span><span id="AuxParams-245"><a href="#AuxParams-245"><span class="linenos">245</span></a>
</span><span id="AuxParams-246"><a href="#AuxParams-246"><span class="linenos">246</span></a><span class="sd">        Returns:</span>
</span><span id="AuxParams-247"><a href="#AuxParams-247"><span class="linenos">247</span></a><span class="sd">            Stochastic parameters, shape: (num_batches, num_nodes)</span>
</span><span id="AuxParams-248"><a href="#AuxParams-248"><span class="linenos">248</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AuxParams-249"><a href="#AuxParams-249"><span class="linenos">249</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_noise</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_batch</span><span class="p">:</span>
</span><span id="AuxParams-250"><a href="#AuxParams-250"><span class="linenos">250</span></a>            <span class="k">assert</span> <span class="n">param</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;param must be a 2D tensor when use_batch is True, but got </span><span class="si">{</span><span class="n">param</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span><span class="si">}</span><span class="s2">D tensor&quot;</span>
</span><span id="AuxParams-251"><a href="#AuxParams-251"><span class="linenos">251</span></a>            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="AuxParams-252"><a href="#AuxParams-252"><span class="linenos">252</span></a>                <span class="k">return</span> <span class="n">param</span>
</span><span id="AuxParams-253"><a href="#AuxParams-253"><span class="linenos">253</span></a>            <span class="n">return_param</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
</span><span id="AuxParams-254"><a href="#AuxParams-254"><span class="linenos">254</span></a>                <span class="p">[</span>
</span><span id="AuxParams-255"><a href="#AuxParams-255"><span class="linenos">255</span></a>                    <span class="n">param</span><span class="p">[[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:],</span>
</span><span id="AuxParams-256"><a href="#AuxParams-256"><span class="linenos">256</span></a>                    <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">param</span><span class="p">[[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">param_logstd</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:])</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">param_logstd</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]),</span>
</span><span id="AuxParams-257"><a href="#AuxParams-257"><span class="linenos">257</span></a>                <span class="p">],</span>
</span><span id="AuxParams-258"><a href="#AuxParams-258"><span class="linenos">258</span></a>                <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="AuxParams-259"><a href="#AuxParams-259"><span class="linenos">259</span></a>            <span class="p">)</span>
</span><span id="AuxParams-260"><a href="#AuxParams-260"><span class="linenos">260</span></a>            <span class="k">return</span> <span class="n">return_param</span>
</span><span id="AuxParams-261"><a href="#AuxParams-261"><span class="linenos">261</span></a>        <span class="k">return</span> <span class="n">param</span>
</span><span id="AuxParams-262"><a href="#AuxParams-262"><span class="linenos">262</span></a>
</span><span id="AuxParams-263"><a href="#AuxParams-263"><span class="linenos">263</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_dst_values_per_edge</span><span class="p">(</span>
</span><span id="AuxParams-264"><a href="#AuxParams-264"><span class="linenos">264</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="AuxParams-265"><a href="#AuxParams-265"><span class="linenos">265</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">HeteroData</span><span class="p">,</span>
</span><span id="AuxParams-266"><a href="#AuxParams-266"><span class="linenos">266</span></a>        <span class="n">edge_index</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="AuxParams-267"><a href="#AuxParams-267"><span class="linenos">267</span></a>        <span class="n">dst_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="AuxParams-268"><a href="#AuxParams-268"><span class="linenos">268</span></a>        <span class="n">dst_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="AuxParams-269"><a href="#AuxParams-269"><span class="linenos">269</span></a>        <span class="n">which</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="AuxParams-270"><a href="#AuxParams-270"><span class="linenos">270</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="AuxParams-271"><a href="#AuxParams-271"><span class="linenos">271</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AuxParams-272"><a href="#AuxParams-272"><span class="linenos">272</span></a><span class="sd">        Return a (num_edges,) tensor of dst parameters for this edge_type.</span>
</span><span id="AuxParams-273"><a href="#AuxParams-273"><span class="linenos">273</span></a>
</span><span id="AuxParams-274"><a href="#AuxParams-274"><span class="linenos">274</span></a><span class="sd">        which in {&quot;logscale&quot;,&quot;bias&quot;,&quot;std&quot;}.</span>
</span><span id="AuxParams-275"><a href="#AuxParams-275"><span class="linenos">275</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AuxParams-276"><a href="#AuxParams-276"><span class="linenos">276</span></a>        <span class="n">device</span> <span class="o">=</span> <span class="n">edge_index</span><span class="o">.</span><span class="n">device</span>
</span><span id="AuxParams-277"><a href="#AuxParams-277"><span class="linenos">277</span></a>        <span class="n">num_edges</span> <span class="o">=</span> <span class="n">edge_index</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="AuxParams-278"><a href="#AuxParams-278"><span class="linenos">278</span></a>
</span><span id="AuxParams-279"><a href="#AuxParams-279"><span class="linenos">279</span></a>        <span class="c1"># not use_batch</span>
</span><span id="AuxParams-280"><a href="#AuxParams-280"><span class="linenos">280</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_batch</span><span class="p">:</span>
</span><span id="AuxParams-281"><a href="#AuxParams-281"><span class="linenos">281</span></a>            <span class="n">dst_global</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="n">dst_type</span><span class="p">]</span><span class="o">.</span><span class="n">n_id</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="AuxParams-282"><a href="#AuxParams-282"><span class="linenos">282</span></a>            <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s2">&quot;logscale&quot;</span><span class="p">:</span>
</span><span id="AuxParams-283"><a href="#AuxParams-283"><span class="linenos">283</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">logscale_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">][</span><span class="n">dst_global</span><span class="p">]</span>
</span><span id="AuxParams-284"><a href="#AuxParams-284"><span class="linenos">284</span></a>            <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s2">&quot;bias&quot;</span><span class="p">:</span>
</span><span id="AuxParams-285"><a href="#AuxParams-285"><span class="linenos">285</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">][</span><span class="n">dst_global</span><span class="p">]</span>
</span><span id="AuxParams-286"><a href="#AuxParams-286"><span class="linenos">286</span></a>            <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s2">&quot;std&quot;</span><span class="p">:</span>
</span><span id="AuxParams-287"><a href="#AuxParams-287"><span class="linenos">287</span></a>                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">][</span><span class="n">dst_global</span><span class="p">]</span>
</span><span id="AuxParams-288"><a href="#AuxParams-288"><span class="linenos">288</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown which=</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AuxParams-289"><a href="#AuxParams-289"><span class="linenos">289</span></a>
</span><span id="AuxParams-290"><a href="#AuxParams-290"><span class="linenos">290</span></a>        <span class="c1"># use_batch and multi_sample</span>
</span><span id="AuxParams-291"><a href="#AuxParams-291"><span class="linenos">291</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_sample</span><span class="p">:</span>
</span><span id="AuxParams-292"><a href="#AuxParams-292"><span class="linenos">292</span></a>            <span class="c1"># Per-sample: index by (cell.sample, cell.batch_local, dst.local_id)</span>
</span><span id="AuxParams-293"><a href="#AuxParams-293"><span class="linenos">293</span></a>            <span class="n">samples</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
</span><span id="AuxParams-294"><a href="#AuxParams-294"><span class="linenos">294</span></a>            <span class="n">b_local</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">batch_local</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
</span><span id="AuxParams-295"><a href="#AuxParams-295"><span class="linenos">295</span></a>            <span class="n">dst_local</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="n">dst_type</span><span class="p">]</span><span class="o">.</span><span class="n">local_id</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
</span><span id="AuxParams-296"><a href="#AuxParams-296"><span class="linenos">296</span></a>
</span><span id="AuxParams-297"><a href="#AuxParams-297"><span class="linenos">297</span></a>            <span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">num_edges</span><span class="p">,),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="AuxParams-298"><a href="#AuxParams-298"><span class="linenos">298</span></a>
</span><span id="AuxParams-299"><a href="#AuxParams-299"><span class="linenos">299</span></a>            <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s2">&quot;logscale&quot;</span><span class="p">:</span>
</span><span id="AuxParams-300"><a href="#AuxParams-300"><span class="linenos">300</span></a>                <span class="n">mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logscale_dict_per_sample</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span>
</span><span id="AuxParams-301"><a href="#AuxParams-301"><span class="linenos">301</span></a>            <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s2">&quot;bias&quot;</span><span class="p">:</span>
</span><span id="AuxParams-302"><a href="#AuxParams-302"><span class="linenos">302</span></a>                <span class="n">mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict_per_sample</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span>
</span><span id="AuxParams-303"><a href="#AuxParams-303"><span class="linenos">303</span></a>            <span class="k">elif</span> <span class="n">which</span> <span class="o">==</span> <span class="s2">&quot;std&quot;</span><span class="p">:</span>
</span><span id="AuxParams-304"><a href="#AuxParams-304"><span class="linenos">304</span></a>                <span class="n">mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">std_dict_per_sample</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span>
</span><span id="AuxParams-305"><a href="#AuxParams-305"><span class="linenos">305</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="AuxParams-306"><a href="#AuxParams-306"><span class="linenos">306</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown which=</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AuxParams-307"><a href="#AuxParams-307"><span class="linenos">307</span></a>
</span><span id="AuxParams-308"><a href="#AuxParams-308"><span class="linenos">308</span></a>            <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
</span><span id="AuxParams-309"><a href="#AuxParams-309"><span class="linenos">309</span></a>                <span class="n">sid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
</span><span id="AuxParams-310"><a href="#AuxParams-310"><span class="linenos">310</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">samples</span> <span class="o">==</span> <span class="n">sid</span><span class="p">)</span>
</span><span id="AuxParams-311"><a href="#AuxParams-311"><span class="linenos">311</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">mask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
</span><span id="AuxParams-312"><a href="#AuxParams-312"><span class="linenos">312</span></a>                    <span class="k">continue</span>
</span><span id="AuxParams-313"><a href="#AuxParams-313"><span class="linenos">313</span></a>                <span class="n">p</span><span class="p">,</span> <span class="n">p_logstd</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
</span><span id="AuxParams-314"><a href="#AuxParams-314"><span class="linenos">314</span></a>                <span class="n">p_eff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batched</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p_logstd</span><span class="p">)</span>
</span><span id="AuxParams-315"><a href="#AuxParams-315"><span class="linenos">315</span></a>                <span class="n">out</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_eff</span><span class="p">[</span><span class="n">b_local</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">dst_local</span><span class="p">[</span><span class="n">mask</span><span class="p">]]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="AuxParams-316"><a href="#AuxParams-316"><span class="linenos">316</span></a>            <span class="k">return</span> <span class="n">out</span>
</span><span id="AuxParams-317"><a href="#AuxParams-317"><span class="linenos">317</span></a>
</span><span id="AuxParams-318"><a href="#AuxParams-318"><span class="linenos">318</span></a>        <span class="c1"># use_batch and not multi_sample</span>
</span><span id="AuxParams-319"><a href="#AuxParams-319"><span class="linenos">319</span></a>        <span class="n">dst_global</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="n">dst_type</span><span class="p">]</span><span class="o">.</span><span class="n">n_id</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="AuxParams-320"><a href="#AuxParams-320"><span class="linenos">320</span></a>        <span class="n">_batch</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">batch</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">],</span> <span class="s2">&quot;batch&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">batch_local</span>
</span><span id="AuxParams-321"><a href="#AuxParams-321"><span class="linenos">321</span></a>        <span class="n">b</span> <span class="o">=</span> <span class="n">_batch</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
</span><span id="AuxParams-322"><a href="#AuxParams-322"><span class="linenos">322</span></a>
</span><span id="AuxParams-323"><a href="#AuxParams-323"><span class="linenos">323</span></a>        <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s2">&quot;logscale&quot;</span><span class="p">:</span>
</span><span id="AuxParams-324"><a href="#AuxParams-324"><span class="linenos">324</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">batched</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logscale_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">logscale_logstd_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">])[</span><span class="n">b</span><span class="p">,</span> <span class="n">dst_global</span><span class="p">]</span>
</span><span id="AuxParams-325"><a href="#AuxParams-325"><span class="linenos">325</span></a>        <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s2">&quot;bias&quot;</span><span class="p">:</span>
</span><span id="AuxParams-326"><a href="#AuxParams-326"><span class="linenos">326</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">batched</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_logstd_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">])[</span><span class="n">b</span><span class="p">,</span> <span class="n">dst_global</span><span class="p">]</span>
</span><span id="AuxParams-327"><a href="#AuxParams-327"><span class="linenos">327</span></a>        <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s2">&quot;std&quot;</span><span class="p">:</span>
</span><span id="AuxParams-328"><a href="#AuxParams-328"><span class="linenos">328</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">batched</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">std_logstd_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">])[</span><span class="n">b</span><span class="p">,</span> <span class="n">dst_global</span><span class="p">]</span>
</span><span id="AuxParams-329"><a href="#AuxParams-329"><span class="linenos">329</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown which=</span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AuxParams-330"><a href="#AuxParams-330"><span class="linenos">330</span></a>
</span><span id="AuxParams-331"><a href="#AuxParams-331"><span class="linenos">331</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">edge_index_dict</span><span class="p">):</span>
</span><span id="AuxParams-332"><a href="#AuxParams-332"><span class="linenos">332</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AuxParams-333"><a href="#AuxParams-333"><span class="linenos">333</span></a><span class="sd">        Get the parameters for the given batch and edge index dictionary.</span>
</span><span id="AuxParams-334"><a href="#AuxParams-334"><span class="linenos">334</span></a>
</span><span id="AuxParams-335"><a href="#AuxParams-335"><span class="linenos">335</span></a><span class="sd">        Args:</span>
</span><span id="AuxParams-336"><a href="#AuxParams-336"><span class="linenos">336</span></a><span class="sd">            batch: Batch object, providing</span>
</span><span id="AuxParams-337"><a href="#AuxParams-337"><span class="linenos">337</span></a><span class="sd">                - batch[node_type].n_id: help convert local node IDs in `edge_index_dict` to global node IDs</span>
</span><span id="AuxParams-338"><a href="#AuxParams-338"><span class="linenos">338</span></a><span class="sd">                - batch[&quot;cell&quot;].batch: provide batch information for the cells</span>
</span><span id="AuxParams-339"><a href="#AuxParams-339"><span class="linenos">339</span></a><span class="sd">            edge_index_dict: Edge index dictionary, each value is a tensor of shape (2, num_edges) with local node IDs</span>
</span><span id="AuxParams-340"><a href="#AuxParams-340"><span class="linenos">340</span></a>
</span><span id="AuxParams-341"><a href="#AuxParams-341"><span class="linenos">341</span></a><span class="sd">        Returns:</span>
</span><span id="AuxParams-342"><a href="#AuxParams-342"><span class="linenos">342</span></a><span class="sd">            Dictionary of parameters for the given batch and edge index dictionary</span>
</span><span id="AuxParams-343"><a href="#AuxParams-343"><span class="linenos">343</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AuxParams-344"><a href="#AuxParams-344"><span class="linenos">344</span></a>        <span class="n">src_logscale_dict</span><span class="p">,</span> <span class="n">src_bias_dict</span><span class="p">,</span> <span class="n">src_std_dict</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>
</span><span id="AuxParams-345"><a href="#AuxParams-345"><span class="linenos">345</span></a>        <span class="n">dst_logscale_dict</span><span class="p">,</span> <span class="n">dst_bias_dict</span><span class="p">,</span> <span class="n">dst_std_dict</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>
</span><span id="AuxParams-346"><a href="#AuxParams-346"><span class="linenos">346</span></a>        <span class="k">for</span> <span class="n">edge_type</span><span class="p">,</span> <span class="n">edge_index</span> <span class="ow">in</span> <span class="n">edge_index_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="AuxParams-347"><a href="#AuxParams-347"><span class="linenos">347</span></a>            <span class="n">src_type</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dst_type</span> <span class="o">=</span> <span class="n">edge_type</span>
</span><span id="AuxParams-348"><a href="#AuxParams-348"><span class="linenos">348</span></a>            <span class="n">src_key</span><span class="p">,</span> <span class="n">dst_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_keys</span><span class="p">(</span><span class="n">src_type</span><span class="p">,</span> <span class="n">dst_type</span><span class="p">,</span> <span class="n">edge_type</span><span class="p">)</span>
</span><span id="AuxParams-349"><a href="#AuxParams-349"><span class="linenos">349</span></a>
</span><span id="AuxParams-350"><a href="#AuxParams-350"><span class="linenos">350</span></a>            <span class="n">src_node_id</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="n">src_type</span><span class="p">]</span><span class="o">.</span><span class="n">n_id</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="c1"># local id to global id</span>
</span><span id="AuxParams-351"><a href="#AuxParams-351"><span class="linenos">351</span></a>            <span class="n">src_logscale_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logscale_dict</span><span class="p">[</span><span class="n">src_key</span><span class="p">][</span><span class="n">src_node_id</span><span class="p">]</span>
</span><span id="AuxParams-352"><a href="#AuxParams-352"><span class="linenos">352</span></a>            <span class="n">src_bias_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">[</span><span class="n">src_key</span><span class="p">][</span><span class="n">src_node_id</span><span class="p">]</span>
</span><span id="AuxParams-353"><a href="#AuxParams-353"><span class="linenos">353</span></a>            <span class="n">src_std_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span><span class="p">[</span><span class="n">src_key</span><span class="p">][</span><span class="n">src_node_id</span><span class="p">]</span>
</span><span id="AuxParams-354"><a href="#AuxParams-354"><span class="linenos">354</span></a>
</span><span id="AuxParams-355"><a href="#AuxParams-355"><span class="linenos">355</span></a>            <span class="n">dst_logscale_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dst_values_per_edge</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">dst_type</span><span class="p">,</span> <span class="n">dst_key</span><span class="p">,</span> <span class="s2">&quot;logscale&quot;</span><span class="p">)</span>
</span><span id="AuxParams-356"><a href="#AuxParams-356"><span class="linenos">356</span></a>            <span class="n">dst_bias_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dst_values_per_edge</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">dst_type</span><span class="p">,</span> <span class="n">dst_key</span><span class="p">,</span> <span class="s2">&quot;bias&quot;</span><span class="p">)</span>
</span><span id="AuxParams-357"><a href="#AuxParams-357"><span class="linenos">357</span></a>            <span class="n">dst_std_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dst_values_per_edge</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">dst_type</span><span class="p">,</span> <span class="n">dst_key</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">)</span>
</span><span id="AuxParams-358"><a href="#AuxParams-358"><span class="linenos">358</span></a>        
</span><span id="AuxParams-359"><a href="#AuxParams-359"><span class="linenos">359</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="AuxParams-360"><a href="#AuxParams-360"><span class="linenos">360</span></a>            <span class="s2">&quot;src_logscale_dict&quot;</span><span class="p">:</span> <span class="n">src_logscale_dict</span><span class="p">,</span>
</span><span id="AuxParams-361"><a href="#AuxParams-361"><span class="linenos">361</span></a>            <span class="s2">&quot;src_bias_dict&quot;</span><span class="p">:</span> <span class="n">src_bias_dict</span><span class="p">,</span>
</span><span id="AuxParams-362"><a href="#AuxParams-362"><span class="linenos">362</span></a>            <span class="s2">&quot;src_std_dict&quot;</span><span class="p">:</span> <span class="n">src_std_dict</span><span class="p">,</span>
</span><span id="AuxParams-363"><a href="#AuxParams-363"><span class="linenos">363</span></a>            <span class="s2">&quot;dst_logscale_dict&quot;</span><span class="p">:</span> <span class="n">dst_logscale_dict</span><span class="p">,</span>
</span><span id="AuxParams-364"><a href="#AuxParams-364"><span class="linenos">364</span></a>            <span class="s2">&quot;dst_bias_dict&quot;</span><span class="p">:</span> <span class="n">dst_bias_dict</span><span class="p">,</span>
</span><span id="AuxParams-365"><a href="#AuxParams-365"><span class="linenos">365</span></a>            <span class="s2">&quot;dst_std_dict&quot;</span><span class="p">:</span> <span class="n">dst_std_dict</span><span class="p">,</span>
</span><span id="AuxParams-366"><a href="#AuxParams-366"><span class="linenos">366</span></a>        <span class="p">}</span>
</span><span id="AuxParams-367"><a href="#AuxParams-367"><span class="linenos">367</span></a>
</span><span id="AuxParams-368"><a href="#AuxParams-368"><span class="linenos">368</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_type</span><span class="p">,</span> <span class="n">dst_type</span><span class="p">,</span> <span class="n">edge_type</span><span class="p">):</span>
</span><span id="AuxParams-369"><a href="#AuxParams-369"><span class="linenos">369</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">edgetype_specific</span><span class="p">:</span>
</span><span id="AuxParams-370"><a href="#AuxParams-370"><span class="linenos">370</span></a>            <span class="n">src_key</span> <span class="o">=</span> <span class="n">make_key</span><span class="p">(</span><span class="n">src_type</span><span class="p">,</span> <span class="n">edge_type</span><span class="p">)</span>
</span><span id="AuxParams-371"><a href="#AuxParams-371"><span class="linenos">371</span></a>            <span class="n">dst_key</span> <span class="o">=</span> <span class="n">make_key</span><span class="p">(</span><span class="n">dst_type</span><span class="p">,</span> <span class="n">edge_type</span><span class="p">)</span>
</span><span id="AuxParams-372"><a href="#AuxParams-372"><span class="linenos">372</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="AuxParams-373"><a href="#AuxParams-373"><span class="linenos">373</span></a>            <span class="n">src_key</span> <span class="o">=</span> <span class="n">src_type</span>
</span><span id="AuxParams-374"><a href="#AuxParams-374"><span class="linenos">374</span></a>            <span class="n">dst_key</span> <span class="o">=</span> <span class="n">dst_type</span>
</span><span id="AuxParams-375"><a href="#AuxParams-375"><span class="linenos">375</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="AuxParams-376"><a href="#AuxParams-376"><span class="linenos">376</span></a>            <span class="n">src_key</span><span class="p">,</span>
</span><span id="AuxParams-377"><a href="#AuxParams-377"><span class="linenos">377</span></a>            <span class="n">dst_key</span><span class="p">,</span>
</span><span id="AuxParams-378"><a href="#AuxParams-378"><span class="linenos">378</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Base class for all neural network modules.</p>

<p>Your models should also subclass this class.</p>

<p>Modules can also contain other Modules, allowing them to be nested in
a tree structure. You can assign the submodules as regular attributes::</p>

<pre><code>import torch.nn as nn
import torch.nn.functional as F


class Model(nn.Module):
    def __init__(self) -&gt; None:
        super().__init__()
        self.conv1 = nn.Conv2d(1, 20, 5)
        self.conv2 = nn.Conv2d(20, 20, 5)

    def forward(self, x):
        x = F.relu(self.conv1(x))
        return F.relu(self.conv2(x))
</code></pre>

<p>Submodules assigned in this way will be registered, and will also have their
parameters converted when you call <code><a href="#AuxParams.to">to()</a></code>, etc.</p>

<div class="alert note">

<p>As per the example above, an <code><a href="#AuxParams.__init__">__init__()</a></code> call to the parent class
must be made before assignment on the child.</p>

</div>

<p>:ivar training: Boolean represents whether this module is in training or
                evaluation mode.
:vartype training: bool</p>
</div>


                            <div id="AuxParams.__init__" class="classattr">
                                        <input id="AuxParams.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">AuxParams</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">data</span><span class="p">:</span> <span class="n">torch_geometric</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">hetero_data</span><span class="o">.</span><span class="n">HeteroData</span>,</span><span class="param">	<span class="n">edgetype_specific</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">check_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">use_noise</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span></span>)</span>

                <label class="view-source-button" for="AuxParams.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AuxParams.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AuxParams.__init__-98"><a href="#AuxParams.__init__-98"><span class="linenos"> 98</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">HeteroData</span><span class="p">,</span> <span class="n">edgetype_specific</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">check_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">use_noise</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AuxParams.__init__-99"><a href="#AuxParams.__init__-99"><span class="linenos"> 99</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AuxParams.__init__-100"><a href="#AuxParams.__init__-100"><span class="linenos">100</span></a><span class="sd">        Prepare parameter dictionaries with batch correction for RNA-seq data</span>
</span><span id="AuxParams.__init__-101"><a href="#AuxParams.__init__-101"><span class="linenos">101</span></a><span class="sd">        </span>
</span><span id="AuxParams.__init__-102"><a href="#AuxParams.__init__-102"><span class="linenos">102</span></a><span class="sd">        Args:</span>
</span><span id="AuxParams.__init__-103"><a href="#AuxParams.__init__-103"><span class="linenos">103</span></a><span class="sd">            data (HeteroData): The data object containing the graph data.</span>
</span><span id="AuxParams.__init__-104"><a href="#AuxParams.__init__-104"><span class="linenos">104</span></a><span class="sd">            edgetype_specific (bool): Whether to use different parameters for different edge types.</span>
</span><span id="AuxParams.__init__-105"><a href="#AuxParams.__init__-105"><span class="linenos">105</span></a><span class="sd">        </span>
</span><span id="AuxParams.__init__-106"><a href="#AuxParams.__init__-106"><span class="linenos">106</span></a><span class="sd">        Notes:</span>
</span><span id="AuxParams.__init__-107"><a href="#AuxParams.__init__-107"><span class="linenos">107</span></a><span class="sd">            An example keylist for a parameter dictionary when edgetype_specific is True is:</span>
</span><span id="AuxParams.__init__-108"><a href="#AuxParams.__init__-108"><span class="linenos">108</span></a><span class="sd">            [</span>
</span><span id="AuxParams.__init__-109"><a href="#AuxParams.__init__-109"><span class="linenos">109</span></a><span class="sd">                &quot;cell__cell_expresses_gene&quot;,      # value shape: (num_cells,)</span>
</span><span id="AuxParams.__init__-110"><a href="#AuxParams.__init__-110"><span class="linenos">110</span></a><span class="sd">                &quot;cell__cell_has_accessible_peak&quot;, # value shape: (num_cells,)</span>
</span><span id="AuxParams.__init__-111"><a href="#AuxParams.__init__-111"><span class="linenos">111</span></a><span class="sd">                &quot;gene__cell_expresses_gene&quot;,      # value shape: (num_batches, num_genes) if use_batch else (num_genes,)</span>
</span><span id="AuxParams.__init__-112"><a href="#AuxParams.__init__-112"><span class="linenos">112</span></a><span class="sd">                &quot;peak__cell_has_accessible_peak&quot;  # value shape: (num_batches, num_peaks) if use_batch else (num_peaks,)</span>
</span><span id="AuxParams.__init__-113"><a href="#AuxParams.__init__-113"><span class="linenos">113</span></a><span class="sd">            ]</span>
</span><span id="AuxParams.__init__-114"><a href="#AuxParams.__init__-114"><span class="linenos">114</span></a><span class="sd">            But for *_logstd_dict, there is only destination node type in the key.</span>
</span><span id="AuxParams.__init__-115"><a href="#AuxParams.__init__-115"><span class="linenos">115</span></a><span class="sd">            [</span>
</span><span id="AuxParams.__init__-116"><a href="#AuxParams.__init__-116"><span class="linenos">116</span></a><span class="sd">                &quot;gene__cell_expresses_gene&quot;,</span>
</span><span id="AuxParams.__init__-117"><a href="#AuxParams.__init__-117"><span class="linenos">117</span></a><span class="sd">                &quot;peak__cell_has_accessible_peak&quot;</span>
</span><span id="AuxParams.__init__-118"><a href="#AuxParams.__init__-118"><span class="linenos">118</span></a><span class="sd">            ]</span>
</span><span id="AuxParams.__init__-119"><a href="#AuxParams.__init__-119"><span class="linenos">119</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AuxParams.__init__-120"><a href="#AuxParams.__init__-120"><span class="linenos">120</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="AuxParams.__init__-121"><a href="#AuxParams.__init__-121"><span class="linenos">121</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">edgetype_specific</span> <span class="o">=</span> <span class="n">edgetype_specific</span>
</span><span id="AuxParams.__init__-122"><a href="#AuxParams.__init__-122"><span class="linenos">122</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">use_noise</span> <span class="o">=</span> <span class="n">use_noise</span>
</span><span id="AuxParams.__init__-123"><a href="#AuxParams.__init__-123"><span class="linenos">123</span></a>
</span><span id="AuxParams.__init__-124"><a href="#AuxParams.__init__-124"><span class="linenos">124</span></a>        <span class="n">srcs</span><span class="p">,</span> <span class="n">dsts</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span> <span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dst</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_types</span><span class="p">])</span>
</span><span id="AuxParams.__init__-125"><a href="#AuxParams.__init__-125"><span class="linenos">125</span></a>        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">srcs</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">{</span><span class="s2">&quot;cell&quot;</span><span class="p">}</span> <span class="ow">and</span> <span class="nb">set</span><span class="p">(</span><span class="n">dsts</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">{</span><span class="s2">&quot;gene&quot;</span><span class="p">,</span> <span class="s2">&quot;peak&quot;</span><span class="p">},</span> <span class="s2">&quot;Only cell-gene and cell-peak edges are supported&quot;</span>
</span><span id="AuxParams.__init__-126"><a href="#AuxParams.__init__-126"><span class="linenos">126</span></a>
</span><span id="AuxParams.__init__-127"><a href="#AuxParams.__init__-127"><span class="linenos">127</span></a>        <span class="k">if</span> <span class="n">check_data</span><span class="p">:</span>
</span><span id="AuxParams.__init__-128"><a href="#AuxParams.__init__-128"><span class="linenos">128</span></a>            <span class="n">ok</span><span class="p">,</span> <span class="n">msgs</span> <span class="o">=</span> <span class="n">chk</span><span class="o">.</span><span class="n">check_heterodata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="AuxParams.__init__-129"><a href="#AuxParams.__init__-129"><span class="linenos">129</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
</span><span id="AuxParams.__init__-130"><a href="#AuxParams.__init__-130"><span class="linenos">130</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid heterodata: </span><span class="si">{</span><span class="n">msgs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AuxParams.__init__-131"><a href="#AuxParams.__init__-131"><span class="linenos">131</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="AuxParams.__init__-132"><a href="#AuxParams.__init__-132"><span class="linenos">132</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;HeteroData codes are valid: </span><span class="si">{</span><span class="n">msgs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="AuxParams.__init__-133"><a href="#AuxParams.__init__-133"><span class="linenos">133</span></a>
</span><span id="AuxParams.__init__-134"><a href="#AuxParams.__init__-134"><span class="linenos">134</span></a>        <span class="c1"># multi-sample detection</span>
</span><span id="AuxParams.__init__-135"><a href="#AuxParams.__init__-135"><span class="linenos">135</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">],</span> <span class="s2">&quot;sample&quot;</span><span class="p">):</span>
</span><span id="AuxParams.__init__-136"><a href="#AuxParams.__init__-136"><span class="linenos">136</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span>
</span><span id="AuxParams.__init__-137"><a href="#AuxParams.__init__-137"><span class="linenos">137</span></a>                <span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="AuxParams.__init__-138"><a href="#AuxParams.__init__-138"><span class="linenos">138</span></a>            <span class="p">))</span>
</span><span id="AuxParams.__init__-139"><a href="#AuxParams.__init__-139"><span class="linenos">139</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="AuxParams.__init__-140"><a href="#AuxParams.__init__-140"><span class="linenos">140</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span>
</span><span id="AuxParams.__init__-141"><a href="#AuxParams.__init__-141"><span class="linenos">141</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">multi_sample</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
</span><span id="AuxParams.__init__-142"><a href="#AuxParams.__init__-142"><span class="linenos">142</span></a>
</span><span id="AuxParams.__init__-143"><a href="#AuxParams.__init__-143"><span class="linenos">143</span></a>        <span class="c1"># if there are more than one batch, turn on use_batch</span>
</span><span id="AuxParams.__init__-144"><a href="#AuxParams.__init__-144"><span class="linenos">144</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">use_batch</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="AuxParams.__init__-145"><a href="#AuxParams.__init__-145"><span class="linenos">145</span></a>            <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">],</span> <span class="s2">&quot;batch_local&quot;</span><span class="p">)</span> 
</span><span id="AuxParams.__init__-146"><a href="#AuxParams.__init__-146"><span class="linenos">146</span></a>            <span class="ow">and</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">batch_local</span><span class="p">)</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="AuxParams.__init__-147"><a href="#AuxParams.__init__-147"><span class="linenos">147</span></a>            <span class="ow">or</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">],</span> <span class="s2">&quot;batch&quot;</span><span class="p">)</span>
</span><span id="AuxParams.__init__-148"><a href="#AuxParams.__init__-148"><span class="linenos">148</span></a>            <span class="ow">and</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">batch</span><span class="p">)</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">))</span>
</span><span id="AuxParams.__init__-149"><a href="#AuxParams.__init__-149"><span class="linenos">149</span></a>        <span class="p">)</span>
</span><span id="AuxParams.__init__-150"><a href="#AuxParams.__init__-150"><span class="linenos">150</span></a>
</span><span id="AuxParams.__init__-151"><a href="#AuxParams.__init__-151"><span class="linenos">151</span></a>        <span class="c1"># Batch correction for RNA-seq data</span>
</span><span id="AuxParams.__init__-152"><a href="#AuxParams.__init__-152"><span class="linenos">152</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ParameterDict</span><span class="p">()</span>
</span><span id="AuxParams.__init__-153"><a href="#AuxParams.__init__-153"><span class="linenos">153</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logscale_dict</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ParameterDict</span><span class="p">()</span>
</span><span id="AuxParams.__init__-154"><a href="#AuxParams.__init__-154"><span class="linenos">154</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ParameterDict</span><span class="p">()</span>
</span><span id="AuxParams.__init__-155"><a href="#AuxParams.__init__-155"><span class="linenos">155</span></a>
</span><span id="AuxParams.__init__-156"><a href="#AuxParams.__init__-156"><span class="linenos">156</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bias_logstd_dict</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ParameterDict</span><span class="p">()</span>
</span><span id="AuxParams.__init__-157"><a href="#AuxParams.__init__-157"><span class="linenos">157</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logscale_logstd_dict</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ParameterDict</span><span class="p">()</span>
</span><span id="AuxParams.__init__-158"><a href="#AuxParams.__init__-158"><span class="linenos">158</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">std_logstd_dict</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ParameterDict</span><span class="p">()</span>
</span><span id="AuxParams.__init__-159"><a href="#AuxParams.__init__-159"><span class="linenos">159</span></a>
</span><span id="AuxParams.__init__-160"><a href="#AuxParams.__init__-160"><span class="linenos">160</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict_per_sample</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">()</span>
</span><span id="AuxParams.__init__-161"><a href="#AuxParams.__init__-161"><span class="linenos">161</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logscale_dict_per_sample</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">()</span>
</span><span id="AuxParams.__init__-162"><a href="#AuxParams.__init__-162"><span class="linenos">162</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">std_dict_per_sample</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">()</span>
</span><span id="AuxParams.__init__-163"><a href="#AuxParams.__init__-163"><span class="linenos">163</span></a>
</span><span id="AuxParams.__init__-164"><a href="#AuxParams.__init__-164"><span class="linenos">164</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_sample</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_batch</span><span class="p">:</span>
</span><span id="AuxParams.__init__-165"><a href="#AuxParams.__init__-165"><span class="linenos">165</span></a>            <span class="c1"># precompute n_batches per sample</span>
</span><span id="AuxParams.__init__-166"><a href="#AuxParams.__init__-166"><span class="linenos">166</span></a>            <span class="n">n_batches_per_sample</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">sid</span><span class="p">:</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">}</span>
</span><span id="AuxParams.__init__-167"><a href="#AuxParams.__init__-167"><span class="linenos">167</span></a>            <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">:</span>
</span><span id="AuxParams.__init__-168"><a href="#AuxParams.__init__-168"><span class="linenos">168</span></a>                <span class="n">mask</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span> <span class="o">==</span> <span class="n">sid</span>
</span><span id="AuxParams.__init__-169"><a href="#AuxParams.__init__-169"><span class="linenos">169</span></a>                <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
</span><span id="AuxParams.__init__-170"><a href="#AuxParams.__init__-170"><span class="linenos">170</span></a>                    <span class="n">bmax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">batch_local</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</span><span id="AuxParams.__init__-171"><a href="#AuxParams.__init__-171"><span class="linenos">171</span></a>                    <span class="n">n_batches_per_sample</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">=</span> <span class="n">bmax</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="AuxParams.__init__-172"><a href="#AuxParams.__init__-172"><span class="linenos">172</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="AuxParams.__init__-173"><a href="#AuxParams.__init__-173"><span class="linenos">173</span></a>                    <span class="n">n_batches_per_sample</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="AuxParams.__init__-174"><a href="#AuxParams.__init__-174"><span class="linenos">174</span></a>            
</span><span id="AuxParams.__init__-175"><a href="#AuxParams.__init__-175"><span class="linenos">175</span></a>            <span class="c1"># precompute n_nodes per sample for each feature node type</span>
</span><span id="AuxParams.__init__-176"><a href="#AuxParams.__init__-176"><span class="linenos">176</span></a>            <span class="n">n_nodes_per_sample_per_type</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="AuxParams.__init__-177"><a href="#AuxParams.__init__-177"><span class="linenos">177</span></a>            <span class="k">for</span> <span class="n">node_type</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">node_types</span><span class="p">:</span>
</span><span id="AuxParams.__init__-178"><a href="#AuxParams.__init__-178"><span class="linenos">178</span></a>                <span class="k">if</span> <span class="n">node_type</span> <span class="o">==</span> <span class="s2">&quot;cell&quot;</span><span class="p">:</span>
</span><span id="AuxParams.__init__-179"><a href="#AuxParams.__init__-179"><span class="linenos">179</span></a>                    <span class="k">continue</span>
</span><span id="AuxParams.__init__-180"><a href="#AuxParams.__init__-180"><span class="linenos">180</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">node_type</span><span class="p">],</span> <span class="s2">&quot;sample&quot;</span><span class="p">):</span>
</span><span id="AuxParams.__init__-181"><a href="#AuxParams.__init__-181"><span class="linenos">181</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Node type </span><span class="si">{</span><span class="n">node_type</span><span class="si">}</span><span class="s2"> does not have sample attribute while there are multiple samples&quot;</span><span class="p">)</span>
</span><span id="AuxParams.__init__-182"><a href="#AuxParams.__init__-182"><span class="linenos">182</span></a>                <span class="n">n_nodes_per_sample_per_type</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">sid</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">}</span>
</span><span id="AuxParams.__init__-183"><a href="#AuxParams.__init__-183"><span class="linenos">183</span></a>                <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">:</span>
</span><span id="AuxParams.__init__-184"><a href="#AuxParams.__init__-184"><span class="linenos">184</span></a>                    <span class="n">mask</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span> <span class="o">==</span> <span class="n">sid</span>
</span><span id="AuxParams.__init__-185"><a href="#AuxParams.__init__-185"><span class="linenos">185</span></a>                    <span class="n">n_nodes_per_sample_per_type</span><span class="p">[</span><span class="n">node_type</span><span class="p">][</span><span class="n">sid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</span><span id="AuxParams.__init__-186"><a href="#AuxParams.__init__-186"><span class="linenos">186</span></a>        
</span><span id="AuxParams.__init__-187"><a href="#AuxParams.__init__-187"><span class="linenos">187</span></a>        <span class="c1"># build parameter containers per edge type</span>
</span><span id="AuxParams.__init__-188"><a href="#AuxParams.__init__-188"><span class="linenos">188</span></a>        <span class="k">for</span> <span class="n">edge_type</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_types</span><span class="p">:</span>
</span><span id="AuxParams.__init__-189"><a href="#AuxParams.__init__-189"><span class="linenos">189</span></a>            <span class="n">src</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dst</span> <span class="o">=</span> <span class="n">edge_type</span>
</span><span id="AuxParams.__init__-190"><a href="#AuxParams.__init__-190"><span class="linenos">190</span></a>            <span class="n">src_key</span><span class="p">,</span> <span class="n">dst_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_keys</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">edge_type</span><span class="p">)</span>
</span><span id="AuxParams.__init__-191"><a href="#AuxParams.__init__-191"><span class="linenos">191</span></a>
</span><span id="AuxParams.__init__-192"><a href="#AuxParams.__init__-192"><span class="linenos">192</span></a>            <span class="n">num_src_nodes</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">src</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span>
</span><span id="AuxParams.__init__-193"><a href="#AuxParams.__init__-193"><span class="linenos">193</span></a>            <span class="n">num_dst_nodes</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span>
</span><span id="AuxParams.__init__-194"><a href="#AuxParams.__init__-194"><span class="linenos">194</span></a>
</span><span id="AuxParams.__init__-195"><a href="#AuxParams.__init__-195"><span class="linenos">195</span></a>            <span class="c1"># src params: always per-node</span>
</span><span id="AuxParams.__init__-196"><a href="#AuxParams.__init__-196"><span class="linenos">196</span></a>            <span class="k">if</span> <span class="n">src_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">:</span>
</span><span id="AuxParams.__init__-197"><a href="#AuxParams.__init__-197"><span class="linenos">197</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">[</span><span class="n">src_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_src_nodes</span><span class="p">))</span>
</span><span id="AuxParams.__init__-198"><a href="#AuxParams.__init__-198"><span class="linenos">198</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logscale_dict</span><span class="p">[</span><span class="n">src_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_src_nodes</span><span class="p">))</span>
</span><span id="AuxParams.__init__-199"><a href="#AuxParams.__init__-199"><span class="linenos">199</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span><span class="p">[</span><span class="n">src_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_src_nodes</span><span class="p">))</span>
</span><span id="AuxParams.__init__-200"><a href="#AuxParams.__init__-200"><span class="linenos">200</span></a>            
</span><span id="AuxParams.__init__-201"><a href="#AuxParams.__init__-201"><span class="linenos">201</span></a>            <span class="c1"># dst params: depending on use_batch and multi_sample</span>
</span><span id="AuxParams.__init__-202"><a href="#AuxParams.__init__-202"><span class="linenos">202</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_batch</span><span class="p">:</span>
</span><span id="AuxParams.__init__-203"><a href="#AuxParams.__init__-203"><span class="linenos">203</span></a>                <span class="k">if</span> <span class="n">dst_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">:</span>
</span><span id="AuxParams.__init__-204"><a href="#AuxParams.__init__-204"><span class="linenos">204</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_dst_nodes</span><span class="p">))</span>
</span><span id="AuxParams.__init__-205"><a href="#AuxParams.__init__-205"><span class="linenos">205</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">logscale_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_dst_nodes</span><span class="p">))</span>
</span><span id="AuxParams.__init__-206"><a href="#AuxParams.__init__-206"><span class="linenos">206</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_dst_nodes</span><span class="p">))</span>
</span><span id="AuxParams.__init__-207"><a href="#AuxParams.__init__-207"><span class="linenos">207</span></a>            <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_sample</span><span class="p">:</span>
</span><span id="AuxParams.__init__-208"><a href="#AuxParams.__init__-208"><span class="linenos">208</span></a>                <span class="n">_batch</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">batch</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">],</span> <span class="s2">&quot;batch&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">batch_local</span>
</span><span id="AuxParams.__init__-209"><a href="#AuxParams.__init__-209"><span class="linenos">209</span></a>                <span class="n">n_batches</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">_batch</span><span class="p">)</span><span class="o">.</span><span class="n">numel</span><span class="p">())</span>
</span><span id="AuxParams.__init__-210"><a href="#AuxParams.__init__-210"><span class="linenos">210</span></a>                <span class="k">if</span> <span class="n">dst_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">:</span>
</span><span id="AuxParams.__init__-211"><a href="#AuxParams.__init__-211"><span class="linenos">211</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">num_dst_nodes</span><span class="p">))</span>
</span><span id="AuxParams.__init__-212"><a href="#AuxParams.__init__-212"><span class="linenos">212</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">logscale_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">num_dst_nodes</span><span class="p">))</span>
</span><span id="AuxParams.__init__-213"><a href="#AuxParams.__init__-213"><span class="linenos">213</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">num_dst_nodes</span><span class="p">))</span>
</span><span id="AuxParams.__init__-214"><a href="#AuxParams.__init__-214"><span class="linenos">214</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">bias_logstd_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">num_dst_nodes</span><span class="p">))</span>
</span><span id="AuxParams.__init__-215"><a href="#AuxParams.__init__-215"><span class="linenos">215</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">logscale_logstd_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">num_dst_nodes</span><span class="p">))</span>
</span><span id="AuxParams.__init__-216"><a href="#AuxParams.__init__-216"><span class="linenos">216</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">std_logstd_dict</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="n">num_dst_nodes</span><span class="p">))</span>
</span><span id="AuxParams.__init__-217"><a href="#AuxParams.__init__-217"><span class="linenos">217</span></a>            <span class="k">else</span><span class="p">:</span> <span class="c1"># multi-sample and use_batch</span>
</span><span id="AuxParams.__init__-218"><a href="#AuxParams.__init__-218"><span class="linenos">218</span></a>                <span class="k">if</span> <span class="n">dst_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict_per_sample</span><span class="p">:</span>
</span><span id="AuxParams.__init__-219"><a href="#AuxParams.__init__-219"><span class="linenos">219</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict_per_sample</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_PerSampleBatchedParam</span><span class="p">(</span>
</span><span id="AuxParams.__init__-220"><a href="#AuxParams.__init__-220"><span class="linenos">220</span></a>                        <span class="n">n_batches_per_sample</span><span class="o">=</span><span class="n">n_batches_per_sample</span><span class="p">,</span>
</span><span id="AuxParams.__init__-221"><a href="#AuxParams.__init__-221"><span class="linenos">221</span></a>                        <span class="n">n_nodes_per_sample</span><span class="o">=</span><span class="n">n_nodes_per_sample_per_type</span><span class="p">[</span><span class="n">dst</span><span class="p">],</span>
</span><span id="AuxParams.__init__-222"><a href="#AuxParams.__init__-222"><span class="linenos">222</span></a>                        <span class="n">sample_ids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">,</span>
</span><span id="AuxParams.__init__-223"><a href="#AuxParams.__init__-223"><span class="linenos">223</span></a>                        <span class="n">init</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="AuxParams.__init__-224"><a href="#AuxParams.__init__-224"><span class="linenos">224</span></a>                    <span class="p">)</span>
</span><span id="AuxParams.__init__-225"><a href="#AuxParams.__init__-225"><span class="linenos">225</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">logscale_dict_per_sample</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_PerSampleBatchedParam</span><span class="p">(</span>
</span><span id="AuxParams.__init__-226"><a href="#AuxParams.__init__-226"><span class="linenos">226</span></a>                        <span class="n">n_batches_per_sample</span><span class="o">=</span><span class="n">n_batches_per_sample</span><span class="p">,</span>
</span><span id="AuxParams.__init__-227"><a href="#AuxParams.__init__-227"><span class="linenos">227</span></a>                        <span class="n">n_nodes_per_sample</span><span class="o">=</span><span class="n">n_nodes_per_sample_per_type</span><span class="p">[</span><span class="n">dst</span><span class="p">],</span>
</span><span id="AuxParams.__init__-228"><a href="#AuxParams.__init__-228"><span class="linenos">228</span></a>                        <span class="n">sample_ids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">,</span>
</span><span id="AuxParams.__init__-229"><a href="#AuxParams.__init__-229"><span class="linenos">229</span></a>                        <span class="n">init</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="AuxParams.__init__-230"><a href="#AuxParams.__init__-230"><span class="linenos">230</span></a>                    <span class="p">)</span>
</span><span id="AuxParams.__init__-231"><a href="#AuxParams.__init__-231"><span class="linenos">231</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">std_dict_per_sample</span><span class="p">[</span><span class="n">dst_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_PerSampleBatchedParam</span><span class="p">(</span>
</span><span id="AuxParams.__init__-232"><a href="#AuxParams.__init__-232"><span class="linenos">232</span></a>                        <span class="n">n_batches_per_sample</span><span class="o">=</span><span class="n">n_batches_per_sample</span><span class="p">,</span>
</span><span id="AuxParams.__init__-233"><a href="#AuxParams.__init__-233"><span class="linenos">233</span></a>                        <span class="n">n_nodes_per_sample</span><span class="o">=</span><span class="n">n_nodes_per_sample_per_type</span><span class="p">[</span><span class="n">dst</span><span class="p">],</span>
</span><span id="AuxParams.__init__-234"><a href="#AuxParams.__init__-234"><span class="linenos">234</span></a>                        <span class="n">sample_ids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_ids</span><span class="p">,</span>
</span><span id="AuxParams.__init__-235"><a href="#AuxParams.__init__-235"><span class="linenos">235</span></a>                        <span class="n">init</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="AuxParams.__init__-236"><a href="#AuxParams.__init__-236"><span class="linenos">236</span></a>                    <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Prepare parameter dictionaries with batch correction for RNA-seq data</p>

<p>Args:
    data (HeteroData): The data object containing the graph data.
    edgetype_specific (bool): Whether to use different parameters for different edge types.</p>

<p>Notes:
    An example keylist for a parameter dictionary when edgetype_specific is True is:
    [
        "cell__cell_expresses_gene",      # value shape: (num_cells,)
        "cell__cell_has_accessible_peak", # value shape: (num_cells,)
        "gene__cell_expresses_gene",      # value shape: (num_batches, num_genes) if use_batch else (num_genes,)
        "peak__cell_has_accessible_peak"  # value shape: (num_batches, num_peaks) if use_batch else (num_peaks,)
    ]
    But for *_logstd_dict, there is only destination node type in the key.
    [
        "gene__cell_expresses_gene",
        "peak__cell_has_accessible_peak"
    ]</p>
</div>


                            </div>
                            <div id="AuxParams.edgetype_specific" class="classattr">
                                <div class="attr variable">
            <span class="name">edgetype_specific</span>

        
    </div>
    <a class="headerlink" href="#AuxParams.edgetype_specific"></a>
    
    

                            </div>
                            <div id="AuxParams.use_noise" class="classattr">
                                <div class="attr variable">
            <span class="name">use_noise</span>

        
    </div>
    <a class="headerlink" href="#AuxParams.use_noise"></a>
    
    

                            </div>
                            <div id="AuxParams.multi_sample" class="classattr">
                                <div class="attr variable">
            <span class="name">multi_sample</span>

        
    </div>
    <a class="headerlink" href="#AuxParams.multi_sample"></a>
    
    

                            </div>
                            <div id="AuxParams.use_batch" class="classattr">
                                <div class="attr variable">
            <span class="name">use_batch</span>

        
    </div>
    <a class="headerlink" href="#AuxParams.use_batch"></a>
    
    

                            </div>
                            <div id="AuxParams.bias_dict" class="classattr">
                                <div class="attr variable">
            <span class="name">bias_dict</span>

        
    </div>
    <a class="headerlink" href="#AuxParams.bias_dict"></a>
    
    

                            </div>
                            <div id="AuxParams.logscale_dict" class="classattr">
                                <div class="attr variable">
            <span class="name">logscale_dict</span>

        
    </div>
    <a class="headerlink" href="#AuxParams.logscale_dict"></a>
    
    

                            </div>
                            <div id="AuxParams.std_dict" class="classattr">
                                <div class="attr variable">
            <span class="name">std_dict</span>

        
    </div>
    <a class="headerlink" href="#AuxParams.std_dict"></a>
    
    

                            </div>
                            <div id="AuxParams.bias_logstd_dict" class="classattr">
                                <div class="attr variable">
            <span class="name">bias_logstd_dict</span>

        
    </div>
    <a class="headerlink" href="#AuxParams.bias_logstd_dict"></a>
    
    

                            </div>
                            <div id="AuxParams.logscale_logstd_dict" class="classattr">
                                <div class="attr variable">
            <span class="name">logscale_logstd_dict</span>

        
    </div>
    <a class="headerlink" href="#AuxParams.logscale_logstd_dict"></a>
    
    

                            </div>
                            <div id="AuxParams.std_logstd_dict" class="classattr">
                                <div class="attr variable">
            <span class="name">std_logstd_dict</span>

        
    </div>
    <a class="headerlink" href="#AuxParams.std_logstd_dict"></a>
    
    

                            </div>
                            <div id="AuxParams.bias_dict_per_sample" class="classattr">
                                <div class="attr variable">
            <span class="name">bias_dict_per_sample</span>

        
    </div>
    <a class="headerlink" href="#AuxParams.bias_dict_per_sample"></a>
    
    

                            </div>
                            <div id="AuxParams.logscale_dict_per_sample" class="classattr">
                                <div class="attr variable">
            <span class="name">logscale_dict_per_sample</span>

        
    </div>
    <a class="headerlink" href="#AuxParams.logscale_dict_per_sample"></a>
    
    

                            </div>
                            <div id="AuxParams.std_dict_per_sample" class="classattr">
                                <div class="attr variable">
            <span class="name">std_dict_per_sample</span>

        
    </div>
    <a class="headerlink" href="#AuxParams.std_dict_per_sample"></a>
    
    

                            </div>
                            <div id="AuxParams.batched" class="classattr">
                                        <input id="AuxParams.batched-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">batched</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">param</span>, </span><span class="param"><span class="n">param_logstd</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AuxParams.batched-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AuxParams.batched"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AuxParams.batched-238"><a href="#AuxParams.batched-238"><span class="linenos">238</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">batched</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">param_logstd</span><span class="p">):</span>
</span><span id="AuxParams.batched-239"><a href="#AuxParams.batched-239"><span class="linenos">239</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AuxParams.batched-240"><a href="#AuxParams.batched-240"><span class="linenos">240</span></a><span class="sd">        Generate a batch of stochastic parameters based on baseline parameters, offsets, and deviations.</span>
</span><span id="AuxParams.batched-241"><a href="#AuxParams.batched-241"><span class="linenos">241</span></a>
</span><span id="AuxParams.batched-242"><a href="#AuxParams.batched-242"><span class="linenos">242</span></a><span class="sd">        Args:</span>
</span><span id="AuxParams.batched-243"><a href="#AuxParams.batched-243"><span class="linenos">243</span></a><span class="sd">            param: Baseline and offset parameters, shape: (num_batches, num_nodes)</span>
</span><span id="AuxParams.batched-244"><a href="#AuxParams.batched-244"><span class="linenos">244</span></a><span class="sd">            param_logstd: Log standard deviations, shape: (num_batches, num_nodes)</span>
</span><span id="AuxParams.batched-245"><a href="#AuxParams.batched-245"><span class="linenos">245</span></a>
</span><span id="AuxParams.batched-246"><a href="#AuxParams.batched-246"><span class="linenos">246</span></a><span class="sd">        Returns:</span>
</span><span id="AuxParams.batched-247"><a href="#AuxParams.batched-247"><span class="linenos">247</span></a><span class="sd">            Stochastic parameters, shape: (num_batches, num_nodes)</span>
</span><span id="AuxParams.batched-248"><a href="#AuxParams.batched-248"><span class="linenos">248</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AuxParams.batched-249"><a href="#AuxParams.batched-249"><span class="linenos">249</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_noise</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_batch</span><span class="p">:</span>
</span><span id="AuxParams.batched-250"><a href="#AuxParams.batched-250"><span class="linenos">250</span></a>            <span class="k">assert</span> <span class="n">param</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;param must be a 2D tensor when use_batch is True, but got </span><span class="si">{</span><span class="n">param</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span><span class="si">}</span><span class="s2">D tensor&quot;</span>
</span><span id="AuxParams.batched-251"><a href="#AuxParams.batched-251"><span class="linenos">251</span></a>            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="AuxParams.batched-252"><a href="#AuxParams.batched-252"><span class="linenos">252</span></a>                <span class="k">return</span> <span class="n">param</span>
</span><span id="AuxParams.batched-253"><a href="#AuxParams.batched-253"><span class="linenos">253</span></a>            <span class="n">return_param</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
</span><span id="AuxParams.batched-254"><a href="#AuxParams.batched-254"><span class="linenos">254</span></a>                <span class="p">[</span>
</span><span id="AuxParams.batched-255"><a href="#AuxParams.batched-255"><span class="linenos">255</span></a>                    <span class="n">param</span><span class="p">[[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:],</span>
</span><span id="AuxParams.batched-256"><a href="#AuxParams.batched-256"><span class="linenos">256</span></a>                    <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">param</span><span class="p">[[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">param_logstd</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:])</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">param_logstd</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]),</span>
</span><span id="AuxParams.batched-257"><a href="#AuxParams.batched-257"><span class="linenos">257</span></a>                <span class="p">],</span>
</span><span id="AuxParams.batched-258"><a href="#AuxParams.batched-258"><span class="linenos">258</span></a>                <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="AuxParams.batched-259"><a href="#AuxParams.batched-259"><span class="linenos">259</span></a>            <span class="p">)</span>
</span><span id="AuxParams.batched-260"><a href="#AuxParams.batched-260"><span class="linenos">260</span></a>            <span class="k">return</span> <span class="n">return_param</span>
</span><span id="AuxParams.batched-261"><a href="#AuxParams.batched-261"><span class="linenos">261</span></a>        <span class="k">return</span> <span class="n">param</span>
</span></pre></div>


            <div class="docstring"><p>Generate a batch of stochastic parameters based on baseline parameters, offsets, and deviations.</p>

<p>Args:
    param: Baseline and offset parameters, shape: (num_batches, num_nodes)
    param_logstd: Log standard deviations, shape: (num_batches, num_nodes)</p>

<p>Returns:
    Stochastic parameters, shape: (num_batches, num_nodes)</p>
</div>


                            </div>
                            <div id="AuxParams.forward" class="classattr">
                                        <input id="AuxParams.forward-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">forward</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">batch</span>, </span><span class="param"><span class="n">edge_index_dict</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AuxParams.forward-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AuxParams.forward"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AuxParams.forward-331"><a href="#AuxParams.forward-331"><span class="linenos">331</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">edge_index_dict</span><span class="p">):</span>
</span><span id="AuxParams.forward-332"><a href="#AuxParams.forward-332"><span class="linenos">332</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AuxParams.forward-333"><a href="#AuxParams.forward-333"><span class="linenos">333</span></a><span class="sd">        Get the parameters for the given batch and edge index dictionary.</span>
</span><span id="AuxParams.forward-334"><a href="#AuxParams.forward-334"><span class="linenos">334</span></a>
</span><span id="AuxParams.forward-335"><a href="#AuxParams.forward-335"><span class="linenos">335</span></a><span class="sd">        Args:</span>
</span><span id="AuxParams.forward-336"><a href="#AuxParams.forward-336"><span class="linenos">336</span></a><span class="sd">            batch: Batch object, providing</span>
</span><span id="AuxParams.forward-337"><a href="#AuxParams.forward-337"><span class="linenos">337</span></a><span class="sd">                - batch[node_type].n_id: help convert local node IDs in `edge_index_dict` to global node IDs</span>
</span><span id="AuxParams.forward-338"><a href="#AuxParams.forward-338"><span class="linenos">338</span></a><span class="sd">                - batch[&quot;cell&quot;].batch: provide batch information for the cells</span>
</span><span id="AuxParams.forward-339"><a href="#AuxParams.forward-339"><span class="linenos">339</span></a><span class="sd">            edge_index_dict: Edge index dictionary, each value is a tensor of shape (2, num_edges) with local node IDs</span>
</span><span id="AuxParams.forward-340"><a href="#AuxParams.forward-340"><span class="linenos">340</span></a>
</span><span id="AuxParams.forward-341"><a href="#AuxParams.forward-341"><span class="linenos">341</span></a><span class="sd">        Returns:</span>
</span><span id="AuxParams.forward-342"><a href="#AuxParams.forward-342"><span class="linenos">342</span></a><span class="sd">            Dictionary of parameters for the given batch and edge index dictionary</span>
</span><span id="AuxParams.forward-343"><a href="#AuxParams.forward-343"><span class="linenos">343</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AuxParams.forward-344"><a href="#AuxParams.forward-344"><span class="linenos">344</span></a>        <span class="n">src_logscale_dict</span><span class="p">,</span> <span class="n">src_bias_dict</span><span class="p">,</span> <span class="n">src_std_dict</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>
</span><span id="AuxParams.forward-345"><a href="#AuxParams.forward-345"><span class="linenos">345</span></a>        <span class="n">dst_logscale_dict</span><span class="p">,</span> <span class="n">dst_bias_dict</span><span class="p">,</span> <span class="n">dst_std_dict</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>
</span><span id="AuxParams.forward-346"><a href="#AuxParams.forward-346"><span class="linenos">346</span></a>        <span class="k">for</span> <span class="n">edge_type</span><span class="p">,</span> <span class="n">edge_index</span> <span class="ow">in</span> <span class="n">edge_index_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="AuxParams.forward-347"><a href="#AuxParams.forward-347"><span class="linenos">347</span></a>            <span class="n">src_type</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dst_type</span> <span class="o">=</span> <span class="n">edge_type</span>
</span><span id="AuxParams.forward-348"><a href="#AuxParams.forward-348"><span class="linenos">348</span></a>            <span class="n">src_key</span><span class="p">,</span> <span class="n">dst_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_keys</span><span class="p">(</span><span class="n">src_type</span><span class="p">,</span> <span class="n">dst_type</span><span class="p">,</span> <span class="n">edge_type</span><span class="p">)</span>
</span><span id="AuxParams.forward-349"><a href="#AuxParams.forward-349"><span class="linenos">349</span></a>
</span><span id="AuxParams.forward-350"><a href="#AuxParams.forward-350"><span class="linenos">350</span></a>            <span class="n">src_node_id</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="n">src_type</span><span class="p">]</span><span class="o">.</span><span class="n">n_id</span><span class="p">[</span><span class="n">edge_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="c1"># local id to global id</span>
</span><span id="AuxParams.forward-351"><a href="#AuxParams.forward-351"><span class="linenos">351</span></a>            <span class="n">src_logscale_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logscale_dict</span><span class="p">[</span><span class="n">src_key</span><span class="p">][</span><span class="n">src_node_id</span><span class="p">]</span>
</span><span id="AuxParams.forward-352"><a href="#AuxParams.forward-352"><span class="linenos">352</span></a>            <span class="n">src_bias_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_dict</span><span class="p">[</span><span class="n">src_key</span><span class="p">][</span><span class="n">src_node_id</span><span class="p">]</span>
</span><span id="AuxParams.forward-353"><a href="#AuxParams.forward-353"><span class="linenos">353</span></a>            <span class="n">src_std_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">std_dict</span><span class="p">[</span><span class="n">src_key</span><span class="p">][</span><span class="n">src_node_id</span><span class="p">]</span>
</span><span id="AuxParams.forward-354"><a href="#AuxParams.forward-354"><span class="linenos">354</span></a>
</span><span id="AuxParams.forward-355"><a href="#AuxParams.forward-355"><span class="linenos">355</span></a>            <span class="n">dst_logscale_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dst_values_per_edge</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">dst_type</span><span class="p">,</span> <span class="n">dst_key</span><span class="p">,</span> <span class="s2">&quot;logscale&quot;</span><span class="p">)</span>
</span><span id="AuxParams.forward-356"><a href="#AuxParams.forward-356"><span class="linenos">356</span></a>            <span class="n">dst_bias_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dst_values_per_edge</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">dst_type</span><span class="p">,</span> <span class="n">dst_key</span><span class="p">,</span> <span class="s2">&quot;bias&quot;</span><span class="p">)</span>
</span><span id="AuxParams.forward-357"><a href="#AuxParams.forward-357"><span class="linenos">357</span></a>            <span class="n">dst_std_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dst_values_per_edge</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">dst_type</span><span class="p">,</span> <span class="n">dst_key</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">)</span>
</span><span id="AuxParams.forward-358"><a href="#AuxParams.forward-358"><span class="linenos">358</span></a>        
</span><span id="AuxParams.forward-359"><a href="#AuxParams.forward-359"><span class="linenos">359</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="AuxParams.forward-360"><a href="#AuxParams.forward-360"><span class="linenos">360</span></a>            <span class="s2">&quot;src_logscale_dict&quot;</span><span class="p">:</span> <span class="n">src_logscale_dict</span><span class="p">,</span>
</span><span id="AuxParams.forward-361"><a href="#AuxParams.forward-361"><span class="linenos">361</span></a>            <span class="s2">&quot;src_bias_dict&quot;</span><span class="p">:</span> <span class="n">src_bias_dict</span><span class="p">,</span>
</span><span id="AuxParams.forward-362"><a href="#AuxParams.forward-362"><span class="linenos">362</span></a>            <span class="s2">&quot;src_std_dict&quot;</span><span class="p">:</span> <span class="n">src_std_dict</span><span class="p">,</span>
</span><span id="AuxParams.forward-363"><a href="#AuxParams.forward-363"><span class="linenos">363</span></a>            <span class="s2">&quot;dst_logscale_dict&quot;</span><span class="p">:</span> <span class="n">dst_logscale_dict</span><span class="p">,</span>
</span><span id="AuxParams.forward-364"><a href="#AuxParams.forward-364"><span class="linenos">364</span></a>            <span class="s2">&quot;dst_bias_dict&quot;</span><span class="p">:</span> <span class="n">dst_bias_dict</span><span class="p">,</span>
</span><span id="AuxParams.forward-365"><a href="#AuxParams.forward-365"><span class="linenos">365</span></a>            <span class="s2">&quot;dst_std_dict&quot;</span><span class="p">:</span> <span class="n">dst_std_dict</span><span class="p">,</span>
</span><span id="AuxParams.forward-366"><a href="#AuxParams.forward-366"><span class="linenos">366</span></a>        <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Get the parameters for the given batch and edge index dictionary.</p>

<p>Args:
    batch: Batch object, providing
        - batch[node_type].n_id: help convert local node IDs in <code>edge_index_dict</code> to global node IDs
        - batch["cell"].batch: provide batch information for the cells
    edge_index_dict: Edge index dictionary, each value is a tensor of shape (2, num_edges) with local node IDs</p>

<p>Returns:
    Dictionary of parameters for the given batch and edge index dictionary</p>
</div>


                            </div>
                            <div id="AuxParams.get_keys" class="classattr">
                                        <input id="AuxParams.get_keys-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_keys</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">src_type</span>, </span><span class="param"><span class="n">dst_type</span>, </span><span class="param"><span class="n">edge_type</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AuxParams.get_keys-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AuxParams.get_keys"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AuxParams.get_keys-368"><a href="#AuxParams.get_keys-368"><span class="linenos">368</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_type</span><span class="p">,</span> <span class="n">dst_type</span><span class="p">,</span> <span class="n">edge_type</span><span class="p">):</span>
</span><span id="AuxParams.get_keys-369"><a href="#AuxParams.get_keys-369"><span class="linenos">369</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">edgetype_specific</span><span class="p">:</span>
</span><span id="AuxParams.get_keys-370"><a href="#AuxParams.get_keys-370"><span class="linenos">370</span></a>            <span class="n">src_key</span> <span class="o">=</span> <span class="n">make_key</span><span class="p">(</span><span class="n">src_type</span><span class="p">,</span> <span class="n">edge_type</span><span class="p">)</span>
</span><span id="AuxParams.get_keys-371"><a href="#AuxParams.get_keys-371"><span class="linenos">371</span></a>            <span class="n">dst_key</span> <span class="o">=</span> <span class="n">make_key</span><span class="p">(</span><span class="n">dst_type</span><span class="p">,</span> <span class="n">edge_type</span><span class="p">)</span>
</span><span id="AuxParams.get_keys-372"><a href="#AuxParams.get_keys-372"><span class="linenos">372</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="AuxParams.get_keys-373"><a href="#AuxParams.get_keys-373"><span class="linenos">373</span></a>            <span class="n">src_key</span> <span class="o">=</span> <span class="n">src_type</span>
</span><span id="AuxParams.get_keys-374"><a href="#AuxParams.get_keys-374"><span class="linenos">374</span></a>            <span class="n">dst_key</span> <span class="o">=</span> <span class="n">dst_type</span>
</span><span id="AuxParams.get_keys-375"><a href="#AuxParams.get_keys-375"><span class="linenos">375</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="AuxParams.get_keys-376"><a href="#AuxParams.get_keys-376"><span class="linenos">376</span></a>            <span class="n">src_key</span><span class="p">,</span>
</span><span id="AuxParams.get_keys-377"><a href="#AuxParams.get_keys-377"><span class="linenos">377</span></a>            <span class="n">dst_key</span><span class="p">,</span>
</span><span id="AuxParams.get_keys-378"><a href="#AuxParams.get_keys-378"><span class="linenos">378</span></a>        <span class="p">)</span>
</span></pre></div>


    

                            </div>
                </section>
                <section id="LightningProxModel">
                            <input id="LightningProxModel-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">LightningProxModel</span><wbr>(<span class="base">lightning.pytorch.core.module.LightningModule</span>):

                <label class="view-source-button" for="LightningProxModel-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel-381"><a href="#LightningProxModel-381"><span class="linenos"> 381</span></a><span class="k">class</span><span class="w"> </span><span class="nc">LightningProxModel</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">):</span>
</span><span id="LightningProxModel-382"><a href="#LightningProxModel-382"><span class="linenos"> 382</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="LightningProxModel-383"><a href="#LightningProxModel-383"><span class="linenos"> 383</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LightningProxModel-384"><a href="#LightningProxModel-384"><span class="linenos"> 384</span></a>        <span class="n">data</span><span class="p">:</span> <span class="n">HeteroData</span><span class="p">,</span>
</span><span id="LightningProxModel-385"><a href="#LightningProxModel-385"><span class="linenos"> 385</span></a>        <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel-386"><a href="#LightningProxModel-386"><span class="linenos"> 386</span></a>        <span class="n">encoder_class</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span> <span class="o">=</span> <span class="n">TransEncoder</span><span class="p">,</span>
</span><span id="LightningProxModel-387"><a href="#LightningProxModel-387"><span class="linenos"> 387</span></a>        <span class="n">n_latent_dims</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
</span><span id="LightningProxModel-388"><a href="#LightningProxModel-388"><span class="linenos"> 388</span></a>        <span class="n">decoder_class</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span> <span class="o">=</span> <span class="n">RelationalEdgeDistributionDecoder</span><span class="p">,</span>
</span><span id="LightningProxModel-389"><a href="#LightningProxModel-389"><span class="linenos"> 389</span></a>        <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel-390"><a href="#LightningProxModel-390"><span class="linenos"> 390</span></a>        <span class="n">num_neg_samples_fold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="LightningProxModel-391"><a href="#LightningProxModel-391"><span class="linenos"> 391</span></a>        <span class="n">edgetype_specific</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="LightningProxModel-392"><a href="#LightningProxModel-392"><span class="linenos"> 392</span></a>        <span class="n">edge_types</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel-393"><a href="#LightningProxModel-393"><span class="linenos"> 393</span></a>        <span class="n">hsic</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel-394"><a href="#LightningProxModel-394"><span class="linenos"> 394</span></a>        <span class="n">herit_loss</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel-395"><a href="#LightningProxModel-395"><span class="linenos"> 395</span></a>        <span class="n">herit_loss_lam</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="LightningProxModel-396"><a href="#LightningProxModel-396"><span class="linenos"> 396</span></a>        <span class="n">kl_lambda</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
</span><span id="LightningProxModel-397"><a href="#LightningProxModel-397"><span class="linenos"> 397</span></a>        <span class="n">kl_n_no</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
</span><span id="LightningProxModel-398"><a href="#LightningProxModel-398"><span class="linenos"> 398</span></a>        <span class="n">kl_n_warmup</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
</span><span id="LightningProxModel-399"><a href="#LightningProxModel-399"><span class="linenos"> 399</span></a>        <span class="c1"># nll_scale: float = 1.0,</span>
</span><span id="LightningProxModel-400"><a href="#LightningProxModel-400"><span class="linenos"> 400</span></a>        <span class="c1"># val_nll_scale: float = 1.0,</span>
</span><span id="LightningProxModel-401"><a href="#LightningProxModel-401"><span class="linenos"> 401</span></a>        <span class="n">learning_rate</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span>
</span><span id="LightningProxModel-402"><a href="#LightningProxModel-402"><span class="linenos"> 402</span></a>        <span class="n">node_weights_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel-403"><a href="#LightningProxModel-403"><span class="linenos"> 403</span></a>        <span class="c1"># nonneg=False, #not used</span>
</span><span id="LightningProxModel-404"><a href="#LightningProxModel-404"><span class="linenos"> 404</span></a>        <span class="n">reweight_rarecell</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel-405"><a href="#LightningProxModel-405"><span class="linenos"> 405</span></a>        <span class="n">reweight_rarecell_neighbors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel-406"><a href="#LightningProxModel-406"><span class="linenos"> 406</span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel-407"><a href="#LightningProxModel-407"><span class="linenos"> 407</span></a>        <span class="n">batch_negative</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># make the default same as in the CLI</span>
</span><span id="LightningProxModel-408"><a href="#LightningProxModel-408"><span class="linenos"> 408</span></a>        <span class="n">monitor_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel-409"><a href="#LightningProxModel-409"><span class="linenos"> 409</span></a>
</span><span id="LightningProxModel-410"><a href="#LightningProxModel-410"><span class="linenos"> 410</span></a>        <span class="n">gene_align_lambda</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
</span><span id="LightningProxModel-411"><a href="#LightningProxModel-411"><span class="linenos"> 411</span></a>        <span class="n">gene_align_n_no</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="LightningProxModel-412"><a href="#LightningProxModel-412"><span class="linenos"> 412</span></a>        <span class="n">gene_align_n_warmup</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
</span><span id="LightningProxModel-413"><a href="#LightningProxModel-413"><span class="linenos"> 413</span></a>        <span class="n">ot_cs_lambda</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
</span><span id="LightningProxModel-414"><a href="#LightningProxModel-414"><span class="linenos"> 414</span></a>        <span class="n">ot_cs_n_no</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
</span><span id="LightningProxModel-415"><a href="#LightningProxModel-415"><span class="linenos"> 415</span></a>        <span class="n">ot_cs_n_warmup</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
</span><span id="LightningProxModel-416"><a href="#LightningProxModel-416"><span class="linenos"> 416</span></a>        <span class="n">ot_cs_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
</span><span id="LightningProxModel-417"><a href="#LightningProxModel-417"><span class="linenos"> 417</span></a>        <span class="n">ot_cb_lambda</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
</span><span id="LightningProxModel-418"><a href="#LightningProxModel-418"><span class="linenos"> 418</span></a>        <span class="n">ot_cb_n_no</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
</span><span id="LightningProxModel-419"><a href="#LightningProxModel-419"><span class="linenos"> 419</span></a>        <span class="n">ot_cb_n_warmup</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
</span><span id="LightningProxModel-420"><a href="#LightningProxModel-420"><span class="linenos"> 420</span></a>        <span class="n">ot_cb_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
</span><span id="LightningProxModel-421"><a href="#LightningProxModel-421"><span class="linenos"> 421</span></a>        <span class="n">ot_eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
</span><span id="LightningProxModel-422"><a href="#LightningProxModel-422"><span class="linenos"> 422</span></a>        <span class="n">ot_iter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
</span><span id="LightningProxModel-423"><a href="#LightningProxModel-423"><span class="linenos"> 423</span></a>        <span class="n">ot_plan_every_n_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="c1"># invalid if 0</span>
</span><span id="LightningProxModel-424"><a href="#LightningProxModel-424"><span class="linenos"> 424</span></a>        <span class="n">ot_loss_every_n_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># if 0, once per epoch (first batch)</span>
</span><span id="LightningProxModel-425"><a href="#LightningProxModel-425"><span class="linenos"> 425</span></a>
</span><span id="LightningProxModel-426"><a href="#LightningProxModel-426"><span class="linenos"> 426</span></a>        <span class="c1"># DEBUG</span>
</span><span id="LightningProxModel-427"><a href="#LightningProxModel-427"><span class="linenos"> 427</span></a>        <span class="n">use_aux</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="LightningProxModel-428"><a href="#LightningProxModel-428"><span class="linenos"> 428</span></a>        <span class="n">use_aux_noise</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel-429"><a href="#LightningProxModel-429"><span class="linenos"> 429</span></a>    <span class="p">):</span>
</span><span id="LightningProxModel-430"><a href="#LightningProxModel-430"><span class="linenos"> 430</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="LightningProxModel-431"><a href="#LightningProxModel-431"><span class="linenos"> 431</span></a>        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel-432"><a href="#LightningProxModel-432"><span class="linenos"> 432</span></a>            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;device is deprecated and will be removed in future versions.&quot;</span>\
</span><span id="LightningProxModel-433"><a href="#LightningProxModel-433"><span class="linenos"> 433</span></a>                <span class="s2">&quot;Please use `model.to(device)` to move the model to the desired device instead.&quot;</span><span class="p">)</span>
</span><span id="LightningProxModel-434"><a href="#LightningProxModel-434"><span class="linenos"> 434</span></a>        
</span><span id="LightningProxModel-435"><a href="#LightningProxModel-435"><span class="linenos"> 435</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">save_hyperparameters</span><span class="p">()</span>
</span><span id="LightningProxModel-436"><a href="#LightningProxModel-436"><span class="linenos"> 436</span></a>        <span class="c1"># self.nonneg = nonneg</span>
</span><span id="LightningProxModel-437"><a href="#LightningProxModel-437"><span class="linenos"> 437</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
</span><span id="LightningProxModel-438"><a href="#LightningProxModel-438"><span class="linenos"> 438</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span> <span class="o">=</span> <span class="n">logger</span>
</span><span id="LightningProxModel-439"><a href="#LightningProxModel-439"><span class="linenos"> 439</span></a>        
</span><span id="LightningProxModel-440"><a href="#LightningProxModel-440"><span class="linenos"> 440</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel-441"><a href="#LightningProxModel-441"><span class="linenos"> 441</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span> <span class="o">=</span> <span class="n">_logger</span><span class="p">()</span> <span class="c1"># fallback to print</span>
</span><span id="LightningProxModel-442"><a href="#LightningProxModel-442"><span class="linenos"> 442</span></a>        
</span><span id="LightningProxModel-443"><a href="#LightningProxModel-443"><span class="linenos"> 443</span></a>        <span class="n">ok</span><span class="p">,</span> <span class="n">msgs</span> <span class="o">=</span> <span class="n">chk</span><span class="o">.</span><span class="n">check_heterodata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="LightningProxModel-444"><a href="#LightningProxModel-444"><span class="linenos"> 444</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
</span><span id="LightningProxModel-445"><a href="#LightningProxModel-445"><span class="linenos"> 445</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid heterodata: </span><span class="si">{</span><span class="n">msgs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LightningProxModel-446"><a href="#LightningProxModel-446"><span class="linenos"> 446</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel-447"><a href="#LightningProxModel-447"><span class="linenos"> 447</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;HeteroData codes are valid: </span><span class="si">{</span><span class="n">msgs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LightningProxModel-448"><a href="#LightningProxModel-448"><span class="linenos"> 448</span></a>
</span><span id="LightningProxModel-449"><a href="#LightningProxModel-449"><span class="linenos"> 449</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="n">learning_rate</span>
</span><span id="LightningProxModel-450"><a href="#LightningProxModel-450"><span class="linenos"> 450</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">encoder_class</span><span class="p">(</span>
</span><span id="LightningProxModel-451"><a href="#LightningProxModel-451"><span class="linenos"> 451</span></a>            <span class="n">data</span><span class="p">,</span>
</span><span id="LightningProxModel-452"><a href="#LightningProxModel-452"><span class="linenos"> 452</span></a>            <span class="n">n_latent_dims</span><span class="p">,</span>
</span><span id="LightningProxModel-453"><a href="#LightningProxModel-453"><span class="linenos"> 453</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel-454"><a href="#LightningProxModel-454"><span class="linenos"> 454</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">decoder_class</span><span class="p">(</span>
</span><span id="LightningProxModel-455"><a href="#LightningProxModel-455"><span class="linenos"> 455</span></a>            <span class="n">data</span><span class="p">,</span>
</span><span id="LightningProxModel-456"><a href="#LightningProxModel-456"><span class="linenos"> 456</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel-457"><a href="#LightningProxModel-457"><span class="linenos"> 457</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span> <span class="o">=</span> <span class="n">hsic</span>
</span><span id="LightningProxModel-458"><a href="#LightningProxModel-458"><span class="linenos"> 458</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel-459"><a href="#LightningProxModel-459"><span class="linenos"> 459</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">hsic_optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span>
</span><span id="LightningProxModel-460"><a href="#LightningProxModel-460"><span class="linenos"> 460</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">hsic</span><span class="o">.</span><span class="n">lam</span>
</span><span id="LightningProxModel-461"><a href="#LightningProxModel-461"><span class="linenos"> 461</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel-462"><a href="#LightningProxModel-462"><span class="linenos"> 462</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">kl_lambda</span> <span class="o">=</span> <span class="n">kl_lambda</span>
</span><span id="LightningProxModel-463"><a href="#LightningProxModel-463"><span class="linenos"> 463</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">kl_n_no</span> <span class="o">=</span> <span class="n">kl_n_no</span>
</span><span id="LightningProxModel-464"><a href="#LightningProxModel-464"><span class="linenos"> 464</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">kl_n_warmup</span> <span class="o">=</span> <span class="n">kl_n_warmup</span>
</span><span id="LightningProxModel-465"><a href="#LightningProxModel-465"><span class="linenos"> 465</span></a>        <span class="c1"># self.nll_scale = nll_scale</span>
</span><span id="LightningProxModel-466"><a href="#LightningProxModel-466"><span class="linenos"> 466</span></a>        <span class="c1"># self.val_nll_scale = val_nll_scale</span>
</span><span id="LightningProxModel-467"><a href="#LightningProxModel-467"><span class="linenos"> 467</span></a>        <span class="c1"># self.num_nodes_dict = data.num_nodes_dict</span>
</span><span id="LightningProxModel-468"><a href="#LightningProxModel-468"><span class="linenos"> 468</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cell_weights</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">)</span>
</span><span id="LightningProxModel-469"><a href="#LightningProxModel-469"><span class="linenos"> 469</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reweight_rarecell</span> <span class="o">=</span> <span class="n">reweight_rarecell</span>
</span><span id="LightningProxModel-470"><a href="#LightningProxModel-470"><span class="linenos"> 470</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reweight_rarecell</span><span class="p">:</span> <span class="c1"># not used</span>
</span><span id="LightningProxModel-471"><a href="#LightningProxModel-471"><span class="linenos"> 471</span></a>            <span class="k">if</span> <span class="n">reweight_rarecell_neighbors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel-472"><a href="#LightningProxModel-472"><span class="linenos"> 472</span></a>                <span class="n">reweight_rarecell_neighbors</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span>
</span><span id="LightningProxModel-473"><a href="#LightningProxModel-473"><span class="linenos"> 473</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reweight_rarecell_neighbors</span> <span class="o">=</span> <span class="n">reweight_rarecell_neighbors</span>
</span><span id="LightningProxModel-474"><a href="#LightningProxModel-474"><span class="linenos"> 474</span></a>        <span class="k">if</span> <span class="n">edge_types</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel-475"><a href="#LightningProxModel-475"><span class="linenos"> 475</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">edge_types</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_types</span>
</span><span id="LightningProxModel-476"><a href="#LightningProxModel-476"><span class="linenos"> 476</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel-477"><a href="#LightningProxModel-477"><span class="linenos"> 477</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">edge_types</span> <span class="o">=</span> <span class="n">edge_types</span>
</span><span id="LightningProxModel-478"><a href="#LightningProxModel-478"><span class="linenos"> 478</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">edgetype_loss_weight_dict</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="LightningProxModel-479"><a href="#LightningProxModel-479"><span class="linenos"> 479</span></a>            <span class="n">edgetype</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edge_types</span><span class="p">))</span> 
</span><span id="LightningProxModel-480"><a href="#LightningProxModel-480"><span class="linenos"> 480</span></a>            <span class="k">for</span> <span class="n">edgetype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_types</span>
</span><span id="LightningProxModel-481"><a href="#LightningProxModel-481"><span class="linenos"> 481</span></a>        <span class="p">}</span>
</span><span id="LightningProxModel-482"><a href="#LightningProxModel-482"><span class="linenos"> 482</span></a>
</span><span id="LightningProxModel-483"><a href="#LightningProxModel-483"><span class="linenos"> 483</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">node_weights_dict</span> <span class="o">=</span> <span class="n">node_weights_dict</span>
</span><span id="LightningProxModel-484"><a href="#LightningProxModel-484"><span class="linenos"> 484</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">herit_loss</span> <span class="o">=</span> <span class="n">herit_loss</span>
</span><span id="LightningProxModel-485"><a href="#LightningProxModel-485"><span class="linenos"> 485</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">herit_loss_lam</span> <span class="o">=</span> <span class="n">herit_loss_lam</span>
</span><span id="LightningProxModel-486"><a href="#LightningProxModel-486"><span class="linenos"> 486</span></a>
</span><span id="LightningProxModel-487"><a href="#LightningProxModel-487"><span class="linenos"> 487</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_neg_samples_fold</span> <span class="o">=</span> <span class="n">num_neg_samples_fold</span>
</span><span id="LightningProxModel-488"><a href="#LightningProxModel-488"><span class="linenos"> 488</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">validation_step_outputs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="LightningProxModel-489"><a href="#LightningProxModel-489"><span class="linenos"> 489</span></a>
</span><span id="LightningProxModel-490"><a href="#LightningProxModel-490"><span class="linenos"> 490</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">use_aux</span> <span class="o">=</span> <span class="n">use_aux</span>
</span><span id="LightningProxModel-491"><a href="#LightningProxModel-491"><span class="linenos"> 491</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">use_aux_noise</span> <span class="o">=</span> <span class="n">use_aux_noise</span>
</span><span id="LightningProxModel-492"><a href="#LightningProxModel-492"><span class="linenos"> 492</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">aux_params</span> <span class="o">=</span> <span class="n">AuxParams</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">edgetype_specific</span><span class="o">=</span><span class="n">edgetype_specific</span><span class="p">,</span> 
</span><span id="LightningProxModel-493"><a href="#LightningProxModel-493"><span class="linenos"> 493</span></a>                                    <span class="n">check_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># already checked above</span>
</span><span id="LightningProxModel-494"><a href="#LightningProxModel-494"><span class="linenos"> 494</span></a>                                    <span class="n">use_noise</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_aux_noise</span>    <span class="c1"># DEBUG</span>
</span><span id="LightningProxModel-495"><a href="#LightningProxModel-495"><span class="linenos"> 495</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel-496"><a href="#LightningProxModel-496"><span class="linenos"> 496</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_aux</span><span class="p">:</span>
</span><span id="LightningProxModel-497"><a href="#LightningProxModel-497"><span class="linenos"> 497</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_freeze_aux_params</span><span class="p">()</span>
</span><span id="LightningProxModel-498"><a href="#LightningProxModel-498"><span class="linenos"> 498</span></a>
</span><span id="LightningProxModel-499"><a href="#LightningProxModel-499"><span class="linenos"> 499</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
</span><span id="LightningProxModel-500"><a href="#LightningProxModel-500"><span class="linenos"> 500</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_negative</span> <span class="o">=</span> <span class="n">batch_negative</span>
</span><span id="LightningProxModel-501"><a href="#LightningProxModel-501"><span class="linenos"> 501</span></a>
</span><span id="LightningProxModel-502"><a href="#LightningProxModel-502"><span class="linenos"> 502</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">monitor_key</span> <span class="o">=</span> <span class="n">monitor_key</span>
</span><span id="LightningProxModel-503"><a href="#LightningProxModel-503"><span class="linenos"> 503</span></a>
</span><span id="LightningProxModel-504"><a href="#LightningProxModel-504"><span class="linenos"> 504</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gene_align_lambda</span> <span class="o">=</span> <span class="n">gene_align_lambda</span>
</span><span id="LightningProxModel-505"><a href="#LightningProxModel-505"><span class="linenos"> 505</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gene_align_n_no</span> <span class="o">=</span> <span class="n">gene_align_n_no</span>
</span><span id="LightningProxModel-506"><a href="#LightningProxModel-506"><span class="linenos"> 506</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gene_align_n_warmup</span> <span class="o">=</span> <span class="n">gene_align_n_warmup</span>
</span><span id="LightningProxModel-507"><a href="#LightningProxModel-507"><span class="linenos"> 507</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ot_cs_lambda</span> <span class="o">=</span> <span class="n">ot_cs_lambda</span>
</span><span id="LightningProxModel-508"><a href="#LightningProxModel-508"><span class="linenos"> 508</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ot_cs_n_no</span> <span class="o">=</span> <span class="n">ot_cs_n_no</span>
</span><span id="LightningProxModel-509"><a href="#LightningProxModel-509"><span class="linenos"> 509</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ot_cs_n_warmup</span> <span class="o">=</span> <span class="n">ot_cs_n_warmup</span>
</span><span id="LightningProxModel-510"><a href="#LightningProxModel-510"><span class="linenos"> 510</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ot_cs_k</span> <span class="o">=</span> <span class="n">ot_cs_k</span>
</span><span id="LightningProxModel-511"><a href="#LightningProxModel-511"><span class="linenos"> 511</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ot_cb_lambda</span> <span class="o">=</span> <span class="n">ot_cb_lambda</span>
</span><span id="LightningProxModel-512"><a href="#LightningProxModel-512"><span class="linenos"> 512</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ot_cb_n_no</span> <span class="o">=</span> <span class="n">ot_cb_n_no</span>
</span><span id="LightningProxModel-513"><a href="#LightningProxModel-513"><span class="linenos"> 513</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ot_cb_n_warmup</span> <span class="o">=</span> <span class="n">ot_cb_n_warmup</span>
</span><span id="LightningProxModel-514"><a href="#LightningProxModel-514"><span class="linenos"> 514</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ot_cb_k</span> <span class="o">=</span> <span class="n">ot_cb_k</span>
</span><span id="LightningProxModel-515"><a href="#LightningProxModel-515"><span class="linenos"> 515</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ot_eps</span> <span class="o">=</span> <span class="n">ot_eps</span>
</span><span id="LightningProxModel-516"><a href="#LightningProxModel-516"><span class="linenos"> 516</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ot_iter</span> <span class="o">=</span> <span class="n">ot_iter</span>
</span><span id="LightningProxModel-517"><a href="#LightningProxModel-517"><span class="linenos"> 517</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ot_plan_every_n_epochs</span> <span class="o">=</span> <span class="n">ot_plan_every_n_epochs</span>
</span><span id="LightningProxModel-518"><a href="#LightningProxModel-518"><span class="linenos"> 518</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ot_loss_every_n_steps</span> <span class="o">=</span> <span class="n">ot_loss_every_n_steps</span>
</span><span id="LightningProxModel-519"><a href="#LightningProxModel-519"><span class="linenos"> 519</span></a>
</span><span id="LightningProxModel-520"><a href="#LightningProxModel-520"><span class="linenos"> 520</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_register_gene_pairs</span><span class="p">()</span>
</span><span id="LightningProxModel-521"><a href="#LightningProxModel-521"><span class="linenos"> 521</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_register_ot_state</span><span class="p">()</span>
</span><span id="LightningProxModel-522"><a href="#LightningProxModel-522"><span class="linenos"> 522</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_register_others</span><span class="p">()</span>
</span><span id="LightningProxModel-523"><a href="#LightningProxModel-523"><span class="linenos"> 523</span></a>
</span><span id="LightningProxModel-524"><a href="#LightningProxModel-524"><span class="linenos"> 524</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log_every_n_steps</span> <span class="o">=</span> <span class="mi">50</span>
</span><span id="LightningProxModel-525"><a href="#LightningProxModel-525"><span class="linenos"> 525</span></a>    
</span><span id="LightningProxModel-526"><a href="#LightningProxModel-526"><span class="linenos"> 526</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_freeze_aux_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LightningProxModel-527"><a href="#LightningProxModel-527"><span class="linenos"> 527</span></a>        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aux_params</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
</span><span id="LightningProxModel-528"><a href="#LightningProxModel-528"><span class="linenos"> 528</span></a>            <span class="n">param</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel-529"><a href="#LightningProxModel-529"><span class="linenos"> 529</span></a>    
</span><span id="LightningProxModel-530"><a href="#LightningProxModel-530"><span class="linenos"> 530</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_register_gene_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LightningProxModel-531"><a href="#LightningProxModel-531"><span class="linenos"> 531</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gene_align_lambda</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LightningProxModel-532"><a href="#LightningProxModel-532"><span class="linenos"> 532</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">],</span> <span class="s2">&quot;sample&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">],</span> <span class="s2">&quot;gene_id&quot;</span><span class="p">)):</span>
</span><span id="LightningProxModel-533"><a href="#LightningProxModel-533"><span class="linenos"> 533</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="LightningProxModel-534"><a href="#LightningProxModel-534"><span class="linenos"> 534</span></a>                    <span class="s2">&quot;gene_align_lambda &gt; 0 requires data[&#39;gene&#39;].sample and data[&#39;gene&#39;].gene_id &quot;</span>
</span><span id="LightningProxModel-535"><a href="#LightningProxModel-535"><span class="linenos"> 535</span></a>                    <span class="s2">&quot;(constructed in make_sc_HetData_multi_rna).&quot;</span>
</span><span id="LightningProxModel-536"><a href="#LightningProxModel-536"><span class="linenos"> 536</span></a>                <span class="p">)</span>
</span><span id="LightningProxModel-537"><a href="#LightningProxModel-537"><span class="linenos"> 537</span></a>            
</span><span id="LightningProxModel-538"><a href="#LightningProxModel-538"><span class="linenos"> 538</span></a>            <span class="n">pairs</span> <span class="o">=</span> <span class="n">build_multi_sample_gene_pairs</span><span class="p">(</span>
</span><span id="LightningProxModel-539"><a href="#LightningProxModel-539"><span class="linenos"> 539</span></a>                <span class="n">gene_sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">,</span>
</span><span id="LightningProxModel-540"><a href="#LightningProxModel-540"><span class="linenos"> 540</span></a>                <span class="n">gene_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">gene_id</span><span class="p">,</span>
</span><span id="LightningProxModel-541"><a href="#LightningProxModel-541"><span class="linenos"> 541</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel-542"><a href="#LightningProxModel-542"><span class="linenos"> 542</span></a>            
</span><span id="LightningProxModel-543"><a href="#LightningProxModel-543"><span class="linenos"> 543</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;gene_align_idx0&quot;</span><span class="p">,</span> <span class="n">pairs</span><span class="o">.</span><span class="n">idx0</span><span class="p">,</span> <span class="n">persistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LightningProxModel-544"><a href="#LightningProxModel-544"><span class="linenos"> 544</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;gene_align_idx1&quot;</span><span class="p">,</span> <span class="n">pairs</span><span class="o">.</span><span class="n">idx1</span><span class="p">,</span> <span class="n">persistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LightningProxModel-545"><a href="#LightningProxModel-545"><span class="linenos"> 545</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_gene_pairs</span> <span class="o">=</span> <span class="n">MultiSampleGenePairs</span><span class="p">(</span><span class="n">idx0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_align_idx0</span><span class="p">,</span> <span class="n">idx1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_align_idx1</span><span class="p">)</span>
</span><span id="LightningProxModel-546"><a href="#LightningProxModel-546"><span class="linenos"> 546</span></a>    
</span><span id="LightningProxModel-547"><a href="#LightningProxModel-547"><span class="linenos"> 547</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_register_ot_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LightningProxModel-548"><a href="#LightningProxModel-548"><span class="linenos"> 548</span></a>        <span class="c1"># cross-sample OT state</span>
</span><span id="LightningProxModel-549"><a href="#LightningProxModel-549"><span class="linenos"> 549</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_cs_lambda</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LightningProxModel-550"><a href="#LightningProxModel-550"><span class="linenos"> 550</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">],</span> <span class="s2">&quot;sample&quot;</span><span class="p">):</span>
</span><span id="LightningProxModel-551"><a href="#LightningProxModel-551"><span class="linenos"> 551</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ot_cs_lambda &gt; 0 requires data[&#39;cell&#39;].sample&quot;</span><span class="p">)</span>
</span><span id="LightningProxModel-552"><a href="#LightningProxModel-552"><span class="linenos"> 552</span></a>            
</span><span id="LightningProxModel-553"><a href="#LightningProxModel-553"><span class="linenos"> 553</span></a>            <span class="c1"># not buffers; we&#39;ll compute OT related variables on the fly</span>
</span><span id="LightningProxModel-554"><a href="#LightningProxModel-554"><span class="linenos"> 554</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_ot_cs_groups</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="n">build_sample_cell_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">)</span>
</span><span id="LightningProxModel-555"><a href="#LightningProxModel-555"><span class="linenos"> 555</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_ot_cs_pairs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="n">make_all_sample_pairs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ot_cs_groups</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;all_pairs&quot;</span><span class="p">)</span>
</span><span id="LightningProxModel-556"><a href="#LightningProxModel-556"><span class="linenos"> 556</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_ot_cs_states</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PairOTState</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="LightningProxModel-557"><a href="#LightningProxModel-557"><span class="linenos"> 557</span></a>        
</span><span id="LightningProxModel-558"><a href="#LightningProxModel-558"><span class="linenos"> 558</span></a>        <span class="c1"># cross-batch OT state</span>
</span><span id="LightningProxModel-559"><a href="#LightningProxModel-559"><span class="linenos"> 559</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_cb_lambda</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LightningProxModel-560"><a href="#LightningProxModel-560"><span class="linenos"> 560</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">],</span> <span class="s2">&quot;batch_local&quot;</span><span class="p">):</span>
</span><span id="LightningProxModel-561"><a href="#LightningProxModel-561"><span class="linenos"> 561</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">],</span> <span class="s2">&quot;batch&quot;</span><span class="p">):</span>
</span><span id="LightningProxModel-562"><a href="#LightningProxModel-562"><span class="linenos"> 562</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ot_cb_lambda &gt; 0 requires data[&#39;cell&#39;].batch_local or data[&#39;cell&#39;].batch&quot;</span><span class="p">)</span>
</span><span id="LightningProxModel-563"><a href="#LightningProxModel-563"><span class="linenos"> 563</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel-564"><a href="#LightningProxModel-564"><span class="linenos"> 564</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">],</span> <span class="s2">&quot;sample&quot;</span><span class="p">):</span>
</span><span id="LightningProxModel-565"><a href="#LightningProxModel-565"><span class="linenos"> 565</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">batch</span><span class="p">)</span>
</span><span id="LightningProxModel-566"><a href="#LightningProxModel-566"><span class="linenos"> 566</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">batch_local</span> <span class="o">=</span> <span class="n">chk</span><span class="o">.</span><span class="n">_make_batch_local_from_global</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">batch</span><span class="p">)</span>
</span><span id="LightningProxModel-567"><a href="#LightningProxModel-567"><span class="linenos"> 567</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_ot_cb_groups</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="n">build_sample_batch_cell_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">batch_local</span><span class="p">)</span>
</span><span id="LightningProxModel-568"><a href="#LightningProxModel-568"><span class="linenos"> 568</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_ot_cb_pairs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">make_all_sample_batch_pairs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ot_cb_groups</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;all_pairs&quot;</span><span class="p">)</span>
</span><span id="LightningProxModel-569"><a href="#LightningProxModel-569"><span class="linenos"> 569</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_ot_cb_states</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PairOTStateKeyed</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="LightningProxModel-570"><a href="#LightningProxModel-570"><span class="linenos"> 570</span></a>
</span><span id="LightningProxModel-571"><a href="#LightningProxModel-571"><span class="linenos"> 571</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_register_others</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LightningProxModel-572"><a href="#LightningProxModel-572"><span class="linenos"> 572</span></a>        <span class="c1"># self.register_buffer(&quot;cell_weights&quot;, self.cell_weights) # not used</span>
</span><span id="LightningProxModel-573"><a href="#LightningProxModel-573"><span class="linenos"> 573</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">edgetype_loss_weight_dict</span> <span class="o">=</span> <span class="n">BufferDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edgetype_loss_weight_dict</span><span class="p">)</span>
</span><span id="LightningProxModel-574"><a href="#LightningProxModel-574"><span class="linenos"> 574</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_weights_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel-575"><a href="#LightningProxModel-575"><span class="linenos"> 575</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">node_weights_dict</span> <span class="o">=</span> <span class="n">BufferDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_weights_dict</span><span class="p">)</span>
</span><span id="LightningProxModel-576"><a href="#LightningProxModel-576"><span class="linenos"> 576</span></a>
</span><span id="LightningProxModel-577"><a href="#LightningProxModel-577"><span class="linenos"> 577</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_stage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="LightningProxModel-578"><a href="#LightningProxModel-578"><span class="linenos"> 578</span></a>        <span class="k">return</span> <span class="s2">&quot;train&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="k">else</span> <span class="s2">&quot;val&quot;</span>
</span><span id="LightningProxModel-579"><a href="#LightningProxModel-579"><span class="linenos"> 579</span></a>    
</span><span id="LightningProxModel-580"><a href="#LightningProxModel-580"><span class="linenos"> 580</span></a>    <span class="nd">@staticmethod</span>
</span><span id="LightningProxModel-581"><a href="#LightningProxModel-581"><span class="linenos"> 581</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_num_edges_in_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="LightningProxModel-582"><a href="#LightningProxModel-582"><span class="linenos"> 582</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="s2">&quot;edge_index_dict&quot;</span><span class="p">):</span>
</span><span id="LightningProxModel-583"><a href="#LightningProxModel-583"><span class="linenos"> 583</span></a>            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
</span><span id="LightningProxModel-584"><a href="#LightningProxModel-584"><span class="linenos"> 584</span></a>        <span class="k">return</span> <span class="mi">1</span>
</span><span id="LightningProxModel-585"><a href="#LightningProxModel-585"><span class="linenos"> 585</span></a>    
</span><span id="LightningProxModel-586"><a href="#LightningProxModel-586"><span class="linenos"> 586</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_edge_type_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edge_type</span><span class="p">:</span> <span class="n">EdgeType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="LightningProxModel-587"><a href="#LightningProxModel-587"><span class="linenos"> 587</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="LightningProxModel-588"><a href="#LightningProxModel-588"><span class="linenos"> 588</span></a>            <span class="k">return</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">edge_type</span><span class="p">)</span>
</span><span id="LightningProxModel-589"><a href="#LightningProxModel-589"><span class="linenos"> 589</span></a>        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
</span><span id="LightningProxModel-590"><a href="#LightningProxModel-590"><span class="linenos"> 590</span></a>            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">edge_type</span><span class="p">)</span>
</span><span id="LightningProxModel-591"><a href="#LightningProxModel-591"><span class="linenos"> 591</span></a>    
</span><span id="LightningProxModel-592"><a href="#LightningProxModel-592"><span class="linenos"> 592</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_log_metric</span><span class="p">(</span>
</span><span id="LightningProxModel-593"><a href="#LightningProxModel-593"><span class="linenos"> 593</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LightningProxModel-594"><a href="#LightningProxModel-594"><span class="linenos"> 594</span></a>        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="LightningProxModel-595"><a href="#LightningProxModel-595"><span class="linenos"> 595</span></a>        <span class="n">value</span><span class="p">,</span>
</span><span id="LightningProxModel-596"><a href="#LightningProxModel-596"><span class="linenos"> 596</span></a>        <span class="o">*</span><span class="p">,</span>
</span><span id="LightningProxModel-597"><a href="#LightningProxModel-597"><span class="linenos"> 597</span></a>        <span class="n">stage</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel-598"><a href="#LightningProxModel-598"><span class="linenos"> 598</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel-599"><a href="#LightningProxModel-599"><span class="linenos"> 599</span></a>        <span class="n">on_step</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel-600"><a href="#LightningProxModel-600"><span class="linenos"> 600</span></a>        <span class="n">on_epoch</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="LightningProxModel-601"><a href="#LightningProxModel-601"><span class="linenos"> 601</span></a>        <span class="n">prog_bar</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel-602"><a href="#LightningProxModel-602"><span class="linenos"> 602</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel-603"><a href="#LightningProxModel-603"><span class="linenos"> 603</span></a>        <span class="n">stage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stage</span><span class="p">()</span> <span class="k">if</span> <span class="n">stage</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">stage</span>
</span><span id="LightningProxModel-604"><a href="#LightningProxModel-604"><span class="linenos"> 604</span></a>        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stage</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="LightningProxModel-605"><a href="#LightningProxModel-605"><span class="linenos"> 605</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">batch_size</span>
</span><span id="LightningProxModel-606"><a href="#LightningProxModel-606"><span class="linenos"> 606</span></a>        <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">math</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="k">else</span> <span class="n">value</span>
</span><span id="LightningProxModel-607"><a href="#LightningProxModel-607"><span class="linenos"> 607</span></a>
</span><span id="LightningProxModel-608"><a href="#LightningProxModel-608"><span class="linenos"> 608</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
</span><span id="LightningProxModel-609"><a href="#LightningProxModel-609"><span class="linenos"> 609</span></a>            <span class="n">key</span><span class="p">,</span>
</span><span id="LightningProxModel-610"><a href="#LightningProxModel-610"><span class="linenos"> 610</span></a>            <span class="n">value</span><span class="p">,</span>
</span><span id="LightningProxModel-611"><a href="#LightningProxModel-611"><span class="linenos"> 611</span></a>            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="LightningProxModel-612"><a href="#LightningProxModel-612"><span class="linenos"> 612</span></a>            <span class="n">on_step</span><span class="o">=</span><span class="n">on_step</span><span class="p">,</span>
</span><span id="LightningProxModel-613"><a href="#LightningProxModel-613"><span class="linenos"> 613</span></a>            <span class="n">on_epoch</span><span class="o">=</span><span class="n">on_epoch</span><span class="p">,</span>
</span><span id="LightningProxModel-614"><a href="#LightningProxModel-614"><span class="linenos"> 614</span></a>            <span class="n">prog_bar</span><span class="o">=</span><span class="n">prog_bar</span><span class="p">,</span>
</span><span id="LightningProxModel-615"><a href="#LightningProxModel-615"><span class="linenos"> 615</span></a>            <span class="n">logger</span><span class="o">=</span><span class="kc">True</span>
</span><span id="LightningProxModel-616"><a href="#LightningProxModel-616"><span class="linenos"> 616</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel-617"><a href="#LightningProxModel-617"><span class="linenos"> 617</span></a>    
</span><span id="LightningProxModel-618"><a href="#LightningProxModel-618"><span class="linenos"> 618</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_log_perf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">seconds</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">on_step</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel-619"><a href="#LightningProxModel-619"><span class="linenos"> 619</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">/perf&quot;</span><span class="p">,</span> <span class="n">seconds</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="n">on_step</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="ow">not</span> <span class="n">on_step</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel-620"><a href="#LightningProxModel-620"><span class="linenos"> 620</span></a>    
</span><span id="LightningProxModel-621"><a href="#LightningProxModel-621"><span class="linenos"> 621</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LightningProxModel-622"><a href="#LightningProxModel-622"><span class="linenos"> 622</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel-623"><a href="#LightningProxModel-623"><span class="linenos"> 623</span></a>            <span class="n">update_lr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hsic_optimizer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span><span class="o">.</span><span class="n">lam</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span>
</span><span id="LightningProxModel-624"><a href="#LightningProxModel-624"><span class="linenos"> 624</span></a>
</span><span id="LightningProxModel-625"><a href="#LightningProxModel-625"><span class="linenos"> 625</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="LightningProxModel-626"><a href="#LightningProxModel-626"><span class="linenos"> 626</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Runs the encoder and computes node-wise latent variables.&quot;&quot;&quot;</span>
</span><span id="LightningProxModel-627"><a href="#LightningProxModel-627"><span class="linenos"> 627</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="LightningProxModel-628"><a href="#LightningProxModel-628"><span class="linenos"> 628</span></a>
</span><span id="LightningProxModel-629"><a href="#LightningProxModel-629"><span class="linenos"> 629</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reparametrize</span><span class="p">(</span>
</span><span id="LightningProxModel-630"><a href="#LightningProxModel-630"><span class="linenos"> 630</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LightningProxModel-631"><a href="#LightningProxModel-631"><span class="linenos"> 631</span></a>        <span class="n">mu_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel-632"><a href="#LightningProxModel-632"><span class="linenos"> 632</span></a>        <span class="n">logstd_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel-633"><a href="#LightningProxModel-633"><span class="linenos"> 633</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
</span><span id="LightningProxModel-634"><a href="#LightningProxModel-634"><span class="linenos"> 634</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate random z from mu, logstd&quot;&quot;&quot;</span>
</span><span id="LightningProxModel-635"><a href="#LightningProxModel-635"><span class="linenos"> 635</span></a>        <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LightningProxModel-636"><a href="#LightningProxModel-636"><span class="linenos"> 636</span></a>        <span class="k">assert</span> <span class="n">mu_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="n">logstd_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span><span id="LightningProxModel-637"><a href="#LightningProxModel-637"><span class="linenos"> 637</span></a>        <span class="k">for</span> <span class="n">node_type</span> <span class="ow">in</span> <span class="n">mu_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="LightningProxModel-638"><a href="#LightningProxModel-638"><span class="linenos"> 638</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="LightningProxModel-639"><a href="#LightningProxModel-639"><span class="linenos"> 639</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">kl_n_no</span>
</span><span id="LightningProxModel-640"><a href="#LightningProxModel-640"><span class="linenos"> 640</span></a>            <span class="p">):</span>  <span class="c1"># Start reparameterization later</span>
</span><span id="LightningProxModel-641"><a href="#LightningProxModel-641"><span class="linenos"> 641</span></a>                <span class="n">out_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">mu_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span>
</span><span id="LightningProxModel-642"><a href="#LightningProxModel-642"><span class="linenos"> 642</span></a>                    <span class="n">logstd_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span>
</span><span id="LightningProxModel-643"><a href="#LightningProxModel-643"><span class="linenos"> 643</span></a>                <span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logstd_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">])</span>
</span><span id="LightningProxModel-644"><a href="#LightningProxModel-644"><span class="linenos"> 644</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel-645"><a href="#LightningProxModel-645"><span class="linenos"> 645</span></a>                <span class="n">out_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">mu_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span>  <span class="c1"># Use mean only initially</span>
</span><span id="LightningProxModel-646"><a href="#LightningProxModel-646"><span class="linenos"> 646</span></a>        <span class="k">return</span> <span class="n">out_dict</span>
</span><span id="LightningProxModel-647"><a href="#LightningProxModel-647"><span class="linenos"> 647</span></a>
</span><span id="LightningProxModel-648"><a href="#LightningProxModel-648"><span class="linenos"> 648</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">relational_recon_loss</span><span class="p">(</span>
</span><span id="LightningProxModel-649"><a href="#LightningProxModel-649"><span class="linenos"> 649</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LightningProxModel-650"><a href="#LightningProxModel-650"><span class="linenos"> 650</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">HeteroData</span><span class="p">,</span>
</span><span id="LightningProxModel-651"><a href="#LightningProxModel-651"><span class="linenos"> 651</span></a>        <span class="n">z_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel-652"><a href="#LightningProxModel-652"><span class="linenos"> 652</span></a>        <span class="n">pos_edge_index_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel-653"><a href="#LightningProxModel-653"><span class="linenos"> 653</span></a>        <span class="n">pos_edge_weight_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel-654"><a href="#LightningProxModel-654"><span class="linenos"> 654</span></a>        <span class="n">neg_edge_index_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel-655"><a href="#LightningProxModel-655"><span class="linenos"> 655</span></a>        <span class="n">batch_alledges</span><span class="p">:</span> <span class="n">HeteroData</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel-656"><a href="#LightningProxModel-656"><span class="linenos"> 656</span></a>        <span class="n">neg_sample</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel-657"><a href="#LightningProxModel-657"><span class="linenos"> 657</span></a>        <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel-658"><a href="#LightningProxModel-658"><span class="linenos"> 658</span></a>        <span class="n">get_metric</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel-659"><a href="#LightningProxModel-659"><span class="linenos"> 659</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span> <span class="n">Dict</span><span class="p">]:</span>
</span><span id="LightningProxModel-660"><a href="#LightningProxModel-660"><span class="linenos"> 660</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate reconstruction loss by maximizing log_prob of observing edge weight in pos_edge_index_dict and 0 weight in neg_edge_index_dict</span>
</span><span id="LightningProxModel-661"><a href="#LightningProxModel-661"><span class="linenos"> 661</span></a>
</span><span id="LightningProxModel-662"><a href="#LightningProxModel-662"><span class="linenos"> 662</span></a><span class="sd">        Args</span>
</span><span id="LightningProxModel-663"><a href="#LightningProxModel-663"><span class="linenos"> 663</span></a><span class="sd">        z_dict: encoded vector</span>
</span><span id="LightningProxModel-664"><a href="#LightningProxModel-664"><span class="linenos"> 664</span></a><span class="sd">        pos_edge_index_dict: Dictionary of Tensors with shape (2, n_pos_edges)</span>
</span><span id="LightningProxModel-665"><a href="#LightningProxModel-665"><span class="linenos"> 665</span></a><span class="sd">        pos_edge_weight_dict: Dictionary of Tensors with shape (n_pos_edges,) encoding the weight of each edges.</span>
</span><span id="LightningProxModel-666"><a href="#LightningProxModel-666"><span class="linenos"> 666</span></a><span class="sd">        neg_edge_index_dict: Dictionary of Tensors with shape (2, n_neg_edges) to be used as negative edges</span>
</span><span id="LightningProxModel-667"><a href="#LightningProxModel-667"><span class="linenos"> 667</span></a><span class="sd">        num_neg_samples: If neg_edge_index is None and</span>
</span><span id="LightningProxModel-668"><a href="#LightningProxModel-668"><span class="linenos"> 668</span></a><span class="sd">            num_neg_samples is None, This number of negative edges are sampled. Otherwise, the same number as the positive edges are sample.</span>
</span><span id="LightningProxModel-669"><a href="#LightningProxModel-669"><span class="linenos"> 669</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LightningProxModel-670"><a href="#LightningProxModel-670"><span class="linenos"> 670</span></a>        <span class="n">pos_dist_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Distribution</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span>
</span><span id="LightningProxModel-671"><a href="#LightningProxModel-671"><span class="linenos"> 671</span></a>            <span class="n">batch</span><span class="p">,</span>
</span><span id="LightningProxModel-672"><a href="#LightningProxModel-672"><span class="linenos"> 672</span></a>            <span class="n">z_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-673"><a href="#LightningProxModel-673"><span class="linenos"> 673</span></a>            <span class="n">pos_edge_index_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-674"><a href="#LightningProxModel-674"><span class="linenos"> 674</span></a>            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">aux_params</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">pos_edge_index_dict</span><span class="p">),</span>
</span><span id="LightningProxModel-675"><a href="#LightningProxModel-675"><span class="linenos"> 675</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel-676"><a href="#LightningProxModel-676"><span class="linenos"> 676</span></a>        <span class="k">if</span> <span class="n">neg_sample</span><span class="p">:</span>
</span><span id="LightningProxModel-677"><a href="#LightningProxModel-677"><span class="linenos"> 677</span></a>            <span class="k">if</span> <span class="n">neg_edge_index_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel-678"><a href="#LightningProxModel-678"><span class="linenos"> 678</span></a>                <span class="n">neg_edge_index_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LightningProxModel-679"><a href="#LightningProxModel-679"><span class="linenos"> 679</span></a>                <span class="k">for</span> <span class="n">edge_type</span> <span class="ow">in</span> <span class="n">pos_edge_index_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="LightningProxModel-680"><a href="#LightningProxModel-680"><span class="linenos"> 680</span></a>                    <span class="n">src</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dst</span> <span class="o">=</span> <span class="n">edge_type</span>
</span><span id="LightningProxModel-681"><a href="#LightningProxModel-681"><span class="linenos"> 681</span></a>                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="n">src</span><span class="p">],</span> <span class="s2">&quot;sample&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="n">dst</span><span class="p">],</span> <span class="s2">&quot;sample&quot;</span><span class="p">):</span>
</span><span id="LightningProxModel-682"><a href="#LightningProxModel-682"><span class="linenos"> 682</span></a>                        <span class="n">neg_edge_index</span> <span class="o">=</span> <span class="n">negative_sampling_same_sample_bipartite</span><span class="p">(</span>
</span><span id="LightningProxModel-683"><a href="#LightningProxModel-683"><span class="linenos"> 683</span></a>                            <span class="n">pos_edge_index_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">],</span>
</span><span id="LightningProxModel-684"><a href="#LightningProxModel-684"><span class="linenos"> 684</span></a>                            <span class="n">src_sample</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="n">src</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">,</span>
</span><span id="LightningProxModel-685"><a href="#LightningProxModel-685"><span class="linenos"> 685</span></a>                            <span class="n">dst_sample</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">,</span>
</span><span id="LightningProxModel-686"><a href="#LightningProxModel-686"><span class="linenos"> 686</span></a>                            <span class="n">num_neg_samples_fold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_neg_samples_fold</span><span class="p">,</span>
</span><span id="LightningProxModel-687"><a href="#LightningProxModel-687"><span class="linenos"> 687</span></a>                            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;sparse&quot;</span><span class="p">,</span>
</span><span id="LightningProxModel-688"><a href="#LightningProxModel-688"><span class="linenos"> 688</span></a>                        <span class="p">)</span>
</span><span id="LightningProxModel-689"><a href="#LightningProxModel-689"><span class="linenos"> 689</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel-690"><a href="#LightningProxModel-690"><span class="linenos"> 690</span></a>                        <span class="n">n_pos_edges</span> <span class="o">=</span> <span class="n">pos_edge_index_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="LightningProxModel-691"><a href="#LightningProxModel-691"><span class="linenos"> 691</span></a>                        <span class="n">neg_edge_index</span> <span class="o">=</span> <span class="n">negative_sampling</span><span class="p">(</span>
</span><span id="LightningProxModel-692"><a href="#LightningProxModel-692"><span class="linenos"> 692</span></a>                            <span class="n">batch</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span><span class="o">.</span><span class="n">edge_index</span><span class="p">,</span>
</span><span id="LightningProxModel-693"><a href="#LightningProxModel-693"><span class="linenos"> 693</span></a>                            <span class="n">num_nodes</span><span class="o">=</span><span class="p">(</span>
</span><span id="LightningProxModel-694"><a href="#LightningProxModel-694"><span class="linenos"> 694</span></a>                                <span class="n">batch</span><span class="p">[</span><span class="n">src</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span>
</span><span id="LightningProxModel-695"><a href="#LightningProxModel-695"><span class="linenos"> 695</span></a>                                <span class="n">batch</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span>
</span><span id="LightningProxModel-696"><a href="#LightningProxModel-696"><span class="linenos"> 696</span></a>                            <span class="p">),</span>
</span><span id="LightningProxModel-697"><a href="#LightningProxModel-697"><span class="linenos"> 697</span></a>                            <span class="n">num_neg_samples</span><span class="o">=</span><span class="n">n_pos_edges</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_neg_samples_fold</span><span class="p">,</span>
</span><span id="LightningProxModel-698"><a href="#LightningProxModel-698"><span class="linenos"> 698</span></a>                        <span class="p">)</span>
</span><span id="LightningProxModel-699"><a href="#LightningProxModel-699"><span class="linenos"> 699</span></a>                    <span class="n">neg_edge_index_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">neg_edge_index</span>
</span><span id="LightningProxModel-700"><a href="#LightningProxModel-700"><span class="linenos"> 700</span></a>            <span class="n">neg_dist_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Distribution</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span>
</span><span id="LightningProxModel-701"><a href="#LightningProxModel-701"><span class="linenos"> 701</span></a>                <span class="n">batch</span><span class="p">,</span>
</span><span id="LightningProxModel-702"><a href="#LightningProxModel-702"><span class="linenos"> 702</span></a>                <span class="n">z_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-703"><a href="#LightningProxModel-703"><span class="linenos"> 703</span></a>                <span class="n">neg_edge_index_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-704"><a href="#LightningProxModel-704"><span class="linenos"> 704</span></a>                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">aux_params</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">neg_edge_index_dict</span><span class="p">),</span>
</span><span id="LightningProxModel-705"><a href="#LightningProxModel-705"><span class="linenos"> 705</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel-706"><a href="#LightningProxModel-706"><span class="linenos"> 706</span></a>        <span class="n">loss_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LightningProxModel-707"><a href="#LightningProxModel-707"><span class="linenos"> 707</span></a>        <span class="n">metric_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LightningProxModel-708"><a href="#LightningProxModel-708"><span class="linenos"> 708</span></a>        <span class="n">fold_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_neg_samples_fold</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel-709"><a href="#LightningProxModel-709"><span class="linenos"> 709</span></a>        <span class="n">weight_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_neg_samples_fold</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel-710"><a href="#LightningProxModel-710"><span class="linenos"> 710</span></a>        <span class="k">for</span> <span class="n">edge_type</span><span class="p">,</span> <span class="n">pos_dist</span> <span class="ow">in</span> <span class="n">pos_dist_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="LightningProxModel-711"><a href="#LightningProxModel-711"><span class="linenos"> 711</span></a>            <span class="n">src_type</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dst_type</span> <span class="o">=</span> <span class="n">edge_type</span>
</span><span id="LightningProxModel-712"><a href="#LightningProxModel-712"><span class="linenos"> 712</span></a>            <span class="n">pos_edge_weights</span> <span class="o">=</span> <span class="n">pos_edge_weight_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span>
</span><span id="LightningProxModel-713"><a href="#LightningProxModel-713"><span class="linenos"> 713</span></a>            <span class="n">pos_loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">pos_dist</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">pos_edge_weights</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="LightningProxModel-714"><a href="#LightningProxModel-714"><span class="linenos"> 714</span></a>            <span class="n">loss_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos_loss</span>
</span><span id="LightningProxModel-715"><a href="#LightningProxModel-715"><span class="linenos"> 715</span></a>            <span class="k">if</span> <span class="n">neg_sample</span><span class="p">:</span>
</span><span id="LightningProxModel-716"><a href="#LightningProxModel-716"><span class="linenos"> 716</span></a>                <span class="n">neg_dist</span> <span class="o">=</span> <span class="n">neg_dist_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span>
</span><span id="LightningProxModel-717"><a href="#LightningProxModel-717"><span class="linenos"> 717</span></a>                <span class="n">neg_edge_weights</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
</span><span id="LightningProxModel-718"><a href="#LightningProxModel-718"><span class="linenos"> 718</span></a>                    <span class="n">neg_dist</span><span class="o">.</span><span class="n">event_shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span>
</span><span id="LightningProxModel-719"><a href="#LightningProxModel-719"><span class="linenos"> 719</span></a>                <span class="p">)</span>
</span><span id="LightningProxModel-720"><a href="#LightningProxModel-720"><span class="linenos"> 720</span></a>                <span class="n">neg_loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">neg_dist</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">neg_edge_weights</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="LightningProxModel-721"><a href="#LightningProxModel-721"><span class="linenos"> 721</span></a>                <span class="n">loss_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">loss_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">+</span> <span class="n">neg_loss</span> <span class="o">*</span> <span class="n">fold_tensor</span><span class="p">)</span> <span class="o">*</span> <span class="n">weight_tensor</span>
</span><span id="LightningProxModel-722"><a href="#LightningProxModel-722"><span class="linenos"> 722</span></a>
</span><span id="LightningProxModel-723"><a href="#LightningProxModel-723"><span class="linenos"> 723</span></a>        <span class="k">return</span> <span class="n">loss_dict</span><span class="p">,</span> <span class="n">neg_edge_index_dict</span><span class="p">,</span> <span class="n">metric_dict</span>
</span><span id="LightningProxModel-724"><a href="#LightningProxModel-724"><span class="linenos"> 724</span></a>
</span><span id="LightningProxModel-725"><a href="#LightningProxModel-725"><span class="linenos"> 725</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_kl_loss</span><span class="p">(</span>
</span><span id="LightningProxModel-726"><a href="#LightningProxModel-726"><span class="linenos"> 726</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LightningProxModel-727"><a href="#LightningProxModel-727"><span class="linenos"> 727</span></a>        <span class="n">mu</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel-728"><a href="#LightningProxModel-728"><span class="linenos"> 728</span></a>        <span class="n">logstd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel-729"><a href="#LightningProxModel-729"><span class="linenos"> 729</span></a>        <span class="n">weight</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel-730"><a href="#LightningProxModel-730"><span class="linenos"> 730</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="LightningProxModel-731"><a href="#LightningProxModel-731"><span class="linenos"> 731</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Computes the KL loss, either for the passed arguments :obj:`mu`</span>
</span><span id="LightningProxModel-732"><a href="#LightningProxModel-732"><span class="linenos"> 732</span></a><span class="sd">        and :obj:`logstd`, or based on latent variables from last encoding.</span>
</span><span id="LightningProxModel-733"><a href="#LightningProxModel-733"><span class="linenos"> 733</span></a>
</span><span id="LightningProxModel-734"><a href="#LightningProxModel-734"><span class="linenos"> 734</span></a><span class="sd">        Args:</span>
</span><span id="LightningProxModel-735"><a href="#LightningProxModel-735"><span class="linenos"> 735</span></a><span class="sd">            mu (Tensor, optional): The latent space for :math:`\mu`. If set to</span>
</span><span id="LightningProxModel-736"><a href="#LightningProxModel-736"><span class="linenos"> 736</span></a><span class="sd">                :obj:`None`, uses the last computation of :math:`mu`.</span>
</span><span id="LightningProxModel-737"><a href="#LightningProxModel-737"><span class="linenos"> 737</span></a><span class="sd">                (default: :obj:`None`)</span>
</span><span id="LightningProxModel-738"><a href="#LightningProxModel-738"><span class="linenos"> 738</span></a><span class="sd">            logstd (Tensor, optional): The latent space for</span>
</span><span id="LightningProxModel-739"><a href="#LightningProxModel-739"><span class="linenos"> 739</span></a><span class="sd">                :math:`\log\sigma`.  If set to :obj:`None`, uses the last</span>
</span><span id="LightningProxModel-740"><a href="#LightningProxModel-740"><span class="linenos"> 740</span></a><span class="sd">                computation of :math:`\log\sigma^2`.(default: :obj:`None`)</span>
</span><span id="LightningProxModel-741"><a href="#LightningProxModel-741"><span class="linenos"> 741</span></a><span class="sd">            weight (Tensor, optional): weights of each position in the tensor.</span>
</span><span id="LightningProxModel-742"><a href="#LightningProxModel-742"><span class="linenos"> 742</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LightningProxModel-743"><a href="#LightningProxModel-743"><span class="linenos"> 743</span></a>
</span><span id="LightningProxModel-744"><a href="#LightningProxModel-744"><span class="linenos"> 744</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">weighted_mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
</span><span id="LightningProxModel-745"><a href="#LightningProxModel-745"><span class="linenos"> 745</span></a>            <span class="c1"># if not w.any():</span>
</span><span id="LightningProxModel-746"><a href="#LightningProxModel-746"><span class="linenos"> 746</span></a>            <span class="c1">#     return 0</span>
</span><span id="LightningProxModel-747"><a href="#LightningProxModel-747"><span class="linenos"> 747</span></a>            <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel-748"><a href="#LightningProxModel-748"><span class="linenos"> 748</span></a>                <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="LightningProxModel-749"><a href="#LightningProxModel-749"><span class="linenos"> 749</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1e-12</span><span class="p">)</span>
</span><span id="LightningProxModel-750"><a href="#LightningProxModel-750"><span class="linenos"> 750</span></a>
</span><span id="LightningProxModel-751"><a href="#LightningProxModel-751"><span class="linenos"> 751</span></a>        <span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mu__</span> <span class="k">if</span> <span class="n">mu</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">mu</span>
</span><span id="LightningProxModel-752"><a href="#LightningProxModel-752"><span class="linenos"> 752</span></a>        <span class="n">logstd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__logstd__</span> <span class="k">if</span> <span class="n">logstd</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">logstd</span>
</span><span id="LightningProxModel-753"><a href="#LightningProxModel-753"><span class="linenos"> 753</span></a>        <span class="n">kls</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">logstd</span> <span class="o">-</span> <span class="n">mu</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">logstd</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="LightningProxModel-754"><a href="#LightningProxModel-754"><span class="linenos"> 754</span></a>        <span class="k">return</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">weighted_mean</span><span class="p">(</span><span class="n">kls</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span>
</span><span id="LightningProxModel-755"><a href="#LightningProxModel-755"><span class="linenos"> 755</span></a>
</span><span id="LightningProxModel-756"><a href="#LightningProxModel-756"><span class="linenos"> 756</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">relational_kl_divergence</span><span class="p">(</span>
</span><span id="LightningProxModel-757"><a href="#LightningProxModel-757"><span class="linenos"> 757</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LightningProxModel-758"><a href="#LightningProxModel-758"><span class="linenos"> 758</span></a>        <span class="n">mu_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel-759"><a href="#LightningProxModel-759"><span class="linenos"> 759</span></a>        <span class="n">logstd_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel-760"><a href="#LightningProxModel-760"><span class="linenos"> 760</span></a>        <span class="n">node_index_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel-761"><a href="#LightningProxModel-761"><span class="linenos"> 761</span></a>        <span class="n">node_weights_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel-762"><a href="#LightningProxModel-762"><span class="linenos"> 762</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
</span><span id="LightningProxModel-763"><a href="#LightningProxModel-763"><span class="linenos"> 763</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Sums KL divergence across relations.</span>
</span><span id="LightningProxModel-764"><a href="#LightningProxModel-764"><span class="linenos"> 764</span></a>
</span><span id="LightningProxModel-765"><a href="#LightningProxModel-765"><span class="linenos"> 765</span></a><span class="sd">        Args</span>
</span><span id="LightningProxModel-766"><a href="#LightningProxModel-766"><span class="linenos"> 766</span></a><span class="sd">            z_dict: encoded vector</span>
</span><span id="LightningProxModel-767"><a href="#LightningProxModel-767"><span class="linenos"> 767</span></a>
</span><span id="LightningProxModel-768"><a href="#LightningProxModel-768"><span class="linenos"> 768</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LightningProxModel-769"><a href="#LightningProxModel-769"><span class="linenos"> 769</span></a>        <span class="n">loss_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LightningProxModel-770"><a href="#LightningProxModel-770"><span class="linenos"> 770</span></a>        <span class="k">if</span> <span class="n">node_weights_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel-771"><a href="#LightningProxModel-771"><span class="linenos"> 771</span></a>            <span class="n">node_weights_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">node_type</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">mu_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">node_type</span> <span class="ow">in</span> <span class="n">mu_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
</span><span id="LightningProxModel-772"><a href="#LightningProxModel-772"><span class="linenos"> 772</span></a>        <span class="k">for</span> <span class="n">node_type</span> <span class="ow">in</span> <span class="n">mu_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="LightningProxModel-773"><a href="#LightningProxModel-773"><span class="linenos"> 773</span></a>            <span class="n">weight</span> <span class="o">=</span> <span class="n">node_weights_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">][</span><span class="n">node_index_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]]</span>
</span><span id="LightningProxModel-774"><a href="#LightningProxModel-774"><span class="linenos"> 774</span></a>            <span class="n">loss_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kl_loss</span><span class="p">(</span>
</span><span id="LightningProxModel-775"><a href="#LightningProxModel-775"><span class="linenos"> 775</span></a>                <span class="n">mu_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">],</span> <span class="n">logstd_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">],</span> <span class="n">weight</span>
</span><span id="LightningProxModel-776"><a href="#LightningProxModel-776"><span class="linenos"> 776</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel-777"><a href="#LightningProxModel-777"><span class="linenos"> 777</span></a>        <span class="k">return</span> <span class="n">loss_dict</span>
</span><span id="LightningProxModel-778"><a href="#LightningProxModel-778"><span class="linenos"> 778</span></a>
</span><span id="LightningProxModel-779"><a href="#LightningProxModel-779"><span class="linenos"> 779</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">kl_div_loss</span><span class="p">(</span>
</span><span id="LightningProxModel-780"><a href="#LightningProxModel-780"><span class="linenos"> 780</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LightningProxModel-781"><a href="#LightningProxModel-781"><span class="linenos"> 781</span></a>        <span class="n">batch</span><span class="p">,</span>
</span><span id="LightningProxModel-782"><a href="#LightningProxModel-782"><span class="linenos"> 782</span></a>        <span class="n">mu_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel-783"><a href="#LightningProxModel-783"><span class="linenos"> 783</span></a>        <span class="n">logstd_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel-784"><a href="#LightningProxModel-784"><span class="linenos"> 784</span></a>        <span class="n">node_index_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel-785"><a href="#LightningProxModel-785"><span class="linenos"> 785</span></a>        <span class="n">node_weights_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel-786"><a href="#LightningProxModel-786"><span class="linenos"> 786</span></a>        <span class="n">nodetype_loss_weight_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel-787"><a href="#LightningProxModel-787"><span class="linenos"> 787</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="LightningProxModel-788"><a href="#LightningProxModel-788"><span class="linenos"> 788</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LightningProxModel-789"><a href="#LightningProxModel-789"><span class="linenos"> 789</span></a><span class="sd">        Args</span>
</span><span id="LightningProxModel-790"><a href="#LightningProxModel-790"><span class="linenos"> 790</span></a><span class="sd">        mu_dict: mu of encoded batch</span>
</span><span id="LightningProxModel-791"><a href="#LightningProxModel-791"><span class="linenos"> 791</span></a><span class="sd">        logstd_dict: logstd of encoded batch</span>
</span><span id="LightningProxModel-792"><a href="#LightningProxModel-792"><span class="linenos"> 792</span></a><span class="sd">        node_index_dict: node index of the batch</span>
</span><span id="LightningProxModel-793"><a href="#LightningProxModel-793"><span class="linenos"> 793</span></a><span class="sd">        node_counts_dict: For entire dataset, counts how many times each node is used for KL div calculation. If None, assume no node has been used for the calculation.</span>
</span><span id="LightningProxModel-794"><a href="#LightningProxModel-794"><span class="linenos"> 794</span></a>
</span><span id="LightningProxModel-795"><a href="#LightningProxModel-795"><span class="linenos"> 795</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LightningProxModel-796"><a href="#LightningProxModel-796"><span class="linenos"> 796</span></a>        <span class="n">kl_div_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relational_kl_divergence</span><span class="p">(</span>
</span><span id="LightningProxModel-797"><a href="#LightningProxModel-797"><span class="linenos"> 797</span></a>            <span class="n">mu_dict</span><span class="p">,</span> <span class="n">logstd_dict</span><span class="p">,</span> <span class="n">node_index_dict</span><span class="p">,</span> <span class="n">node_weights_dict</span><span class="o">=</span><span class="n">node_weights_dict</span>
</span><span id="LightningProxModel-798"><a href="#LightningProxModel-798"><span class="linenos"> 798</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel-799"><a href="#LightningProxModel-799"><span class="linenos"> 799</span></a>        <span class="n">l</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel-800"><a href="#LightningProxModel-800"><span class="linenos"> 800</span></a>        <span class="k">if</span> <span class="n">nodetype_loss_weight_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel-801"><a href="#LightningProxModel-801"><span class="linenos"> 801</span></a>            <span class="n">nodetype_loss_weight_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">node_type</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">kl_div_dict</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">node_type</span> <span class="ow">in</span> <span class="n">kl_div_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
</span><span id="LightningProxModel-802"><a href="#LightningProxModel-802"><span class="linenos"> 802</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel-803"><a href="#LightningProxModel-803"><span class="linenos"> 803</span></a>            <span class="n">s</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">nodetype_loss_weight_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span> <span class="k">for</span> <span class="n">node_type</span> <span class="ow">in</span> <span class="n">kl_div_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="LightningProxModel-804"><a href="#LightningProxModel-804"><span class="linenos"> 804</span></a>            <span class="n">nodetype_loss_weight_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">node_type</span><span class="p">:</span> <span class="n">nodetype_loss_weight_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span> <span class="o">/</span> <span class="n">s</span> <span class="k">for</span> <span class="n">node_type</span> <span class="ow">in</span> <span class="n">kl_div_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
</span><span id="LightningProxModel-805"><a href="#LightningProxModel-805"><span class="linenos"> 805</span></a>        <span class="k">for</span> <span class="n">node_type</span><span class="p">,</span> <span class="n">kl_div</span> <span class="ow">in</span> <span class="n">kl_div_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="LightningProxModel-806"><a href="#LightningProxModel-806"><span class="linenos"> 806</span></a>            <span class="n">l</span> <span class="o">+=</span> <span class="n">kl_div</span> <span class="o">*</span> <span class="n">nodetype_loss_weight_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span>
</span><span id="LightningProxModel-807"><a href="#LightningProxModel-807"><span class="linenos"> 807</span></a>        <span class="k">return</span> <span class="n">l</span>
</span><span id="LightningProxModel-808"><a href="#LightningProxModel-808"><span class="linenos"> 808</span></a>
</span><span id="LightningProxModel-809"><a href="#LightningProxModel-809"><span class="linenos"> 809</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">nll_loss</span><span class="p">(</span>
</span><span id="LightningProxModel-810"><a href="#LightningProxModel-810"><span class="linenos"> 810</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LightningProxModel-811"><a href="#LightningProxModel-811"><span class="linenos"> 811</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">HeteroData</span><span class="p">,</span>
</span><span id="LightningProxModel-812"><a href="#LightningProxModel-812"><span class="linenos"> 812</span></a>        <span class="n">z_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel-813"><a href="#LightningProxModel-813"><span class="linenos"> 813</span></a>        <span class="n">pos_edge_index_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel-814"><a href="#LightningProxModel-814"><span class="linenos"> 814</span></a>        <span class="n">pos_edge_weight_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel-815"><a href="#LightningProxModel-815"><span class="linenos"> 815</span></a>        <span class="n">neg_edge_index_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel-816"><a href="#LightningProxModel-816"><span class="linenos"> 816</span></a>        <span class="c1"># num_neg_samples_fold: Optional[int] = 1,</span>
</span><span id="LightningProxModel-817"><a href="#LightningProxModel-817"><span class="linenos"> 817</span></a>        <span class="n">edgetype_loss_weight_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel-818"><a href="#LightningProxModel-818"><span class="linenos"> 818</span></a>        <span class="n">batch_alledges</span><span class="p">:</span> <span class="n">HeteroData</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel-819"><a href="#LightningProxModel-819"><span class="linenos"> 819</span></a>        <span class="n">neg_sample</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel-820"><a href="#LightningProxModel-820"><span class="linenos"> 820</span></a>    <span class="p">):</span>
</span><span id="LightningProxModel-821"><a href="#LightningProxModel-821"><span class="linenos"> 821</span></a>        <span class="n">nll_dict</span><span class="p">,</span> <span class="n">neg_edge_index_dict</span><span class="p">,</span> <span class="n">metric_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relational_recon_loss</span><span class="p">(</span>
</span><span id="LightningProxModel-822"><a href="#LightningProxModel-822"><span class="linenos"> 822</span></a>            <span class="n">batch</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span>
</span><span id="LightningProxModel-823"><a href="#LightningProxModel-823"><span class="linenos"> 823</span></a>            <span class="n">z_dict</span><span class="o">=</span><span class="n">z_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-824"><a href="#LightningProxModel-824"><span class="linenos"> 824</span></a>            <span class="n">pos_edge_index_dict</span><span class="o">=</span><span class="n">pos_edge_index_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-825"><a href="#LightningProxModel-825"><span class="linenos"> 825</span></a>            <span class="n">pos_edge_weight_dict</span><span class="o">=</span><span class="n">pos_edge_weight_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-826"><a href="#LightningProxModel-826"><span class="linenos"> 826</span></a>            <span class="n">neg_edge_index_dict</span><span class="o">=</span><span class="n">neg_edge_index_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-827"><a href="#LightningProxModel-827"><span class="linenos"> 827</span></a>            <span class="n">batch_alledges</span><span class="o">=</span><span class="n">batch_alledges</span><span class="p">,</span>
</span><span id="LightningProxModel-828"><a href="#LightningProxModel-828"><span class="linenos"> 828</span></a>            <span class="n">neg_sample</span><span class="o">=</span><span class="n">neg_sample</span><span class="p">,</span>
</span><span id="LightningProxModel-829"><a href="#LightningProxModel-829"><span class="linenos"> 829</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel-830"><a href="#LightningProxModel-830"><span class="linenos"> 830</span></a>        <span class="n">l</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel-831"><a href="#LightningProxModel-831"><span class="linenos"> 831</span></a>        <span class="n">weighted_nll_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LightningProxModel-832"><a href="#LightningProxModel-832"><span class="linenos"> 832</span></a>        <span class="k">if</span> <span class="n">edgetype_loss_weight_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel-833"><a href="#LightningProxModel-833"><span class="linenos"> 833</span></a>            <span class="n">edgetype_loss_weight_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">edge_type</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">nll_dict</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">edge_type</span> <span class="ow">in</span> <span class="n">nll_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
</span><span id="LightningProxModel-834"><a href="#LightningProxModel-834"><span class="linenos"> 834</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel-835"><a href="#LightningProxModel-835"><span class="linenos"> 835</span></a>            <span class="n">s</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">edgetype_loss_weight_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="k">for</span> <span class="n">edge_type</span> <span class="ow">in</span> <span class="n">nll_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="LightningProxModel-836"><a href="#LightningProxModel-836"><span class="linenos"> 836</span></a>            <span class="n">edgetype_loss_weight_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">edge_type</span><span class="p">:</span> <span class="n">edgetype_loss_weight_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">/</span> <span class="n">s</span> <span class="k">for</span> <span class="n">edge_type</span> <span class="ow">in</span> <span class="n">nll_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
</span><span id="LightningProxModel-837"><a href="#LightningProxModel-837"><span class="linenos"> 837</span></a>        <span class="k">for</span> <span class="n">edge_type</span><span class="p">,</span> <span class="n">nll</span> <span class="ow">in</span> <span class="n">nll_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="LightningProxModel-838"><a href="#LightningProxModel-838"><span class="linenos"> 838</span></a>            <span class="n">l</span> <span class="o">+=</span> <span class="n">nll</span> <span class="o">*</span> <span class="n">edgetype_loss_weight_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span>
</span><span id="LightningProxModel-839"><a href="#LightningProxModel-839"><span class="linenos"> 839</span></a>            <span class="n">weighted_nll_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">nll</span> <span class="o">*</span> <span class="n">edgetype_loss_weight_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span>
</span><span id="LightningProxModel-840"><a href="#LightningProxModel-840"><span class="linenos"> 840</span></a>        <span class="k">return</span> <span class="n">l</span><span class="p">,</span> <span class="n">weighted_nll_dict</span><span class="p">,</span> <span class="n">neg_edge_index_dict</span><span class="p">,</span> <span class="n">metric_dict</span>
</span><span id="LightningProxModel-841"><a href="#LightningProxModel-841"><span class="linenos"> 841</span></a>
</span><span id="LightningProxModel-842"><a href="#LightningProxModel-842"><span class="linenos"> 842</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">gene_alignment_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>        
</span><span id="LightningProxModel-843"><a href="#LightningProxModel-843"><span class="linenos"> 843</span></a>        <span class="n">gene_mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">__mu_dict__</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">]</span> <span class="c1"># (n_genes, n_latent_dims)</span>
</span><span id="LightningProxModel-844"><a href="#LightningProxModel-844"><span class="linenos"> 844</span></a>        <span class="n">pairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gene_pairs</span>
</span><span id="LightningProxModel-845"><a href="#LightningProxModel-845"><span class="linenos"> 845</span></a>        <span class="k">return</span> <span class="n">gene_alignment_msd_loss</span><span class="p">(</span><span class="n">gene_mu</span><span class="p">,</span> <span class="n">pairs</span><span class="p">)</span>
</span><span id="LightningProxModel-846"><a href="#LightningProxModel-846"><span class="linenos"> 846</span></a>
</span><span id="LightningProxModel-847"><a href="#LightningProxModel-847"><span class="linenos"> 847</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">ot_alignment_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span id="LightningProxModel-848"><a href="#LightningProxModel-848"><span class="linenos"> 848</span></a>        <span class="c1"># current trainable mu (NOT detach) =&gt; gradients flow to those cells</span>
</span><span id="LightningProxModel-849"><a href="#LightningProxModel-849"><span class="linenos"> 849</span></a>        <span class="n">cell_mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">__mu_dict__</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span>
</span><span id="LightningProxModel-850"><a href="#LightningProxModel-850"><span class="linenos"> 850</span></a>        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;cs&quot;</span><span class="p">:</span>
</span><span id="LightningProxModel-851"><a href="#LightningProxModel-851"><span class="linenos"> 851</span></a>            <span class="k">return</span> <span class="n">ot_cost_multi</span><span class="p">(</span><span class="n">cell_mu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ot_cs_states</span><span class="p">,</span> <span class="n">P_detach</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LightningProxModel-852"><a href="#LightningProxModel-852"><span class="linenos"> 852</span></a>        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;cb&quot;</span><span class="p">:</span>
</span><span id="LightningProxModel-853"><a href="#LightningProxModel-853"><span class="linenos"> 853</span></a>            <span class="k">return</span> <span class="n">ot_cost_multi</span><span class="p">(</span><span class="n">cell_mu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ot_cb_states</span><span class="p">,</span> <span class="n">P_detach</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LightningProxModel-854"><a href="#LightningProxModel-854"><span class="linenos"> 854</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel-855"><a href="#LightningProxModel-855"><span class="linenos"> 855</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown OT type=</span><span class="si">{</span><span class="nb">type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LightningProxModel-856"><a href="#LightningProxModel-856"><span class="linenos"> 856</span></a>
</span><span id="LightningProxModel-857"><a href="#LightningProxModel-857"><span class="linenos"> 857</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">training_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
</span><span id="LightningProxModel-858"><a href="#LightningProxModel-858"><span class="linenos"> 858</span></a>        <span class="c1"># batch = batch.to(self.device)</span>
</span><span id="LightningProxModel-859"><a href="#LightningProxModel-859"><span class="linenos"> 859</span></a>        
</span><span id="LightningProxModel-860"><a href="#LightningProxModel-860"><span class="linenos"> 860</span></a>        <span class="n">t_all0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="LightningProxModel-861"><a href="#LightningProxModel-861"><span class="linenos"> 861</span></a>
</span><span id="LightningProxModel-862"><a href="#LightningProxModel-862"><span class="linenos"> 862</span></a>        <span class="n">mu_dict</span><span class="p">,</span> <span class="n">logstd_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="LightningProxModel-863"><a href="#LightningProxModel-863"><span class="linenos"> 863</span></a>        <span class="n">z_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reparametrize</span><span class="p">(</span><span class="n">mu_dict</span><span class="p">,</span> <span class="n">logstd_dict</span><span class="p">)</span>
</span><span id="LightningProxModel-864"><a href="#LightningProxModel-864"><span class="linenos"> 864</span></a>
</span><span id="LightningProxModel-865"><a href="#LightningProxModel-865"><span class="linenos"> 865</span></a>        <span class="n">bs_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_edges_in_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="LightningProxModel-866"><a href="#LightningProxModel-866"><span class="linenos"> 866</span></a>
</span><span id="LightningProxModel-867"><a href="#LightningProxModel-867"><span class="linenos"> 867</span></a>        <span class="c1"># ---- NLL ----</span>
</span><span id="LightningProxModel-868"><a href="#LightningProxModel-868"><span class="linenos"> 868</span></a>        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="LightningProxModel-869"><a href="#LightningProxModel-869"><span class="linenos"> 869</span></a>        <span class="n">batch_nll_loss</span><span class="p">,</span> <span class="n">weighted_nll_dict</span><span class="p">,</span> <span class="n">neg_edge_index_dict</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nll_loss</span><span class="p">(</span>
</span><span id="LightningProxModel-870"><a href="#LightningProxModel-870"><span class="linenos"> 870</span></a>            <span class="n">batch</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span>
</span><span id="LightningProxModel-871"><a href="#LightningProxModel-871"><span class="linenos"> 871</span></a>            <span class="n">z_dict</span><span class="o">=</span><span class="n">z_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-872"><a href="#LightningProxModel-872"><span class="linenos"> 872</span></a>            <span class="n">pos_edge_index_dict</span><span class="o">=</span><span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-873"><a href="#LightningProxModel-873"><span class="linenos"> 873</span></a>            <span class="n">pos_edge_weight_dict</span><span class="o">=</span><span class="n">batch</span><span class="o">.</span><span class="n">edge_attr_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-874"><a href="#LightningProxModel-874"><span class="linenos"> 874</span></a>            <span class="n">edgetype_loss_weight_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">edgetype_loss_weight_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-875"><a href="#LightningProxModel-875"><span class="linenos"> 875</span></a>            <span class="n">neg_sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_negative</span>
</span><span id="LightningProxModel-876"><a href="#LightningProxModel-876"><span class="linenos"> 876</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel-877"><a href="#LightningProxModel-877"><span class="linenos"> 877</span></a>
</span><span id="LightningProxModel-878"><a href="#LightningProxModel-878"><span class="linenos"> 878</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;nll&quot;</span><span class="p">,</span> <span class="n">batch_nll_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel-879"><a href="#LightningProxModel-879"><span class="linenos"> 879</span></a>        <span class="c1"># self._log_perf(&quot;nll&quot;, time.time() - t0, on_step=True)</span>
</span><span id="LightningProxModel-880"><a href="#LightningProxModel-880"><span class="linenos"> 880</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">weighted_nll_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="LightningProxModel-881"><a href="#LightningProxModel-881"><span class="linenos"> 881</span></a>            <span class="k">for</span> <span class="n">edge_type</span><span class="p">,</span> <span class="n">nll_w</span> <span class="ow">in</span> <span class="n">weighted_nll_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="LightningProxModel-882"><a href="#LightningProxModel-882"><span class="linenos"> 882</span></a>                <span class="n">edge_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edge_type_key</span><span class="p">(</span><span class="n">edge_type</span><span class="p">)</span>
</span><span id="LightningProxModel-883"><a href="#LightningProxModel-883"><span class="linenos"> 883</span></a>                <span class="n">edge_bs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span><span class="o">.</span><span class="n">edge_index</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</span><span id="LightningProxModel-884"><a href="#LightningProxModel-884"><span class="linenos"> 884</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;nll/</span><span class="si">{</span><span class="n">edge_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">nll_w</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">edge_bs</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel-885"><a href="#LightningProxModel-885"><span class="linenos"> 885</span></a>        
</span><span id="LightningProxModel-886"><a href="#LightningProxModel-886"><span class="linenos"> 886</span></a>        <span class="c1"># ---- KL ----</span>
</span><span id="LightningProxModel-887"><a href="#LightningProxModel-887"><span class="linenos"> 887</span></a>        <span class="n">compute_kl_now</span><span class="p">,</span> <span class="n">kl_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_kl_now</span><span class="p">(</span><span class="n">return_weight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LightningProxModel-888"><a href="#LightningProxModel-888"><span class="linenos"> 888</span></a>        <span class="n">batch_kl_div_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel-889"><a href="#LightningProxModel-889"><span class="linenos"> 889</span></a>        <span class="k">if</span> <span class="n">compute_kl_now</span><span class="p">:</span>
</span><span id="LightningProxModel-890"><a href="#LightningProxModel-890"><span class="linenos"> 890</span></a>            <span class="n">batch_kl_div_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kl_div_loss</span><span class="p">(</span>
</span><span id="LightningProxModel-891"><a href="#LightningProxModel-891"><span class="linenos"> 891</span></a>                <span class="n">batch</span><span class="p">,</span>
</span><span id="LightningProxModel-892"><a href="#LightningProxModel-892"><span class="linenos"> 892</span></a>                <span class="n">mu_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-893"><a href="#LightningProxModel-893"><span class="linenos"> 893</span></a>                <span class="n">logstd_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-894"><a href="#LightningProxModel-894"><span class="linenos"> 894</span></a>                <span class="n">batch</span><span class="o">.</span><span class="n">n_id_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-895"><a href="#LightningProxModel-895"><span class="linenos"> 895</span></a>                <span class="n">node_weights_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node_weights_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-896"><a href="#LightningProxModel-896"><span class="linenos"> 896</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel-897"><a href="#LightningProxModel-897"><span class="linenos"> 897</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;kl&quot;</span><span class="p">,</span> <span class="n">batch_kl_div_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel-898"><a href="#LightningProxModel-898"><span class="linenos"> 898</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;kl_weighted&quot;</span><span class="p">,</span> <span class="n">kl_weight</span> <span class="o">*</span> <span class="n">batch_kl_div_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel-899"><a href="#LightningProxModel-899"><span class="linenos"> 899</span></a>        
</span><span id="LightningProxModel-900"><a href="#LightningProxModel-900"><span class="linenos"> 900</span></a>        <span class="c1"># ---- Herit Loss ----</span>
</span><span id="LightningProxModel-901"><a href="#LightningProxModel-901"><span class="linenos"> 901</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">herit_loss</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel-902"><a href="#LightningProxModel-902"><span class="linenos"> 902</span></a>            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="LightningProxModel-903"><a href="#LightningProxModel-903"><span class="linenos"> 903</span></a>            <span class="k">if</span> <span class="s2">&quot;peak&quot;</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">node_types</span><span class="p">:</span>
</span><span id="LightningProxModel-904"><a href="#LightningProxModel-904"><span class="linenos"> 904</span></a>                <span class="n">pid</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;peak&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">n_id</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="LightningProxModel-905"><a href="#LightningProxModel-905"><span class="linenos"> 905</span></a>                <span class="n">herit_loss_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">herit_loss_lam</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">herit_loss</span><span class="p">(</span>
</span><span id="LightningProxModel-906"><a href="#LightningProxModel-906"><span class="linenos"> 906</span></a>                    <span class="n">mu_dict</span><span class="p">[</span><span class="s2">&quot;peak&quot;</span><span class="p">],</span>
</span><span id="LightningProxModel-907"><a href="#LightningProxModel-907"><span class="linenos"> 907</span></a>                    <span class="n">pid</span><span class="p">,</span>
</span><span id="LightningProxModel-908"><a href="#LightningProxModel-908"><span class="linenos"> 908</span></a>                <span class="p">)</span>
</span><span id="LightningProxModel-909"><a href="#LightningProxModel-909"><span class="linenos"> 909</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel-910"><a href="#LightningProxModel-910"><span class="linenos"> 910</span></a>                <span class="n">herit_loss_value</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel-911"><a href="#LightningProxModel-911"><span class="linenos"> 911</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;herit_loss&quot;</span><span class="p">,</span> <span class="n">herit_loss_value</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel-912"><a href="#LightningProxModel-912"><span class="linenos"> 912</span></a>            <span class="c1"># self._log_perf(&quot;herit_loss&quot;, time.time() - t0, on_step=True)</span>
</span><span id="LightningProxModel-913"><a href="#LightningProxModel-913"><span class="linenos"> 913</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel-914"><a href="#LightningProxModel-914"><span class="linenos"> 914</span></a>            <span class="n">herit_loss_value</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel-915"><a href="#LightningProxModel-915"><span class="linenos"> 915</span></a>        
</span><span id="LightningProxModel-916"><a href="#LightningProxModel-916"><span class="linenos"> 916</span></a>        <span class="c1"># ---- Gene Alignment ----</span>
</span><span id="LightningProxModel-917"><a href="#LightningProxModel-917"><span class="linenos"> 917</span></a>        <span class="n">compute_gene_align_now</span><span class="p">,</span> <span class="n">gene_align_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_gene_align_now</span><span class="p">(</span><span class="n">return_weight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LightningProxModel-918"><a href="#LightningProxModel-918"><span class="linenos"> 918</span></a>
</span><span id="LightningProxModel-919"><a href="#LightningProxModel-919"><span class="linenos"> 919</span></a>        <span class="n">gene_align_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel-920"><a href="#LightningProxModel-920"><span class="linenos"> 920</span></a>        <span class="k">if</span> <span class="n">compute_gene_align_now</span><span class="p">:</span>
</span><span id="LightningProxModel-921"><a href="#LightningProxModel-921"><span class="linenos"> 921</span></a>            <span class="n">gene_align_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gene_alignment_loss</span><span class="p">()</span>
</span><span id="LightningProxModel-922"><a href="#LightningProxModel-922"><span class="linenos"> 922</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;gene_align&quot;</span><span class="p">,</span> <span class="n">gene_align_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel-923"><a href="#LightningProxModel-923"><span class="linenos"> 923</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;gene_align_weighted&quot;</span><span class="p">,</span> <span class="n">gene_align_weight</span> <span class="o">*</span> <span class="n">gene_align_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel-924"><a href="#LightningProxModel-924"><span class="linenos"> 924</span></a>
</span><span id="LightningProxModel-925"><a href="#LightningProxModel-925"><span class="linenos"> 925</span></a>        <span class="c1"># ---- OT loss ----</span>
</span><span id="LightningProxModel-926"><a href="#LightningProxModel-926"><span class="linenos"> 926</span></a>        <span class="n">compute_ot_cs_now</span><span class="p">,</span> <span class="n">ot_cs_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_ot_cs_now</span><span class="p">(</span><span class="n">return_weight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LightningProxModel-927"><a href="#LightningProxModel-927"><span class="linenos"> 927</span></a>
</span><span id="LightningProxModel-928"><a href="#LightningProxModel-928"><span class="linenos"> 928</span></a>        <span class="n">ot_cs_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel-929"><a href="#LightningProxModel-929"><span class="linenos"> 929</span></a>        <span class="k">if</span> <span class="n">compute_ot_cs_now</span><span class="p">:</span>
</span><span id="LightningProxModel-930"><a href="#LightningProxModel-930"><span class="linenos"> 930</span></a>            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="LightningProxModel-931"><a href="#LightningProxModel-931"><span class="linenos"> 931</span></a>            <span class="n">ot_cs_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_alignment_loss</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;cs&quot;</span><span class="p">)</span>
</span><span id="LightningProxModel-932"><a href="#LightningProxModel-932"><span class="linenos"> 932</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;ot_cs_loss&quot;</span><span class="p">,</span> <span class="n">ot_cs_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel-933"><a href="#LightningProxModel-933"><span class="linenos"> 933</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;ot_cs_weighted&quot;</span><span class="p">,</span> <span class="n">ot_cs_weight</span> <span class="o">*</span> <span class="n">ot_cs_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel-934"><a href="#LightningProxModel-934"><span class="linenos"> 934</span></a>            <span class="c1"># self._log_perf(&quot;ot_cs_loss&quot;, time.time() - t0, on_step=True)</span>
</span><span id="LightningProxModel-935"><a href="#LightningProxModel-935"><span class="linenos"> 935</span></a>        
</span><span id="LightningProxModel-936"><a href="#LightningProxModel-936"><span class="linenos"> 936</span></a>        <span class="n">compute_ot_cb_now</span><span class="p">,</span> <span class="n">ot_cb_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_ot_cb_now</span><span class="p">(</span><span class="n">return_weight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LightningProxModel-937"><a href="#LightningProxModel-937"><span class="linenos"> 937</span></a>        <span class="n">ot_cb_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel-938"><a href="#LightningProxModel-938"><span class="linenos"> 938</span></a>        <span class="k">if</span> <span class="n">compute_ot_cb_now</span><span class="p">:</span>
</span><span id="LightningProxModel-939"><a href="#LightningProxModel-939"><span class="linenos"> 939</span></a>            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="LightningProxModel-940"><a href="#LightningProxModel-940"><span class="linenos"> 940</span></a>            <span class="n">ot_cb_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_alignment_loss</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;cb&quot;</span><span class="p">)</span>
</span><span id="LightningProxModel-941"><a href="#LightningProxModel-941"><span class="linenos"> 941</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;ot_cb_loss&quot;</span><span class="p">,</span> <span class="n">ot_cb_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel-942"><a href="#LightningProxModel-942"><span class="linenos"> 942</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;ot_cb_weighted&quot;</span><span class="p">,</span> <span class="n">ot_cb_weight</span> <span class="o">*</span> <span class="n">ot_cb_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel-943"><a href="#LightningProxModel-943"><span class="linenos"> 943</span></a>            <span class="c1"># self._log_perf(&quot;ot_cb_loss&quot;, time.time() - t0, on_step=True)</span>
</span><span id="LightningProxModel-944"><a href="#LightningProxModel-944"><span class="linenos"> 944</span></a>        
</span><span id="LightningProxModel-945"><a href="#LightningProxModel-945"><span class="linenos"> 945</span></a>        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LightningProxModel-946"><a href="#LightningProxModel-946"><span class="linenos"> 946</span></a>            <span class="n">batch_nll_loss</span>
</span><span id="LightningProxModel-947"><a href="#LightningProxModel-947"><span class="linenos"> 947</span></a>            <span class="o">+</span> <span class="n">kl_weight</span> <span class="o">*</span> <span class="n">batch_kl_div_loss</span>
</span><span id="LightningProxModel-948"><a href="#LightningProxModel-948"><span class="linenos"> 948</span></a>            <span class="c1"># + aux_kl_div_loss / self.nll_scale</span>
</span><span id="LightningProxModel-949"><a href="#LightningProxModel-949"><span class="linenos"> 949</span></a>            <span class="o">+</span> <span class="n">herit_loss_value</span>
</span><span id="LightningProxModel-950"><a href="#LightningProxModel-950"><span class="linenos"> 950</span></a>            <span class="c1"># + aux_reg_loss</span>
</span><span id="LightningProxModel-951"><a href="#LightningProxModel-951"><span class="linenos"> 951</span></a>            <span class="o">+</span> <span class="n">gene_align_weight</span> <span class="o">*</span> <span class="n">gene_align_loss</span>
</span><span id="LightningProxModel-952"><a href="#LightningProxModel-952"><span class="linenos"> 952</span></a>            <span class="o">+</span> <span class="n">ot_cs_weight</span> <span class="o">*</span> <span class="n">ot_cs_loss</span>
</span><span id="LightningProxModel-953"><a href="#LightningProxModel-953"><span class="linenos"> 953</span></a>            <span class="o">+</span> <span class="n">ot_cb_weight</span> <span class="o">*</span> <span class="n">ot_cb_loss</span>
</span><span id="LightningProxModel-954"><a href="#LightningProxModel-954"><span class="linenos"> 954</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel-955"><a href="#LightningProxModel-955"><span class="linenos"> 955</span></a>
</span><span id="LightningProxModel-956"><a href="#LightningProxModel-956"><span class="linenos"> 956</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;loss&quot;</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LightningProxModel-957"><a href="#LightningProxModel-957"><span class="linenos"> 957</span></a>        <span class="c1"># self._log_perf(&quot;step_total&quot;, time.time() - t_all0, on_step=True)</span>
</span><span id="LightningProxModel-958"><a href="#LightningProxModel-958"><span class="linenos"> 958</span></a>
</span><span id="LightningProxModel-959"><a href="#LightningProxModel-959"><span class="linenos"> 959</span></a>        <span class="c1"># Debug: Monitor gradients and embeddings every 10 steps</span>
</span><span id="LightningProxModel-960"><a href="#LightningProxModel-960"><span class="linenos"> 960</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_step</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="LightningProxModel-961"><a href="#LightningProxModel-961"><span class="linenos"> 961</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_debug_embeddings_only</span><span class="p">(</span><span class="n">mu_dict</span><span class="p">,</span> <span class="n">logstd_dict</span><span class="p">)</span>
</span><span id="LightningProxModel-962"><a href="#LightningProxModel-962"><span class="linenos"> 962</span></a>
</span><span id="LightningProxModel-963"><a href="#LightningProxModel-963"><span class="linenos"> 963</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">local_step</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="LightningProxModel-964"><a href="#LightningProxModel-964"><span class="linenos"> 964</span></a>
</span><span id="LightningProxModel-965"><a href="#LightningProxModel-965"><span class="linenos"> 965</span></a>        <span class="k">return</span> <span class="n">loss</span>
</span><span id="LightningProxModel-966"><a href="#LightningProxModel-966"><span class="linenos"> 966</span></a>
</span><span id="LightningProxModel-967"><a href="#LightningProxModel-967"><span class="linenos"> 967</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_after_backward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LightningProxModel-968"><a href="#LightningProxModel-968"><span class="linenos"> 968</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Called after loss.backward() and before optimizers are stepped.&quot;&quot;&quot;</span>
</span><span id="LightningProxModel-969"><a href="#LightningProxModel-969"><span class="linenos"> 969</span></a>
</span><span id="LightningProxModel-970"><a href="#LightningProxModel-970"><span class="linenos"> 970</span></a>        <span class="c1"># Gradient clipping to prevent aux_params from dominating</span>
</span><span id="LightningProxModel-971"><a href="#LightningProxModel-971"><span class="linenos"> 971</span></a>        <span class="c1"># torch.nn.utils.clip_grad_norm_(self.aux_params.parameters(), max_norm=1.0)</span>
</span><span id="LightningProxModel-972"><a href="#LightningProxModel-972"><span class="linenos"> 972</span></a>
</span><span id="LightningProxModel-973"><a href="#LightningProxModel-973"><span class="linenos"> 973</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_step</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="LightningProxModel-974"><a href="#LightningProxModel-974"><span class="linenos"> 974</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_debug_gradients</span><span class="p">()</span>
</span><span id="LightningProxModel-975"><a href="#LightningProxModel-975"><span class="linenos"> 975</span></a>
</span><span id="LightningProxModel-976"><a href="#LightningProxModel-976"><span class="linenos"> 976</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_debug_embeddings_only</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu_dict</span><span class="p">,</span> <span class="n">logstd_dict</span><span class="p">):</span>
</span><span id="LightningProxModel-977"><a href="#LightningProxModel-977"><span class="linenos"> 977</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Debug method to monitor embedding quality only (no gradients).&quot;&quot;&quot;</span>
</span><span id="LightningProxModel-978"><a href="#LightningProxModel-978"><span class="linenos"> 978</span></a>
</span><span id="LightningProxModel-979"><a href="#LightningProxModel-979"><span class="linenos"> 979</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="LightningProxModel-980"><a href="#LightningProxModel-980"><span class="linenos"> 980</span></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== EMBEDDING DEBUG - Epoch </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="si">}</span><span class="s2">, Step </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">global_step</span><span class="si">}</span><span class="s2"> ===&quot;</span>
</span><span id="LightningProxModel-981"><a href="#LightningProxModel-981"><span class="linenos"> 981</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel-982"><a href="#LightningProxModel-982"><span class="linenos"> 982</span></a>
</span><span id="LightningProxModel-983"><a href="#LightningProxModel-983"><span class="linenos"> 983</span></a>        <span class="c1"># 1. Check KL Divergence and Variance</span>
</span><span id="LightningProxModel-984"><a href="#LightningProxModel-984"><span class="linenos"> 984</span></a>        <span class="k">for</span> <span class="n">node_type</span> <span class="ow">in</span> <span class="n">mu_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="LightningProxModel-985"><a href="#LightningProxModel-985"><span class="linenos"> 985</span></a>            <span class="n">mu_std</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">mu_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="LightningProxModel-986"><a href="#LightningProxModel-986"><span class="linenos"> 986</span></a>            <span class="n">logstd_mean</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">logstd_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="LightningProxModel-987"><a href="#LightningProxModel-987"><span class="linenos"> 987</span></a>
</span><span id="LightningProxModel-988"><a href="#LightningProxModel-988"><span class="linenos"> 988</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="LightningProxModel-989"><a href="#LightningProxModel-989"><span class="linenos"> 989</span></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node_type</span><span class="si">}</span><span class="s2"> - mu std: </span><span class="si">{</span><span class="n">mu_std</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, logstd mean: </span><span class="si">{</span><span class="n">logstd_mean</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="LightningProxModel-990"><a href="#LightningProxModel-990"><span class="linenos"> 990</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel-991"><a href="#LightningProxModel-991"><span class="linenos"> 991</span></a>
</span><span id="LightningProxModel-992"><a href="#LightningProxModel-992"><span class="linenos"> 992</span></a>            <span class="c1"># Check for collapse</span>
</span><span id="LightningProxModel-993"><a href="#LightningProxModel-993"><span class="linenos"> 993</span></a>            <span class="k">if</span> <span class="n">mu_std</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>
</span><span id="LightningProxModel-994"><a href="#LightningProxModel-994"><span class="linenos"> 994</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: Potential mu collapse in </span><span class="si">{</span><span class="n">node_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LightningProxModel-995"><a href="#LightningProxModel-995"><span class="linenos"> 995</span></a>            <span class="k">if</span> <span class="n">logstd_mean</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">5</span><span class="p">:</span>
</span><span id="LightningProxModel-996"><a href="#LightningProxModel-996"><span class="linenos"> 996</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="LightningProxModel-997"><a href="#LightningProxModel-997"><span class="linenos"> 997</span></a>                    <span class="sa">f</span><span class="s2">&quot;WARNING: Potential variance collapse in </span><span class="si">{</span><span class="n">node_type</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="LightningProxModel-998"><a href="#LightningProxModel-998"><span class="linenos"> 998</span></a>                <span class="p">)</span>
</span><span id="LightningProxModel-999"><a href="#LightningProxModel-999"><span class="linenos"> 999</span></a>
</span><span id="LightningProxModel-1000"><a href="#LightningProxModel-1000"><span class="linenos">1000</span></a>        <span class="c1"># 2. Check latent representation quality</span>
</span><span id="LightningProxModel-1001"><a href="#LightningProxModel-1001"><span class="linenos">1001</span></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="LightningProxModel-1002"><a href="#LightningProxModel-1002"><span class="linenos">1002</span></a>            <span class="n">z_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reparametrize</span><span class="p">(</span><span class="n">mu_dict</span><span class="p">,</span> <span class="n">logstd_dict</span><span class="p">)</span>
</span><span id="LightningProxModel-1003"><a href="#LightningProxModel-1003"><span class="linenos">1003</span></a>
</span><span id="LightningProxModel-1004"><a href="#LightningProxModel-1004"><span class="linenos">1004</span></a>            <span class="k">for</span> <span class="n">node_type</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">z_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="LightningProxModel-1005"><a href="#LightningProxModel-1005"><span class="linenos">1005</span></a>                <span class="c1"># Check variance across dimensions</span>
</span><span id="LightningProxModel-1006"><a href="#LightningProxModel-1006"><span class="linenos">1006</span></a>                <span class="n">dim_vars</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="LightningProxModel-1007"><a href="#LightningProxModel-1007"><span class="linenos">1007</span></a>                <span class="n">active_dims</span> <span class="o">=</span> <span class="p">(</span><span class="n">dim_vars</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="LightningProxModel-1008"><a href="#LightningProxModel-1008"><span class="linenos">1008</span></a>                <span class="n">total_dims</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="LightningProxModel-1009"><a href="#LightningProxModel-1009"><span class="linenos">1009</span></a>
</span><span id="LightningProxModel-1010"><a href="#LightningProxModel-1010"><span class="linenos">1010</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="LightningProxModel-1011"><a href="#LightningProxModel-1011"><span class="linenos">1011</span></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node_type</span><span class="si">}</span><span class="s2"> - Active dims: </span><span class="si">{</span><span class="n">active_dims</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_dims</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="LightningProxModel-1012"><a href="#LightningProxModel-1012"><span class="linenos">1012</span></a>                <span class="p">)</span>
</span><span id="LightningProxModel-1013"><a href="#LightningProxModel-1013"><span class="linenos">1013</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="LightningProxModel-1014"><a href="#LightningProxModel-1014"><span class="linenos">1014</span></a>                    <span class="sa">f</span><span class="s2">&quot;  Min/Max variance: </span><span class="si">{</span><span class="n">dim_vars</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">dim_vars</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="LightningProxModel-1015"><a href="#LightningProxModel-1015"><span class="linenos">1015</span></a>                <span class="p">)</span>
</span><span id="LightningProxModel-1016"><a href="#LightningProxModel-1016"><span class="linenos">1016</span></a>
</span><span id="LightningProxModel-1017"><a href="#LightningProxModel-1017"><span class="linenos">1017</span></a>                <span class="k">if</span> <span class="n">active_dims</span> <span class="o">&lt;</span> <span class="n">total_dims</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">:</span>
</span><span id="LightningProxModel-1018"><a href="#LightningProxModel-1018"><span class="linenos">1018</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="LightningProxModel-1019"><a href="#LightningProxModel-1019"><span class="linenos">1019</span></a>                        <span class="sa">f</span><span class="s2">&quot;WARNING: Very few active dimensions in </span><span class="si">{</span><span class="n">node_type</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="LightningProxModel-1020"><a href="#LightningProxModel-1020"><span class="linenos">1020</span></a>                    <span class="p">)</span>
</span><span id="LightningProxModel-1021"><a href="#LightningProxModel-1021"><span class="linenos">1021</span></a>
</span><span id="LightningProxModel-1022"><a href="#LightningProxModel-1022"><span class="linenos">1022</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
</span><span id="LightningProxModel-1023"><a href="#LightningProxModel-1023"><span class="linenos">1023</span></a>
</span><span id="LightningProxModel-1024"><a href="#LightningProxModel-1024"><span class="linenos">1024</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_debug_gradients</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LightningProxModel-1025"><a href="#LightningProxModel-1025"><span class="linenos">1025</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Debug method to monitor gradients after backward pass.&quot;&quot;&quot;</span>
</span><span id="LightningProxModel-1026"><a href="#LightningProxModel-1026"><span class="linenos">1026</span></a>
</span><span id="LightningProxModel-1027"><a href="#LightningProxModel-1027"><span class="linenos">1027</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="LightningProxModel-1028"><a href="#LightningProxModel-1028"><span class="linenos">1028</span></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== GRADIENT DEBUG - Epoch </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span><span class="si">}</span><span class="s2">, Step </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">global_step</span><span class="si">}</span><span class="s2"> ===&quot;</span>
</span><span id="LightningProxModel-1029"><a href="#LightningProxModel-1029"><span class="linenos">1029</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel-1030"><a href="#LightningProxModel-1030"><span class="linenos">1030</span></a>
</span><span id="LightningProxModel-1031"><a href="#LightningProxModel-1031"><span class="linenos">1031</span></a>        <span class="c1"># Check gradient norms after backward pass</span>
</span><span id="LightningProxModel-1032"><a href="#LightningProxModel-1032"><span class="linenos">1032</span></a>        <span class="n">encoder_grad_norm</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="LightningProxModel-1033"><a href="#LightningProxModel-1033"><span class="linenos">1033</span></a>        <span class="n">decoder_grad_norm</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="LightningProxModel-1034"><a href="#LightningProxModel-1034"><span class="linenos">1034</span></a>        <span class="n">aux_grad_norm</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="LightningProxModel-1035"><a href="#LightningProxModel-1035"><span class="linenos">1035</span></a>
</span><span id="LightningProxModel-1036"><a href="#LightningProxModel-1036"><span class="linenos">1036</span></a>        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
</span><span id="LightningProxModel-1037"><a href="#LightningProxModel-1037"><span class="linenos">1037</span></a>            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">grad</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel-1038"><a href="#LightningProxModel-1038"><span class="linenos">1038</span></a>                <span class="n">grad_norm</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span>
</span><span id="LightningProxModel-1039"><a href="#LightningProxModel-1039"><span class="linenos">1039</span></a>                <span class="k">if</span> <span class="s2">&quot;encoder&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
</span><span id="LightningProxModel-1040"><a href="#LightningProxModel-1040"><span class="linenos">1040</span></a>                    <span class="n">encoder_grad_norm</span> <span class="o">+=</span> <span class="n">grad_norm</span>
</span><span id="LightningProxModel-1041"><a href="#LightningProxModel-1041"><span class="linenos">1041</span></a>                <span class="k">elif</span> <span class="s2">&quot;decoder&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
</span><span id="LightningProxModel-1042"><a href="#LightningProxModel-1042"><span class="linenos">1042</span></a>                    <span class="n">decoder_grad_norm</span> <span class="o">+=</span> <span class="n">grad_norm</span>
</span><span id="LightningProxModel-1043"><a href="#LightningProxModel-1043"><span class="linenos">1043</span></a>                <span class="k">elif</span> <span class="s2">&quot;aux_params&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
</span><span id="LightningProxModel-1044"><a href="#LightningProxModel-1044"><span class="linenos">1044</span></a>                    <span class="n">aux_grad_norm</span> <span class="o">+=</span> <span class="n">grad_norm</span>
</span><span id="LightningProxModel-1045"><a href="#LightningProxModel-1045"><span class="linenos">1045</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel-1046"><a href="#LightningProxModel-1046"><span class="linenos">1046</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No gradient for: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LightningProxModel-1047"><a href="#LightningProxModel-1047"><span class="linenos">1047</span></a>
</span><span id="LightningProxModel-1048"><a href="#LightningProxModel-1048"><span class="linenos">1048</span></a>        <span class="n">encoder_grad_norm</span> <span class="o">=</span> <span class="n">encoder_grad_norm</span><span class="o">**</span><span class="mf">0.5</span>
</span><span id="LightningProxModel-1049"><a href="#LightningProxModel-1049"><span class="linenos">1049</span></a>        <span class="n">decoder_grad_norm</span> <span class="o">=</span> <span class="n">decoder_grad_norm</span><span class="o">**</span><span class="mf">0.5</span>
</span><span id="LightningProxModel-1050"><a href="#LightningProxModel-1050"><span class="linenos">1050</span></a>        <span class="n">aux_grad_norm</span> <span class="o">=</span> <span class="n">aux_grad_norm</span><span class="o">**</span><span class="mf">0.5</span>
</span><span id="LightningProxModel-1051"><a href="#LightningProxModel-1051"><span class="linenos">1051</span></a>
</span><span id="LightningProxModel-1052"><a href="#LightningProxModel-1052"><span class="linenos">1052</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Encoder grad norm: </span><span class="si">{</span><span class="n">encoder_grad_norm</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LightningProxModel-1053"><a href="#LightningProxModel-1053"><span class="linenos">1053</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Decoder grad norm: </span><span class="si">{</span><span class="n">decoder_grad_norm</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LightningProxModel-1054"><a href="#LightningProxModel-1054"><span class="linenos">1054</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Aux params grad norm: </span><span class="si">{</span><span class="n">aux_grad_norm</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LightningProxModel-1055"><a href="#LightningProxModel-1055"><span class="linenos">1055</span></a>
</span><span id="LightningProxModel-1056"><a href="#LightningProxModel-1056"><span class="linenos">1056</span></a>        <span class="c1"># Check gradient ratios</span>
</span><span id="LightningProxModel-1057"><a href="#LightningProxModel-1057"><span class="linenos">1057</span></a>        <span class="n">total_grad_norm</span> <span class="o">=</span> <span class="n">encoder_grad_norm</span> <span class="o">+</span> <span class="n">decoder_grad_norm</span> <span class="o">+</span> <span class="n">aux_grad_norm</span>
</span><span id="LightningProxModel-1058"><a href="#LightningProxModel-1058"><span class="linenos">1058</span></a>        <span class="k">if</span> <span class="n">total_grad_norm</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LightningProxModel-1059"><a href="#LightningProxModel-1059"><span class="linenos">1059</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="LightningProxModel-1060"><a href="#LightningProxModel-1060"><span class="linenos">1060</span></a>                <span class="sa">f</span><span class="s2">&quot;Encoder grad %: </span><span class="si">{</span><span class="mi">100</span><span class="o">*</span><span class="n">encoder_grad_norm</span><span class="o">/</span><span class="n">total_grad_norm</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span>
</span><span id="LightningProxModel-1061"><a href="#LightningProxModel-1061"><span class="linenos">1061</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel-1062"><a href="#LightningProxModel-1062"><span class="linenos">1062</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="LightningProxModel-1063"><a href="#LightningProxModel-1063"><span class="linenos">1063</span></a>                <span class="sa">f</span><span class="s2">&quot;Decoder grad %: </span><span class="si">{</span><span class="mi">100</span><span class="o">*</span><span class="n">decoder_grad_norm</span><span class="o">/</span><span class="n">total_grad_norm</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span>
</span><span id="LightningProxModel-1064"><a href="#LightningProxModel-1064"><span class="linenos">1064</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel-1065"><a href="#LightningProxModel-1065"><span class="linenos">1065</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="LightningProxModel-1066"><a href="#LightningProxModel-1066"><span class="linenos">1066</span></a>                <span class="sa">f</span><span class="s2">&quot;Aux params grad %: </span><span class="si">{</span><span class="mi">100</span><span class="o">*</span><span class="n">aux_grad_norm</span><span class="o">/</span><span class="n">total_grad_norm</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span>
</span><span id="LightningProxModel-1067"><a href="#LightningProxModel-1067"><span class="linenos">1067</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel-1068"><a href="#LightningProxModel-1068"><span class="linenos">1068</span></a>
</span><span id="LightningProxModel-1069"><a href="#LightningProxModel-1069"><span class="linenos">1069</span></a>            <span class="k">if</span> <span class="n">encoder_grad_norm</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">decoder_grad_norm</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LightningProxModel-1070"><a href="#LightningProxModel-1070"><span class="linenos">1070</span></a>                <span class="n">ratio</span> <span class="o">=</span> <span class="n">encoder_grad_norm</span> <span class="o">/</span> <span class="n">decoder_grad_norm</span>
</span><span id="LightningProxModel-1071"><a href="#LightningProxModel-1071"><span class="linenos">1071</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Encoder/Decoder grad ratio: </span><span class="si">{</span><span class="n">ratio</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LightningProxModel-1072"><a href="#LightningProxModel-1072"><span class="linenos">1072</span></a>                <span class="k">if</span> <span class="n">ratio</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>
</span><span id="LightningProxModel-1073"><a href="#LightningProxModel-1073"><span class="linenos">1073</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="LightningProxModel-1074"><a href="#LightningProxModel-1074"><span class="linenos">1074</span></a>                        <span class="s2">&quot;WARNING: Encoder gradients much smaller than decoder&quot;</span>
</span><span id="LightningProxModel-1075"><a href="#LightningProxModel-1075"><span class="linenos">1075</span></a>                    <span class="p">)</span>
</span><span id="LightningProxModel-1076"><a href="#LightningProxModel-1076"><span class="linenos">1076</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel-1077"><a href="#LightningProxModel-1077"><span class="linenos">1077</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;WARNING: No gradients found!&quot;</span><span class="p">)</span>
</span><span id="LightningProxModel-1078"><a href="#LightningProxModel-1078"><span class="linenos">1078</span></a>
</span><span id="LightningProxModel-1079"><a href="#LightningProxModel-1079"><span class="linenos">1079</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
</span><span id="LightningProxModel-1080"><a href="#LightningProxModel-1080"><span class="linenos">1080</span></a>
</span><span id="LightningProxModel-1081"><a href="#LightningProxModel-1081"><span class="linenos">1081</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validation_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
</span><span id="LightningProxModel-1082"><a href="#LightningProxModel-1082"><span class="linenos">1082</span></a>        <span class="c1"># batch = batch.to(self.device)</span>
</span><span id="LightningProxModel-1083"><a href="#LightningProxModel-1083"><span class="linenos">1083</span></a>        
</span><span id="LightningProxModel-1084"><a href="#LightningProxModel-1084"><span class="linenos">1084</span></a>        <span class="n">mu_dict</span><span class="p">,</span> <span class="n">logstd_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="LightningProxModel-1085"><a href="#LightningProxModel-1085"><span class="linenos">1085</span></a>        <span class="n">z_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reparametrize</span><span class="p">(</span><span class="n">mu_dict</span><span class="p">,</span> <span class="n">logstd_dict</span><span class="p">)</span>
</span><span id="LightningProxModel-1086"><a href="#LightningProxModel-1086"><span class="linenos">1086</span></a>        
</span><span id="LightningProxModel-1087"><a href="#LightningProxModel-1087"><span class="linenos">1087</span></a>        <span class="n">bs_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_edges_in_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="LightningProxModel-1088"><a href="#LightningProxModel-1088"><span class="linenos">1088</span></a>
</span><span id="LightningProxModel-1089"><a href="#LightningProxModel-1089"><span class="linenos">1089</span></a>        <span class="c1"># ---- NLL ----</span>
</span><span id="LightningProxModel-1090"><a href="#LightningProxModel-1090"><span class="linenos">1090</span></a>        <span class="n">batch_nll_loss</span><span class="p">,</span> <span class="n">weighted_nll_dict</span><span class="p">,</span> <span class="n">neg_edge_index_dict</span><span class="p">,</span> <span class="n">metric_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nll_loss</span><span class="p">(</span>
</span><span id="LightningProxModel-1091"><a href="#LightningProxModel-1091"><span class="linenos">1091</span></a>            <span class="n">batch</span><span class="p">,</span>
</span><span id="LightningProxModel-1092"><a href="#LightningProxModel-1092"><span class="linenos">1092</span></a>            <span class="n">z_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-1093"><a href="#LightningProxModel-1093"><span class="linenos">1093</span></a>            <span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-1094"><a href="#LightningProxModel-1094"><span class="linenos">1094</span></a>            <span class="n">batch</span><span class="o">.</span><span class="n">edge_attr_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-1095"><a href="#LightningProxModel-1095"><span class="linenos">1095</span></a>            <span class="n">edgetype_loss_weight_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">edgetype_loss_weight_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-1096"><a href="#LightningProxModel-1096"><span class="linenos">1096</span></a>            <span class="n">neg_sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_negative</span>
</span><span id="LightningProxModel-1097"><a href="#LightningProxModel-1097"><span class="linenos">1097</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel-1098"><a href="#LightningProxModel-1098"><span class="linenos">1098</span></a>
</span><span id="LightningProxModel-1099"><a href="#LightningProxModel-1099"><span class="linenos">1099</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;nll&quot;</span><span class="p">,</span> <span class="n">batch_nll_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel-1100"><a href="#LightningProxModel-1100"><span class="linenos">1100</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">weighted_nll_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="LightningProxModel-1101"><a href="#LightningProxModel-1101"><span class="linenos">1101</span></a>            <span class="k">for</span> <span class="n">edge_type</span><span class="p">,</span> <span class="n">nll_w</span> <span class="ow">in</span> <span class="n">weighted_nll_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="LightningProxModel-1102"><a href="#LightningProxModel-1102"><span class="linenos">1102</span></a>                <span class="n">edge_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edge_type_key</span><span class="p">(</span><span class="n">edge_type</span><span class="p">)</span>
</span><span id="LightningProxModel-1103"><a href="#LightningProxModel-1103"><span class="linenos">1103</span></a>                <span class="n">edge_bs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span><span class="o">.</span><span class="n">edge_index</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</span><span id="LightningProxModel-1104"><a href="#LightningProxModel-1104"><span class="linenos">1104</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;nll/</span><span class="si">{</span><span class="n">edge_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">nll_w</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">edge_bs</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel-1105"><a href="#LightningProxModel-1105"><span class="linenos">1105</span></a>
</span><span id="LightningProxModel-1106"><a href="#LightningProxModel-1106"><span class="linenos">1106</span></a>        <span class="c1"># ---- KL ----</span>
</span><span id="LightningProxModel-1107"><a href="#LightningProxModel-1107"><span class="linenos">1107</span></a>        <span class="n">compute_kl_now</span><span class="p">,</span> <span class="n">kl_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_kl_now</span><span class="p">(</span><span class="n">return_weight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LightningProxModel-1108"><a href="#LightningProxModel-1108"><span class="linenos">1108</span></a>        <span class="n">batch_kl_div_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel-1109"><a href="#LightningProxModel-1109"><span class="linenos">1109</span></a>        <span class="k">if</span> <span class="n">compute_kl_now</span><span class="p">:</span>
</span><span id="LightningProxModel-1110"><a href="#LightningProxModel-1110"><span class="linenos">1110</span></a>            <span class="n">batch_kl_div_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kl_div_loss</span><span class="p">(</span>
</span><span id="LightningProxModel-1111"><a href="#LightningProxModel-1111"><span class="linenos">1111</span></a>                <span class="n">batch</span><span class="p">,</span>
</span><span id="LightningProxModel-1112"><a href="#LightningProxModel-1112"><span class="linenos">1112</span></a>                <span class="n">mu_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-1113"><a href="#LightningProxModel-1113"><span class="linenos">1113</span></a>                <span class="n">logstd_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-1114"><a href="#LightningProxModel-1114"><span class="linenos">1114</span></a>                <span class="n">batch</span><span class="o">.</span><span class="n">n_id_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-1115"><a href="#LightningProxModel-1115"><span class="linenos">1115</span></a>                <span class="n">node_weights_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node_weights_dict</span><span class="p">,</span>
</span><span id="LightningProxModel-1116"><a href="#LightningProxModel-1116"><span class="linenos">1116</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel-1117"><a href="#LightningProxModel-1117"><span class="linenos">1117</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;kl&quot;</span><span class="p">,</span> <span class="n">batch_kl_div_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel-1118"><a href="#LightningProxModel-1118"><span class="linenos">1118</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;kl_weighted&quot;</span><span class="p">,</span> <span class="n">kl_weight</span> <span class="o">*</span> <span class="n">batch_kl_div_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel-1119"><a href="#LightningProxModel-1119"><span class="linenos">1119</span></a>
</span><span id="LightningProxModel-1120"><a href="#LightningProxModel-1120"><span class="linenos">1120</span></a>        <span class="c1"># ---- Herit Loss ----</span>
</span><span id="LightningProxModel-1121"><a href="#LightningProxModel-1121"><span class="linenos">1121</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">herit_loss</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel-1122"><a href="#LightningProxModel-1122"><span class="linenos">1122</span></a>            <span class="k">if</span> <span class="s2">&quot;peak&quot;</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">node_types</span><span class="p">:</span>
</span><span id="LightningProxModel-1123"><a href="#LightningProxModel-1123"><span class="linenos">1123</span></a>                <span class="n">pid</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;peak&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">n_id</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="LightningProxModel-1124"><a href="#LightningProxModel-1124"><span class="linenos">1124</span></a>                <span class="n">herit_loss_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">herit_loss_lam</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">herit_loss</span><span class="p">(</span>
</span><span id="LightningProxModel-1125"><a href="#LightningProxModel-1125"><span class="linenos">1125</span></a>                    <span class="n">mu_dict</span><span class="p">[</span><span class="s2">&quot;peak&quot;</span><span class="p">],</span>
</span><span id="LightningProxModel-1126"><a href="#LightningProxModel-1126"><span class="linenos">1126</span></a>                    <span class="n">pid</span><span class="p">,</span>
</span><span id="LightningProxModel-1127"><a href="#LightningProxModel-1127"><span class="linenos">1127</span></a>                <span class="p">)</span>
</span><span id="LightningProxModel-1128"><a href="#LightningProxModel-1128"><span class="linenos">1128</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel-1129"><a href="#LightningProxModel-1129"><span class="linenos">1129</span></a>                <span class="n">herit_loss_value</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel-1130"><a href="#LightningProxModel-1130"><span class="linenos">1130</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;herit_loss&quot;</span><span class="p">,</span> <span class="n">herit_loss_value</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel-1131"><a href="#LightningProxModel-1131"><span class="linenos">1131</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel-1132"><a href="#LightningProxModel-1132"><span class="linenos">1132</span></a>            <span class="n">herit_loss_value</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel-1133"><a href="#LightningProxModel-1133"><span class="linenos">1133</span></a>        
</span><span id="LightningProxModel-1134"><a href="#LightningProxModel-1134"><span class="linenos">1134</span></a>        <span class="c1"># ---- Gene Alignment ----</span>
</span><span id="LightningProxModel-1135"><a href="#LightningProxModel-1135"><span class="linenos">1135</span></a>        <span class="n">compute_gene_align_now</span><span class="p">,</span> <span class="n">gene_align_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_gene_align_now</span><span class="p">(</span><span class="n">return_weight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LightningProxModel-1136"><a href="#LightningProxModel-1136"><span class="linenos">1136</span></a>
</span><span id="LightningProxModel-1137"><a href="#LightningProxModel-1137"><span class="linenos">1137</span></a>        <span class="n">gene_align_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel-1138"><a href="#LightningProxModel-1138"><span class="linenos">1138</span></a>        <span class="k">if</span> <span class="n">compute_gene_align_now</span><span class="p">:</span>
</span><span id="LightningProxModel-1139"><a href="#LightningProxModel-1139"><span class="linenos">1139</span></a>            <span class="n">gene_align_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gene_alignment_loss</span><span class="p">()</span>
</span><span id="LightningProxModel-1140"><a href="#LightningProxModel-1140"><span class="linenos">1140</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;gene_align&quot;</span><span class="p">,</span> <span class="n">gene_align_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel-1141"><a href="#LightningProxModel-1141"><span class="linenos">1141</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;gene_align_weighted&quot;</span><span class="p">,</span> <span class="n">gene_align_weight</span> <span class="o">*</span> <span class="n">gene_align_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel-1142"><a href="#LightningProxModel-1142"><span class="linenos">1142</span></a>
</span><span id="LightningProxModel-1143"><a href="#LightningProxModel-1143"><span class="linenos">1143</span></a>        <span class="c1"># ---- OT loss ----</span>
</span><span id="LightningProxModel-1144"><a href="#LightningProxModel-1144"><span class="linenos">1144</span></a>        <span class="n">compute_ot_cs_now</span><span class="p">,</span> <span class="n">ot_cs_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_ot_cs_now</span><span class="p">(</span><span class="n">return_weight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LightningProxModel-1145"><a href="#LightningProxModel-1145"><span class="linenos">1145</span></a>
</span><span id="LightningProxModel-1146"><a href="#LightningProxModel-1146"><span class="linenos">1146</span></a>        <span class="n">ot_cs_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel-1147"><a href="#LightningProxModel-1147"><span class="linenos">1147</span></a>        <span class="k">if</span> <span class="n">compute_ot_cs_now</span><span class="p">:</span>
</span><span id="LightningProxModel-1148"><a href="#LightningProxModel-1148"><span class="linenos">1148</span></a>            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="LightningProxModel-1149"><a href="#LightningProxModel-1149"><span class="linenos">1149</span></a>            <span class="n">ot_cs_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_alignment_loss</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;cs&quot;</span><span class="p">)</span>
</span><span id="LightningProxModel-1150"><a href="#LightningProxModel-1150"><span class="linenos">1150</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;ot_cs_loss&quot;</span><span class="p">,</span> <span class="n">ot_cs_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel-1151"><a href="#LightningProxModel-1151"><span class="linenos">1151</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;ot_cs_weighted&quot;</span><span class="p">,</span> <span class="n">ot_cs_weight</span> <span class="o">*</span> <span class="n">ot_cs_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel-1152"><a href="#LightningProxModel-1152"><span class="linenos">1152</span></a>        
</span><span id="LightningProxModel-1153"><a href="#LightningProxModel-1153"><span class="linenos">1153</span></a>        <span class="n">compute_ot_cb_now</span><span class="p">,</span> <span class="n">ot_cb_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_ot_cb_now</span><span class="p">(</span><span class="n">return_weight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LightningProxModel-1154"><a href="#LightningProxModel-1154"><span class="linenos">1154</span></a>        <span class="n">ot_cb_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel-1155"><a href="#LightningProxModel-1155"><span class="linenos">1155</span></a>        <span class="k">if</span> <span class="n">compute_ot_cb_now</span><span class="p">:</span>
</span><span id="LightningProxModel-1156"><a href="#LightningProxModel-1156"><span class="linenos">1156</span></a>            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="LightningProxModel-1157"><a href="#LightningProxModel-1157"><span class="linenos">1157</span></a>            <span class="n">ot_cb_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_alignment_loss</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;cb&quot;</span><span class="p">)</span>
</span><span id="LightningProxModel-1158"><a href="#LightningProxModel-1158"><span class="linenos">1158</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;ot_cb_loss&quot;</span><span class="p">,</span> <span class="n">ot_cb_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel-1159"><a href="#LightningProxModel-1159"><span class="linenos">1159</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;ot_cb_weighted&quot;</span><span class="p">,</span> <span class="n">ot_cb_weight</span> <span class="o">*</span> <span class="n">ot_cb_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel-1160"><a href="#LightningProxModel-1160"><span class="linenos">1160</span></a>
</span><span id="LightningProxModel-1161"><a href="#LightningProxModel-1161"><span class="linenos">1161</span></a>        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LightningProxModel-1162"><a href="#LightningProxModel-1162"><span class="linenos">1162</span></a>            <span class="n">batch_nll_loss</span> <span class="o">+</span> 
</span><span id="LightningProxModel-1163"><a href="#LightningProxModel-1163"><span class="linenos">1163</span></a>            <span class="n">kl_weight</span> <span class="o">*</span> <span class="n">batch_kl_div_loss</span> <span class="o">+</span> 
</span><span id="LightningProxModel-1164"><a href="#LightningProxModel-1164"><span class="linenos">1164</span></a>            <span class="n">herit_loss_value</span>
</span><span id="LightningProxModel-1165"><a href="#LightningProxModel-1165"><span class="linenos">1165</span></a>            <span class="o">+</span> <span class="n">gene_align_weight</span> <span class="o">*</span> <span class="n">gene_align_loss</span>
</span><span id="LightningProxModel-1166"><a href="#LightningProxModel-1166"><span class="linenos">1166</span></a>            <span class="o">+</span> <span class="n">ot_cs_weight</span> <span class="o">*</span> <span class="n">ot_cs_loss</span>
</span><span id="LightningProxModel-1167"><a href="#LightningProxModel-1167"><span class="linenos">1167</span></a>            <span class="o">+</span> <span class="n">ot_cb_weight</span> <span class="o">*</span> <span class="n">ot_cb_loss</span>
</span><span id="LightningProxModel-1168"><a href="#LightningProxModel-1168"><span class="linenos">1168</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel-1169"><a href="#LightningProxModel-1169"><span class="linenos">1169</span></a>
</span><span id="LightningProxModel-1170"><a href="#LightningProxModel-1170"><span class="linenos">1170</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;loss&quot;</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LightningProxModel-1171"><a href="#LightningProxModel-1171"><span class="linenos">1171</span></a>
</span><span id="LightningProxModel-1172"><a href="#LightningProxModel-1172"><span class="linenos">1172</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">validation_step_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
</span><span id="LightningProxModel-1173"><a href="#LightningProxModel-1173"><span class="linenos">1173</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">local_step_val</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="LightningProxModel-1174"><a href="#LightningProxModel-1174"><span class="linenos">1174</span></a>
</span><span id="LightningProxModel-1175"><a href="#LightningProxModel-1175"><span class="linenos">1175</span></a>        <span class="k">return</span> <span class="n">loss</span>
</span><span id="LightningProxModel-1176"><a href="#LightningProxModel-1176"><span class="linenos">1176</span></a>
</span><span id="LightningProxModel-1177"><a href="#LightningProxModel-1177"><span class="linenos">1177</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">mean_cell_neighbor_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
</span><span id="LightningProxModel-1178"><a href="#LightningProxModel-1178"><span class="linenos">1178</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LightningProxModel-1179"><a href="#LightningProxModel-1179"><span class="linenos">1179</span></a><span class="sd">        Calculates the mean distance between each cell node and its k nearest neighbors.</span>
</span><span id="LightningProxModel-1180"><a href="#LightningProxModel-1180"><span class="linenos">1180</span></a><span class="sd">        Returns a tensor of mean distances for each cell.</span>
</span><span id="LightningProxModel-1181"><a href="#LightningProxModel-1181"><span class="linenos">1181</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LightningProxModel-1182"><a href="#LightningProxModel-1182"><span class="linenos">1182</span></a>        <span class="n">cell_mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">__mu_dict__</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>  <span class="c1"># (num_cells, latent_dim)</span>
</span><span id="LightningProxModel-1183"><a href="#LightningProxModel-1183"><span class="linenos">1183</span></a>        <span class="c1"># Compute pairwise Euclidean distances</span>
</span><span id="LightningProxModel-1184"><a href="#LightningProxModel-1184"><span class="linenos">1184</span></a>        <span class="n">dist_matrix</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cdist</span><span class="p">(</span><span class="n">cell_mu</span><span class="p">,</span> <span class="n">cell_mu</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># (num_cells, num_cells)</span>
</span><span id="LightningProxModel-1185"><a href="#LightningProxModel-1185"><span class="linenos">1185</span></a>        <span class="c1"># Exclude self-distance by setting diagonal to infinity</span>
</span><span id="LightningProxModel-1186"><a href="#LightningProxModel-1186"><span class="linenos">1186</span></a>        <span class="n">dist_matrix</span><span class="o">.</span><span class="n">fill_diagonal_</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">))</span>
</span><span id="LightningProxModel-1187"><a href="#LightningProxModel-1187"><span class="linenos">1187</span></a>        <span class="c1"># Find k nearest neighbors for each cell</span>
</span><span id="LightningProxModel-1188"><a href="#LightningProxModel-1188"><span class="linenos">1188</span></a>        <span class="n">knn_distances</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">dist_matrix</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">largest</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="LightningProxModel-1189"><a href="#LightningProxModel-1189"><span class="linenos">1189</span></a>        <span class="c1"># Mean distance to k nearest neighbors for each cell</span>
</span><span id="LightningProxModel-1190"><a href="#LightningProxModel-1190"><span class="linenos">1190</span></a>        <span class="n">mean_distances</span> <span class="o">=</span> <span class="n">knn_distances</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="LightningProxModel-1191"><a href="#LightningProxModel-1191"><span class="linenos">1191</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">mean_distances</span> <span class="o">/</span> <span class="n">mean_distances</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="LightningProxModel-1192"><a href="#LightningProxModel-1192"><span class="linenos">1192</span></a>        <span class="k">return</span> <span class="n">weights</span>  <span class="c1"># shape: (num_cells,)</span>
</span><span id="LightningProxModel-1193"><a href="#LightningProxModel-1193"><span class="linenos">1193</span></a>    
</span><span id="LightningProxModel-1194"><a href="#LightningProxModel-1194"><span class="linenos">1194</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_kl_now</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">return_weight</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="LightningProxModel-1195"><a href="#LightningProxModel-1195"><span class="linenos">1195</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Decide whether to compute KL loss for this training/validation step.&quot;&quot;&quot;</span>
</span><span id="LightningProxModel-1196"><a href="#LightningProxModel-1196"><span class="linenos">1196</span></a>        <span class="n">kl_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kl_lambda</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_linear_warmup_scale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kl_n_no</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kl_n_warmup</span><span class="p">)</span>
</span><span id="LightningProxModel-1197"><a href="#LightningProxModel-1197"><span class="linenos">1197</span></a>        <span class="n">compute_kl_now</span> <span class="o">=</span> <span class="n">kl_weight</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="LightningProxModel-1198"><a href="#LightningProxModel-1198"><span class="linenos">1198</span></a>        <span class="k">if</span> <span class="n">return_weight</span><span class="p">:</span>
</span><span id="LightningProxModel-1199"><a href="#LightningProxModel-1199"><span class="linenos">1199</span></a>            <span class="k">return</span> <span class="n">compute_kl_now</span><span class="p">,</span> <span class="n">kl_weight</span>
</span><span id="LightningProxModel-1200"><a href="#LightningProxModel-1200"><span class="linenos">1200</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel-1201"><a href="#LightningProxModel-1201"><span class="linenos">1201</span></a>            <span class="k">return</span> <span class="n">compute_kl_now</span>
</span><span id="LightningProxModel-1202"><a href="#LightningProxModel-1202"><span class="linenos">1202</span></a>    
</span><span id="LightningProxModel-1203"><a href="#LightningProxModel-1203"><span class="linenos">1203</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_gene_align_now</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">return_weight</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="LightningProxModel-1204"><a href="#LightningProxModel-1204"><span class="linenos">1204</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Decide whether to compute gene alignment loss for this training/validation step.&quot;&quot;&quot;</span>
</span><span id="LightningProxModel-1205"><a href="#LightningProxModel-1205"><span class="linenos">1205</span></a>        <span class="n">gene_align_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gene_align_lambda</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_linear_warmup_scale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_align_n_no</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gene_align_n_warmup</span><span class="p">)</span>
</span><span id="LightningProxModel-1206"><a href="#LightningProxModel-1206"><span class="linenos">1206</span></a>        <span class="n">compute_gene_align_now</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LightningProxModel-1207"><a href="#LightningProxModel-1207"><span class="linenos">1207</span></a>        <span class="k">if</span> <span class="n">gene_align_weight</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_gene_pairs&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gene_pairs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel-1208"><a href="#LightningProxModel-1208"><span class="linenos">1208</span></a>            <span class="n">compute_gene_align_now</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="LightningProxModel-1209"><a href="#LightningProxModel-1209"><span class="linenos">1209</span></a>        <span class="k">if</span> <span class="n">return_weight</span><span class="p">:</span>
</span><span id="LightningProxModel-1210"><a href="#LightningProxModel-1210"><span class="linenos">1210</span></a>            <span class="k">return</span> <span class="n">compute_gene_align_now</span><span class="p">,</span> <span class="n">gene_align_weight</span>
</span><span id="LightningProxModel-1211"><a href="#LightningProxModel-1211"><span class="linenos">1211</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel-1212"><a href="#LightningProxModel-1212"><span class="linenos">1212</span></a>            <span class="k">return</span> <span class="n">compute_gene_align_now</span>
</span><span id="LightningProxModel-1213"><a href="#LightningProxModel-1213"><span class="linenos">1213</span></a>
</span><span id="LightningProxModel-1214"><a href="#LightningProxModel-1214"><span class="linenos">1214</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_ot_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LightningProxModel-1215"><a href="#LightningProxModel-1215"><span class="linenos">1215</span></a>        <span class="n">need_plan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_plan_every_n_epochs</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="LightningProxModel-1216"><a href="#LightningProxModel-1216"><span class="linenos">1216</span></a>        <span class="n">ot_cs_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_cs_lambda</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_linear_warmup_scale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ot_cs_n_no</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_cs_n_warmup</span><span class="p">)</span>
</span><span id="LightningProxModel-1217"><a href="#LightningProxModel-1217"><span class="linenos">1217</span></a>        <span class="n">ot_cb_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_cb_lambda</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_linear_warmup_scale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ot_cb_n_no</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_cb_n_warmup</span><span class="p">)</span>
</span><span id="LightningProxModel-1218"><a href="#LightningProxModel-1218"><span class="linenos">1218</span></a>
</span><span id="LightningProxModel-1219"><a href="#LightningProxModel-1219"><span class="linenos">1219</span></a>        <span class="k">if</span> <span class="n">ot_cs_weight</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">need_plan</span><span class="p">:</span>
</span><span id="LightningProxModel-1220"><a href="#LightningProxModel-1220"><span class="linenos">1220</span></a>            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="LightningProxModel-1221"><a href="#LightningProxModel-1221"><span class="linenos">1221</span></a>            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="LightningProxModel-1222"><a href="#LightningProxModel-1222"><span class="linenos">1222</span></a>                <span class="n">cell_mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">__mu_dict__</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</span><span id="LightningProxModel-1223"><a href="#LightningProxModel-1223"><span class="linenos">1223</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_ot_cs_states</span> <span class="o">=</span> <span class="n">compute_multi_sample_ot_states</span><span class="p">(</span>
</span><span id="LightningProxModel-1224"><a href="#LightningProxModel-1224"><span class="linenos">1224</span></a>                    <span class="n">cell_mu</span><span class="o">=</span><span class="n">cell_mu</span><span class="p">,</span>
</span><span id="LightningProxModel-1225"><a href="#LightningProxModel-1225"><span class="linenos">1225</span></a>                    <span class="n">groups</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ot_cs_groups</span><span class="p">,</span>
</span><span id="LightningProxModel-1226"><a href="#LightningProxModel-1226"><span class="linenos">1226</span></a>                    <span class="n">pairs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ot_cs_pairs</span><span class="p">,</span>
</span><span id="LightningProxModel-1227"><a href="#LightningProxModel-1227"><span class="linenos">1227</span></a>                    <span class="n">subset_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ot_cs_k</span><span class="p">,</span>
</span><span id="LightningProxModel-1228"><a href="#LightningProxModel-1228"><span class="linenos">1228</span></a>                    <span class="n">eps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ot_eps</span><span class="p">,</span>
</span><span id="LightningProxModel-1229"><a href="#LightningProxModel-1229"><span class="linenos">1229</span></a>                    <span class="n">n_iters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ot_iter</span><span class="p">,</span>
</span><span id="LightningProxModel-1230"><a href="#LightningProxModel-1230"><span class="linenos">1230</span></a>                <span class="p">)</span>
</span><span id="LightningProxModel-1231"><a href="#LightningProxModel-1231"><span class="linenos">1231</span></a>            <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="LightningProxModel-1232"><a href="#LightningProxModel-1232"><span class="linenos">1232</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;time:ot_cs_plan&quot;</span><span class="p">,</span> <span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LightningProxModel-1233"><a href="#LightningProxModel-1233"><span class="linenos">1233</span></a>        
</span><span id="LightningProxModel-1234"><a href="#LightningProxModel-1234"><span class="linenos">1234</span></a>        <span class="k">if</span> <span class="n">ot_cb_weight</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">need_plan</span><span class="p">:</span>
</span><span id="LightningProxModel-1235"><a href="#LightningProxModel-1235"><span class="linenos">1235</span></a>            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="LightningProxModel-1236"><a href="#LightningProxModel-1236"><span class="linenos">1236</span></a>            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="LightningProxModel-1237"><a href="#LightningProxModel-1237"><span class="linenos">1237</span></a>                <span class="n">cell_mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">__mu_dict__</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</span><span id="LightningProxModel-1238"><a href="#LightningProxModel-1238"><span class="linenos">1238</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_ot_cb_states</span> <span class="o">=</span> <span class="n">compute_multi_batch_ot_states</span><span class="p">(</span>
</span><span id="LightningProxModel-1239"><a href="#LightningProxModel-1239"><span class="linenos">1239</span></a>                    <span class="n">cell_mu</span><span class="o">=</span><span class="n">cell_mu</span><span class="p">,</span>
</span><span id="LightningProxModel-1240"><a href="#LightningProxModel-1240"><span class="linenos">1240</span></a>                    <span class="n">groups_sb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ot_cb_groups</span><span class="p">,</span>
</span><span id="LightningProxModel-1241"><a href="#LightningProxModel-1241"><span class="linenos">1241</span></a>                    <span class="n">pairs_sb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ot_cb_pairs</span><span class="p">,</span>
</span><span id="LightningProxModel-1242"><a href="#LightningProxModel-1242"><span class="linenos">1242</span></a>                    <span class="n">subset_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ot_cb_k</span><span class="p">,</span>
</span><span id="LightningProxModel-1243"><a href="#LightningProxModel-1243"><span class="linenos">1243</span></a>                    <span class="n">eps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ot_eps</span><span class="p">,</span>
</span><span id="LightningProxModel-1244"><a href="#LightningProxModel-1244"><span class="linenos">1244</span></a>                    <span class="n">n_iters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ot_iter</span><span class="p">,</span>
</span><span id="LightningProxModel-1245"><a href="#LightningProxModel-1245"><span class="linenos">1245</span></a>                <span class="p">)</span>
</span><span id="LightningProxModel-1246"><a href="#LightningProxModel-1246"><span class="linenos">1246</span></a>            <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="LightningProxModel-1247"><a href="#LightningProxModel-1247"><span class="linenos">1247</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;time:ot_cb_plan&quot;</span><span class="p">,</span> <span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LightningProxModel-1248"><a href="#LightningProxModel-1248"><span class="linenos">1248</span></a>
</span><span id="LightningProxModel-1249"><a href="#LightningProxModel-1249"><span class="linenos">1249</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_ot_cs_now</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">return_weight</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="LightningProxModel-1250"><a href="#LightningProxModel-1250"><span class="linenos">1250</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Decide whether to compute cross-sample OT loss for this training/validation step.&quot;&quot;&quot;</span>
</span><span id="LightningProxModel-1251"><a href="#LightningProxModel-1251"><span class="linenos">1251</span></a>        <span class="n">ot_cs_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_cs_lambda</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_linear_warmup_scale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ot_cs_n_no</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_cs_n_warmup</span><span class="p">)</span>
</span><span id="LightningProxModel-1252"><a href="#LightningProxModel-1252"><span class="linenos">1252</span></a>        <span class="n">compute_ot_cs_now</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LightningProxModel-1253"><a href="#LightningProxModel-1253"><span class="linenos">1253</span></a>        <span class="k">if</span> <span class="n">ot_cs_weight</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_ot_cs_states&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ot_cs_states</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ot_cs_states</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LightningProxModel-1254"><a href="#LightningProxModel-1254"><span class="linenos">1254</span></a>            <span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_step</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_step_val</span>
</span><span id="LightningProxModel-1255"><a href="#LightningProxModel-1255"><span class="linenos">1255</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_loss_every_n_steps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LightningProxModel-1256"><a href="#LightningProxModel-1256"><span class="linenos">1256</span></a>                <span class="n">compute_ot_cs_now</span> <span class="o">=</span> <span class="p">(</span><span class="n">step</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_loss_every_n_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="LightningProxModel-1257"><a href="#LightningProxModel-1257"><span class="linenos">1257</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel-1258"><a href="#LightningProxModel-1258"><span class="linenos">1258</span></a>                <span class="c1"># default: once per epoch (first batch)</span>
</span><span id="LightningProxModel-1259"><a href="#LightningProxModel-1259"><span class="linenos">1259</span></a>                <span class="n">compute_ot_cs_now</span> <span class="o">=</span> <span class="p">(</span><span class="n">step</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="LightningProxModel-1260"><a href="#LightningProxModel-1260"><span class="linenos">1260</span></a>        <span class="k">if</span> <span class="n">return_weight</span><span class="p">:</span>
</span><span id="LightningProxModel-1261"><a href="#LightningProxModel-1261"><span class="linenos">1261</span></a>            <span class="k">return</span> <span class="n">compute_ot_cs_now</span><span class="p">,</span> <span class="n">ot_cs_weight</span>
</span><span id="LightningProxModel-1262"><a href="#LightningProxModel-1262"><span class="linenos">1262</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel-1263"><a href="#LightningProxModel-1263"><span class="linenos">1263</span></a>            <span class="k">return</span> <span class="n">compute_ot_cs_now</span>
</span><span id="LightningProxModel-1264"><a href="#LightningProxModel-1264"><span class="linenos">1264</span></a>    
</span><span id="LightningProxModel-1265"><a href="#LightningProxModel-1265"><span class="linenos">1265</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_ot_cb_now</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">return_weight</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="LightningProxModel-1266"><a href="#LightningProxModel-1266"><span class="linenos">1266</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Decide whether to compute cross-batch OT loss for this training/validation step.&quot;&quot;&quot;</span>
</span><span id="LightningProxModel-1267"><a href="#LightningProxModel-1267"><span class="linenos">1267</span></a>        <span class="n">ot_cb_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_cb_lambda</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_linear_warmup_scale</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ot_cb_n_no</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_cb_n_warmup</span><span class="p">)</span>
</span><span id="LightningProxModel-1268"><a href="#LightningProxModel-1268"><span class="linenos">1268</span></a>        <span class="n">compute_ot_cb_now</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LightningProxModel-1269"><a href="#LightningProxModel-1269"><span class="linenos">1269</span></a>        <span class="k">if</span> <span class="n">ot_cb_weight</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_ot_cb_states&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ot_cb_states</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ot_cb_states</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LightningProxModel-1270"><a href="#LightningProxModel-1270"><span class="linenos">1270</span></a>            <span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_step</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_step_val</span>
</span><span id="LightningProxModel-1271"><a href="#LightningProxModel-1271"><span class="linenos">1271</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_loss_every_n_steps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LightningProxModel-1272"><a href="#LightningProxModel-1272"><span class="linenos">1272</span></a>                <span class="n">compute_ot_cb_now</span> <span class="o">=</span> <span class="p">(</span><span class="n">step</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_loss_every_n_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="LightningProxModel-1273"><a href="#LightningProxModel-1273"><span class="linenos">1273</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel-1274"><a href="#LightningProxModel-1274"><span class="linenos">1274</span></a>                <span class="c1"># default: once per epoch (first batch)</span>
</span><span id="LightningProxModel-1275"><a href="#LightningProxModel-1275"><span class="linenos">1275</span></a>                <span class="n">compute_ot_cb_now</span> <span class="o">=</span> <span class="p">(</span><span class="n">step</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="LightningProxModel-1276"><a href="#LightningProxModel-1276"><span class="linenos">1276</span></a>        <span class="k">if</span> <span class="n">return_weight</span><span class="p">:</span>
</span><span id="LightningProxModel-1277"><a href="#LightningProxModel-1277"><span class="linenos">1277</span></a>            <span class="k">return</span> <span class="n">compute_ot_cb_now</span><span class="p">,</span> <span class="n">ot_cb_weight</span>
</span><span id="LightningProxModel-1278"><a href="#LightningProxModel-1278"><span class="linenos">1278</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel-1279"><a href="#LightningProxModel-1279"><span class="linenos">1279</span></a>            <span class="k">return</span> <span class="n">compute_ot_cb_now</span>
</span><span id="LightningProxModel-1280"><a href="#LightningProxModel-1280"><span class="linenos">1280</span></a>
</span><span id="LightningProxModel-1281"><a href="#LightningProxModel-1281"><span class="linenos">1281</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_epoch_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LightningProxModel-1282"><a href="#LightningProxModel-1282"><span class="linenos">1282</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">validation_step_outputs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="LightningProxModel-1283"><a href="#LightningProxModel-1283"><span class="linenos">1283</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">is_last_batch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel-1284"><a href="#LightningProxModel-1284"><span class="linenos">1284</span></a>            <span class="n">hsic_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span><span class="o">.</span><span class="n">custom_train</span><span class="p">(</span>
</span><span id="LightningProxModel-1285"><a href="#LightningProxModel-1285"><span class="linenos">1285</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">__mu_dict__</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">],</span> <span class="n">optimizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hsic_optimizer</span>
</span><span id="LightningProxModel-1286"><a href="#LightningProxModel-1286"><span class="linenos">1286</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel-1287"><a href="#LightningProxModel-1287"><span class="linenos">1287</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;hsic_loss&quot;</span><span class="p">,</span> <span class="n">hsic_loss</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LightningProxModel-1288"><a href="#LightningProxModel-1288"><span class="linenos">1288</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel-1289"><a href="#LightningProxModel-1289"><span class="linenos">1289</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;hsic_lr&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic_optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;lr&quot;</span><span class="p">],</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LightningProxModel-1290"><a href="#LightningProxModel-1290"><span class="linenos">1290</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reweight_rarecell</span><span class="p">:</span>
</span><span id="LightningProxModel-1291"><a href="#LightningProxModel-1291"><span class="linenos">1291</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cell_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean_cell_neighbor_distance</span><span class="p">(</span>
</span><span id="LightningProxModel-1292"><a href="#LightningProxModel-1292"><span class="linenos">1292</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">reweight_rarecell_neighbors</span>
</span><span id="LightningProxModel-1293"><a href="#LightningProxModel-1293"><span class="linenos">1293</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel-1294"><a href="#LightningProxModel-1294"><span class="linenos">1294</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">local_step</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="LightningProxModel-1295"><a href="#LightningProxModel-1295"><span class="linenos">1295</span></a>        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="LightningProxModel-1296"><a href="#LightningProxModel-1296"><span class="linenos">1296</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_ot_plan</span><span class="p">()</span>
</span><span id="LightningProxModel-1297"><a href="#LightningProxModel-1297"><span class="linenos">1297</span></a>        <span class="c1"># self._log_perf(&quot;ot_plan&quot;, time.time() - t0, on_step=False)</span>
</span><span id="LightningProxModel-1298"><a href="#LightningProxModel-1298"><span class="linenos">1298</span></a>
</span><span id="LightningProxModel-1299"><a href="#LightningProxModel-1299"><span class="linenos">1299</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_batch_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
</span><span id="LightningProxModel-1300"><a href="#LightningProxModel-1300"><span class="linenos">1300</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">):</span>
</span><span id="LightningProxModel-1301"><a href="#LightningProxModel-1301"><span class="linenos">1301</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;data_loading_time&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
</span><span id="LightningProxModel-1302"><a href="#LightningProxModel-1302"><span class="linenos">1302</span></a>
</span><span id="LightningProxModel-1303"><a href="#LightningProxModel-1303"><span class="linenos">1303</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_batch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
</span><span id="LightningProxModel-1304"><a href="#LightningProxModel-1304"><span class="linenos">1304</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="LightningProxModel-1305"><a href="#LightningProxModel-1305"><span class="linenos">1305</span></a>
</span><span id="LightningProxModel-1306"><a href="#LightningProxModel-1306"><span class="linenos">1306</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_validation_epoch_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LightningProxModel-1307"><a href="#LightningProxModel-1307"><span class="linenos">1307</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">local_step_val</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="LightningProxModel-1308"><a href="#LightningProxModel-1308"><span class="linenos">1308</span></a>    
</span><span id="LightningProxModel-1309"><a href="#LightningProxModel-1309"><span class="linenos">1309</span></a>    <span class="c1"># def on_validation_epoch_end(self):</span>
</span><span id="LightningProxModel-1310"><a href="#LightningProxModel-1310"><span class="linenos">1310</span></a>    <span class="c1">#     # record distance for each gene pair</span>
</span><span id="LightningProxModel-1311"><a href="#LightningProxModel-1311"><span class="linenos">1311</span></a>    <span class="c1">#     pairs = self._gene_pairs if hasattr(self, &quot;_gene_pairs&quot;) else None</span>
</span><span id="LightningProxModel-1312"><a href="#LightningProxModel-1312"><span class="linenos">1312</span></a>    <span class="c1">#     if pairs is not None and hasattr(pairs, &quot;idx0&quot;) and pairs.idx0 is not None:</span>
</span><span id="LightningProxModel-1313"><a href="#LightningProxModel-1313"><span class="linenos">1313</span></a>    <span class="c1">#         gene_mu = self.encoder.__mu_dict__[&quot;gene&quot;]</span>
</span><span id="LightningProxModel-1314"><a href="#LightningProxModel-1314"><span class="linenos">1314</span></a>    <span class="c1">#         gene_id = self.data[&quot;gene&quot;].gene_id[pairs.idx0]</span>
</span><span id="LightningProxModel-1315"><a href="#LightningProxModel-1315"><span class="linenos">1315</span></a>    <span class="c1">#         dist = (gene_mu[pairs.idx0] - gene_mu[pairs.idx1]).pow(2).sum(dim=-1).sqrt()</span>
</span><span id="LightningProxModel-1316"><a href="#LightningProxModel-1316"><span class="linenos">1316</span></a>
</span><span id="LightningProxModel-1317"><a href="#LightningProxModel-1317"><span class="linenos">1317</span></a>    <span class="c1">#         gene_id = gene_id.detach().cpu().numpy()</span>
</span><span id="LightningProxModel-1318"><a href="#LightningProxModel-1318"><span class="linenos">1318</span></a>    <span class="c1">#         dist = dist.detach().cpu().numpy()</span>
</span><span id="LightningProxModel-1319"><a href="#LightningProxModel-1319"><span class="linenos">1319</span></a>
</span><span id="LightningProxModel-1320"><a href="#LightningProxModel-1320"><span class="linenos">1320</span></a>    <span class="c1">#         col = f&quot;dist_{self.current_epoch}&quot;</span>
</span><span id="LightningProxModel-1321"><a href="#LightningProxModel-1321"><span class="linenos">1321</span></a>    <span class="c1">#         if not hasattr(self, &quot;_gene_align_dist_cols&quot;):</span>
</span><span id="LightningProxModel-1322"><a href="#LightningProxModel-1322"><span class="linenos">1322</span></a>    <span class="c1">#             self._gene_align_dist_cols = {}</span>
</span><span id="LightningProxModel-1323"><a href="#LightningProxModel-1323"><span class="linenos">1323</span></a>            
</span><span id="LightningProxModel-1324"><a href="#LightningProxModel-1324"><span class="linenos">1324</span></a>    <span class="c1">#         self._gene_align_dist_cols[col] = pd.Series(dist, index=gene_id, name=col)</span>
</span><span id="LightningProxModel-1325"><a href="#LightningProxModel-1325"><span class="linenos">1325</span></a>
</span><span id="LightningProxModel-1326"><a href="#LightningProxModel-1326"><span class="linenos">1326</span></a>    <span class="c1"># def on_fit_end(self):</span>
</span><span id="LightningProxModel-1327"><a href="#LightningProxModel-1327"><span class="linenos">1327</span></a>    <span class="c1">#     if not hasattr(self, &quot;_gene_align_dist_cols&quot;):</span>
</span><span id="LightningProxModel-1328"><a href="#LightningProxModel-1328"><span class="linenos">1328</span></a>    <span class="c1">#         return</span>
</span><span id="LightningProxModel-1329"><a href="#LightningProxModel-1329"><span class="linenos">1329</span></a>    <span class="c1">#     df = pd.concat(self._gene_align_dist_cols.values(), axis=1)</span>
</span><span id="LightningProxModel-1330"><a href="#LightningProxModel-1330"><span class="linenos">1330</span></a>
</span><span id="LightningProxModel-1331"><a href="#LightningProxModel-1331"><span class="linenos">1331</span></a>    <span class="c1">#     log_dir = None</span>
</span><span id="LightningProxModel-1332"><a href="#LightningProxModel-1332"><span class="linenos">1332</span></a>    <span class="c1">#     if self.trainer is not None:</span>
</span><span id="LightningProxModel-1333"><a href="#LightningProxModel-1333"><span class="linenos">1333</span></a>    <span class="c1">#         log_dir = getattr(self.trainer, &quot;log_dir&quot;, None)</span>
</span><span id="LightningProxModel-1334"><a href="#LightningProxModel-1334"><span class="linenos">1334</span></a>    <span class="c1">#     if log_dir is None and getattr(self, &quot;logger&quot;, None) is not None:</span>
</span><span id="LightningProxModel-1335"><a href="#LightningProxModel-1335"><span class="linenos">1335</span></a>    <span class="c1">#         log_dir = getattr(self.logger, &quot;log_dir&quot;, None)</span>
</span><span id="LightningProxModel-1336"><a href="#LightningProxModel-1336"><span class="linenos">1336</span></a>    <span class="c1">#     if log_dir is None:</span>
</span><span id="LightningProxModel-1337"><a href="#LightningProxModel-1337"><span class="linenos">1337</span></a>    <span class="c1">#         log_dir = &quot;.&quot;</span>
</span><span id="LightningProxModel-1338"><a href="#LightningProxModel-1338"><span class="linenos">1338</span></a>        
</span><span id="LightningProxModel-1339"><a href="#LightningProxModel-1339"><span class="linenos">1339</span></a>    <span class="c1">#     os.makedirs(log_dir, exist_ok=True)</span>
</span><span id="LightningProxModel-1340"><a href="#LightningProxModel-1340"><span class="linenos">1340</span></a>    <span class="c1">#     timestamp = datetime.now().strftime(&quot;%Y%m%d_%H%M%S&quot;)</span>
</span><span id="LightningProxModel-1341"><a href="#LightningProxModel-1341"><span class="linenos">1341</span></a>    <span class="c1">#     filename = os.path.join(log_dir, f&quot;gene_align_dist_df_{timestamp}.csv&quot;)</span>
</span><span id="LightningProxModel-1342"><a href="#LightningProxModel-1342"><span class="linenos">1342</span></a>    <span class="c1">#     df.to_csv(filename)</span>
</span><span id="LightningProxModel-1343"><a href="#LightningProxModel-1343"><span class="linenos">1343</span></a>    <span class="c1">#     self.logger2.info(f&quot;Gene alignment distance dataframe saved to {filename}&quot;)</span>
</span><span id="LightningProxModel-1344"><a href="#LightningProxModel-1344"><span class="linenos">1344</span></a>
</span><span id="LightningProxModel-1345"><a href="#LightningProxModel-1345"><span class="linenos">1345</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">configure_optimizers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LightningProxModel-1346"><a href="#LightningProxModel-1346"><span class="linenos">1346</span></a>        <span class="c1"># Different learning rates for encoder vs aux_params</span>
</span><span id="LightningProxModel-1347"><a href="#LightningProxModel-1347"><span class="linenos">1347</span></a>        <span class="n">all_params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
</span><span id="LightningProxModel-1348"><a href="#LightningProxModel-1348"><span class="linenos">1348</span></a>        <span class="n">encoder_params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
</span><span id="LightningProxModel-1349"><a href="#LightningProxModel-1349"><span class="linenos">1349</span></a>        <span class="n">aux_params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aux_params</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
</span><span id="LightningProxModel-1350"><a href="#LightningProxModel-1350"><span class="linenos">1350</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">encoder_params</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">aux_params</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_params</span><span class="p">),</span> <span class="s2">&quot;Parameters other than encoder and aux_params exist in the model&quot;</span> <span class="c1"># sanity check</span>
</span><span id="LightningProxModel-1351"><a href="#LightningProxModel-1351"><span class="linenos">1351</span></a>
</span><span id="LightningProxModel-1352"><a href="#LightningProxModel-1352"><span class="linenos">1352</span></a>        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span>
</span><span id="LightningProxModel-1353"><a href="#LightningProxModel-1353"><span class="linenos">1353</span></a>            <span class="c1"># currently there are only encoder and aux parameters, no decoder parameters</span>
</span><span id="LightningProxModel-1354"><a href="#LightningProxModel-1354"><span class="linenos">1354</span></a>            <span class="p">[</span>
</span><span id="LightningProxModel-1355"><a href="#LightningProxModel-1355"><span class="linenos">1355</span></a>                <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">encoder_params</span><span class="p">,</span> <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">},</span>
</span><span id="LightningProxModel-1356"><a href="#LightningProxModel-1356"><span class="linenos">1356</span></a>                <span class="p">{</span>
</span><span id="LightningProxModel-1357"><a href="#LightningProxModel-1357"><span class="linenos">1357</span></a>                    <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">aux_params</span><span class="p">,</span>
</span><span id="LightningProxModel-1358"><a href="#LightningProxModel-1358"><span class="linenos">1358</span></a>                    <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">,</span>
</span><span id="LightningProxModel-1359"><a href="#LightningProxModel-1359"><span class="linenos">1359</span></a>                <span class="p">},</span>  <span class="c1"># 10x smaller LR for aux params</span>
</span><span id="LightningProxModel-1360"><a href="#LightningProxModel-1360"><span class="linenos">1360</span></a>            <span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_aux</span> <span class="k">else</span>
</span><span id="LightningProxModel-1361"><a href="#LightningProxModel-1361"><span class="linenos">1361</span></a>            <span class="p">[{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">encoder_params</span><span class="p">,</span> <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">}]</span>
</span><span id="LightningProxModel-1362"><a href="#LightningProxModel-1362"><span class="linenos">1362</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel-1363"><a href="#LightningProxModel-1363"><span class="linenos">1363</span></a>
</span><span id="LightningProxModel-1364"><a href="#LightningProxModel-1364"><span class="linenos">1364</span></a>        <span class="n">scheduler</span> <span class="o">=</span> <span class="n">ReduceLROnPlateau</span><span class="p">(</span>
</span><span id="LightningProxModel-1365"><a href="#LightningProxModel-1365"><span class="linenos">1365</span></a>            <span class="n">optimizer</span><span class="p">,</span>
</span><span id="LightningProxModel-1366"><a href="#LightningProxModel-1366"><span class="linenos">1366</span></a>            <span class="n">patience</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
</span><span id="LightningProxModel-1367"><a href="#LightningProxModel-1367"><span class="linenos">1367</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel-1368"><a href="#LightningProxModel-1368"><span class="linenos">1368</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">optimizer</span><span class="p">],</span> <span class="p">[</span>
</span><span id="LightningProxModel-1369"><a href="#LightningProxModel-1369"><span class="linenos">1369</span></a>            <span class="p">{</span>
</span><span id="LightningProxModel-1370"><a href="#LightningProxModel-1370"><span class="linenos">1370</span></a>                <span class="s2">&quot;scheduler&quot;</span><span class="p">:</span> <span class="n">scheduler</span><span class="p">,</span>
</span><span id="LightningProxModel-1371"><a href="#LightningProxModel-1371"><span class="linenos">1371</span></a>                <span class="s2">&quot;interval&quot;</span><span class="p">:</span> <span class="s2">&quot;epoch&quot;</span><span class="p">,</span>
</span><span id="LightningProxModel-1372"><a href="#LightningProxModel-1372"><span class="linenos">1372</span></a>                <span class="s2">&quot;frequency&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="LightningProxModel-1373"><a href="#LightningProxModel-1373"><span class="linenos">1373</span></a>                <span class="s2">&quot;monitor&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor_key</span><span class="p">,</span>
</span><span id="LightningProxModel-1374"><a href="#LightningProxModel-1374"><span class="linenos">1374</span></a>                <span class="s2">&quot;strict&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel-1375"><a href="#LightningProxModel-1375"><span class="linenos">1375</span></a>            <span class="p">}</span>
</span><span id="LightningProxModel-1376"><a href="#LightningProxModel-1376"><span class="linenos">1376</span></a>        <span class="p">]</span>
</span><span id="LightningProxModel-1377"><a href="#LightningProxModel-1377"><span class="linenos">1377</span></a>
</span><span id="LightningProxModel-1378"><a href="#LightningProxModel-1378"><span class="linenos">1378</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">lr_scheduler_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">,</span> <span class="n">metric</span><span class="p">):</span>
</span><span id="LightningProxModel-1379"><a href="#LightningProxModel-1379"><span class="linenos">1379</span></a>        <span class="k">if</span> <span class="n">metric</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel-1380"><a href="#LightningProxModel-1380"><span class="linenos">1380</span></a>            <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="LightningProxModel-1381"><a href="#LightningProxModel-1381"><span class="linenos">1381</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel-1382"><a href="#LightningProxModel-1382"><span class="linenos">1382</span></a>            <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
</span><span id="LightningProxModel-1383"><a href="#LightningProxModel-1383"><span class="linenos">1383</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel-1384"><a href="#LightningProxModel-1384"><span class="linenos">1384</span></a>            <span class="n">update_lr</span><span class="p">(</span>
</span><span id="LightningProxModel-1385"><a href="#LightningProxModel-1385"><span class="linenos">1385</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">hsic_optimizer</span><span class="p">,</span>
</span><span id="LightningProxModel-1386"><a href="#LightningProxModel-1386"><span class="linenos">1386</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span><span class="o">.</span><span class="n">lam</span>
</span><span id="LightningProxModel-1387"><a href="#LightningProxModel-1387"><span class="linenos">1387</span></a>                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">lr_scheduler_configs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span>
</span><span id="LightningProxModel-1388"><a href="#LightningProxModel-1388"><span class="linenos">1388</span></a>                    <span class="mi">0</span>
</span><span id="LightningProxModel-1389"><a href="#LightningProxModel-1389"><span class="linenos">1389</span></a>                <span class="p">][</span><span class="s2">&quot;lr&quot;</span><span class="p">],</span>
</span><span id="LightningProxModel-1390"><a href="#LightningProxModel-1390"><span class="linenos">1390</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel-1391"><a href="#LightningProxModel-1391"><span class="linenos">1391</span></a>    
</span><span id="LightningProxModel-1392"><a href="#LightningProxModel-1392"><span class="linenos">1392</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_linear_warmup_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_no</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n_warmup</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="LightningProxModel-1393"><a href="#LightningProxModel-1393"><span class="linenos">1393</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span> <span class="o">&lt;</span> <span class="n">n_no</span><span class="p">:</span>
</span><span id="LightningProxModel-1394"><a href="#LightningProxModel-1394"><span class="linenos">1394</span></a>            <span class="k">return</span> <span class="mf">0.0</span>
</span><span id="LightningProxModel-1395"><a href="#LightningProxModel-1395"><span class="linenos">1395</span></a>        <span class="k">if</span> <span class="n">n_warmup</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LightningProxModel-1396"><a href="#LightningProxModel-1396"><span class="linenos">1396</span></a>            <span class="k">return</span> <span class="mf">1.0</span>
</span><span id="LightningProxModel-1397"><a href="#LightningProxModel-1397"><span class="linenos">1397</span></a>        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">n_no</span><span class="p">,</span> <span class="n">n_warmup</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_warmup</span><span class="p">)</span>
</span><span id="LightningProxModel-1398"><a href="#LightningProxModel-1398"><span class="linenos">1398</span></a>
</span><span id="LightningProxModel-1399"><a href="#LightningProxModel-1399"><span class="linenos">1399</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_save_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checkpoint</span><span class="p">):</span>
</span><span id="LightningProxModel-1400"><a href="#LightningProxModel-1400"><span class="linenos">1400</span></a>        <span class="c1"># Remove the argument from the checkpoint before it is saved</span>
</span><span id="LightningProxModel-1401"><a href="#LightningProxModel-1401"><span class="linenos">1401</span></a>        <span class="n">checkpoint</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;train_data_dict&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Hooks to be used in LightningModule.</p>
</div>


                            <div id="LightningProxModel.__init__" class="classattr">
                                        <input id="LightningProxModel.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">LightningProxModel</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">data</span><span class="p">:</span> <span class="n">torch_geometric</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">hetero_data</span><span class="o">.</span><span class="n">HeteroData</span>,</span><span class="param">	<span class="n">logger</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	encoder_class: torch.nn.modules.module.Module = &lt;class &#x27;<a href="encoders.html#TransEncoder">simba_plus.encoders.TransEncoder</a>&#x27;&gt;,</span><span class="param">	<span class="n">n_latent_dims</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span>,</span><span class="param">	decoder_class: torch.nn.modules.module.Module = &lt;class &#x27;<a href="decoders.html#RelationalEdgeDistributionDecoder">simba_plus.decoders.RelationalEdgeDistributionDecoder</a>&#x27;&gt;,</span><span class="param">	<span class="n">device</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">num_neg_samples_fold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">edgetype_specific</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">edge_types</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">hsic</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">Module</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">herit_loss</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">Module</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">herit_loss_lam</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">kl_lambda</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span>,</span><span class="param">	<span class="n">kl_n_no</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span>,</span><span class="param">	<span class="n">kl_n_warmup</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span>,</span><span class="param">	<span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span>,</span><span class="param">	<span class="n">node_weights_dict</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">reweight_rarecell</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">reweight_rarecell_neighbors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">batch_negative</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">monitor_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">gene_align_lambda</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>,</span><span class="param">	<span class="n">gene_align_n_no</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>,</span><span class="param">	<span class="n">gene_align_n_warmup</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>,</span><span class="param">	<span class="n">ot_cs_lambda</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>,</span><span class="param">	<span class="n">ot_cs_n_no</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span>,</span><span class="param">	<span class="n">ot_cs_n_warmup</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span>,</span><span class="param">	<span class="n">ot_cs_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span>,</span><span class="param">	<span class="n">ot_cb_lambda</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>,</span><span class="param">	<span class="n">ot_cb_n_no</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span>,</span><span class="param">	<span class="n">ot_cb_n_warmup</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span>,</span><span class="param">	<span class="n">ot_cb_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span>,</span><span class="param">	<span class="n">ot_eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span>,</span><span class="param">	<span class="n">ot_iter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span>,</span><span class="param">	<span class="n">ot_plan_every_n_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">ot_loss_every_n_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">use_aux</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">use_aux_noise</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span>)</span>

                <label class="view-source-button" for="LightningProxModel.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel.__init__-382"><a href="#LightningProxModel.__init__-382"><span class="linenos">382</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="LightningProxModel.__init__-383"><a href="#LightningProxModel.__init__-383"><span class="linenos">383</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-384"><a href="#LightningProxModel.__init__-384"><span class="linenos">384</span></a>        <span class="n">data</span><span class="p">:</span> <span class="n">HeteroData</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-385"><a href="#LightningProxModel.__init__-385"><span class="linenos">385</span></a>        <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-386"><a href="#LightningProxModel.__init__-386"><span class="linenos">386</span></a>        <span class="n">encoder_class</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span> <span class="o">=</span> <span class="n">TransEncoder</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-387"><a href="#LightningProxModel.__init__-387"><span class="linenos">387</span></a>        <span class="n">n_latent_dims</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-388"><a href="#LightningProxModel.__init__-388"><span class="linenos">388</span></a>        <span class="n">decoder_class</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span> <span class="o">=</span> <span class="n">RelationalEdgeDistributionDecoder</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-389"><a href="#LightningProxModel.__init__-389"><span class="linenos">389</span></a>        <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-390"><a href="#LightningProxModel.__init__-390"><span class="linenos">390</span></a>        <span class="n">num_neg_samples_fold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-391"><a href="#LightningProxModel.__init__-391"><span class="linenos">391</span></a>        <span class="n">edgetype_specific</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-392"><a href="#LightningProxModel.__init__-392"><span class="linenos">392</span></a>        <span class="n">edge_types</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-393"><a href="#LightningProxModel.__init__-393"><span class="linenos">393</span></a>        <span class="n">hsic</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-394"><a href="#LightningProxModel.__init__-394"><span class="linenos">394</span></a>        <span class="n">herit_loss</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-395"><a href="#LightningProxModel.__init__-395"><span class="linenos">395</span></a>        <span class="n">herit_loss_lam</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-396"><a href="#LightningProxModel.__init__-396"><span class="linenos">396</span></a>        <span class="n">kl_lambda</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-397"><a href="#LightningProxModel.__init__-397"><span class="linenos">397</span></a>        <span class="n">kl_n_no</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-398"><a href="#LightningProxModel.__init__-398"><span class="linenos">398</span></a>        <span class="n">kl_n_warmup</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-399"><a href="#LightningProxModel.__init__-399"><span class="linenos">399</span></a>        <span class="c1"># nll_scale: float = 1.0,</span>
</span><span id="LightningProxModel.__init__-400"><a href="#LightningProxModel.__init__-400"><span class="linenos">400</span></a>        <span class="c1"># val_nll_scale: float = 1.0,</span>
</span><span id="LightningProxModel.__init__-401"><a href="#LightningProxModel.__init__-401"><span class="linenos">401</span></a>        <span class="n">learning_rate</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-402"><a href="#LightningProxModel.__init__-402"><span class="linenos">402</span></a>        <span class="n">node_weights_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-403"><a href="#LightningProxModel.__init__-403"><span class="linenos">403</span></a>        <span class="c1"># nonneg=False, #not used</span>
</span><span id="LightningProxModel.__init__-404"><a href="#LightningProxModel.__init__-404"><span class="linenos">404</span></a>        <span class="n">reweight_rarecell</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-405"><a href="#LightningProxModel.__init__-405"><span class="linenos">405</span></a>        <span class="n">reweight_rarecell_neighbors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-406"><a href="#LightningProxModel.__init__-406"><span class="linenos">406</span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-407"><a href="#LightningProxModel.__init__-407"><span class="linenos">407</span></a>        <span class="n">batch_negative</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># make the default same as in the CLI</span>
</span><span id="LightningProxModel.__init__-408"><a href="#LightningProxModel.__init__-408"><span class="linenos">408</span></a>        <span class="n">monitor_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-409"><a href="#LightningProxModel.__init__-409"><span class="linenos">409</span></a>
</span><span id="LightningProxModel.__init__-410"><a href="#LightningProxModel.__init__-410"><span class="linenos">410</span></a>        <span class="n">gene_align_lambda</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-411"><a href="#LightningProxModel.__init__-411"><span class="linenos">411</span></a>        <span class="n">gene_align_n_no</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-412"><a href="#LightningProxModel.__init__-412"><span class="linenos">412</span></a>        <span class="n">gene_align_n_warmup</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-413"><a href="#LightningProxModel.__init__-413"><span class="linenos">413</span></a>        <span class="n">ot_cs_lambda</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-414"><a href="#LightningProxModel.__init__-414"><span class="linenos">414</span></a>        <span class="n">ot_cs_n_no</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-415"><a href="#LightningProxModel.__init__-415"><span class="linenos">415</span></a>        <span class="n">ot_cs_n_warmup</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-416"><a href="#LightningProxModel.__init__-416"><span class="linenos">416</span></a>        <span class="n">ot_cs_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-417"><a href="#LightningProxModel.__init__-417"><span class="linenos">417</span></a>        <span class="n">ot_cb_lambda</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-418"><a href="#LightningProxModel.__init__-418"><span class="linenos">418</span></a>        <span class="n">ot_cb_n_no</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-419"><a href="#LightningProxModel.__init__-419"><span class="linenos">419</span></a>        <span class="n">ot_cb_n_warmup</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-420"><a href="#LightningProxModel.__init__-420"><span class="linenos">420</span></a>        <span class="n">ot_cb_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-421"><a href="#LightningProxModel.__init__-421"><span class="linenos">421</span></a>        <span class="n">ot_eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-422"><a href="#LightningProxModel.__init__-422"><span class="linenos">422</span></a>        <span class="n">ot_iter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-423"><a href="#LightningProxModel.__init__-423"><span class="linenos">423</span></a>        <span class="n">ot_plan_every_n_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="c1"># invalid if 0</span>
</span><span id="LightningProxModel.__init__-424"><a href="#LightningProxModel.__init__-424"><span class="linenos">424</span></a>        <span class="n">ot_loss_every_n_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># if 0, once per epoch (first batch)</span>
</span><span id="LightningProxModel.__init__-425"><a href="#LightningProxModel.__init__-425"><span class="linenos">425</span></a>
</span><span id="LightningProxModel.__init__-426"><a href="#LightningProxModel.__init__-426"><span class="linenos">426</span></a>        <span class="c1"># DEBUG</span>
</span><span id="LightningProxModel.__init__-427"><a href="#LightningProxModel.__init__-427"><span class="linenos">427</span></a>        <span class="n">use_aux</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-428"><a href="#LightningProxModel.__init__-428"><span class="linenos">428</span></a>        <span class="n">use_aux_noise</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-429"><a href="#LightningProxModel.__init__-429"><span class="linenos">429</span></a>    <span class="p">):</span>
</span><span id="LightningProxModel.__init__-430"><a href="#LightningProxModel.__init__-430"><span class="linenos">430</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="LightningProxModel.__init__-431"><a href="#LightningProxModel.__init__-431"><span class="linenos">431</span></a>        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel.__init__-432"><a href="#LightningProxModel.__init__-432"><span class="linenos">432</span></a>            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;device is deprecated and will be removed in future versions.&quot;</span>\
</span><span id="LightningProxModel.__init__-433"><a href="#LightningProxModel.__init__-433"><span class="linenos">433</span></a>                <span class="s2">&quot;Please use `model.to(device)` to move the model to the desired device instead.&quot;</span><span class="p">)</span>
</span><span id="LightningProxModel.__init__-434"><a href="#LightningProxModel.__init__-434"><span class="linenos">434</span></a>        
</span><span id="LightningProxModel.__init__-435"><a href="#LightningProxModel.__init__-435"><span class="linenos">435</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">save_hyperparameters</span><span class="p">()</span>
</span><span id="LightningProxModel.__init__-436"><a href="#LightningProxModel.__init__-436"><span class="linenos">436</span></a>        <span class="c1"># self.nonneg = nonneg</span>
</span><span id="LightningProxModel.__init__-437"><a href="#LightningProxModel.__init__-437"><span class="linenos">437</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
</span><span id="LightningProxModel.__init__-438"><a href="#LightningProxModel.__init__-438"><span class="linenos">438</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span> <span class="o">=</span> <span class="n">logger</span>
</span><span id="LightningProxModel.__init__-439"><a href="#LightningProxModel.__init__-439"><span class="linenos">439</span></a>        
</span><span id="LightningProxModel.__init__-440"><a href="#LightningProxModel.__init__-440"><span class="linenos">440</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel.__init__-441"><a href="#LightningProxModel.__init__-441"><span class="linenos">441</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span> <span class="o">=</span> <span class="n">_logger</span><span class="p">()</span> <span class="c1"># fallback to print</span>
</span><span id="LightningProxModel.__init__-442"><a href="#LightningProxModel.__init__-442"><span class="linenos">442</span></a>        
</span><span id="LightningProxModel.__init__-443"><a href="#LightningProxModel.__init__-443"><span class="linenos">443</span></a>        <span class="n">ok</span><span class="p">,</span> <span class="n">msgs</span> <span class="o">=</span> <span class="n">chk</span><span class="o">.</span><span class="n">check_heterodata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="LightningProxModel.__init__-444"><a href="#LightningProxModel.__init__-444"><span class="linenos">444</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
</span><span id="LightningProxModel.__init__-445"><a href="#LightningProxModel.__init__-445"><span class="linenos">445</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid heterodata: </span><span class="si">{</span><span class="n">msgs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LightningProxModel.__init__-446"><a href="#LightningProxModel.__init__-446"><span class="linenos">446</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel.__init__-447"><a href="#LightningProxModel.__init__-447"><span class="linenos">447</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger2</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;HeteroData codes are valid: </span><span class="si">{</span><span class="n">msgs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LightningProxModel.__init__-448"><a href="#LightningProxModel.__init__-448"><span class="linenos">448</span></a>
</span><span id="LightningProxModel.__init__-449"><a href="#LightningProxModel.__init__-449"><span class="linenos">449</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="n">learning_rate</span>
</span><span id="LightningProxModel.__init__-450"><a href="#LightningProxModel.__init__-450"><span class="linenos">450</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">encoder_class</span><span class="p">(</span>
</span><span id="LightningProxModel.__init__-451"><a href="#LightningProxModel.__init__-451"><span class="linenos">451</span></a>            <span class="n">data</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-452"><a href="#LightningProxModel.__init__-452"><span class="linenos">452</span></a>            <span class="n">n_latent_dims</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-453"><a href="#LightningProxModel.__init__-453"><span class="linenos">453</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel.__init__-454"><a href="#LightningProxModel.__init__-454"><span class="linenos">454</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">decoder_class</span><span class="p">(</span>
</span><span id="LightningProxModel.__init__-455"><a href="#LightningProxModel.__init__-455"><span class="linenos">455</span></a>            <span class="n">data</span><span class="p">,</span>
</span><span id="LightningProxModel.__init__-456"><a href="#LightningProxModel.__init__-456"><span class="linenos">456</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel.__init__-457"><a href="#LightningProxModel.__init__-457"><span class="linenos">457</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span> <span class="o">=</span> <span class="n">hsic</span>
</span><span id="LightningProxModel.__init__-458"><a href="#LightningProxModel.__init__-458"><span class="linenos">458</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel.__init__-459"><a href="#LightningProxModel.__init__-459"><span class="linenos">459</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">hsic_optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span>
</span><span id="LightningProxModel.__init__-460"><a href="#LightningProxModel.__init__-460"><span class="linenos">460</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">hsic</span><span class="o">.</span><span class="n">lam</span>
</span><span id="LightningProxModel.__init__-461"><a href="#LightningProxModel.__init__-461"><span class="linenos">461</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel.__init__-462"><a href="#LightningProxModel.__init__-462"><span class="linenos">462</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">kl_lambda</span> <span class="o">=</span> <span class="n">kl_lambda</span>
</span><span id="LightningProxModel.__init__-463"><a href="#LightningProxModel.__init__-463"><span class="linenos">463</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">kl_n_no</span> <span class="o">=</span> <span class="n">kl_n_no</span>
</span><span id="LightningProxModel.__init__-464"><a href="#LightningProxModel.__init__-464"><span class="linenos">464</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">kl_n_warmup</span> <span class="o">=</span> <span class="n">kl_n_warmup</span>
</span><span id="LightningProxModel.__init__-465"><a href="#LightningProxModel.__init__-465"><span class="linenos">465</span></a>        <span class="c1"># self.nll_scale = nll_scale</span>
</span><span id="LightningProxModel.__init__-466"><a href="#LightningProxModel.__init__-466"><span class="linenos">466</span></a>        <span class="c1"># self.val_nll_scale = val_nll_scale</span>
</span><span id="LightningProxModel.__init__-467"><a href="#LightningProxModel.__init__-467"><span class="linenos">467</span></a>        <span class="c1"># self.num_nodes_dict = data.num_nodes_dict</span>
</span><span id="LightningProxModel.__init__-468"><a href="#LightningProxModel.__init__-468"><span class="linenos">468</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cell_weights</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">)</span>
</span><span id="LightningProxModel.__init__-469"><a href="#LightningProxModel.__init__-469"><span class="linenos">469</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reweight_rarecell</span> <span class="o">=</span> <span class="n">reweight_rarecell</span>
</span><span id="LightningProxModel.__init__-470"><a href="#LightningProxModel.__init__-470"><span class="linenos">470</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reweight_rarecell</span><span class="p">:</span> <span class="c1"># not used</span>
</span><span id="LightningProxModel.__init__-471"><a href="#LightningProxModel.__init__-471"><span class="linenos">471</span></a>            <span class="k">if</span> <span class="n">reweight_rarecell_neighbors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel.__init__-472"><a href="#LightningProxModel.__init__-472"><span class="linenos">472</span></a>                <span class="n">reweight_rarecell_neighbors</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span>
</span><span id="LightningProxModel.__init__-473"><a href="#LightningProxModel.__init__-473"><span class="linenos">473</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">reweight_rarecell_neighbors</span> <span class="o">=</span> <span class="n">reweight_rarecell_neighbors</span>
</span><span id="LightningProxModel.__init__-474"><a href="#LightningProxModel.__init__-474"><span class="linenos">474</span></a>        <span class="k">if</span> <span class="n">edge_types</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel.__init__-475"><a href="#LightningProxModel.__init__-475"><span class="linenos">475</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">edge_types</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">edge_types</span>
</span><span id="LightningProxModel.__init__-476"><a href="#LightningProxModel.__init__-476"><span class="linenos">476</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel.__init__-477"><a href="#LightningProxModel.__init__-477"><span class="linenos">477</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">edge_types</span> <span class="o">=</span> <span class="n">edge_types</span>
</span><span id="LightningProxModel.__init__-478"><a href="#LightningProxModel.__init__-478"><span class="linenos">478</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">edgetype_loss_weight_dict</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="LightningProxModel.__init__-479"><a href="#LightningProxModel.__init__-479"><span class="linenos">479</span></a>            <span class="n">edgetype</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edge_types</span><span class="p">))</span> 
</span><span id="LightningProxModel.__init__-480"><a href="#LightningProxModel.__init__-480"><span class="linenos">480</span></a>            <span class="k">for</span> <span class="n">edgetype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_types</span>
</span><span id="LightningProxModel.__init__-481"><a href="#LightningProxModel.__init__-481"><span class="linenos">481</span></a>        <span class="p">}</span>
</span><span id="LightningProxModel.__init__-482"><a href="#LightningProxModel.__init__-482"><span class="linenos">482</span></a>
</span><span id="LightningProxModel.__init__-483"><a href="#LightningProxModel.__init__-483"><span class="linenos">483</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">node_weights_dict</span> <span class="o">=</span> <span class="n">node_weights_dict</span>
</span><span id="LightningProxModel.__init__-484"><a href="#LightningProxModel.__init__-484"><span class="linenos">484</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">herit_loss</span> <span class="o">=</span> <span class="n">herit_loss</span>
</span><span id="LightningProxModel.__init__-485"><a href="#LightningProxModel.__init__-485"><span class="linenos">485</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">herit_loss_lam</span> <span class="o">=</span> <span class="n">herit_loss_lam</span>
</span><span id="LightningProxModel.__init__-486"><a href="#LightningProxModel.__init__-486"><span class="linenos">486</span></a>
</span><span id="LightningProxModel.__init__-487"><a href="#LightningProxModel.__init__-487"><span class="linenos">487</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_neg_samples_fold</span> <span class="o">=</span> <span class="n">num_neg_samples_fold</span>
</span><span id="LightningProxModel.__init__-488"><a href="#LightningProxModel.__init__-488"><span class="linenos">488</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">validation_step_outputs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="LightningProxModel.__init__-489"><a href="#LightningProxModel.__init__-489"><span class="linenos">489</span></a>
</span><span id="LightningProxModel.__init__-490"><a href="#LightningProxModel.__init__-490"><span class="linenos">490</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">use_aux</span> <span class="o">=</span> <span class="n">use_aux</span>
</span><span id="LightningProxModel.__init__-491"><a href="#LightningProxModel.__init__-491"><span class="linenos">491</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">use_aux_noise</span> <span class="o">=</span> <span class="n">use_aux_noise</span>
</span><span id="LightningProxModel.__init__-492"><a href="#LightningProxModel.__init__-492"><span class="linenos">492</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">aux_params</span> <span class="o">=</span> <span class="n">AuxParams</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">edgetype_specific</span><span class="o">=</span><span class="n">edgetype_specific</span><span class="p">,</span> 
</span><span id="LightningProxModel.__init__-493"><a href="#LightningProxModel.__init__-493"><span class="linenos">493</span></a>                                    <span class="n">check_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># already checked above</span>
</span><span id="LightningProxModel.__init__-494"><a href="#LightningProxModel.__init__-494"><span class="linenos">494</span></a>                                    <span class="n">use_noise</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_aux_noise</span>    <span class="c1"># DEBUG</span>
</span><span id="LightningProxModel.__init__-495"><a href="#LightningProxModel.__init__-495"><span class="linenos">495</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel.__init__-496"><a href="#LightningProxModel.__init__-496"><span class="linenos">496</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_aux</span><span class="p">:</span>
</span><span id="LightningProxModel.__init__-497"><a href="#LightningProxModel.__init__-497"><span class="linenos">497</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_freeze_aux_params</span><span class="p">()</span>
</span><span id="LightningProxModel.__init__-498"><a href="#LightningProxModel.__init__-498"><span class="linenos">498</span></a>
</span><span id="LightningProxModel.__init__-499"><a href="#LightningProxModel.__init__-499"><span class="linenos">499</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
</span><span id="LightningProxModel.__init__-500"><a href="#LightningProxModel.__init__-500"><span class="linenos">500</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_negative</span> <span class="o">=</span> <span class="n">batch_negative</span>
</span><span id="LightningProxModel.__init__-501"><a href="#LightningProxModel.__init__-501"><span class="linenos">501</span></a>
</span><span id="LightningProxModel.__init__-502"><a href="#LightningProxModel.__init__-502"><span class="linenos">502</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">monitor_key</span> <span class="o">=</span> <span class="n">monitor_key</span>
</span><span id="LightningProxModel.__init__-503"><a href="#LightningProxModel.__init__-503"><span class="linenos">503</span></a>
</span><span id="LightningProxModel.__init__-504"><a href="#LightningProxModel.__init__-504"><span class="linenos">504</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gene_align_lambda</span> <span class="o">=</span> <span class="n">gene_align_lambda</span>
</span><span id="LightningProxModel.__init__-505"><a href="#LightningProxModel.__init__-505"><span class="linenos">505</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gene_align_n_no</span> <span class="o">=</span> <span class="n">gene_align_n_no</span>
</span><span id="LightningProxModel.__init__-506"><a href="#LightningProxModel.__init__-506"><span class="linenos">506</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gene_align_n_warmup</span> <span class="o">=</span> <span class="n">gene_align_n_warmup</span>
</span><span id="LightningProxModel.__init__-507"><a href="#LightningProxModel.__init__-507"><span class="linenos">507</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ot_cs_lambda</span> <span class="o">=</span> <span class="n">ot_cs_lambda</span>
</span><span id="LightningProxModel.__init__-508"><a href="#LightningProxModel.__init__-508"><span class="linenos">508</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ot_cs_n_no</span> <span class="o">=</span> <span class="n">ot_cs_n_no</span>
</span><span id="LightningProxModel.__init__-509"><a href="#LightningProxModel.__init__-509"><span class="linenos">509</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ot_cs_n_warmup</span> <span class="o">=</span> <span class="n">ot_cs_n_warmup</span>
</span><span id="LightningProxModel.__init__-510"><a href="#LightningProxModel.__init__-510"><span class="linenos">510</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ot_cs_k</span> <span class="o">=</span> <span class="n">ot_cs_k</span>
</span><span id="LightningProxModel.__init__-511"><a href="#LightningProxModel.__init__-511"><span class="linenos">511</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ot_cb_lambda</span> <span class="o">=</span> <span class="n">ot_cb_lambda</span>
</span><span id="LightningProxModel.__init__-512"><a href="#LightningProxModel.__init__-512"><span class="linenos">512</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ot_cb_n_no</span> <span class="o">=</span> <span class="n">ot_cb_n_no</span>
</span><span id="LightningProxModel.__init__-513"><a href="#LightningProxModel.__init__-513"><span class="linenos">513</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ot_cb_n_warmup</span> <span class="o">=</span> <span class="n">ot_cb_n_warmup</span>
</span><span id="LightningProxModel.__init__-514"><a href="#LightningProxModel.__init__-514"><span class="linenos">514</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ot_cb_k</span> <span class="o">=</span> <span class="n">ot_cb_k</span>
</span><span id="LightningProxModel.__init__-515"><a href="#LightningProxModel.__init__-515"><span class="linenos">515</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ot_eps</span> <span class="o">=</span> <span class="n">ot_eps</span>
</span><span id="LightningProxModel.__init__-516"><a href="#LightningProxModel.__init__-516"><span class="linenos">516</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ot_iter</span> <span class="o">=</span> <span class="n">ot_iter</span>
</span><span id="LightningProxModel.__init__-517"><a href="#LightningProxModel.__init__-517"><span class="linenos">517</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ot_plan_every_n_epochs</span> <span class="o">=</span> <span class="n">ot_plan_every_n_epochs</span>
</span><span id="LightningProxModel.__init__-518"><a href="#LightningProxModel.__init__-518"><span class="linenos">518</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ot_loss_every_n_steps</span> <span class="o">=</span> <span class="n">ot_loss_every_n_steps</span>
</span><span id="LightningProxModel.__init__-519"><a href="#LightningProxModel.__init__-519"><span class="linenos">519</span></a>
</span><span id="LightningProxModel.__init__-520"><a href="#LightningProxModel.__init__-520"><span class="linenos">520</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_register_gene_pairs</span><span class="p">()</span>
</span><span id="LightningProxModel.__init__-521"><a href="#LightningProxModel.__init__-521"><span class="linenos">521</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_register_ot_state</span><span class="p">()</span>
</span><span id="LightningProxModel.__init__-522"><a href="#LightningProxModel.__init__-522"><span class="linenos">522</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_register_others</span><span class="p">()</span>
</span><span id="LightningProxModel.__init__-523"><a href="#LightningProxModel.__init__-523"><span class="linenos">523</span></a>
</span><span id="LightningProxModel.__init__-524"><a href="#LightningProxModel.__init__-524"><span class="linenos">524</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log_every_n_steps</span> <span class="o">=</span> <span class="mi">50</span>
</span></pre></div>


            <div class="docstring"><p>Attributes:
    prepare_data_per_node:
        If True, each LOCAL_RANK=0 will call prepare data.
        Otherwise only NODE_RANK=0, LOCAL_RANK=0 will prepare data.
    allow_zero_length_dataloader_with_multiple_devices:
        If True, dataloader with zero length within local rank is allowed.
        Default value is False.</p>
</div>


                            </div>
                            <div id="LightningProxModel.data" class="classattr">
                                <div class="attr variable">
            <span class="name">data</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.data"></a>
    
    

                            </div>
                            <div id="LightningProxModel.logger2" class="classattr">
                                <div class="attr variable">
            <span class="name">logger2</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.logger2"></a>
    
    

                            </div>
                            <div id="LightningProxModel.learning_rate" class="classattr">
                                <div class="attr variable">
            <span class="name">learning_rate</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.learning_rate"></a>
    
    

                            </div>
                            <div id="LightningProxModel.encoder" class="classattr">
                                <div class="attr variable">
            <span class="name">encoder</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.encoder"></a>
    
    

                            </div>
                            <div id="LightningProxModel.decoder" class="classattr">
                                <div class="attr variable">
            <span class="name">decoder</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.decoder"></a>
    
    

                            </div>
                            <div id="LightningProxModel.hsic" class="classattr">
                                <div class="attr variable">
            <span class="name">hsic</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.hsic"></a>
    
    

                            </div>
                            <div id="LightningProxModel.kl_lambda" class="classattr">
                                <div class="attr variable">
            <span class="name">kl_lambda</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.kl_lambda"></a>
    
    

                            </div>
                            <div id="LightningProxModel.kl_n_no" class="classattr">
                                <div class="attr variable">
            <span class="name">kl_n_no</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.kl_n_no"></a>
    
    

                            </div>
                            <div id="LightningProxModel.kl_n_warmup" class="classattr">
                                <div class="attr variable">
            <span class="name">kl_n_warmup</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.kl_n_warmup"></a>
    
    

                            </div>
                            <div id="LightningProxModel.cell_weights" class="classattr">
                                <div class="attr variable">
            <span class="name">cell_weights</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.cell_weights"></a>
    
    

                            </div>
                            <div id="LightningProxModel.reweight_rarecell" class="classattr">
                                <div class="attr variable">
            <span class="name">reweight_rarecell</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.reweight_rarecell"></a>
    
    

                            </div>
                            <div id="LightningProxModel.edgetype_loss_weight_dict" class="classattr">
                                <div class="attr variable">
            <span class="name">edgetype_loss_weight_dict</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.edgetype_loss_weight_dict"></a>
    
    

                            </div>
                            <div id="LightningProxModel.node_weights_dict" class="classattr">
                                <div class="attr variable">
            <span class="name">node_weights_dict</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.node_weights_dict"></a>
    
    

                            </div>
                            <div id="LightningProxModel.herit_loss" class="classattr">
                                <div class="attr variable">
            <span class="name">herit_loss</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.herit_loss"></a>
    
    

                            </div>
                            <div id="LightningProxModel.herit_loss_lam" class="classattr">
                                <div class="attr variable">
            <span class="name">herit_loss_lam</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.herit_loss_lam"></a>
    
    

                            </div>
                            <div id="LightningProxModel.num_neg_samples_fold" class="classattr">
                                <div class="attr variable">
            <span class="name">num_neg_samples_fold</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.num_neg_samples_fold"></a>
    
    

                            </div>
                            <div id="LightningProxModel.validation_step_outputs" class="classattr">
                                <div class="attr variable">
            <span class="name">validation_step_outputs</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.validation_step_outputs"></a>
    
    

                            </div>
                            <div id="LightningProxModel.use_aux" class="classattr">
                                <div class="attr variable">
            <span class="name">use_aux</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.use_aux"></a>
    
    

                            </div>
                            <div id="LightningProxModel.use_aux_noise" class="classattr">
                                <div class="attr variable">
            <span class="name">use_aux_noise</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.use_aux_noise"></a>
    
    

                            </div>
                            <div id="LightningProxModel.aux_params" class="classattr">
                                <div class="attr variable">
            <span class="name">aux_params</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.aux_params"></a>
    
    

                            </div>
                            <div id="LightningProxModel.verbose" class="classattr">
                                <div class="attr variable">
            <span class="name">verbose</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.verbose"></a>
    
    

                            </div>
                            <div id="LightningProxModel.batch_negative" class="classattr">
                                <div class="attr variable">
            <span class="name">batch_negative</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.batch_negative"></a>
    
    

                            </div>
                            <div id="LightningProxModel.monitor_key" class="classattr">
                                <div class="attr variable">
            <span class="name">monitor_key</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.monitor_key"></a>
    
    

                            </div>
                            <div id="LightningProxModel.gene_align_lambda" class="classattr">
                                <div class="attr variable">
            <span class="name">gene_align_lambda</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.gene_align_lambda"></a>
    
    

                            </div>
                            <div id="LightningProxModel.gene_align_n_no" class="classattr">
                                <div class="attr variable">
            <span class="name">gene_align_n_no</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.gene_align_n_no"></a>
    
    

                            </div>
                            <div id="LightningProxModel.gene_align_n_warmup" class="classattr">
                                <div class="attr variable">
            <span class="name">gene_align_n_warmup</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.gene_align_n_warmup"></a>
    
    

                            </div>
                            <div id="LightningProxModel.ot_cs_lambda" class="classattr">
                                <div class="attr variable">
            <span class="name">ot_cs_lambda</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.ot_cs_lambda"></a>
    
    

                            </div>
                            <div id="LightningProxModel.ot_cs_n_no" class="classattr">
                                <div class="attr variable">
            <span class="name">ot_cs_n_no</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.ot_cs_n_no"></a>
    
    

                            </div>
                            <div id="LightningProxModel.ot_cs_n_warmup" class="classattr">
                                <div class="attr variable">
            <span class="name">ot_cs_n_warmup</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.ot_cs_n_warmup"></a>
    
    

                            </div>
                            <div id="LightningProxModel.ot_cs_k" class="classattr">
                                <div class="attr variable">
            <span class="name">ot_cs_k</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.ot_cs_k"></a>
    
    

                            </div>
                            <div id="LightningProxModel.ot_cb_lambda" class="classattr">
                                <div class="attr variable">
            <span class="name">ot_cb_lambda</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.ot_cb_lambda"></a>
    
    

                            </div>
                            <div id="LightningProxModel.ot_cb_n_no" class="classattr">
                                <div class="attr variable">
            <span class="name">ot_cb_n_no</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.ot_cb_n_no"></a>
    
    

                            </div>
                            <div id="LightningProxModel.ot_cb_n_warmup" class="classattr">
                                <div class="attr variable">
            <span class="name">ot_cb_n_warmup</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.ot_cb_n_warmup"></a>
    
    

                            </div>
                            <div id="LightningProxModel.ot_cb_k" class="classattr">
                                <div class="attr variable">
            <span class="name">ot_cb_k</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.ot_cb_k"></a>
    
    

                            </div>
                            <div id="LightningProxModel.ot_eps" class="classattr">
                                <div class="attr variable">
            <span class="name">ot_eps</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.ot_eps"></a>
    
    

                            </div>
                            <div id="LightningProxModel.ot_iter" class="classattr">
                                <div class="attr variable">
            <span class="name">ot_iter</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.ot_iter"></a>
    
    

                            </div>
                            <div id="LightningProxModel.ot_plan_every_n_epochs" class="classattr">
                                <div class="attr variable">
            <span class="name">ot_plan_every_n_epochs</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.ot_plan_every_n_epochs"></a>
    
    

                            </div>
                            <div id="LightningProxModel.ot_loss_every_n_steps" class="classattr">
                                <div class="attr variable">
            <span class="name">ot_loss_every_n_steps</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.ot_loss_every_n_steps"></a>
    
    

                            </div>
                            <div id="LightningProxModel.log_every_n_steps" class="classattr">
                                <div class="attr variable">
            <span class="name">log_every_n_steps</span>

        
    </div>
    <a class="headerlink" href="#LightningProxModel.log_every_n_steps"></a>
    
    

                            </div>
                            <div id="LightningProxModel.on_train_start" class="classattr">
                                        <input id="LightningProxModel.on_train_start-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_train_start</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LightningProxModel.on_train_start-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel.on_train_start"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel.on_train_start-621"><a href="#LightningProxModel.on_train_start-621"><span class="linenos">621</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LightningProxModel.on_train_start-622"><a href="#LightningProxModel.on_train_start-622"><span class="linenos">622</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel.on_train_start-623"><a href="#LightningProxModel.on_train_start-623"><span class="linenos">623</span></a>            <span class="n">update_lr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hsic_optimizer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span><span class="o">.</span><span class="n">lam</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Called at the beginning of training after sanity check.</p>
</div>


                            </div>
                            <div id="LightningProxModel.encode" class="classattr">
                                        <input id="LightningProxModel.encode-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">encode</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="o">*</span><span class="n">args</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">) -> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>:</span></span>

                <label class="view-source-button" for="LightningProxModel.encode-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel.encode"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel.encode-625"><a href="#LightningProxModel.encode-625"><span class="linenos">625</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="LightningProxModel.encode-626"><a href="#LightningProxModel.encode-626"><span class="linenos">626</span></a><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Runs the encoder and computes node-wise latent variables.&quot;&quot;&quot;</span>
</span><span id="LightningProxModel.encode-627"><a href="#LightningProxModel.encode-627"><span class="linenos">627</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Runs the encoder and computes node-wise latent variables.</p>
</div>


                            </div>
                            <div id="LightningProxModel.reparametrize" class="classattr">
                                        <input id="LightningProxModel.reparametrize-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">reparametrize</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">mu_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>,</span><span class="param">	<span class="n">logstd_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="LightningProxModel.reparametrize-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel.reparametrize"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel.reparametrize-629"><a href="#LightningProxModel.reparametrize-629"><span class="linenos">629</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reparametrize</span><span class="p">(</span>
</span><span id="LightningProxModel.reparametrize-630"><a href="#LightningProxModel.reparametrize-630"><span class="linenos">630</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LightningProxModel.reparametrize-631"><a href="#LightningProxModel.reparametrize-631"><span class="linenos">631</span></a>        <span class="n">mu_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel.reparametrize-632"><a href="#LightningProxModel.reparametrize-632"><span class="linenos">632</span></a>        <span class="n">logstd_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel.reparametrize-633"><a href="#LightningProxModel.reparametrize-633"><span class="linenos">633</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
</span><span id="LightningProxModel.reparametrize-634"><a href="#LightningProxModel.reparametrize-634"><span class="linenos">634</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate random z from mu, logstd&quot;&quot;&quot;</span>
</span><span id="LightningProxModel.reparametrize-635"><a href="#LightningProxModel.reparametrize-635"><span class="linenos">635</span></a>        <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LightningProxModel.reparametrize-636"><a href="#LightningProxModel.reparametrize-636"><span class="linenos">636</span></a>        <span class="k">assert</span> <span class="n">mu_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="n">logstd_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span><span id="LightningProxModel.reparametrize-637"><a href="#LightningProxModel.reparametrize-637"><span class="linenos">637</span></a>        <span class="k">for</span> <span class="n">node_type</span> <span class="ow">in</span> <span class="n">mu_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="LightningProxModel.reparametrize-638"><a href="#LightningProxModel.reparametrize-638"><span class="linenos">638</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="LightningProxModel.reparametrize-639"><a href="#LightningProxModel.reparametrize-639"><span class="linenos">639</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">kl_n_no</span>
</span><span id="LightningProxModel.reparametrize-640"><a href="#LightningProxModel.reparametrize-640"><span class="linenos">640</span></a>            <span class="p">):</span>  <span class="c1"># Start reparameterization later</span>
</span><span id="LightningProxModel.reparametrize-641"><a href="#LightningProxModel.reparametrize-641"><span class="linenos">641</span></a>                <span class="n">out_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">mu_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span>
</span><span id="LightningProxModel.reparametrize-642"><a href="#LightningProxModel.reparametrize-642"><span class="linenos">642</span></a>                    <span class="n">logstd_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span>
</span><span id="LightningProxModel.reparametrize-643"><a href="#LightningProxModel.reparametrize-643"><span class="linenos">643</span></a>                <span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logstd_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">])</span>
</span><span id="LightningProxModel.reparametrize-644"><a href="#LightningProxModel.reparametrize-644"><span class="linenos">644</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel.reparametrize-645"><a href="#LightningProxModel.reparametrize-645"><span class="linenos">645</span></a>                <span class="n">out_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">mu_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span>  <span class="c1"># Use mean only initially</span>
</span><span id="LightningProxModel.reparametrize-646"><a href="#LightningProxModel.reparametrize-646"><span class="linenos">646</span></a>        <span class="k">return</span> <span class="n">out_dict</span>
</span></pre></div>


            <div class="docstring"><p>Generate random z from mu, logstd</p>
</div>


                            </div>
                            <div id="LightningProxModel.relational_recon_loss" class="classattr">
                                        <input id="LightningProxModel.relational_recon_loss-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">relational_recon_loss</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">batch</span><span class="p">:</span> <span class="n">torch_geometric</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">hetero_data</span><span class="o">.</span><span class="n">HeteroData</span>,</span><span class="param">	<span class="n">z_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>,</span><span class="param">	<span class="n">pos_edge_index_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>,</span><span class="param">	<span class="n">pos_edge_weight_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>,</span><span class="param">	<span class="n">neg_edge_index_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">batch_alledges</span><span class="p">:</span> <span class="n">torch_geometric</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">hetero_data</span><span class="o">.</span><span class="n">HeteroData</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">neg_sample</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">plot</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">get_metric</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">) -> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">Dict</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="LightningProxModel.relational_recon_loss-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel.relational_recon_loss"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel.relational_recon_loss-648"><a href="#LightningProxModel.relational_recon_loss-648"><span class="linenos">648</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">relational_recon_loss</span><span class="p">(</span>
</span><span id="LightningProxModel.relational_recon_loss-649"><a href="#LightningProxModel.relational_recon_loss-649"><span class="linenos">649</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-650"><a href="#LightningProxModel.relational_recon_loss-650"><span class="linenos">650</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">HeteroData</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-651"><a href="#LightningProxModel.relational_recon_loss-651"><span class="linenos">651</span></a>        <span class="n">z_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel.relational_recon_loss-652"><a href="#LightningProxModel.relational_recon_loss-652"><span class="linenos">652</span></a>        <span class="n">pos_edge_index_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel.relational_recon_loss-653"><a href="#LightningProxModel.relational_recon_loss-653"><span class="linenos">653</span></a>        <span class="n">pos_edge_weight_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel.relational_recon_loss-654"><a href="#LightningProxModel.relational_recon_loss-654"><span class="linenos">654</span></a>        <span class="n">neg_edge_index_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-655"><a href="#LightningProxModel.relational_recon_loss-655"><span class="linenos">655</span></a>        <span class="n">batch_alledges</span><span class="p">:</span> <span class="n">HeteroData</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-656"><a href="#LightningProxModel.relational_recon_loss-656"><span class="linenos">656</span></a>        <span class="n">neg_sample</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-657"><a href="#LightningProxModel.relational_recon_loss-657"><span class="linenos">657</span></a>        <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-658"><a href="#LightningProxModel.relational_recon_loss-658"><span class="linenos">658</span></a>        <span class="n">get_metric</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-659"><a href="#LightningProxModel.relational_recon_loss-659"><span class="linenos">659</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span> <span class="n">Dict</span><span class="p">]:</span>
</span><span id="LightningProxModel.relational_recon_loss-660"><a href="#LightningProxModel.relational_recon_loss-660"><span class="linenos">660</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate reconstruction loss by maximizing log_prob of observing edge weight in pos_edge_index_dict and 0 weight in neg_edge_index_dict</span>
</span><span id="LightningProxModel.relational_recon_loss-661"><a href="#LightningProxModel.relational_recon_loss-661"><span class="linenos">661</span></a>
</span><span id="LightningProxModel.relational_recon_loss-662"><a href="#LightningProxModel.relational_recon_loss-662"><span class="linenos">662</span></a><span class="sd">        Args</span>
</span><span id="LightningProxModel.relational_recon_loss-663"><a href="#LightningProxModel.relational_recon_loss-663"><span class="linenos">663</span></a><span class="sd">        z_dict: encoded vector</span>
</span><span id="LightningProxModel.relational_recon_loss-664"><a href="#LightningProxModel.relational_recon_loss-664"><span class="linenos">664</span></a><span class="sd">        pos_edge_index_dict: Dictionary of Tensors with shape (2, n_pos_edges)</span>
</span><span id="LightningProxModel.relational_recon_loss-665"><a href="#LightningProxModel.relational_recon_loss-665"><span class="linenos">665</span></a><span class="sd">        pos_edge_weight_dict: Dictionary of Tensors with shape (n_pos_edges,) encoding the weight of each edges.</span>
</span><span id="LightningProxModel.relational_recon_loss-666"><a href="#LightningProxModel.relational_recon_loss-666"><span class="linenos">666</span></a><span class="sd">        neg_edge_index_dict: Dictionary of Tensors with shape (2, n_neg_edges) to be used as negative edges</span>
</span><span id="LightningProxModel.relational_recon_loss-667"><a href="#LightningProxModel.relational_recon_loss-667"><span class="linenos">667</span></a><span class="sd">        num_neg_samples: If neg_edge_index is None and</span>
</span><span id="LightningProxModel.relational_recon_loss-668"><a href="#LightningProxModel.relational_recon_loss-668"><span class="linenos">668</span></a><span class="sd">            num_neg_samples is None, This number of negative edges are sampled. Otherwise, the same number as the positive edges are sample.</span>
</span><span id="LightningProxModel.relational_recon_loss-669"><a href="#LightningProxModel.relational_recon_loss-669"><span class="linenos">669</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LightningProxModel.relational_recon_loss-670"><a href="#LightningProxModel.relational_recon_loss-670"><span class="linenos">670</span></a>        <span class="n">pos_dist_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Distribution</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span>
</span><span id="LightningProxModel.relational_recon_loss-671"><a href="#LightningProxModel.relational_recon_loss-671"><span class="linenos">671</span></a>            <span class="n">batch</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-672"><a href="#LightningProxModel.relational_recon_loss-672"><span class="linenos">672</span></a>            <span class="n">z_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-673"><a href="#LightningProxModel.relational_recon_loss-673"><span class="linenos">673</span></a>            <span class="n">pos_edge_index_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-674"><a href="#LightningProxModel.relational_recon_loss-674"><span class="linenos">674</span></a>            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">aux_params</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">pos_edge_index_dict</span><span class="p">),</span>
</span><span id="LightningProxModel.relational_recon_loss-675"><a href="#LightningProxModel.relational_recon_loss-675"><span class="linenos">675</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel.relational_recon_loss-676"><a href="#LightningProxModel.relational_recon_loss-676"><span class="linenos">676</span></a>        <span class="k">if</span> <span class="n">neg_sample</span><span class="p">:</span>
</span><span id="LightningProxModel.relational_recon_loss-677"><a href="#LightningProxModel.relational_recon_loss-677"><span class="linenos">677</span></a>            <span class="k">if</span> <span class="n">neg_edge_index_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel.relational_recon_loss-678"><a href="#LightningProxModel.relational_recon_loss-678"><span class="linenos">678</span></a>                <span class="n">neg_edge_index_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LightningProxModel.relational_recon_loss-679"><a href="#LightningProxModel.relational_recon_loss-679"><span class="linenos">679</span></a>                <span class="k">for</span> <span class="n">edge_type</span> <span class="ow">in</span> <span class="n">pos_edge_index_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="LightningProxModel.relational_recon_loss-680"><a href="#LightningProxModel.relational_recon_loss-680"><span class="linenos">680</span></a>                    <span class="n">src</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dst</span> <span class="o">=</span> <span class="n">edge_type</span>
</span><span id="LightningProxModel.relational_recon_loss-681"><a href="#LightningProxModel.relational_recon_loss-681"><span class="linenos">681</span></a>                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="n">src</span><span class="p">],</span> <span class="s2">&quot;sample&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="n">dst</span><span class="p">],</span> <span class="s2">&quot;sample&quot;</span><span class="p">):</span>
</span><span id="LightningProxModel.relational_recon_loss-682"><a href="#LightningProxModel.relational_recon_loss-682"><span class="linenos">682</span></a>                        <span class="n">neg_edge_index</span> <span class="o">=</span> <span class="n">negative_sampling_same_sample_bipartite</span><span class="p">(</span>
</span><span id="LightningProxModel.relational_recon_loss-683"><a href="#LightningProxModel.relational_recon_loss-683"><span class="linenos">683</span></a>                            <span class="n">pos_edge_index_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">],</span>
</span><span id="LightningProxModel.relational_recon_loss-684"><a href="#LightningProxModel.relational_recon_loss-684"><span class="linenos">684</span></a>                            <span class="n">src_sample</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="n">src</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-685"><a href="#LightningProxModel.relational_recon_loss-685"><span class="linenos">685</span></a>                            <span class="n">dst_sample</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-686"><a href="#LightningProxModel.relational_recon_loss-686"><span class="linenos">686</span></a>                            <span class="n">num_neg_samples_fold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_neg_samples_fold</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-687"><a href="#LightningProxModel.relational_recon_loss-687"><span class="linenos">687</span></a>                            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;sparse&quot;</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-688"><a href="#LightningProxModel.relational_recon_loss-688"><span class="linenos">688</span></a>                        <span class="p">)</span>
</span><span id="LightningProxModel.relational_recon_loss-689"><a href="#LightningProxModel.relational_recon_loss-689"><span class="linenos">689</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel.relational_recon_loss-690"><a href="#LightningProxModel.relational_recon_loss-690"><span class="linenos">690</span></a>                        <span class="n">n_pos_edges</span> <span class="o">=</span> <span class="n">pos_edge_index_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="LightningProxModel.relational_recon_loss-691"><a href="#LightningProxModel.relational_recon_loss-691"><span class="linenos">691</span></a>                        <span class="n">neg_edge_index</span> <span class="o">=</span> <span class="n">negative_sampling</span><span class="p">(</span>
</span><span id="LightningProxModel.relational_recon_loss-692"><a href="#LightningProxModel.relational_recon_loss-692"><span class="linenos">692</span></a>                            <span class="n">batch</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span><span class="o">.</span><span class="n">edge_index</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-693"><a href="#LightningProxModel.relational_recon_loss-693"><span class="linenos">693</span></a>                            <span class="n">num_nodes</span><span class="o">=</span><span class="p">(</span>
</span><span id="LightningProxModel.relational_recon_loss-694"><a href="#LightningProxModel.relational_recon_loss-694"><span class="linenos">694</span></a>                                <span class="n">batch</span><span class="p">[</span><span class="n">src</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-695"><a href="#LightningProxModel.relational_recon_loss-695"><span class="linenos">695</span></a>                                <span class="n">batch</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-696"><a href="#LightningProxModel.relational_recon_loss-696"><span class="linenos">696</span></a>                            <span class="p">),</span>
</span><span id="LightningProxModel.relational_recon_loss-697"><a href="#LightningProxModel.relational_recon_loss-697"><span class="linenos">697</span></a>                            <span class="n">num_neg_samples</span><span class="o">=</span><span class="n">n_pos_edges</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_neg_samples_fold</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-698"><a href="#LightningProxModel.relational_recon_loss-698"><span class="linenos">698</span></a>                        <span class="p">)</span>
</span><span id="LightningProxModel.relational_recon_loss-699"><a href="#LightningProxModel.relational_recon_loss-699"><span class="linenos">699</span></a>                    <span class="n">neg_edge_index_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">neg_edge_index</span>
</span><span id="LightningProxModel.relational_recon_loss-700"><a href="#LightningProxModel.relational_recon_loss-700"><span class="linenos">700</span></a>            <span class="n">neg_dist_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Distribution</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span>
</span><span id="LightningProxModel.relational_recon_loss-701"><a href="#LightningProxModel.relational_recon_loss-701"><span class="linenos">701</span></a>                <span class="n">batch</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-702"><a href="#LightningProxModel.relational_recon_loss-702"><span class="linenos">702</span></a>                <span class="n">z_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-703"><a href="#LightningProxModel.relational_recon_loss-703"><span class="linenos">703</span></a>                <span class="n">neg_edge_index_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_recon_loss-704"><a href="#LightningProxModel.relational_recon_loss-704"><span class="linenos">704</span></a>                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">aux_params</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">neg_edge_index_dict</span><span class="p">),</span>
</span><span id="LightningProxModel.relational_recon_loss-705"><a href="#LightningProxModel.relational_recon_loss-705"><span class="linenos">705</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel.relational_recon_loss-706"><a href="#LightningProxModel.relational_recon_loss-706"><span class="linenos">706</span></a>        <span class="n">loss_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LightningProxModel.relational_recon_loss-707"><a href="#LightningProxModel.relational_recon_loss-707"><span class="linenos">707</span></a>        <span class="n">metric_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LightningProxModel.relational_recon_loss-708"><a href="#LightningProxModel.relational_recon_loss-708"><span class="linenos">708</span></a>        <span class="n">fold_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_neg_samples_fold</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel.relational_recon_loss-709"><a href="#LightningProxModel.relational_recon_loss-709"><span class="linenos">709</span></a>        <span class="n">weight_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_neg_samples_fold</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel.relational_recon_loss-710"><a href="#LightningProxModel.relational_recon_loss-710"><span class="linenos">710</span></a>        <span class="k">for</span> <span class="n">edge_type</span><span class="p">,</span> <span class="n">pos_dist</span> <span class="ow">in</span> <span class="n">pos_dist_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="LightningProxModel.relational_recon_loss-711"><a href="#LightningProxModel.relational_recon_loss-711"><span class="linenos">711</span></a>            <span class="n">src_type</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dst_type</span> <span class="o">=</span> <span class="n">edge_type</span>
</span><span id="LightningProxModel.relational_recon_loss-712"><a href="#LightningProxModel.relational_recon_loss-712"><span class="linenos">712</span></a>            <span class="n">pos_edge_weights</span> <span class="o">=</span> <span class="n">pos_edge_weight_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span>
</span><span id="LightningProxModel.relational_recon_loss-713"><a href="#LightningProxModel.relational_recon_loss-713"><span class="linenos">713</span></a>            <span class="n">pos_loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">pos_dist</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">pos_edge_weights</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="LightningProxModel.relational_recon_loss-714"><a href="#LightningProxModel.relational_recon_loss-714"><span class="linenos">714</span></a>            <span class="n">loss_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos_loss</span>
</span><span id="LightningProxModel.relational_recon_loss-715"><a href="#LightningProxModel.relational_recon_loss-715"><span class="linenos">715</span></a>            <span class="k">if</span> <span class="n">neg_sample</span><span class="p">:</span>
</span><span id="LightningProxModel.relational_recon_loss-716"><a href="#LightningProxModel.relational_recon_loss-716"><span class="linenos">716</span></a>                <span class="n">neg_dist</span> <span class="o">=</span> <span class="n">neg_dist_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span>
</span><span id="LightningProxModel.relational_recon_loss-717"><a href="#LightningProxModel.relational_recon_loss-717"><span class="linenos">717</span></a>                <span class="n">neg_edge_weights</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
</span><span id="LightningProxModel.relational_recon_loss-718"><a href="#LightningProxModel.relational_recon_loss-718"><span class="linenos">718</span></a>                    <span class="n">neg_dist</span><span class="o">.</span><span class="n">event_shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span>
</span><span id="LightningProxModel.relational_recon_loss-719"><a href="#LightningProxModel.relational_recon_loss-719"><span class="linenos">719</span></a>                <span class="p">)</span>
</span><span id="LightningProxModel.relational_recon_loss-720"><a href="#LightningProxModel.relational_recon_loss-720"><span class="linenos">720</span></a>                <span class="n">neg_loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">neg_dist</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">neg_edge_weights</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="LightningProxModel.relational_recon_loss-721"><a href="#LightningProxModel.relational_recon_loss-721"><span class="linenos">721</span></a>                <span class="n">loss_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">loss_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">+</span> <span class="n">neg_loss</span> <span class="o">*</span> <span class="n">fold_tensor</span><span class="p">)</span> <span class="o">*</span> <span class="n">weight_tensor</span>
</span><span id="LightningProxModel.relational_recon_loss-722"><a href="#LightningProxModel.relational_recon_loss-722"><span class="linenos">722</span></a>
</span><span id="LightningProxModel.relational_recon_loss-723"><a href="#LightningProxModel.relational_recon_loss-723"><span class="linenos">723</span></a>        <span class="k">return</span> <span class="n">loss_dict</span><span class="p">,</span> <span class="n">neg_edge_index_dict</span><span class="p">,</span> <span class="n">metric_dict</span>
</span></pre></div>


            <div class="docstring"><p>Calculate reconstruction loss by maximizing log_prob of observing edge weight in pos_edge_index_dict and 0 weight in neg_edge_index_dict</p>

<p>Args
z_dict: encoded vector
pos_edge_index_dict: Dictionary of Tensors with shape (2, n_pos_edges)
pos_edge_weight_dict: Dictionary of Tensors with shape (n_pos_edges,) encoding the weight of each edges.
neg_edge_index_dict: Dictionary of Tensors with shape (2, n_neg_edges) to be used as negative edges
num_neg_samples: If neg_edge_index is None and
    num_neg_samples is None, This number of negative edges are sampled. Otherwise, the same number as the positive edges are sample.</p>
</div>


                            </div>
                            <div id="LightningProxModel.relational_kl_divergence" class="classattr">
                                        <input id="LightningProxModel.relational_kl_divergence-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">relational_kl_divergence</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">mu_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>,</span><span class="param">	<span class="n">logstd_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>,</span><span class="param">	<span class="n">node_index_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>,</span><span class="param">	<span class="n">node_weights_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="LightningProxModel.relational_kl_divergence-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel.relational_kl_divergence"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel.relational_kl_divergence-756"><a href="#LightningProxModel.relational_kl_divergence-756"><span class="linenos">756</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">relational_kl_divergence</span><span class="p">(</span>
</span><span id="LightningProxModel.relational_kl_divergence-757"><a href="#LightningProxModel.relational_kl_divergence-757"><span class="linenos">757</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_kl_divergence-758"><a href="#LightningProxModel.relational_kl_divergence-758"><span class="linenos">758</span></a>        <span class="n">mu_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel.relational_kl_divergence-759"><a href="#LightningProxModel.relational_kl_divergence-759"><span class="linenos">759</span></a>        <span class="n">logstd_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel.relational_kl_divergence-760"><a href="#LightningProxModel.relational_kl_divergence-760"><span class="linenos">760</span></a>        <span class="n">node_index_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel.relational_kl_divergence-761"><a href="#LightningProxModel.relational_kl_divergence-761"><span class="linenos">761</span></a>        <span class="n">node_weights_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel.relational_kl_divergence-762"><a href="#LightningProxModel.relational_kl_divergence-762"><span class="linenos">762</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
</span><span id="LightningProxModel.relational_kl_divergence-763"><a href="#LightningProxModel.relational_kl_divergence-763"><span class="linenos">763</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Sums KL divergence across relations.</span>
</span><span id="LightningProxModel.relational_kl_divergence-764"><a href="#LightningProxModel.relational_kl_divergence-764"><span class="linenos">764</span></a>
</span><span id="LightningProxModel.relational_kl_divergence-765"><a href="#LightningProxModel.relational_kl_divergence-765"><span class="linenos">765</span></a><span class="sd">        Args</span>
</span><span id="LightningProxModel.relational_kl_divergence-766"><a href="#LightningProxModel.relational_kl_divergence-766"><span class="linenos">766</span></a><span class="sd">            z_dict: encoded vector</span>
</span><span id="LightningProxModel.relational_kl_divergence-767"><a href="#LightningProxModel.relational_kl_divergence-767"><span class="linenos">767</span></a>
</span><span id="LightningProxModel.relational_kl_divergence-768"><a href="#LightningProxModel.relational_kl_divergence-768"><span class="linenos">768</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LightningProxModel.relational_kl_divergence-769"><a href="#LightningProxModel.relational_kl_divergence-769"><span class="linenos">769</span></a>        <span class="n">loss_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LightningProxModel.relational_kl_divergence-770"><a href="#LightningProxModel.relational_kl_divergence-770"><span class="linenos">770</span></a>        <span class="k">if</span> <span class="n">node_weights_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel.relational_kl_divergence-771"><a href="#LightningProxModel.relational_kl_divergence-771"><span class="linenos">771</span></a>            <span class="n">node_weights_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">node_type</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">mu_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">node_type</span> <span class="ow">in</span> <span class="n">mu_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
</span><span id="LightningProxModel.relational_kl_divergence-772"><a href="#LightningProxModel.relational_kl_divergence-772"><span class="linenos">772</span></a>        <span class="k">for</span> <span class="n">node_type</span> <span class="ow">in</span> <span class="n">mu_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="LightningProxModel.relational_kl_divergence-773"><a href="#LightningProxModel.relational_kl_divergence-773"><span class="linenos">773</span></a>            <span class="n">weight</span> <span class="o">=</span> <span class="n">node_weights_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">][</span><span class="n">node_index_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]]</span>
</span><span id="LightningProxModel.relational_kl_divergence-774"><a href="#LightningProxModel.relational_kl_divergence-774"><span class="linenos">774</span></a>            <span class="n">loss_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kl_loss</span><span class="p">(</span>
</span><span id="LightningProxModel.relational_kl_divergence-775"><a href="#LightningProxModel.relational_kl_divergence-775"><span class="linenos">775</span></a>                <span class="n">mu_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">],</span> <span class="n">logstd_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">],</span> <span class="n">weight</span>
</span><span id="LightningProxModel.relational_kl_divergence-776"><a href="#LightningProxModel.relational_kl_divergence-776"><span class="linenos">776</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel.relational_kl_divergence-777"><a href="#LightningProxModel.relational_kl_divergence-777"><span class="linenos">777</span></a>        <span class="k">return</span> <span class="n">loss_dict</span>
</span></pre></div>


            <div class="docstring"><p>Sums KL divergence across relations.</p>

<p>Args
    z_dict: encoded vector</p>
</div>


                            </div>
                            <div id="LightningProxModel.kl_div_loss" class="classattr">
                                        <input id="LightningProxModel.kl_div_loss-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">kl_div_loss</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">batch</span>,</span><span class="param">	<span class="n">mu_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>,</span><span class="param">	<span class="n">logstd_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>,</span><span class="param">	<span class="n">node_index_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>,</span><span class="param">	<span class="n">node_weights_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">nodetype_loss_weight_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>:</span></span>

                <label class="view-source-button" for="LightningProxModel.kl_div_loss-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel.kl_div_loss"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel.kl_div_loss-779"><a href="#LightningProxModel.kl_div_loss-779"><span class="linenos">779</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">kl_div_loss</span><span class="p">(</span>
</span><span id="LightningProxModel.kl_div_loss-780"><a href="#LightningProxModel.kl_div_loss-780"><span class="linenos">780</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LightningProxModel.kl_div_loss-781"><a href="#LightningProxModel.kl_div_loss-781"><span class="linenos">781</span></a>        <span class="n">batch</span><span class="p">,</span>
</span><span id="LightningProxModel.kl_div_loss-782"><a href="#LightningProxModel.kl_div_loss-782"><span class="linenos">782</span></a>        <span class="n">mu_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel.kl_div_loss-783"><a href="#LightningProxModel.kl_div_loss-783"><span class="linenos">783</span></a>        <span class="n">logstd_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel.kl_div_loss-784"><a href="#LightningProxModel.kl_div_loss-784"><span class="linenos">784</span></a>        <span class="n">node_index_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel.kl_div_loss-785"><a href="#LightningProxModel.kl_div_loss-785"><span class="linenos">785</span></a>        <span class="n">node_weights_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel.kl_div_loss-786"><a href="#LightningProxModel.kl_div_loss-786"><span class="linenos">786</span></a>        <span class="n">nodetype_loss_weight_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel.kl_div_loss-787"><a href="#LightningProxModel.kl_div_loss-787"><span class="linenos">787</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="LightningProxModel.kl_div_loss-788"><a href="#LightningProxModel.kl_div_loss-788"><span class="linenos">788</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LightningProxModel.kl_div_loss-789"><a href="#LightningProxModel.kl_div_loss-789"><span class="linenos">789</span></a><span class="sd">        Args</span>
</span><span id="LightningProxModel.kl_div_loss-790"><a href="#LightningProxModel.kl_div_loss-790"><span class="linenos">790</span></a><span class="sd">        mu_dict: mu of encoded batch</span>
</span><span id="LightningProxModel.kl_div_loss-791"><a href="#LightningProxModel.kl_div_loss-791"><span class="linenos">791</span></a><span class="sd">        logstd_dict: logstd of encoded batch</span>
</span><span id="LightningProxModel.kl_div_loss-792"><a href="#LightningProxModel.kl_div_loss-792"><span class="linenos">792</span></a><span class="sd">        node_index_dict: node index of the batch</span>
</span><span id="LightningProxModel.kl_div_loss-793"><a href="#LightningProxModel.kl_div_loss-793"><span class="linenos">793</span></a><span class="sd">        node_counts_dict: For entire dataset, counts how many times each node is used for KL div calculation. If None, assume no node has been used for the calculation.</span>
</span><span id="LightningProxModel.kl_div_loss-794"><a href="#LightningProxModel.kl_div_loss-794"><span class="linenos">794</span></a>
</span><span id="LightningProxModel.kl_div_loss-795"><a href="#LightningProxModel.kl_div_loss-795"><span class="linenos">795</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LightningProxModel.kl_div_loss-796"><a href="#LightningProxModel.kl_div_loss-796"><span class="linenos">796</span></a>        <span class="n">kl_div_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relational_kl_divergence</span><span class="p">(</span>
</span><span id="LightningProxModel.kl_div_loss-797"><a href="#LightningProxModel.kl_div_loss-797"><span class="linenos">797</span></a>            <span class="n">mu_dict</span><span class="p">,</span> <span class="n">logstd_dict</span><span class="p">,</span> <span class="n">node_index_dict</span><span class="p">,</span> <span class="n">node_weights_dict</span><span class="o">=</span><span class="n">node_weights_dict</span>
</span><span id="LightningProxModel.kl_div_loss-798"><a href="#LightningProxModel.kl_div_loss-798"><span class="linenos">798</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel.kl_div_loss-799"><a href="#LightningProxModel.kl_div_loss-799"><span class="linenos">799</span></a>        <span class="n">l</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel.kl_div_loss-800"><a href="#LightningProxModel.kl_div_loss-800"><span class="linenos">800</span></a>        <span class="k">if</span> <span class="n">nodetype_loss_weight_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel.kl_div_loss-801"><a href="#LightningProxModel.kl_div_loss-801"><span class="linenos">801</span></a>            <span class="n">nodetype_loss_weight_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">node_type</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">kl_div_dict</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">node_type</span> <span class="ow">in</span> <span class="n">kl_div_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
</span><span id="LightningProxModel.kl_div_loss-802"><a href="#LightningProxModel.kl_div_loss-802"><span class="linenos">802</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel.kl_div_loss-803"><a href="#LightningProxModel.kl_div_loss-803"><span class="linenos">803</span></a>            <span class="n">s</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">nodetype_loss_weight_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span> <span class="k">for</span> <span class="n">node_type</span> <span class="ow">in</span> <span class="n">kl_div_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="LightningProxModel.kl_div_loss-804"><a href="#LightningProxModel.kl_div_loss-804"><span class="linenos">804</span></a>            <span class="n">nodetype_loss_weight_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">node_type</span><span class="p">:</span> <span class="n">nodetype_loss_weight_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span> <span class="o">/</span> <span class="n">s</span> <span class="k">for</span> <span class="n">node_type</span> <span class="ow">in</span> <span class="n">kl_div_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
</span><span id="LightningProxModel.kl_div_loss-805"><a href="#LightningProxModel.kl_div_loss-805"><span class="linenos">805</span></a>        <span class="k">for</span> <span class="n">node_type</span><span class="p">,</span> <span class="n">kl_div</span> <span class="ow">in</span> <span class="n">kl_div_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="LightningProxModel.kl_div_loss-806"><a href="#LightningProxModel.kl_div_loss-806"><span class="linenos">806</span></a>            <span class="n">l</span> <span class="o">+=</span> <span class="n">kl_div</span> <span class="o">*</span> <span class="n">nodetype_loss_weight_dict</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span>
</span><span id="LightningProxModel.kl_div_loss-807"><a href="#LightningProxModel.kl_div_loss-807"><span class="linenos">807</span></a>        <span class="k">return</span> <span class="n">l</span>
</span></pre></div>


            <div class="docstring"><p>Args
mu_dict: mu of encoded batch
logstd_dict: logstd of encoded batch
node_index_dict: node index of the batch
node_counts_dict: For entire dataset, counts how many times each node is used for KL div calculation. If None, assume no node has been used for the calculation.</p>
</div>


                            </div>
                            <div id="LightningProxModel.nll_loss" class="classattr">
                                        <input id="LightningProxModel.nll_loss-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">nll_loss</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">batch</span><span class="p">:</span> <span class="n">torch_geometric</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">hetero_data</span><span class="o">.</span><span class="n">HeteroData</span>,</span><span class="param">	<span class="n">z_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>,</span><span class="param">	<span class="n">pos_edge_index_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>,</span><span class="param">	<span class="n">pos_edge_weight_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>,</span><span class="param">	<span class="n">neg_edge_index_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">edgetype_loss_weight_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">batch_alledges</span><span class="p">:</span> <span class="n">torch_geometric</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">hetero_data</span><span class="o">.</span><span class="n">HeteroData</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">neg_sample</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LightningProxModel.nll_loss-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel.nll_loss"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel.nll_loss-809"><a href="#LightningProxModel.nll_loss-809"><span class="linenos">809</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">nll_loss</span><span class="p">(</span>
</span><span id="LightningProxModel.nll_loss-810"><a href="#LightningProxModel.nll_loss-810"><span class="linenos">810</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LightningProxModel.nll_loss-811"><a href="#LightningProxModel.nll_loss-811"><span class="linenos">811</span></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">HeteroData</span><span class="p">,</span>
</span><span id="LightningProxModel.nll_loss-812"><a href="#LightningProxModel.nll_loss-812"><span class="linenos">812</span></a>        <span class="n">z_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">NodeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel.nll_loss-813"><a href="#LightningProxModel.nll_loss-813"><span class="linenos">813</span></a>        <span class="n">pos_edge_index_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel.nll_loss-814"><a href="#LightningProxModel.nll_loss-814"><span class="linenos">814</span></a>        <span class="n">pos_edge_weight_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="LightningProxModel.nll_loss-815"><a href="#LightningProxModel.nll_loss-815"><span class="linenos">815</span></a>        <span class="n">neg_edge_index_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel.nll_loss-816"><a href="#LightningProxModel.nll_loss-816"><span class="linenos">816</span></a>        <span class="c1"># num_neg_samples_fold: Optional[int] = 1,</span>
</span><span id="LightningProxModel.nll_loss-817"><a href="#LightningProxModel.nll_loss-817"><span class="linenos">817</span></a>        <span class="n">edgetype_loss_weight_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">EdgeType</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel.nll_loss-818"><a href="#LightningProxModel.nll_loss-818"><span class="linenos">818</span></a>        <span class="n">batch_alledges</span><span class="p">:</span> <span class="n">HeteroData</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LightningProxModel.nll_loss-819"><a href="#LightningProxModel.nll_loss-819"><span class="linenos">819</span></a>        <span class="n">neg_sample</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel.nll_loss-820"><a href="#LightningProxModel.nll_loss-820"><span class="linenos">820</span></a>    <span class="p">):</span>
</span><span id="LightningProxModel.nll_loss-821"><a href="#LightningProxModel.nll_loss-821"><span class="linenos">821</span></a>        <span class="n">nll_dict</span><span class="p">,</span> <span class="n">neg_edge_index_dict</span><span class="p">,</span> <span class="n">metric_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relational_recon_loss</span><span class="p">(</span>
</span><span id="LightningProxModel.nll_loss-822"><a href="#LightningProxModel.nll_loss-822"><span class="linenos">822</span></a>            <span class="n">batch</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span>
</span><span id="LightningProxModel.nll_loss-823"><a href="#LightningProxModel.nll_loss-823"><span class="linenos">823</span></a>            <span class="n">z_dict</span><span class="o">=</span><span class="n">z_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.nll_loss-824"><a href="#LightningProxModel.nll_loss-824"><span class="linenos">824</span></a>            <span class="n">pos_edge_index_dict</span><span class="o">=</span><span class="n">pos_edge_index_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.nll_loss-825"><a href="#LightningProxModel.nll_loss-825"><span class="linenos">825</span></a>            <span class="n">pos_edge_weight_dict</span><span class="o">=</span><span class="n">pos_edge_weight_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.nll_loss-826"><a href="#LightningProxModel.nll_loss-826"><span class="linenos">826</span></a>            <span class="n">neg_edge_index_dict</span><span class="o">=</span><span class="n">neg_edge_index_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.nll_loss-827"><a href="#LightningProxModel.nll_loss-827"><span class="linenos">827</span></a>            <span class="n">batch_alledges</span><span class="o">=</span><span class="n">batch_alledges</span><span class="p">,</span>
</span><span id="LightningProxModel.nll_loss-828"><a href="#LightningProxModel.nll_loss-828"><span class="linenos">828</span></a>            <span class="n">neg_sample</span><span class="o">=</span><span class="n">neg_sample</span><span class="p">,</span>
</span><span id="LightningProxModel.nll_loss-829"><a href="#LightningProxModel.nll_loss-829"><span class="linenos">829</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel.nll_loss-830"><a href="#LightningProxModel.nll_loss-830"><span class="linenos">830</span></a>        <span class="n">l</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel.nll_loss-831"><a href="#LightningProxModel.nll_loss-831"><span class="linenos">831</span></a>        <span class="n">weighted_nll_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LightningProxModel.nll_loss-832"><a href="#LightningProxModel.nll_loss-832"><span class="linenos">832</span></a>        <span class="k">if</span> <span class="n">edgetype_loss_weight_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel.nll_loss-833"><a href="#LightningProxModel.nll_loss-833"><span class="linenos">833</span></a>            <span class="n">edgetype_loss_weight_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">edge_type</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">nll_dict</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">edge_type</span> <span class="ow">in</span> <span class="n">nll_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
</span><span id="LightningProxModel.nll_loss-834"><a href="#LightningProxModel.nll_loss-834"><span class="linenos">834</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel.nll_loss-835"><a href="#LightningProxModel.nll_loss-835"><span class="linenos">835</span></a>            <span class="n">s</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">edgetype_loss_weight_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="k">for</span> <span class="n">edge_type</span> <span class="ow">in</span> <span class="n">nll_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="LightningProxModel.nll_loss-836"><a href="#LightningProxModel.nll_loss-836"><span class="linenos">836</span></a>            <span class="n">edgetype_loss_weight_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">edge_type</span><span class="p">:</span> <span class="n">edgetype_loss_weight_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">/</span> <span class="n">s</span> <span class="k">for</span> <span class="n">edge_type</span> <span class="ow">in</span> <span class="n">nll_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
</span><span id="LightningProxModel.nll_loss-837"><a href="#LightningProxModel.nll_loss-837"><span class="linenos">837</span></a>        <span class="k">for</span> <span class="n">edge_type</span><span class="p">,</span> <span class="n">nll</span> <span class="ow">in</span> <span class="n">nll_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="LightningProxModel.nll_loss-838"><a href="#LightningProxModel.nll_loss-838"><span class="linenos">838</span></a>            <span class="n">l</span> <span class="o">+=</span> <span class="n">nll</span> <span class="o">*</span> <span class="n">edgetype_loss_weight_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span>
</span><span id="LightningProxModel.nll_loss-839"><a href="#LightningProxModel.nll_loss-839"><span class="linenos">839</span></a>            <span class="n">weighted_nll_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">nll</span> <span class="o">*</span> <span class="n">edgetype_loss_weight_dict</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span>
</span><span id="LightningProxModel.nll_loss-840"><a href="#LightningProxModel.nll_loss-840"><span class="linenos">840</span></a>        <span class="k">return</span> <span class="n">l</span><span class="p">,</span> <span class="n">weighted_nll_dict</span><span class="p">,</span> <span class="n">neg_edge_index_dict</span><span class="p">,</span> <span class="n">metric_dict</span>
</span></pre></div>


    

                            </div>
                            <div id="LightningProxModel.gene_alignment_loss" class="classattr">
                                        <input id="LightningProxModel.gene_alignment_loss-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">gene_alignment_loss</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>:</span></span>

                <label class="view-source-button" for="LightningProxModel.gene_alignment_loss-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel.gene_alignment_loss"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel.gene_alignment_loss-842"><a href="#LightningProxModel.gene_alignment_loss-842"><span class="linenos">842</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">gene_alignment_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>        
</span><span id="LightningProxModel.gene_alignment_loss-843"><a href="#LightningProxModel.gene_alignment_loss-843"><span class="linenos">843</span></a>        <span class="n">gene_mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">__mu_dict__</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">]</span> <span class="c1"># (n_genes, n_latent_dims)</span>
</span><span id="LightningProxModel.gene_alignment_loss-844"><a href="#LightningProxModel.gene_alignment_loss-844"><span class="linenos">844</span></a>        <span class="n">pairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gene_pairs</span>
</span><span id="LightningProxModel.gene_alignment_loss-845"><a href="#LightningProxModel.gene_alignment_loss-845"><span class="linenos">845</span></a>        <span class="k">return</span> <span class="n">gene_alignment_msd_loss</span><span class="p">(</span><span class="n">gene_mu</span><span class="p">,</span> <span class="n">pairs</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="LightningProxModel.ot_alignment_loss" class="classattr">
                                        <input id="LightningProxModel.ot_alignment_loss-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">ot_alignment_loss</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="nb">type</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>:</span></span>

                <label class="view-source-button" for="LightningProxModel.ot_alignment_loss-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel.ot_alignment_loss"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel.ot_alignment_loss-847"><a href="#LightningProxModel.ot_alignment_loss-847"><span class="linenos">847</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">ot_alignment_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
</span><span id="LightningProxModel.ot_alignment_loss-848"><a href="#LightningProxModel.ot_alignment_loss-848"><span class="linenos">848</span></a>        <span class="c1"># current trainable mu (NOT detach) =&gt; gradients flow to those cells</span>
</span><span id="LightningProxModel.ot_alignment_loss-849"><a href="#LightningProxModel.ot_alignment_loss-849"><span class="linenos">849</span></a>        <span class="n">cell_mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">__mu_dict__</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span>
</span><span id="LightningProxModel.ot_alignment_loss-850"><a href="#LightningProxModel.ot_alignment_loss-850"><span class="linenos">850</span></a>        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;cs&quot;</span><span class="p">:</span>
</span><span id="LightningProxModel.ot_alignment_loss-851"><a href="#LightningProxModel.ot_alignment_loss-851"><span class="linenos">851</span></a>            <span class="k">return</span> <span class="n">ot_cost_multi</span><span class="p">(</span><span class="n">cell_mu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ot_cs_states</span><span class="p">,</span> <span class="n">P_detach</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LightningProxModel.ot_alignment_loss-852"><a href="#LightningProxModel.ot_alignment_loss-852"><span class="linenos">852</span></a>        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;cb&quot;</span><span class="p">:</span>
</span><span id="LightningProxModel.ot_alignment_loss-853"><a href="#LightningProxModel.ot_alignment_loss-853"><span class="linenos">853</span></a>            <span class="k">return</span> <span class="n">ot_cost_multi</span><span class="p">(</span><span class="n">cell_mu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ot_cb_states</span><span class="p">,</span> <span class="n">P_detach</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LightningProxModel.ot_alignment_loss-854"><a href="#LightningProxModel.ot_alignment_loss-854"><span class="linenos">854</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel.ot_alignment_loss-855"><a href="#LightningProxModel.ot_alignment_loss-855"><span class="linenos">855</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown OT type=</span><span class="si">{</span><span class="nb">type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="LightningProxModel.training_step" class="classattr">
                                        <input id="LightningProxModel.training_step-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">training_step</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">batch</span>, </span><span class="param"><span class="n">batch_idx</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LightningProxModel.training_step-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel.training_step"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel.training_step-857"><a href="#LightningProxModel.training_step-857"><span class="linenos">857</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">training_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
</span><span id="LightningProxModel.training_step-858"><a href="#LightningProxModel.training_step-858"><span class="linenos">858</span></a>        <span class="c1"># batch = batch.to(self.device)</span>
</span><span id="LightningProxModel.training_step-859"><a href="#LightningProxModel.training_step-859"><span class="linenos">859</span></a>        
</span><span id="LightningProxModel.training_step-860"><a href="#LightningProxModel.training_step-860"><span class="linenos">860</span></a>        <span class="n">t_all0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="LightningProxModel.training_step-861"><a href="#LightningProxModel.training_step-861"><span class="linenos">861</span></a>
</span><span id="LightningProxModel.training_step-862"><a href="#LightningProxModel.training_step-862"><span class="linenos">862</span></a>        <span class="n">mu_dict</span><span class="p">,</span> <span class="n">logstd_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="LightningProxModel.training_step-863"><a href="#LightningProxModel.training_step-863"><span class="linenos">863</span></a>        <span class="n">z_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reparametrize</span><span class="p">(</span><span class="n">mu_dict</span><span class="p">,</span> <span class="n">logstd_dict</span><span class="p">)</span>
</span><span id="LightningProxModel.training_step-864"><a href="#LightningProxModel.training_step-864"><span class="linenos">864</span></a>
</span><span id="LightningProxModel.training_step-865"><a href="#LightningProxModel.training_step-865"><span class="linenos">865</span></a>        <span class="n">bs_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_edges_in_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="LightningProxModel.training_step-866"><a href="#LightningProxModel.training_step-866"><span class="linenos">866</span></a>
</span><span id="LightningProxModel.training_step-867"><a href="#LightningProxModel.training_step-867"><span class="linenos">867</span></a>        <span class="c1"># ---- NLL ----</span>
</span><span id="LightningProxModel.training_step-868"><a href="#LightningProxModel.training_step-868"><span class="linenos">868</span></a>        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="LightningProxModel.training_step-869"><a href="#LightningProxModel.training_step-869"><span class="linenos">869</span></a>        <span class="n">batch_nll_loss</span><span class="p">,</span> <span class="n">weighted_nll_dict</span><span class="p">,</span> <span class="n">neg_edge_index_dict</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nll_loss</span><span class="p">(</span>
</span><span id="LightningProxModel.training_step-870"><a href="#LightningProxModel.training_step-870"><span class="linenos">870</span></a>            <span class="n">batch</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span>
</span><span id="LightningProxModel.training_step-871"><a href="#LightningProxModel.training_step-871"><span class="linenos">871</span></a>            <span class="n">z_dict</span><span class="o">=</span><span class="n">z_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.training_step-872"><a href="#LightningProxModel.training_step-872"><span class="linenos">872</span></a>            <span class="n">pos_edge_index_dict</span><span class="o">=</span><span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.training_step-873"><a href="#LightningProxModel.training_step-873"><span class="linenos">873</span></a>            <span class="n">pos_edge_weight_dict</span><span class="o">=</span><span class="n">batch</span><span class="o">.</span><span class="n">edge_attr_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.training_step-874"><a href="#LightningProxModel.training_step-874"><span class="linenos">874</span></a>            <span class="n">edgetype_loss_weight_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">edgetype_loss_weight_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.training_step-875"><a href="#LightningProxModel.training_step-875"><span class="linenos">875</span></a>            <span class="n">neg_sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_negative</span>
</span><span id="LightningProxModel.training_step-876"><a href="#LightningProxModel.training_step-876"><span class="linenos">876</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel.training_step-877"><a href="#LightningProxModel.training_step-877"><span class="linenos">877</span></a>
</span><span id="LightningProxModel.training_step-878"><a href="#LightningProxModel.training_step-878"><span class="linenos">878</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;nll&quot;</span><span class="p">,</span> <span class="n">batch_nll_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel.training_step-879"><a href="#LightningProxModel.training_step-879"><span class="linenos">879</span></a>        <span class="c1"># self._log_perf(&quot;nll&quot;, time.time() - t0, on_step=True)</span>
</span><span id="LightningProxModel.training_step-880"><a href="#LightningProxModel.training_step-880"><span class="linenos">880</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">weighted_nll_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="LightningProxModel.training_step-881"><a href="#LightningProxModel.training_step-881"><span class="linenos">881</span></a>            <span class="k">for</span> <span class="n">edge_type</span><span class="p">,</span> <span class="n">nll_w</span> <span class="ow">in</span> <span class="n">weighted_nll_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="LightningProxModel.training_step-882"><a href="#LightningProxModel.training_step-882"><span class="linenos">882</span></a>                <span class="n">edge_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edge_type_key</span><span class="p">(</span><span class="n">edge_type</span><span class="p">)</span>
</span><span id="LightningProxModel.training_step-883"><a href="#LightningProxModel.training_step-883"><span class="linenos">883</span></a>                <span class="n">edge_bs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span><span class="o">.</span><span class="n">edge_index</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</span><span id="LightningProxModel.training_step-884"><a href="#LightningProxModel.training_step-884"><span class="linenos">884</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;nll/</span><span class="si">{</span><span class="n">edge_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">nll_w</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">edge_bs</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel.training_step-885"><a href="#LightningProxModel.training_step-885"><span class="linenos">885</span></a>        
</span><span id="LightningProxModel.training_step-886"><a href="#LightningProxModel.training_step-886"><span class="linenos">886</span></a>        <span class="c1"># ---- KL ----</span>
</span><span id="LightningProxModel.training_step-887"><a href="#LightningProxModel.training_step-887"><span class="linenos">887</span></a>        <span class="n">compute_kl_now</span><span class="p">,</span> <span class="n">kl_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_kl_now</span><span class="p">(</span><span class="n">return_weight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LightningProxModel.training_step-888"><a href="#LightningProxModel.training_step-888"><span class="linenos">888</span></a>        <span class="n">batch_kl_div_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel.training_step-889"><a href="#LightningProxModel.training_step-889"><span class="linenos">889</span></a>        <span class="k">if</span> <span class="n">compute_kl_now</span><span class="p">:</span>
</span><span id="LightningProxModel.training_step-890"><a href="#LightningProxModel.training_step-890"><span class="linenos">890</span></a>            <span class="n">batch_kl_div_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kl_div_loss</span><span class="p">(</span>
</span><span id="LightningProxModel.training_step-891"><a href="#LightningProxModel.training_step-891"><span class="linenos">891</span></a>                <span class="n">batch</span><span class="p">,</span>
</span><span id="LightningProxModel.training_step-892"><a href="#LightningProxModel.training_step-892"><span class="linenos">892</span></a>                <span class="n">mu_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.training_step-893"><a href="#LightningProxModel.training_step-893"><span class="linenos">893</span></a>                <span class="n">logstd_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.training_step-894"><a href="#LightningProxModel.training_step-894"><span class="linenos">894</span></a>                <span class="n">batch</span><span class="o">.</span><span class="n">n_id_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.training_step-895"><a href="#LightningProxModel.training_step-895"><span class="linenos">895</span></a>                <span class="n">node_weights_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node_weights_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.training_step-896"><a href="#LightningProxModel.training_step-896"><span class="linenos">896</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel.training_step-897"><a href="#LightningProxModel.training_step-897"><span class="linenos">897</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;kl&quot;</span><span class="p">,</span> <span class="n">batch_kl_div_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel.training_step-898"><a href="#LightningProxModel.training_step-898"><span class="linenos">898</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;kl_weighted&quot;</span><span class="p">,</span> <span class="n">kl_weight</span> <span class="o">*</span> <span class="n">batch_kl_div_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel.training_step-899"><a href="#LightningProxModel.training_step-899"><span class="linenos">899</span></a>        
</span><span id="LightningProxModel.training_step-900"><a href="#LightningProxModel.training_step-900"><span class="linenos">900</span></a>        <span class="c1"># ---- Herit Loss ----</span>
</span><span id="LightningProxModel.training_step-901"><a href="#LightningProxModel.training_step-901"><span class="linenos">901</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">herit_loss</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel.training_step-902"><a href="#LightningProxModel.training_step-902"><span class="linenos">902</span></a>            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="LightningProxModel.training_step-903"><a href="#LightningProxModel.training_step-903"><span class="linenos">903</span></a>            <span class="k">if</span> <span class="s2">&quot;peak&quot;</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">node_types</span><span class="p">:</span>
</span><span id="LightningProxModel.training_step-904"><a href="#LightningProxModel.training_step-904"><span class="linenos">904</span></a>                <span class="n">pid</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;peak&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">n_id</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="LightningProxModel.training_step-905"><a href="#LightningProxModel.training_step-905"><span class="linenos">905</span></a>                <span class="n">herit_loss_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">herit_loss_lam</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">herit_loss</span><span class="p">(</span>
</span><span id="LightningProxModel.training_step-906"><a href="#LightningProxModel.training_step-906"><span class="linenos">906</span></a>                    <span class="n">mu_dict</span><span class="p">[</span><span class="s2">&quot;peak&quot;</span><span class="p">],</span>
</span><span id="LightningProxModel.training_step-907"><a href="#LightningProxModel.training_step-907"><span class="linenos">907</span></a>                    <span class="n">pid</span><span class="p">,</span>
</span><span id="LightningProxModel.training_step-908"><a href="#LightningProxModel.training_step-908"><span class="linenos">908</span></a>                <span class="p">)</span>
</span><span id="LightningProxModel.training_step-909"><a href="#LightningProxModel.training_step-909"><span class="linenos">909</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel.training_step-910"><a href="#LightningProxModel.training_step-910"><span class="linenos">910</span></a>                <span class="n">herit_loss_value</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel.training_step-911"><a href="#LightningProxModel.training_step-911"><span class="linenos">911</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;herit_loss&quot;</span><span class="p">,</span> <span class="n">herit_loss_value</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel.training_step-912"><a href="#LightningProxModel.training_step-912"><span class="linenos">912</span></a>            <span class="c1"># self._log_perf(&quot;herit_loss&quot;, time.time() - t0, on_step=True)</span>
</span><span id="LightningProxModel.training_step-913"><a href="#LightningProxModel.training_step-913"><span class="linenos">913</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel.training_step-914"><a href="#LightningProxModel.training_step-914"><span class="linenos">914</span></a>            <span class="n">herit_loss_value</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel.training_step-915"><a href="#LightningProxModel.training_step-915"><span class="linenos">915</span></a>        
</span><span id="LightningProxModel.training_step-916"><a href="#LightningProxModel.training_step-916"><span class="linenos">916</span></a>        <span class="c1"># ---- Gene Alignment ----</span>
</span><span id="LightningProxModel.training_step-917"><a href="#LightningProxModel.training_step-917"><span class="linenos">917</span></a>        <span class="n">compute_gene_align_now</span><span class="p">,</span> <span class="n">gene_align_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_gene_align_now</span><span class="p">(</span><span class="n">return_weight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LightningProxModel.training_step-918"><a href="#LightningProxModel.training_step-918"><span class="linenos">918</span></a>
</span><span id="LightningProxModel.training_step-919"><a href="#LightningProxModel.training_step-919"><span class="linenos">919</span></a>        <span class="n">gene_align_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel.training_step-920"><a href="#LightningProxModel.training_step-920"><span class="linenos">920</span></a>        <span class="k">if</span> <span class="n">compute_gene_align_now</span><span class="p">:</span>
</span><span id="LightningProxModel.training_step-921"><a href="#LightningProxModel.training_step-921"><span class="linenos">921</span></a>            <span class="n">gene_align_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gene_alignment_loss</span><span class="p">()</span>
</span><span id="LightningProxModel.training_step-922"><a href="#LightningProxModel.training_step-922"><span class="linenos">922</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;gene_align&quot;</span><span class="p">,</span> <span class="n">gene_align_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel.training_step-923"><a href="#LightningProxModel.training_step-923"><span class="linenos">923</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;gene_align_weighted&quot;</span><span class="p">,</span> <span class="n">gene_align_weight</span> <span class="o">*</span> <span class="n">gene_align_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel.training_step-924"><a href="#LightningProxModel.training_step-924"><span class="linenos">924</span></a>
</span><span id="LightningProxModel.training_step-925"><a href="#LightningProxModel.training_step-925"><span class="linenos">925</span></a>        <span class="c1"># ---- OT loss ----</span>
</span><span id="LightningProxModel.training_step-926"><a href="#LightningProxModel.training_step-926"><span class="linenos">926</span></a>        <span class="n">compute_ot_cs_now</span><span class="p">,</span> <span class="n">ot_cs_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_ot_cs_now</span><span class="p">(</span><span class="n">return_weight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LightningProxModel.training_step-927"><a href="#LightningProxModel.training_step-927"><span class="linenos">927</span></a>
</span><span id="LightningProxModel.training_step-928"><a href="#LightningProxModel.training_step-928"><span class="linenos">928</span></a>        <span class="n">ot_cs_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel.training_step-929"><a href="#LightningProxModel.training_step-929"><span class="linenos">929</span></a>        <span class="k">if</span> <span class="n">compute_ot_cs_now</span><span class="p">:</span>
</span><span id="LightningProxModel.training_step-930"><a href="#LightningProxModel.training_step-930"><span class="linenos">930</span></a>            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="LightningProxModel.training_step-931"><a href="#LightningProxModel.training_step-931"><span class="linenos">931</span></a>            <span class="n">ot_cs_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_alignment_loss</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;cs&quot;</span><span class="p">)</span>
</span><span id="LightningProxModel.training_step-932"><a href="#LightningProxModel.training_step-932"><span class="linenos">932</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;ot_cs_loss&quot;</span><span class="p">,</span> <span class="n">ot_cs_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel.training_step-933"><a href="#LightningProxModel.training_step-933"><span class="linenos">933</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;ot_cs_weighted&quot;</span><span class="p">,</span> <span class="n">ot_cs_weight</span> <span class="o">*</span> <span class="n">ot_cs_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel.training_step-934"><a href="#LightningProxModel.training_step-934"><span class="linenos">934</span></a>            <span class="c1"># self._log_perf(&quot;ot_cs_loss&quot;, time.time() - t0, on_step=True)</span>
</span><span id="LightningProxModel.training_step-935"><a href="#LightningProxModel.training_step-935"><span class="linenos">935</span></a>        
</span><span id="LightningProxModel.training_step-936"><a href="#LightningProxModel.training_step-936"><span class="linenos">936</span></a>        <span class="n">compute_ot_cb_now</span><span class="p">,</span> <span class="n">ot_cb_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_ot_cb_now</span><span class="p">(</span><span class="n">return_weight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LightningProxModel.training_step-937"><a href="#LightningProxModel.training_step-937"><span class="linenos">937</span></a>        <span class="n">ot_cb_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel.training_step-938"><a href="#LightningProxModel.training_step-938"><span class="linenos">938</span></a>        <span class="k">if</span> <span class="n">compute_ot_cb_now</span><span class="p">:</span>
</span><span id="LightningProxModel.training_step-939"><a href="#LightningProxModel.training_step-939"><span class="linenos">939</span></a>            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="LightningProxModel.training_step-940"><a href="#LightningProxModel.training_step-940"><span class="linenos">940</span></a>            <span class="n">ot_cb_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_alignment_loss</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;cb&quot;</span><span class="p">)</span>
</span><span id="LightningProxModel.training_step-941"><a href="#LightningProxModel.training_step-941"><span class="linenos">941</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;ot_cb_loss&quot;</span><span class="p">,</span> <span class="n">ot_cb_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel.training_step-942"><a href="#LightningProxModel.training_step-942"><span class="linenos">942</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;ot_cb_weighted&quot;</span><span class="p">,</span> <span class="n">ot_cb_weight</span> <span class="o">*</span> <span class="n">ot_cb_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel.training_step-943"><a href="#LightningProxModel.training_step-943"><span class="linenos">943</span></a>            <span class="c1"># self._log_perf(&quot;ot_cb_loss&quot;, time.time() - t0, on_step=True)</span>
</span><span id="LightningProxModel.training_step-944"><a href="#LightningProxModel.training_step-944"><span class="linenos">944</span></a>        
</span><span id="LightningProxModel.training_step-945"><a href="#LightningProxModel.training_step-945"><span class="linenos">945</span></a>        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LightningProxModel.training_step-946"><a href="#LightningProxModel.training_step-946"><span class="linenos">946</span></a>            <span class="n">batch_nll_loss</span>
</span><span id="LightningProxModel.training_step-947"><a href="#LightningProxModel.training_step-947"><span class="linenos">947</span></a>            <span class="o">+</span> <span class="n">kl_weight</span> <span class="o">*</span> <span class="n">batch_kl_div_loss</span>
</span><span id="LightningProxModel.training_step-948"><a href="#LightningProxModel.training_step-948"><span class="linenos">948</span></a>            <span class="c1"># + aux_kl_div_loss / self.nll_scale</span>
</span><span id="LightningProxModel.training_step-949"><a href="#LightningProxModel.training_step-949"><span class="linenos">949</span></a>            <span class="o">+</span> <span class="n">herit_loss_value</span>
</span><span id="LightningProxModel.training_step-950"><a href="#LightningProxModel.training_step-950"><span class="linenos">950</span></a>            <span class="c1"># + aux_reg_loss</span>
</span><span id="LightningProxModel.training_step-951"><a href="#LightningProxModel.training_step-951"><span class="linenos">951</span></a>            <span class="o">+</span> <span class="n">gene_align_weight</span> <span class="o">*</span> <span class="n">gene_align_loss</span>
</span><span id="LightningProxModel.training_step-952"><a href="#LightningProxModel.training_step-952"><span class="linenos">952</span></a>            <span class="o">+</span> <span class="n">ot_cs_weight</span> <span class="o">*</span> <span class="n">ot_cs_loss</span>
</span><span id="LightningProxModel.training_step-953"><a href="#LightningProxModel.training_step-953"><span class="linenos">953</span></a>            <span class="o">+</span> <span class="n">ot_cb_weight</span> <span class="o">*</span> <span class="n">ot_cb_loss</span>
</span><span id="LightningProxModel.training_step-954"><a href="#LightningProxModel.training_step-954"><span class="linenos">954</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel.training_step-955"><a href="#LightningProxModel.training_step-955"><span class="linenos">955</span></a>
</span><span id="LightningProxModel.training_step-956"><a href="#LightningProxModel.training_step-956"><span class="linenos">956</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;loss&quot;</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LightningProxModel.training_step-957"><a href="#LightningProxModel.training_step-957"><span class="linenos">957</span></a>        <span class="c1"># self._log_perf(&quot;step_total&quot;, time.time() - t_all0, on_step=True)</span>
</span><span id="LightningProxModel.training_step-958"><a href="#LightningProxModel.training_step-958"><span class="linenos">958</span></a>
</span><span id="LightningProxModel.training_step-959"><a href="#LightningProxModel.training_step-959"><span class="linenos">959</span></a>        <span class="c1"># Debug: Monitor gradients and embeddings every 10 steps</span>
</span><span id="LightningProxModel.training_step-960"><a href="#LightningProxModel.training_step-960"><span class="linenos">960</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_step</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="LightningProxModel.training_step-961"><a href="#LightningProxModel.training_step-961"><span class="linenos">961</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_debug_embeddings_only</span><span class="p">(</span><span class="n">mu_dict</span><span class="p">,</span> <span class="n">logstd_dict</span><span class="p">)</span>
</span><span id="LightningProxModel.training_step-962"><a href="#LightningProxModel.training_step-962"><span class="linenos">962</span></a>
</span><span id="LightningProxModel.training_step-963"><a href="#LightningProxModel.training_step-963"><span class="linenos">963</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">local_step</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="LightningProxModel.training_step-964"><a href="#LightningProxModel.training_step-964"><span class="linenos">964</span></a>
</span><span id="LightningProxModel.training_step-965"><a href="#LightningProxModel.training_step-965"><span class="linenos">965</span></a>        <span class="k">return</span> <span class="n">loss</span>
</span></pre></div>


            <div class="docstring"><p>Here you compute and return the training loss and some additional metrics for e.g. the progress bar or
logger.</p>

<p>Args:
    batch: The output of your data iterable, normally a <code>~torch.utils.data.DataLoader</code>.
    batch_idx: The index of this batch.
    dataloader_idx: The index of the dataloader that produced this batch.
        (only if multiple dataloaders used)</p>

<p>Return:
    - <code>~torch.Tensor</code> - The loss tensor
    - <code>dict</code> - A dictionary which can include any keys, but must include the key <code>'loss'</code> in the case of
      automatic optimization.
    - <code>None</code> - In automatic optimization, this will skip to the next batch (but is not supported for
      multi-GPU, TPU, or DeepSpeed). For manual optimization, this has no special meaning, as returning
      the loss is not required.</p>

<p>In this step you'd normally do the forward pass and calculate the loss for a batch.
You can also do fancier things like multiple forward passes or something model specific.</p>

<p>Example::</p>

<pre><code>def training_step(self, batch, batch_idx):
    x, y, z = batch
    out = self.encoder(x)
    loss = self.loss(out, x)
    return loss
</code></pre>

<p>To use multiple optimizers, you can switch to 'manual optimization' and control their stepping:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">automatic_optimization</span> <span class="o">=</span> <span class="kc">False</span>


<span class="c1"># Multiple optimizers (e.g.: GANs)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">training_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
    <span class="n">opt1</span><span class="p">,</span> <span class="n">opt2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizers</span><span class="p">()</span>

    <span class="c1"># do training_step with encoder</span>
    <span class="o">...</span>
    <span class="n">opt1</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
    <span class="c1"># do training_step with decoder</span>
    <span class="o">...</span>
    <span class="n">opt2</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</code></pre>
</div>

<p>Note:
    When <code>accumulate_grad_batches</code> &gt; 1, the loss returned here will be automatically
    normalized by <code>accumulate_grad_batches</code> internally.</p>
</div>


                            </div>
                            <div id="LightningProxModel.on_after_backward" class="classattr">
                                        <input id="LightningProxModel.on_after_backward-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_after_backward</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LightningProxModel.on_after_backward-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel.on_after_backward"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel.on_after_backward-967"><a href="#LightningProxModel.on_after_backward-967"><span class="linenos">967</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_after_backward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LightningProxModel.on_after_backward-968"><a href="#LightningProxModel.on_after_backward-968"><span class="linenos">968</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Called after loss.backward() and before optimizers are stepped.&quot;&quot;&quot;</span>
</span><span id="LightningProxModel.on_after_backward-969"><a href="#LightningProxModel.on_after_backward-969"><span class="linenos">969</span></a>
</span><span id="LightningProxModel.on_after_backward-970"><a href="#LightningProxModel.on_after_backward-970"><span class="linenos">970</span></a>        <span class="c1"># Gradient clipping to prevent aux_params from dominating</span>
</span><span id="LightningProxModel.on_after_backward-971"><a href="#LightningProxModel.on_after_backward-971"><span class="linenos">971</span></a>        <span class="c1"># torch.nn.utils.clip_grad_norm_(self.aux_params.parameters(), max_norm=1.0)</span>
</span><span id="LightningProxModel.on_after_backward-972"><a href="#LightningProxModel.on_after_backward-972"><span class="linenos">972</span></a>
</span><span id="LightningProxModel.on_after_backward-973"><a href="#LightningProxModel.on_after_backward-973"><span class="linenos">973</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_step</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="LightningProxModel.on_after_backward-974"><a href="#LightningProxModel.on_after_backward-974"><span class="linenos">974</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_debug_gradients</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Called after loss.backward() and before optimizers are stepped.</p>
</div>


                            </div>
                            <div id="LightningProxModel.validation_step" class="classattr">
                                        <input id="LightningProxModel.validation_step-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">validation_step</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">batch</span>, </span><span class="param"><span class="n">batch_idx</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LightningProxModel.validation_step-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel.validation_step"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel.validation_step-1081"><a href="#LightningProxModel.validation_step-1081"><span class="linenos">1081</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validation_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
</span><span id="LightningProxModel.validation_step-1082"><a href="#LightningProxModel.validation_step-1082"><span class="linenos">1082</span></a>        <span class="c1"># batch = batch.to(self.device)</span>
</span><span id="LightningProxModel.validation_step-1083"><a href="#LightningProxModel.validation_step-1083"><span class="linenos">1083</span></a>        
</span><span id="LightningProxModel.validation_step-1084"><a href="#LightningProxModel.validation_step-1084"><span class="linenos">1084</span></a>        <span class="n">mu_dict</span><span class="p">,</span> <span class="n">logstd_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="LightningProxModel.validation_step-1085"><a href="#LightningProxModel.validation_step-1085"><span class="linenos">1085</span></a>        <span class="n">z_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reparametrize</span><span class="p">(</span><span class="n">mu_dict</span><span class="p">,</span> <span class="n">logstd_dict</span><span class="p">)</span>
</span><span id="LightningProxModel.validation_step-1086"><a href="#LightningProxModel.validation_step-1086"><span class="linenos">1086</span></a>        
</span><span id="LightningProxModel.validation_step-1087"><a href="#LightningProxModel.validation_step-1087"><span class="linenos">1087</span></a>        <span class="n">bs_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_edges_in_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="LightningProxModel.validation_step-1088"><a href="#LightningProxModel.validation_step-1088"><span class="linenos">1088</span></a>
</span><span id="LightningProxModel.validation_step-1089"><a href="#LightningProxModel.validation_step-1089"><span class="linenos">1089</span></a>        <span class="c1"># ---- NLL ----</span>
</span><span id="LightningProxModel.validation_step-1090"><a href="#LightningProxModel.validation_step-1090"><span class="linenos">1090</span></a>        <span class="n">batch_nll_loss</span><span class="p">,</span> <span class="n">weighted_nll_dict</span><span class="p">,</span> <span class="n">neg_edge_index_dict</span><span class="p">,</span> <span class="n">metric_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nll_loss</span><span class="p">(</span>
</span><span id="LightningProxModel.validation_step-1091"><a href="#LightningProxModel.validation_step-1091"><span class="linenos">1091</span></a>            <span class="n">batch</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-1092"><a href="#LightningProxModel.validation_step-1092"><span class="linenos">1092</span></a>            <span class="n">z_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-1093"><a href="#LightningProxModel.validation_step-1093"><span class="linenos">1093</span></a>            <span class="n">batch</span><span class="o">.</span><span class="n">edge_index_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-1094"><a href="#LightningProxModel.validation_step-1094"><span class="linenos">1094</span></a>            <span class="n">batch</span><span class="o">.</span><span class="n">edge_attr_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-1095"><a href="#LightningProxModel.validation_step-1095"><span class="linenos">1095</span></a>            <span class="n">edgetype_loss_weight_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">edgetype_loss_weight_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-1096"><a href="#LightningProxModel.validation_step-1096"><span class="linenos">1096</span></a>            <span class="n">neg_sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_negative</span>
</span><span id="LightningProxModel.validation_step-1097"><a href="#LightningProxModel.validation_step-1097"><span class="linenos">1097</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel.validation_step-1098"><a href="#LightningProxModel.validation_step-1098"><span class="linenos">1098</span></a>
</span><span id="LightningProxModel.validation_step-1099"><a href="#LightningProxModel.validation_step-1099"><span class="linenos">1099</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;nll&quot;</span><span class="p">,</span> <span class="n">batch_nll_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel.validation_step-1100"><a href="#LightningProxModel.validation_step-1100"><span class="linenos">1100</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">weighted_nll_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="LightningProxModel.validation_step-1101"><a href="#LightningProxModel.validation_step-1101"><span class="linenos">1101</span></a>            <span class="k">for</span> <span class="n">edge_type</span><span class="p">,</span> <span class="n">nll_w</span> <span class="ow">in</span> <span class="n">weighted_nll_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="LightningProxModel.validation_step-1102"><a href="#LightningProxModel.validation_step-1102"><span class="linenos">1102</span></a>                <span class="n">edge_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edge_type_key</span><span class="p">(</span><span class="n">edge_type</span><span class="p">)</span>
</span><span id="LightningProxModel.validation_step-1103"><a href="#LightningProxModel.validation_step-1103"><span class="linenos">1103</span></a>                <span class="n">edge_bs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="n">edge_type</span><span class="p">]</span><span class="o">.</span><span class="n">edge_index</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</span><span id="LightningProxModel.validation_step-1104"><a href="#LightningProxModel.validation_step-1104"><span class="linenos">1104</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;nll/</span><span class="si">{</span><span class="n">edge_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">nll_w</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">edge_bs</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel.validation_step-1105"><a href="#LightningProxModel.validation_step-1105"><span class="linenos">1105</span></a>
</span><span id="LightningProxModel.validation_step-1106"><a href="#LightningProxModel.validation_step-1106"><span class="linenos">1106</span></a>        <span class="c1"># ---- KL ----</span>
</span><span id="LightningProxModel.validation_step-1107"><a href="#LightningProxModel.validation_step-1107"><span class="linenos">1107</span></a>        <span class="n">compute_kl_now</span><span class="p">,</span> <span class="n">kl_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_kl_now</span><span class="p">(</span><span class="n">return_weight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LightningProxModel.validation_step-1108"><a href="#LightningProxModel.validation_step-1108"><span class="linenos">1108</span></a>        <span class="n">batch_kl_div_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel.validation_step-1109"><a href="#LightningProxModel.validation_step-1109"><span class="linenos">1109</span></a>        <span class="k">if</span> <span class="n">compute_kl_now</span><span class="p">:</span>
</span><span id="LightningProxModel.validation_step-1110"><a href="#LightningProxModel.validation_step-1110"><span class="linenos">1110</span></a>            <span class="n">batch_kl_div_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kl_div_loss</span><span class="p">(</span>
</span><span id="LightningProxModel.validation_step-1111"><a href="#LightningProxModel.validation_step-1111"><span class="linenos">1111</span></a>                <span class="n">batch</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-1112"><a href="#LightningProxModel.validation_step-1112"><span class="linenos">1112</span></a>                <span class="n">mu_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-1113"><a href="#LightningProxModel.validation_step-1113"><span class="linenos">1113</span></a>                <span class="n">logstd_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-1114"><a href="#LightningProxModel.validation_step-1114"><span class="linenos">1114</span></a>                <span class="n">batch</span><span class="o">.</span><span class="n">n_id_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-1115"><a href="#LightningProxModel.validation_step-1115"><span class="linenos">1115</span></a>                <span class="n">node_weights_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node_weights_dict</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-1116"><a href="#LightningProxModel.validation_step-1116"><span class="linenos">1116</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel.validation_step-1117"><a href="#LightningProxModel.validation_step-1117"><span class="linenos">1117</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;kl&quot;</span><span class="p">,</span> <span class="n">batch_kl_div_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel.validation_step-1118"><a href="#LightningProxModel.validation_step-1118"><span class="linenos">1118</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;kl_weighted&quot;</span><span class="p">,</span> <span class="n">kl_weight</span> <span class="o">*</span> <span class="n">batch_kl_div_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel.validation_step-1119"><a href="#LightningProxModel.validation_step-1119"><span class="linenos">1119</span></a>
</span><span id="LightningProxModel.validation_step-1120"><a href="#LightningProxModel.validation_step-1120"><span class="linenos">1120</span></a>        <span class="c1"># ---- Herit Loss ----</span>
</span><span id="LightningProxModel.validation_step-1121"><a href="#LightningProxModel.validation_step-1121"><span class="linenos">1121</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">herit_loss</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel.validation_step-1122"><a href="#LightningProxModel.validation_step-1122"><span class="linenos">1122</span></a>            <span class="k">if</span> <span class="s2">&quot;peak&quot;</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">node_types</span><span class="p">:</span>
</span><span id="LightningProxModel.validation_step-1123"><a href="#LightningProxModel.validation_step-1123"><span class="linenos">1123</span></a>                <span class="n">pid</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;peak&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">n_id</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</span><span id="LightningProxModel.validation_step-1124"><a href="#LightningProxModel.validation_step-1124"><span class="linenos">1124</span></a>                <span class="n">herit_loss_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">herit_loss_lam</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">herit_loss</span><span class="p">(</span>
</span><span id="LightningProxModel.validation_step-1125"><a href="#LightningProxModel.validation_step-1125"><span class="linenos">1125</span></a>                    <span class="n">mu_dict</span><span class="p">[</span><span class="s2">&quot;peak&quot;</span><span class="p">],</span>
</span><span id="LightningProxModel.validation_step-1126"><a href="#LightningProxModel.validation_step-1126"><span class="linenos">1126</span></a>                    <span class="n">pid</span><span class="p">,</span>
</span><span id="LightningProxModel.validation_step-1127"><a href="#LightningProxModel.validation_step-1127"><span class="linenos">1127</span></a>                <span class="p">)</span>
</span><span id="LightningProxModel.validation_step-1128"><a href="#LightningProxModel.validation_step-1128"><span class="linenos">1128</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel.validation_step-1129"><a href="#LightningProxModel.validation_step-1129"><span class="linenos">1129</span></a>                <span class="n">herit_loss_value</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel.validation_step-1130"><a href="#LightningProxModel.validation_step-1130"><span class="linenos">1130</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;herit_loss&quot;</span><span class="p">,</span> <span class="n">herit_loss_value</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel.validation_step-1131"><a href="#LightningProxModel.validation_step-1131"><span class="linenos">1131</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel.validation_step-1132"><a href="#LightningProxModel.validation_step-1132"><span class="linenos">1132</span></a>            <span class="n">herit_loss_value</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel.validation_step-1133"><a href="#LightningProxModel.validation_step-1133"><span class="linenos">1133</span></a>        
</span><span id="LightningProxModel.validation_step-1134"><a href="#LightningProxModel.validation_step-1134"><span class="linenos">1134</span></a>        <span class="c1"># ---- Gene Alignment ----</span>
</span><span id="LightningProxModel.validation_step-1135"><a href="#LightningProxModel.validation_step-1135"><span class="linenos">1135</span></a>        <span class="n">compute_gene_align_now</span><span class="p">,</span> <span class="n">gene_align_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_gene_align_now</span><span class="p">(</span><span class="n">return_weight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LightningProxModel.validation_step-1136"><a href="#LightningProxModel.validation_step-1136"><span class="linenos">1136</span></a>
</span><span id="LightningProxModel.validation_step-1137"><a href="#LightningProxModel.validation_step-1137"><span class="linenos">1137</span></a>        <span class="n">gene_align_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel.validation_step-1138"><a href="#LightningProxModel.validation_step-1138"><span class="linenos">1138</span></a>        <span class="k">if</span> <span class="n">compute_gene_align_now</span><span class="p">:</span>
</span><span id="LightningProxModel.validation_step-1139"><a href="#LightningProxModel.validation_step-1139"><span class="linenos">1139</span></a>            <span class="n">gene_align_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gene_alignment_loss</span><span class="p">()</span>
</span><span id="LightningProxModel.validation_step-1140"><a href="#LightningProxModel.validation_step-1140"><span class="linenos">1140</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;gene_align&quot;</span><span class="p">,</span> <span class="n">gene_align_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel.validation_step-1141"><a href="#LightningProxModel.validation_step-1141"><span class="linenos">1141</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;gene_align_weighted&quot;</span><span class="p">,</span> <span class="n">gene_align_weight</span> <span class="o">*</span> <span class="n">gene_align_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel.validation_step-1142"><a href="#LightningProxModel.validation_step-1142"><span class="linenos">1142</span></a>
</span><span id="LightningProxModel.validation_step-1143"><a href="#LightningProxModel.validation_step-1143"><span class="linenos">1143</span></a>        <span class="c1"># ---- OT loss ----</span>
</span><span id="LightningProxModel.validation_step-1144"><a href="#LightningProxModel.validation_step-1144"><span class="linenos">1144</span></a>        <span class="n">compute_ot_cs_now</span><span class="p">,</span> <span class="n">ot_cs_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_ot_cs_now</span><span class="p">(</span><span class="n">return_weight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LightningProxModel.validation_step-1145"><a href="#LightningProxModel.validation_step-1145"><span class="linenos">1145</span></a>
</span><span id="LightningProxModel.validation_step-1146"><a href="#LightningProxModel.validation_step-1146"><span class="linenos">1146</span></a>        <span class="n">ot_cs_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel.validation_step-1147"><a href="#LightningProxModel.validation_step-1147"><span class="linenos">1147</span></a>        <span class="k">if</span> <span class="n">compute_ot_cs_now</span><span class="p">:</span>
</span><span id="LightningProxModel.validation_step-1148"><a href="#LightningProxModel.validation_step-1148"><span class="linenos">1148</span></a>            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="LightningProxModel.validation_step-1149"><a href="#LightningProxModel.validation_step-1149"><span class="linenos">1149</span></a>            <span class="n">ot_cs_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_alignment_loss</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;cs&quot;</span><span class="p">)</span>
</span><span id="LightningProxModel.validation_step-1150"><a href="#LightningProxModel.validation_step-1150"><span class="linenos">1150</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;ot_cs_loss&quot;</span><span class="p">,</span> <span class="n">ot_cs_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel.validation_step-1151"><a href="#LightningProxModel.validation_step-1151"><span class="linenos">1151</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;ot_cs_weighted&quot;</span><span class="p">,</span> <span class="n">ot_cs_weight</span> <span class="o">*</span> <span class="n">ot_cs_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel.validation_step-1152"><a href="#LightningProxModel.validation_step-1152"><span class="linenos">1152</span></a>        
</span><span id="LightningProxModel.validation_step-1153"><a href="#LightningProxModel.validation_step-1153"><span class="linenos">1153</span></a>        <span class="n">compute_ot_cb_now</span><span class="p">,</span> <span class="n">ot_cb_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_ot_cb_now</span><span class="p">(</span><span class="n">return_weight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LightningProxModel.validation_step-1154"><a href="#LightningProxModel.validation_step-1154"><span class="linenos">1154</span></a>        <span class="n">ot_cb_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="LightningProxModel.validation_step-1155"><a href="#LightningProxModel.validation_step-1155"><span class="linenos">1155</span></a>        <span class="k">if</span> <span class="n">compute_ot_cb_now</span><span class="p">:</span>
</span><span id="LightningProxModel.validation_step-1156"><a href="#LightningProxModel.validation_step-1156"><span class="linenos">1156</span></a>            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="LightningProxModel.validation_step-1157"><a href="#LightningProxModel.validation_step-1157"><span class="linenos">1157</span></a>            <span class="n">ot_cb_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ot_alignment_loss</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;cb&quot;</span><span class="p">)</span>
</span><span id="LightningProxModel.validation_step-1158"><a href="#LightningProxModel.validation_step-1158"><span class="linenos">1158</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;ot_cb_loss&quot;</span><span class="p">,</span> <span class="n">ot_cb_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel.validation_step-1159"><a href="#LightningProxModel.validation_step-1159"><span class="linenos">1159</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;ot_cb_weighted&quot;</span><span class="p">,</span> <span class="n">ot_cb_weight</span> <span class="o">*</span> <span class="n">ot_cb_loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LightningProxModel.validation_step-1160"><a href="#LightningProxModel.validation_step-1160"><span class="linenos">1160</span></a>
</span><span id="LightningProxModel.validation_step-1161"><a href="#LightningProxModel.validation_step-1161"><span class="linenos">1161</span></a>        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LightningProxModel.validation_step-1162"><a href="#LightningProxModel.validation_step-1162"><span class="linenos">1162</span></a>            <span class="n">batch_nll_loss</span> <span class="o">+</span> 
</span><span id="LightningProxModel.validation_step-1163"><a href="#LightningProxModel.validation_step-1163"><span class="linenos">1163</span></a>            <span class="n">kl_weight</span> <span class="o">*</span> <span class="n">batch_kl_div_loss</span> <span class="o">+</span> 
</span><span id="LightningProxModel.validation_step-1164"><a href="#LightningProxModel.validation_step-1164"><span class="linenos">1164</span></a>            <span class="n">herit_loss_value</span>
</span><span id="LightningProxModel.validation_step-1165"><a href="#LightningProxModel.validation_step-1165"><span class="linenos">1165</span></a>            <span class="o">+</span> <span class="n">gene_align_weight</span> <span class="o">*</span> <span class="n">gene_align_loss</span>
</span><span id="LightningProxModel.validation_step-1166"><a href="#LightningProxModel.validation_step-1166"><span class="linenos">1166</span></a>            <span class="o">+</span> <span class="n">ot_cs_weight</span> <span class="o">*</span> <span class="n">ot_cs_loss</span>
</span><span id="LightningProxModel.validation_step-1167"><a href="#LightningProxModel.validation_step-1167"><span class="linenos">1167</span></a>            <span class="o">+</span> <span class="n">ot_cb_weight</span> <span class="o">*</span> <span class="n">ot_cb_loss</span>
</span><span id="LightningProxModel.validation_step-1168"><a href="#LightningProxModel.validation_step-1168"><span class="linenos">1168</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel.validation_step-1169"><a href="#LightningProxModel.validation_step-1169"><span class="linenos">1169</span></a>
</span><span id="LightningProxModel.validation_step-1170"><a href="#LightningProxModel.validation_step-1170"><span class="linenos">1170</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;loss&quot;</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">bs_edges</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LightningProxModel.validation_step-1171"><a href="#LightningProxModel.validation_step-1171"><span class="linenos">1171</span></a>
</span><span id="LightningProxModel.validation_step-1172"><a href="#LightningProxModel.validation_step-1172"><span class="linenos">1172</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">validation_step_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
</span><span id="LightningProxModel.validation_step-1173"><a href="#LightningProxModel.validation_step-1173"><span class="linenos">1173</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">local_step_val</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="LightningProxModel.validation_step-1174"><a href="#LightningProxModel.validation_step-1174"><span class="linenos">1174</span></a>
</span><span id="LightningProxModel.validation_step-1175"><a href="#LightningProxModel.validation_step-1175"><span class="linenos">1175</span></a>        <span class="k">return</span> <span class="n">loss</span>
</span></pre></div>


            <div class="docstring"><p>Operates on a single batch of data from the validation set. In this step you'd might generate examples or
calculate anything of interest like accuracy.</p>

<p>Args:
    batch: The output of your data iterable, normally a <code>~torch.utils.data.DataLoader</code>.
    batch_idx: The index of this batch.
    dataloader_idx: The index of the dataloader that produced this batch.
        (only if multiple dataloaders used)</p>

<p>Return:
    - <code>~torch.Tensor</code> - The loss tensor
    - <code>dict</code> - A dictionary. Can include any keys, but must include the key <code>'loss'</code>.
    - <code>None</code> - Skip to the next batch.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="c1"># if you have one val dataloader:</span>
<span class="k">def</span><span class="w"> </span><span class="nf">validation_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span> <span class="o">...</span>


<span class="c1"># if you have multiple val dataloaders:</span>
<span class="k">def</span><span class="w"> </span><span class="nf">validation_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="n">dataloader_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span> <span class="o">...</span>
</code></pre>
</div>

<p>Examples::</p>

<pre><code># CASE 1: A single validation dataset
def validation_step(self, batch, batch_idx):
    x, y = batch

    # implement your own
    out = self(x)
    loss = self.loss(out, y)

    # log 6 example images
    # or generated text... or whatever
    sample_imgs = x[:6]
    grid = torchvision.utils.make_grid(sample_imgs)
    self.logger.experiment.add_image('example_images', grid, 0)

    # calculate acc
    labels_hat = torch.argmax(out, dim=1)
    val_acc = torch.sum(y == labels_hat).item() / (len(y) * 1.0)

    # log the outputs!
    self.log_dict({'val_loss': loss, 'val_acc': val_acc})
</code></pre>

<p>If you pass in multiple val dataloaders, <code><a href="#LightningProxModel.validation_step">validation_step()</a></code> will have an additional argument. We recommend
setting the default value of 0 so that you can quickly switch between single and multiple dataloaders.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="c1"># CASE 2: multiple validation dataloaders</span>
<span class="k">def</span><span class="w"> </span><span class="nf">validation_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="n">dataloader_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="c1"># dataloader_idx tells you which dataset this is.</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">batch</span>

    <span class="c1"># implement your own</span>
    <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dataloader_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss0</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss1</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="c1"># calculate acc</span>
    <span class="n">labels_hat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y</span> <span class="o">==</span> <span class="n">labels_hat</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="c1"># log the outputs separately for each dataloader</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">log_dict</span><span class="p">({</span><span class="sa">f</span><span class="s2">&quot;val_loss_</span><span class="si">{</span><span class="n">dataloader_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">loss</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;val_acc_</span><span class="si">{</span><span class="n">dataloader_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">acc</span><span class="p">})</span>
</code></pre>
</div>

<p>Note:
    If you don't need to validate you don't need to implement this method.</p>

<p>Note:
    When the <code><a href="#LightningProxModel.validation_step">validation_step()</a></code> is called, the model has been put in eval mode
    and PyTorch gradients have been disabled. At the end of validation,
    the model goes back to training mode and gradients are enabled.</p>
</div>


                            </div>
                            <div id="LightningProxModel.mean_cell_neighbor_distance" class="classattr">
                                        <input id="LightningProxModel.mean_cell_neighbor_distance-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">mean_cell_neighbor_distance</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">k</span><span class="o">=</span><span class="mi">50</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LightningProxModel.mean_cell_neighbor_distance-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel.mean_cell_neighbor_distance"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel.mean_cell_neighbor_distance-1177"><a href="#LightningProxModel.mean_cell_neighbor_distance-1177"><span class="linenos">1177</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">mean_cell_neighbor_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
</span><span id="LightningProxModel.mean_cell_neighbor_distance-1178"><a href="#LightningProxModel.mean_cell_neighbor_distance-1178"><span class="linenos">1178</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LightningProxModel.mean_cell_neighbor_distance-1179"><a href="#LightningProxModel.mean_cell_neighbor_distance-1179"><span class="linenos">1179</span></a><span class="sd">        Calculates the mean distance between each cell node and its k nearest neighbors.</span>
</span><span id="LightningProxModel.mean_cell_neighbor_distance-1180"><a href="#LightningProxModel.mean_cell_neighbor_distance-1180"><span class="linenos">1180</span></a><span class="sd">        Returns a tensor of mean distances for each cell.</span>
</span><span id="LightningProxModel.mean_cell_neighbor_distance-1181"><a href="#LightningProxModel.mean_cell_neighbor_distance-1181"><span class="linenos">1181</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LightningProxModel.mean_cell_neighbor_distance-1182"><a href="#LightningProxModel.mean_cell_neighbor_distance-1182"><span class="linenos">1182</span></a>        <span class="n">cell_mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">__mu_dict__</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>  <span class="c1"># (num_cells, latent_dim)</span>
</span><span id="LightningProxModel.mean_cell_neighbor_distance-1183"><a href="#LightningProxModel.mean_cell_neighbor_distance-1183"><span class="linenos">1183</span></a>        <span class="c1"># Compute pairwise Euclidean distances</span>
</span><span id="LightningProxModel.mean_cell_neighbor_distance-1184"><a href="#LightningProxModel.mean_cell_neighbor_distance-1184"><span class="linenos">1184</span></a>        <span class="n">dist_matrix</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cdist</span><span class="p">(</span><span class="n">cell_mu</span><span class="p">,</span> <span class="n">cell_mu</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># (num_cells, num_cells)</span>
</span><span id="LightningProxModel.mean_cell_neighbor_distance-1185"><a href="#LightningProxModel.mean_cell_neighbor_distance-1185"><span class="linenos">1185</span></a>        <span class="c1"># Exclude self-distance by setting diagonal to infinity</span>
</span><span id="LightningProxModel.mean_cell_neighbor_distance-1186"><a href="#LightningProxModel.mean_cell_neighbor_distance-1186"><span class="linenos">1186</span></a>        <span class="n">dist_matrix</span><span class="o">.</span><span class="n">fill_diagonal_</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">))</span>
</span><span id="LightningProxModel.mean_cell_neighbor_distance-1187"><a href="#LightningProxModel.mean_cell_neighbor_distance-1187"><span class="linenos">1187</span></a>        <span class="c1"># Find k nearest neighbors for each cell</span>
</span><span id="LightningProxModel.mean_cell_neighbor_distance-1188"><a href="#LightningProxModel.mean_cell_neighbor_distance-1188"><span class="linenos">1188</span></a>        <span class="n">knn_distances</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">dist_matrix</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">largest</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="LightningProxModel.mean_cell_neighbor_distance-1189"><a href="#LightningProxModel.mean_cell_neighbor_distance-1189"><span class="linenos">1189</span></a>        <span class="c1"># Mean distance to k nearest neighbors for each cell</span>
</span><span id="LightningProxModel.mean_cell_neighbor_distance-1190"><a href="#LightningProxModel.mean_cell_neighbor_distance-1190"><span class="linenos">1190</span></a>        <span class="n">mean_distances</span> <span class="o">=</span> <span class="n">knn_distances</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="LightningProxModel.mean_cell_neighbor_distance-1191"><a href="#LightningProxModel.mean_cell_neighbor_distance-1191"><span class="linenos">1191</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">mean_distances</span> <span class="o">/</span> <span class="n">mean_distances</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="LightningProxModel.mean_cell_neighbor_distance-1192"><a href="#LightningProxModel.mean_cell_neighbor_distance-1192"><span class="linenos">1192</span></a>        <span class="k">return</span> <span class="n">weights</span>  <span class="c1"># shape: (num_cells,)</span>
</span></pre></div>


            <div class="docstring"><p>Calculates the mean distance between each cell node and its k nearest neighbors.
Returns a tensor of mean distances for each cell.</p>
</div>


                            </div>
                            <div id="LightningProxModel.on_train_epoch_start" class="classattr">
                                        <input id="LightningProxModel.on_train_epoch_start-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_train_epoch_start</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LightningProxModel.on_train_epoch_start-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel.on_train_epoch_start"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel.on_train_epoch_start-1281"><a href="#LightningProxModel.on_train_epoch_start-1281"><span class="linenos">1281</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_epoch_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LightningProxModel.on_train_epoch_start-1282"><a href="#LightningProxModel.on_train_epoch_start-1282"><span class="linenos">1282</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">validation_step_outputs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="LightningProxModel.on_train_epoch_start-1283"><a href="#LightningProxModel.on_train_epoch_start-1283"><span class="linenos">1283</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">is_last_batch</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel.on_train_epoch_start-1284"><a href="#LightningProxModel.on_train_epoch_start-1284"><span class="linenos">1284</span></a>            <span class="n">hsic_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span><span class="o">.</span><span class="n">custom_train</span><span class="p">(</span>
</span><span id="LightningProxModel.on_train_epoch_start-1285"><a href="#LightningProxModel.on_train_epoch_start-1285"><span class="linenos">1285</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">__mu_dict__</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">],</span> <span class="n">optimizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hsic_optimizer</span>
</span><span id="LightningProxModel.on_train_epoch_start-1286"><a href="#LightningProxModel.on_train_epoch_start-1286"><span class="linenos">1286</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel.on_train_epoch_start-1287"><a href="#LightningProxModel.on_train_epoch_start-1287"><span class="linenos">1287</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;hsic_loss&quot;</span><span class="p">,</span> <span class="n">hsic_loss</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LightningProxModel.on_train_epoch_start-1288"><a href="#LightningProxModel.on_train_epoch_start-1288"><span class="linenos">1288</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel.on_train_epoch_start-1289"><a href="#LightningProxModel.on_train_epoch_start-1289"><span class="linenos">1289</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_metric</span><span class="p">(</span><span class="s2">&quot;hsic_lr&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic_optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;lr&quot;</span><span class="p">],</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LightningProxModel.on_train_epoch_start-1290"><a href="#LightningProxModel.on_train_epoch_start-1290"><span class="linenos">1290</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reweight_rarecell</span><span class="p">:</span>
</span><span id="LightningProxModel.on_train_epoch_start-1291"><a href="#LightningProxModel.on_train_epoch_start-1291"><span class="linenos">1291</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cell_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean_cell_neighbor_distance</span><span class="p">(</span>
</span><span id="LightningProxModel.on_train_epoch_start-1292"><a href="#LightningProxModel.on_train_epoch_start-1292"><span class="linenos">1292</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">reweight_rarecell_neighbors</span>
</span><span id="LightningProxModel.on_train_epoch_start-1293"><a href="#LightningProxModel.on_train_epoch_start-1293"><span class="linenos">1293</span></a>            <span class="p">)</span>
</span><span id="LightningProxModel.on_train_epoch_start-1294"><a href="#LightningProxModel.on_train_epoch_start-1294"><span class="linenos">1294</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">local_step</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="LightningProxModel.on_train_epoch_start-1295"><a href="#LightningProxModel.on_train_epoch_start-1295"><span class="linenos">1295</span></a>        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="LightningProxModel.on_train_epoch_start-1296"><a href="#LightningProxModel.on_train_epoch_start-1296"><span class="linenos">1296</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_ot_plan</span><span class="p">()</span>
</span><span id="LightningProxModel.on_train_epoch_start-1297"><a href="#LightningProxModel.on_train_epoch_start-1297"><span class="linenos">1297</span></a>        <span class="c1"># self._log_perf(&quot;ot_plan&quot;, time.time() - t0, on_step=False)</span>
</span></pre></div>


            <div class="docstring"><p>Called in the training loop at the very beginning of the epoch.</p>
</div>


                            </div>
                            <div id="LightningProxModel.on_train_batch_start" class="classattr">
                                        <input id="LightningProxModel.on_train_batch_start-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_train_batch_start</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">batch</span>, </span><span class="param"><span class="n">batch_idx</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LightningProxModel.on_train_batch_start-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel.on_train_batch_start"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel.on_train_batch_start-1299"><a href="#LightningProxModel.on_train_batch_start-1299"><span class="linenos">1299</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_batch_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
</span><span id="LightningProxModel.on_train_batch_start-1300"><a href="#LightningProxModel.on_train_batch_start-1300"><span class="linenos">1300</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">):</span>
</span><span id="LightningProxModel.on_train_batch_start-1301"><a href="#LightningProxModel.on_train_batch_start-1301"><span class="linenos">1301</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;data_loading_time&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Called in the training loop before anything happens for that batch.</p>

<p>If you return -1 here, you will skip training for the rest of the current epoch.
Learning rate scheduler will still be stepped at the end of epoch.</p>

<p>Args:
    batch: The batched data as it is returned by the training DataLoader.
    batch_idx: the index of the batch</p>
</div>


                            </div>
                            <div id="LightningProxModel.on_train_batch_end" class="classattr">
                                        <input id="LightningProxModel.on_train_batch_end-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_train_batch_end</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">output</span>, </span><span class="param"><span class="n">batch</span>, </span><span class="param"><span class="n">batch_idx</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LightningProxModel.on_train_batch_end-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel.on_train_batch_end"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel.on_train_batch_end-1303"><a href="#LightningProxModel.on_train_batch_end-1303"><span class="linenos">1303</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_train_batch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">batch_idx</span><span class="p">):</span>
</span><span id="LightningProxModel.on_train_batch_end-1304"><a href="#LightningProxModel.on_train_batch_end-1304"><span class="linenos">1304</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Called in the training loop after the batch.</p>

<p>Args:
    outputs: The outputs of training_step(x)
    batch: The batched data as it is returned by the training DataLoader.
    batch_idx: the index of the batch</p>

<p>Note:
    The value <code>outputs["loss"]</code> here will be the normalized value w.r.t <code>accumulate_grad_batches</code> of the
    loss returned from <code><a href="#LightningProxModel.training_step">training_step</a></code>.</p>
</div>


                            </div>
                            <div id="LightningProxModel.on_validation_epoch_start" class="classattr">
                                        <input id="LightningProxModel.on_validation_epoch_start-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_validation_epoch_start</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LightningProxModel.on_validation_epoch_start-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel.on_validation_epoch_start"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel.on_validation_epoch_start-1306"><a href="#LightningProxModel.on_validation_epoch_start-1306"><span class="linenos">1306</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_validation_epoch_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LightningProxModel.on_validation_epoch_start-1307"><a href="#LightningProxModel.on_validation_epoch_start-1307"><span class="linenos">1307</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">local_step_val</span> <span class="o">=</span> <span class="mi">0</span>
</span></pre></div>


            <div class="docstring"><p>Called in the validation loop at the very beginning of the epoch.</p>
</div>


                            </div>
                            <div id="LightningProxModel.configure_optimizers" class="classattr">
                                        <input id="LightningProxModel.configure_optimizers-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">configure_optimizers</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LightningProxModel.configure_optimizers-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel.configure_optimizers"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel.configure_optimizers-1345"><a href="#LightningProxModel.configure_optimizers-1345"><span class="linenos">1345</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">configure_optimizers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LightningProxModel.configure_optimizers-1346"><a href="#LightningProxModel.configure_optimizers-1346"><span class="linenos">1346</span></a>        <span class="c1"># Different learning rates for encoder vs aux_params</span>
</span><span id="LightningProxModel.configure_optimizers-1347"><a href="#LightningProxModel.configure_optimizers-1347"><span class="linenos">1347</span></a>        <span class="n">all_params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
</span><span id="LightningProxModel.configure_optimizers-1348"><a href="#LightningProxModel.configure_optimizers-1348"><span class="linenos">1348</span></a>        <span class="n">encoder_params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
</span><span id="LightningProxModel.configure_optimizers-1349"><a href="#LightningProxModel.configure_optimizers-1349"><span class="linenos">1349</span></a>        <span class="n">aux_params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aux_params</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
</span><span id="LightningProxModel.configure_optimizers-1350"><a href="#LightningProxModel.configure_optimizers-1350"><span class="linenos">1350</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">encoder_params</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">aux_params</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_params</span><span class="p">),</span> <span class="s2">&quot;Parameters other than encoder and aux_params exist in the model&quot;</span> <span class="c1"># sanity check</span>
</span><span id="LightningProxModel.configure_optimizers-1351"><a href="#LightningProxModel.configure_optimizers-1351"><span class="linenos">1351</span></a>
</span><span id="LightningProxModel.configure_optimizers-1352"><a href="#LightningProxModel.configure_optimizers-1352"><span class="linenos">1352</span></a>        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span>
</span><span id="LightningProxModel.configure_optimizers-1353"><a href="#LightningProxModel.configure_optimizers-1353"><span class="linenos">1353</span></a>            <span class="c1"># currently there are only encoder and aux parameters, no decoder parameters</span>
</span><span id="LightningProxModel.configure_optimizers-1354"><a href="#LightningProxModel.configure_optimizers-1354"><span class="linenos">1354</span></a>            <span class="p">[</span>
</span><span id="LightningProxModel.configure_optimizers-1355"><a href="#LightningProxModel.configure_optimizers-1355"><span class="linenos">1355</span></a>                <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">encoder_params</span><span class="p">,</span> <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">},</span>
</span><span id="LightningProxModel.configure_optimizers-1356"><a href="#LightningProxModel.configure_optimizers-1356"><span class="linenos">1356</span></a>                <span class="p">{</span>
</span><span id="LightningProxModel.configure_optimizers-1357"><a href="#LightningProxModel.configure_optimizers-1357"><span class="linenos">1357</span></a>                    <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">aux_params</span><span class="p">,</span>
</span><span id="LightningProxModel.configure_optimizers-1358"><a href="#LightningProxModel.configure_optimizers-1358"><span class="linenos">1358</span></a>                    <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">,</span>
</span><span id="LightningProxModel.configure_optimizers-1359"><a href="#LightningProxModel.configure_optimizers-1359"><span class="linenos">1359</span></a>                <span class="p">},</span>  <span class="c1"># 10x smaller LR for aux params</span>
</span><span id="LightningProxModel.configure_optimizers-1360"><a href="#LightningProxModel.configure_optimizers-1360"><span class="linenos">1360</span></a>            <span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_aux</span> <span class="k">else</span>
</span><span id="LightningProxModel.configure_optimizers-1361"><a href="#LightningProxModel.configure_optimizers-1361"><span class="linenos">1361</span></a>            <span class="p">[{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">encoder_params</span><span class="p">,</span> <span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">}]</span>
</span><span id="LightningProxModel.configure_optimizers-1362"><a href="#LightningProxModel.configure_optimizers-1362"><span class="linenos">1362</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel.configure_optimizers-1363"><a href="#LightningProxModel.configure_optimizers-1363"><span class="linenos">1363</span></a>
</span><span id="LightningProxModel.configure_optimizers-1364"><a href="#LightningProxModel.configure_optimizers-1364"><span class="linenos">1364</span></a>        <span class="n">scheduler</span> <span class="o">=</span> <span class="n">ReduceLROnPlateau</span><span class="p">(</span>
</span><span id="LightningProxModel.configure_optimizers-1365"><a href="#LightningProxModel.configure_optimizers-1365"><span class="linenos">1365</span></a>            <span class="n">optimizer</span><span class="p">,</span>
</span><span id="LightningProxModel.configure_optimizers-1366"><a href="#LightningProxModel.configure_optimizers-1366"><span class="linenos">1366</span></a>            <span class="n">patience</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
</span><span id="LightningProxModel.configure_optimizers-1367"><a href="#LightningProxModel.configure_optimizers-1367"><span class="linenos">1367</span></a>        <span class="p">)</span>
</span><span id="LightningProxModel.configure_optimizers-1368"><a href="#LightningProxModel.configure_optimizers-1368"><span class="linenos">1368</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">optimizer</span><span class="p">],</span> <span class="p">[</span>
</span><span id="LightningProxModel.configure_optimizers-1369"><a href="#LightningProxModel.configure_optimizers-1369"><span class="linenos">1369</span></a>            <span class="p">{</span>
</span><span id="LightningProxModel.configure_optimizers-1370"><a href="#LightningProxModel.configure_optimizers-1370"><span class="linenos">1370</span></a>                <span class="s2">&quot;scheduler&quot;</span><span class="p">:</span> <span class="n">scheduler</span><span class="p">,</span>
</span><span id="LightningProxModel.configure_optimizers-1371"><a href="#LightningProxModel.configure_optimizers-1371"><span class="linenos">1371</span></a>                <span class="s2">&quot;interval&quot;</span><span class="p">:</span> <span class="s2">&quot;epoch&quot;</span><span class="p">,</span>
</span><span id="LightningProxModel.configure_optimizers-1372"><a href="#LightningProxModel.configure_optimizers-1372"><span class="linenos">1372</span></a>                <span class="s2">&quot;frequency&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="LightningProxModel.configure_optimizers-1373"><a href="#LightningProxModel.configure_optimizers-1373"><span class="linenos">1373</span></a>                <span class="s2">&quot;monitor&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor_key</span><span class="p">,</span>
</span><span id="LightningProxModel.configure_optimizers-1374"><a href="#LightningProxModel.configure_optimizers-1374"><span class="linenos">1374</span></a>                <span class="s2">&quot;strict&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="LightningProxModel.configure_optimizers-1375"><a href="#LightningProxModel.configure_optimizers-1375"><span class="linenos">1375</span></a>            <span class="p">}</span>
</span><span id="LightningProxModel.configure_optimizers-1376"><a href="#LightningProxModel.configure_optimizers-1376"><span class="linenos">1376</span></a>        <span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Choose what optimizers and learning-rate schedulers to use in your optimization. Normally you'd need one.
But in the case of GANs or similar you might have multiple. Optimization with multiple optimizers only works in
the manual optimization mode.</p>

<p>Return:
    Any of these 6 options.</p>

<pre><code>- **Single optimizer**.
- **List or Tuple** of optimizers.
- **Two lists** - The first list has multiple optimizers, and the second has multiple LR schedulers
  (or multiple ``lr_scheduler_config``).
- **Dictionary**, with an ``"optimizer"`` key, and (optionally) a ``"lr_scheduler"``
  key whose value is a single LR scheduler or ``lr_scheduler_config``.
- **None** - Fit will run without any optimizer.
</code></pre>

<p>The <code>lr_scheduler_config</code> is a dictionary which contains the scheduler and its associated configuration.
The default configuration is shown below.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">lr_scheduler_config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># REQUIRED: The scheduler instance</span>
    <span class="s2">&quot;scheduler&quot;</span><span class="p">:</span> <span class="n">lr_scheduler</span><span class="p">,</span>
    <span class="c1"># The unit of the scheduler&#39;s step size, could also be &#39;step&#39;.</span>
    <span class="c1"># &#39;epoch&#39; updates the scheduler on epoch end whereas &#39;step&#39;</span>
    <span class="c1"># updates it after a optimizer update.</span>
    <span class="s2">&quot;interval&quot;</span><span class="p">:</span> <span class="s2">&quot;epoch&quot;</span><span class="p">,</span>
    <span class="c1"># How many epochs/steps should pass between calls to</span>
    <span class="c1"># `scheduler.step()`. 1 corresponds to updating the learning</span>
    <span class="c1"># rate after every epoch/step.</span>
    <span class="s2">&quot;frequency&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="c1"># Metric to monitor for schedulers like `ReduceLROnPlateau`</span>
    <span class="s2">&quot;monitor&quot;</span><span class="p">:</span> <span class="s2">&quot;val_loss&quot;</span><span class="p">,</span>
    <span class="c1"># If set to `True`, will enforce that the value specified &#39;monitor&#39;</span>
    <span class="c1"># is available when the scheduler is updated, thus stopping</span>
    <span class="c1"># training if not found. If set to `False`, it will only produce a warning</span>
    <span class="s2">&quot;strict&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="c1"># If using the `LearningRateMonitor` callback to monitor the</span>
    <span class="c1"># learning rate progress, this keyword can be used to specify</span>
    <span class="c1"># a custom logged name</span>
    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">}</span>
</code></pre>
</div>

<p>When there are schedulers in which the <code>.step()</code> method is conditioned on a value, such as the
<code>torch.optim.lr_scheduler.ReduceLROnPlateau</code> scheduler, Lightning requires that the
<code>lr_scheduler_config</code> contains the keyword <code>"monitor"</code> set to the metric name that the scheduler
should be conditioned on.</p>

<p>.. testcode::</p>

<pre><code># The ReduceLROnPlateau scheduler requires a monitor
def configure_optimizers(self):
    optimizer = Adam(...)
    return {
        "optimizer": optimizer,
        "lr_scheduler": {
            "scheduler": ReduceLROnPlateau(optimizer, ...),
            "monitor": "metric_to_track",
            "frequency": "indicates how often the metric is updated",
            # If "monitor" references validation metrics, then "frequency" should be set to a
            # multiple of "trainer.check_val_every_n_epoch".
        },
    }


# In the case of two optimizers, only one using the ReduceLROnPlateau scheduler
def configure_optimizers(self):
    optimizer1 = Adam(...)
    optimizer2 = SGD(...)
    scheduler1 = ReduceLROnPlateau(optimizer1, ...)
    scheduler2 = LambdaLR(optimizer2, ...)
    return (
        {
            "optimizer": optimizer1,
            "lr_scheduler": {
                "scheduler": scheduler1,
                "monitor": "metric_to_track",
            },
        },
        {"optimizer": optimizer2, "lr_scheduler": scheduler2},
    )
</code></pre>

<p>Metrics can be made available to monitor by simply logging it using
<code>self.log('metric_to_track', metric_val)</code> in your <code>~lightning.pytorch.core.LightningModule</code>.</p>

<p>Note:
    Some things to know:</p>

<pre><code>- Lightning calls ``.backward()`` and ``.step()`` automatically in case of automatic optimization.
- If a learning rate scheduler is specified in ``configure_optimizers()`` with key
  ``"interval"`` (default "epoch") in the scheduler configuration, Lightning will call
  the scheduler's ``.step()`` method automatically in case of automatic optimization.
- If you use 16-bit precision (``precision=16``), Lightning will automatically handle the optimizer.
- If you use `torch.optim.LBFGS`, Lightning handles the closure function automatically for you.
- If you use multiple optimizers, you will have to switch to 'manual optimization' mode and step them
  yourself.
- If you need to control how often the optimizer steps, override the `optimizer_step()` hook.
</code></pre>
</div>


                            </div>
                            <div id="LightningProxModel.lr_scheduler_step" class="classattr">
                                        <input id="LightningProxModel.lr_scheduler_step-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">lr_scheduler_step</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">scheduler</span>, </span><span class="param"><span class="n">metric</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LightningProxModel.lr_scheduler_step-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel.lr_scheduler_step"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel.lr_scheduler_step-1378"><a href="#LightningProxModel.lr_scheduler_step-1378"><span class="linenos">1378</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">lr_scheduler_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">,</span> <span class="n">metric</span><span class="p">):</span>
</span><span id="LightningProxModel.lr_scheduler_step-1379"><a href="#LightningProxModel.lr_scheduler_step-1379"><span class="linenos">1379</span></a>        <span class="k">if</span> <span class="n">metric</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel.lr_scheduler_step-1380"><a href="#LightningProxModel.lr_scheduler_step-1380"><span class="linenos">1380</span></a>            <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="LightningProxModel.lr_scheduler_step-1381"><a href="#LightningProxModel.lr_scheduler_step-1381"><span class="linenos">1381</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LightningProxModel.lr_scheduler_step-1382"><a href="#LightningProxModel.lr_scheduler_step-1382"><span class="linenos">1382</span></a>            <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
</span><span id="LightningProxModel.lr_scheduler_step-1383"><a href="#LightningProxModel.lr_scheduler_step-1383"><span class="linenos">1383</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LightningProxModel.lr_scheduler_step-1384"><a href="#LightningProxModel.lr_scheduler_step-1384"><span class="linenos">1384</span></a>            <span class="n">update_lr</span><span class="p">(</span>
</span><span id="LightningProxModel.lr_scheduler_step-1385"><a href="#LightningProxModel.lr_scheduler_step-1385"><span class="linenos">1385</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">hsic_optimizer</span><span class="p">,</span>
</span><span id="LightningProxModel.lr_scheduler_step-1386"><a href="#LightningProxModel.lr_scheduler_step-1386"><span class="linenos">1386</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">hsic</span><span class="o">.</span><span class="n">lam</span>
</span><span id="LightningProxModel.lr_scheduler_step-1387"><a href="#LightningProxModel.lr_scheduler_step-1387"><span class="linenos">1387</span></a>                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">lr_scheduler_configs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span>
</span><span id="LightningProxModel.lr_scheduler_step-1388"><a href="#LightningProxModel.lr_scheduler_step-1388"><span class="linenos">1388</span></a>                    <span class="mi">0</span>
</span><span id="LightningProxModel.lr_scheduler_step-1389"><a href="#LightningProxModel.lr_scheduler_step-1389"><span class="linenos">1389</span></a>                <span class="p">][</span><span class="s2">&quot;lr&quot;</span><span class="p">],</span>
</span><span id="LightningProxModel.lr_scheduler_step-1390"><a href="#LightningProxModel.lr_scheduler_step-1390"><span class="linenos">1390</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Override this method to adjust the default way the <code>~lightning.pytorch.trainer.trainer.Trainer</code> calls
each scheduler. By default, Lightning calls <code>step()</code> and as shown in the example for each scheduler based on
its <code>interval</code>.</p>

<p>Args:
    scheduler: Learning rate scheduler.
    metric: Value of the monitor used for schedulers like <code>ReduceLROnPlateau</code>.</p>

<p>Examples::</p>

<pre><code># DEFAULT
def lr_scheduler_step(self, scheduler, metric):
    if metric is None:
        scheduler.step()
    else:
        scheduler.step(metric)

# Alternative way to update schedulers if it requires an epoch value
def lr_scheduler_step(self, scheduler, metric):
    scheduler.step(epoch=self.current_epoch)
</code></pre>
</div>


                            </div>
                            <div id="LightningProxModel.on_save_checkpoint" class="classattr">
                                        <input id="LightningProxModel.on_save_checkpoint-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">on_save_checkpoint</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">checkpoint</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LightningProxModel.on_save_checkpoint-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LightningProxModel.on_save_checkpoint"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LightningProxModel.on_save_checkpoint-1399"><a href="#LightningProxModel.on_save_checkpoint-1399"><span class="linenos">1399</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_save_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checkpoint</span><span class="p">):</span>
</span><span id="LightningProxModel.on_save_checkpoint-1400"><a href="#LightningProxModel.on_save_checkpoint-1400"><span class="linenos">1400</span></a>        <span class="c1"># Remove the argument from the checkpoint before it is saved</span>
</span><span id="LightningProxModel.on_save_checkpoint-1401"><a href="#LightningProxModel.on_save_checkpoint-1401"><span class="linenos">1401</span></a>        <span class="n">checkpoint</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;train_data_dict&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Called by Lightning when saving a checkpoint to give you a chance to store anything else you might want to
save.</p>

<p>Args:
    checkpoint: The full checkpoint dictionary before it gets dumped to a file.
        Implementations of this hook can insert additional data into this dictionary.</p>

<p>Example::</p>

<pre><code>def on_save_checkpoint(self, checkpoint):
    # 99% of use cases you don't need to implement this method
    checkpoint['something_cool_i_want_to_save'] = my_cool_pickable_object
</code></pre>

<p>Note:
    Lightning saves all aspects of training (epoch, global step, etc...)
    including amp scaling.
    There is no need for you to store anything about training.</p>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>