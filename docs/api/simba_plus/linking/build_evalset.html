<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 16.0.0"/>
    <title>simba_plus.linking.build_evalset API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:27px;vertical-align:bottom;width:50px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../linking.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;simba_plus.linking</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="function" href="#build_eqtl_evalset">build_eqtl_evalset</a>
            </li>
            <li>
                    <a class="function" href="#liftover_df">liftover_df</a>
            </li>
            <li>
                    <a class="function" href="#load_gtex_finemap">load_gtex_finemap</a>
            </li>
            <li>
                    <a class="function" href="#overlap_variants_with_peaks">overlap_variants_with_peaks</a>
            </li>
            <li>
                    <a class="function" href="#merge_and_label_eqtl_pairs">merge_and_label_eqtl_pairs</a>
            </li>
            <li>
                    <a class="function" href="#build_crispr_evalset">build_crispr_evalset</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22160%22%20viewBox%3D%220%200%20150%2080%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M132.316%2048.886c.276-4.679%202.342-6.698%204.409-7.982s4.27-1.165%206.751-1.055c1.586.07%203.044.156%204.222-.482%201.142-.619%202.026-1.932%202.162-3.739.268-3.576-1.929-5.368-5.006-5.551s-7.599.524-10.517%201.606c-4.455%201.652-8.588%206.606-9.552%208.992s-2.342%206.193-1.745%2010.873%202.664%209.221%205.878%2011.79%205.878%203.808%2010.103%204.312%203.444.229%206.062.229%205.006-2.202%204.914-4.909-2.296-5.001-4.501-4.863-3.077.505-5.281.229-7.715-2.064-7.899-9.451z%22%20fill%3D%22%23198754%22/%3E%3Ccircle%20cx%3D%22101.504%22%20cy%3D%2248.943%22%20r%3D%2214.208%22%20fill%3D%22none%22%20stroke%3D%22%23198754%22%20stroke-width%3D%229.354%22/%3E%3Cpath%20d%3D%22M87.81.002c-3.637.065-5.001.454-7.014%201.232s-3.443%201.363-6.3%204.282c-1.723%201.76-3.148%205.019-3.776%207.329-.413%201.521-.316%202.63-.316%202.63l-.195%2034.612c.065%205.774-6.755%208.305-9.612%208.37s-9.678-1.038-9.743-9.408%207.128-9.521%208.362-9.521c1.413-.13%202.526-.021%203.718-.016%202.071.009%204.157-.778%204.092-4.671s-4.157-4.736-4.157-4.736c-6.3-.843-11.43%202.206-11.43%202.206S40.917%2038.15%2041.372%2049.634%2051.568%2068.19%2061.311%2068.125s18.316-7.007%2018.445-17.193l.13-22.772c.046-2.291%202.683-3.644%204.476-4.203.745-.232%201.694-.274%201.694-.274l10.457-.13s4.871-.324%207.729-3.114%204.352-6.294%204.352-6.294.974-3.049.13-4.606-.195-1.233-2.792-3.309-8.573-4.477-8.573-4.477S91.447-.063%2087.81.002zM0%2047.169l.065%2028.417S0%2080.127%204.481%2079.997s5.072-3.866%205.049-4.152l-.113-28.482s1.624-7.656%209.937-7.721%2010.002%206.942%2010.002%208.499-.909%2010.51-9.093%2010.51c-.948%200-2.99-.567-4.145-.272-3.919%201-3.194%204.554-3.194%204.554s.065%205.061%207.404%204.996%2018.575-6.034%2018.575-19.074S26.953%2030.04%2019.549%2029.91%201.234%2035.296%200%2047.169z%22%20fill%3D%22%23198754%22/%3E%3Cg%20transform%3D%22matrix%28.325601%200%200%20.325256%20-10.32669%20-45.802786%29%22%3E%3Ccircle%20cx%3D%22297.554%22%20cy%3D%22172.286%22%20r%3D%2216.5%22%20fill%3D%22%23fff%22/%3E%3Cellipse%20cx%3D%22297.709%22%20cy%3D%22172.642%22%20rx%3D%2211.071%22%20ry%3D%2210.871%22%20fill%3D%22%23105a48%22/%3E%3Ccircle%20cx%3D%22304.104%22%20cy%3D%22167.667%22%20r%3D%224.5%22%20fill%3D%22%23fff%22/%3E%3C/g%3E%3Cpath%20d%3D%22M94.661%2017.032l.893-1.476s.99.714%201.916.925%201.575.114%202.955.114l14.565-.162c1.283-.032%203.085-.762%203.02-3.293s-.373-3.503-.373-3.503l1.283-.487s.52.503.877%201.573.309%201.995.292%202.66-.227%201.541-.227%201.541%201.564-.308%202.359-1.038.823-.779%201.489-1.508.812-.86.812-.86.552-.13.877.26.341.957.065%201.46-1.672%202.206-3.247%203.066-2.76%201.427-3.929%201.768-3.848.73-7.063.714l-10.944-.114s-2.143-.081-3.02-.373-2.241-.973-2.598-1.265z%22%20fill%3D%22%23d36d49%22/%3E%3Cg%20fill%3D%22%23105a48%22%3E%3Cellipse%20cx%3D%2293.052%22%20cy%3D%2243.567%22%20rx%3D%22.869%22%20ry%3D%221.014%22%20transform%3D%22rotate%28341.022%29%22/%3E%3Cellipse%20cx%3D%22104.3%22%20cy%3D%22-16.184%22%20rx%3D%22.865%22%20ry%3D%221.009%22%20transform%3D%22rotate%2814.786%29%22/%3E%3C/g%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../../simba_plus.html">simba_plus</a><wbr>.<a href="./../linking.html">linking</a><wbr>.build_evalset    </h1>

                        <div class="docstring"><p>Evaluation set builders for GTEx eQTL and CRISPR benchmarks.</p>

<p>This module constructs labeled evaluation sets for model benchmarking from
precomputed candidate peak–gene links.</p>

<p>Currently supports:
    * GTEx eQTL evaluation set (Whole Blood, fine-mapped)
    * CRISPR enhancer–gene benchmark evaluation set</p>

<p>Example:</p>

<blockquote>
  <blockquote>
    <blockquote>
      <p>from simba_variant import evalset_builders as eb
      eb.build_eqtl_evalset(
          ...     candidate_csv="pbmc_peak_gene_candidates.csv",
          ...     gtex_file="gtex_susie.tsv.gz",
          ...     genesymbol_file="gtex_genesymbol.csv",
          ...     genomes_bed_files=["1000G.EUR.hg38.1.filtered.bed", ...],
          ...     output_csv="eqtl_pbmc.csv"
          ... )</p>
    </blockquote>
  </blockquote>
</blockquote>
</div>

                        <input id="mod-build_evalset-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-build_evalset-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="sd">&quot;&quot;&quot;Evaluation set builders for GTEx eQTL and CRISPR benchmarks.</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="sd">This module constructs labeled evaluation sets for model benchmarking from</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="sd">precomputed candidate peak–gene links.</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="sd">Currently supports:</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="sd">    * GTEx eQTL evaluation set (Whole Blood, fine-mapped)</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="sd">    * CRISPR enhancer–gene benchmark evaluation set</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="sd">Example:</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="sd">    &gt;&gt;&gt; from simba_variant import evalset_builders as eb</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="sd">    &gt;&gt;&gt; eb.build_eqtl_evalset(</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="sd">    ...     candidate_csv=&quot;pbmc_peak_gene_candidates.csv&quot;,</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="sd">    ...     gtex_file=&quot;gtex_susie.tsv.gz&quot;,</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="sd">    ...     genesymbol_file=&quot;gtex_genesymbol.csv&quot;,</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="sd">    ...     genomes_bed_files=[&quot;1000G.EUR.hg38.1.filtered.bed&quot;, ...],</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="sd">    ...     output_csv=&quot;eqtl_pbmc.csv&quot;</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="sd">    ... )</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">pyranges</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pr</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">urllib.request</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Optional</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">tarfile</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">zipfile</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">gzip</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">platform</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a><span class="k">def</span><span class="w"> </span><span class="nf">build_eqtl_evalset</span><span class="p">(</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a>    <span class="n">candidate_csv</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a>    <span class="n">output_csv</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a>    <span class="n">download_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;../data&quot;</span><span class="p">,</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a>    <span class="n">pip_pos</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a>    <span class="n">pip_neg</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a>    <span class="n">gtex_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;SUSIE&quot;</span><span class="p">,</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a>    <span class="n">gtex_tissue</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Whole_Blood&quot;</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build a GTEx eQTL evaluation set (replicates the notebook logic).</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="sd">    This function downloads and prepares 1000G and GTEx data, overlaps peaks and variants,</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="sd">    computes inverse distance, and labels SNP–gene pairs based on PIP thresholds.</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">download_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a>    <span class="c1"># 1️⃣ Download and extract 1000 Genomes PLINK files if not present</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a>    <span class="n">plink_dir</span><span class="p">,</span> <span class="n">frq_dir</span> <span class="o">=</span> <span class="n">_download_and_extract_1000g</span><span class="p">(</span><span class="n">download_dir</span><span class="p">)</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>    <span class="c1"># 2️⃣ Download GTEx fine-mapping results if not present</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>    <span class="n">gtex_zip</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">download_dir</span><span class="p">,</span> <span class="s2">&quot;Public_GTEx_finemapping.zip&quot;</span><span class="p">)</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>    <span class="n">gtex_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">download_dir</span><span class="p">,</span> <span class="s2">&quot;GTEx_49tissues_release1.tsv.bgz&quot;</span><span class="p">)</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">gtex_zip</span><span class="p">):</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>        <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://www.dropbox.com/scl/fo/bjp6o8hgixt5occ6ggq2o/ADTTMnyH-4rzDFS6g7oIcEE?rlkey=7558jp42yvmyjhgmcilbhlnu7&amp;e=4&amp;dl=1&quot;</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading GTEx fine-mapping dataset...&quot;</span><span class="p">)</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;wget&quot;</span><span class="p">,</span> <span class="s2">&quot;-O&quot;</span><span class="p">,</span> <span class="n">gtex_zip</span><span class="p">,</span> <span class="n">url</span><span class="p">],</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>        <span class="k">if</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">is_zipfile</span><span class="p">(</span><span class="n">gtex_zip</span><span class="p">):</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracting </span><span class="si">{</span><span class="n">gtex_zip</span><span class="si">}</span><span class="s2"> ...&quot;</span><span class="p">)</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>            <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">gtex_zip</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zip_ref</span><span class="p">:</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>                <span class="n">zip_ref</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">download_dir</span><span class="p">)</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracted GTEx data to: </span><span class="si">{</span><span class="n">download_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">gtex_zip</span><span class="si">}</span><span class="s2"> is not a valid zip archive. Please check the downloaded file.&quot;</span><span class="p">)</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>    <span class="c1"># 3️⃣ Load input candidate peak–gene links</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>    <span class="n">candidates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">candidate_csv</span><span class="p">)</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>    <span class="k">if</span> <span class="s2">&quot;gene_name&quot;</span> <span class="ow">in</span> <span class="n">candidates</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>        <span class="n">candidates</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;gene_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Gene_name&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>    <span class="n">candidates</span><span class="p">[</span><span class="s2">&quot;peak_gene_pair&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">candidates</span><span class="p">[</span><span class="s2">&quot;Peak&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">candidates</span><span class="p">[</span><span class="s2">&quot;Gene_name&quot;</span><span class="p">]</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>    <span class="c1"># 4️⃣ Load and concatenate 1000G variant BEDs</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading 1000G variant BED files...&quot;</span><span class="p">)</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>    <span class="n">bed_files</span> <span class="o">=</span> <span class="n">_process_1000g_bim_frq</span><span class="p">(</span><span class="n">plink_dir</span><span class="o">=</span><span class="n">plink_dir</span><span class="p">,</span> <span class="n">frq_dir</span><span class="o">=</span><span class="n">frq_dir</span><span class="p">,</span> <span class="n">maf_threshold</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>    <span class="n">genomes_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>        <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;CHROM&quot;</span><span class="p">,</span> <span class="s2">&quot;START&quot;</span><span class="p">,</span> <span class="s2">&quot;END&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">bed_files</span><span class="p">],</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>        <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>    <span class="p">)</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>    <span class="n">genomes_df</span><span class="p">[</span><span class="s2">&quot;CHROM&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;chr&quot;</span> <span class="o">+</span> <span class="n">genomes_df</span><span class="p">[</span><span class="s2">&quot;CHROM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>    <span class="n">valid_chroms</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;chr</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">23</span><span class="p">)]</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>    <span class="n">genomes_df</span> <span class="o">=</span> <span class="n">genomes_df</span><span class="p">[</span><span class="n">genomes_df</span><span class="p">[</span><span class="s1">&#39;CHROM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">valid_chroms</span><span class="p">)]</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>    <span class="n">variants_bed</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">PyRanges</span><span class="p">(</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>        <span class="n">genomes_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;CHROM&quot;</span><span class="p">:</span> <span class="s2">&quot;Chromosome&quot;</span><span class="p">,</span> <span class="s2">&quot;START&quot;</span><span class="p">:</span> <span class="s2">&quot;Start&quot;</span><span class="p">,</span> <span class="s2">&quot;END&quot;</span><span class="p">:</span> <span class="s2">&quot;End&quot;</span><span class="p">})</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>    <span class="p">)</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>    <span class="c1"># 5️⃣ Load and filter GTEx eQTLs</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading GTEx fine-mapping results...&quot;</span><span class="p">)</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>    <span class="n">gtex_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">gtex_file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>    <span class="n">gtex_df</span> <span class="o">=</span> <span class="n">gtex_df</span><span class="p">[(</span><span class="n">gtex_df</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">gtex_method</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gtex_df</span><span class="o">.</span><span class="n">tissue</span> <span class="o">==</span> <span class="n">gtex_tissue</span><span class="p">)]</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>    <span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>    <span class="n">gtex_df</span> <span class="o">=</span> <span class="n">_map_ensembl_to_symbol</span><span class="p">(</span><span class="n">gtex_df</span><span class="p">)</span> <span class="c1"># convert Ensembl IDs to gene symbols</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>    <span class="n">gtex_df</span> <span class="o">=</span> <span class="n">gtex_df</span><span class="p">[(</span><span class="o">~</span><span class="n">gtex_df</span><span class="p">[</span><span class="s1">&#39;GeneSymbol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">())]</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>    <span class="n">gtex_df</span> <span class="o">=</span> <span class="n">gtex_df</span><span class="p">[</span><span class="o">~</span><span class="n">gtex_df</span><span class="p">[</span><span class="s1">&#39;GeneSymbol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;ENSG&#39;</span><span class="p">)]</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>    <span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>    <span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>    <span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;chr_pos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;variant_hg38&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(chr[0-9XYM]+_\d+)&#39;</span><span class="p">)</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>    <span class="n">gtex_df</span><span class="p">[</span><span class="s1">&#39;pair&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gtex_df</span><span class="p">[</span><span class="s1">&#39;chr_pos&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">gtex_df</span><span class="p">[</span><span class="s1">&#39;GeneSymbol&#39;</span><span class="p">]</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>    <span class="n">pos_training</span> <span class="o">=</span> <span class="n">gtex_df</span><span class="p">[</span><span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;pip&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">pip_pos</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="s2">&quot;pair&quot;</span><span class="p">)</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>    <span class="n">neg_training</span> <span class="o">=</span> <span class="n">gtex_df</span><span class="p">[</span><span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;pip&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">pip_neg</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="s2">&quot;pair&quot;</span><span class="p">)</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>    <span class="c1"># 6️⃣ Overlap candidate peaks with variants</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Overlapping candidate peaks with variants...&quot;</span><span class="p">)</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>    <span class="n">split_lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">[</span><span class="s2">&quot;Peak&quot;</span><span class="p">]]</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>    <span class="n">ann_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">split_lst</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;CHROM&quot;</span><span class="p">,</span> <span class="s2">&quot;START&quot;</span><span class="p">,</span> <span class="s2">&quot;END&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s2">&quot;START&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s2">&quot;END&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">})</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>    <span class="n">ann_df</span><span class="p">[</span><span class="s2">&quot;Peak&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">candidates</span><span class="p">[</span><span class="s2">&quot;Peak&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>    <span class="n">ann_pr</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">PyRanges</span><span class="p">(</span><span class="n">ann_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;CHROM&quot;</span><span class="p">:</span> <span class="s2">&quot;Chromosome&quot;</span><span class="p">,</span> <span class="s2">&quot;START&quot;</span><span class="p">:</span> <span class="s2">&quot;Start&quot;</span><span class="p">,</span> <span class="s2">&quot;END&quot;</span><span class="p">:</span> <span class="s2">&quot;End&quot;</span><span class="p">}))</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>    <span class="n">overlap_pr</span> <span class="o">=</span> <span class="n">variants_bed</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ann_pr</span><span class="p">)</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>    <span class="n">overlap_df</span> <span class="o">=</span> <span class="n">overlap_pr</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>        <span class="s2">&quot;Chromosome&quot;</span><span class="p">:</span> <span class="s2">&quot;CHROM&quot;</span><span class="p">,</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>        <span class="s2">&quot;Start&quot;</span><span class="p">:</span> <span class="s2">&quot;POS&quot;</span><span class="p">,</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>        <span class="s2">&quot;End&quot;</span><span class="p">:</span> <span class="s2">&quot;POS2&quot;</span><span class="p">,</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>        <span class="s2">&quot;Start_b&quot;</span><span class="p">:</span> <span class="s2">&quot;START_ANN&quot;</span><span class="p">,</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>        <span class="s2">&quot;End_b&quot;</span><span class="p">:</span> <span class="s2">&quot;END_ANN&quot;</span><span class="p">,</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>    <span class="p">})</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>    <span class="n">overlap_df</span><span class="p">[</span><span class="s2">&quot;Peak&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>        <span class="n">overlap_df</span><span class="p">[</span><span class="s2">&quot;CHROM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">overlap_df</span><span class="p">[</span><span class="s2">&quot;START_ANN&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">overlap_df</span><span class="p">[</span><span class="s2">&quot;END_ANN&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>    <span class="p">)</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>    <span class="c1"># 7️⃣ Merge with candidate peaks and compute inverse distance</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>    <span class="n">merged</span> <span class="o">=</span> <span class="n">candidates</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">overlap_df</span><span class="p">[[</span><span class="s2">&quot;CHROM&quot;</span><span class="p">,</span> <span class="s2">&quot;POS&quot;</span><span class="p">,</span> <span class="s2">&quot;POS2&quot;</span><span class="p">,</span> <span class="s2">&quot;Peak&quot;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Peak&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>    <span class="n">merged</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Gene_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Gene&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>    <span class="k">if</span> <span class="s2">&quot;Distance_to_TSS&quot;</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>        <span class="n">merged</span><span class="p">[</span><span class="s2">&quot;1/Distance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">merged</span><span class="p">[</span><span class="s2">&quot;Distance_to_TSS&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">upper</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>    <span class="n">merged</span><span class="p">[</span><span class="s2">&quot;snp_gene_pair&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="s2">&quot;CHROM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">merged</span><span class="p">[</span><span class="s2">&quot;POS2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">merged</span><span class="p">[</span><span class="s2">&quot;Gene&quot;</span><span class="p">]</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>    <span class="c1"># 8️⃣ Label positives and negatives</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>    <span class="n">pos_df</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">merged</span><span class="o">.</span><span class="n">snp_gene_pair</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">pos_training</span><span class="o">.</span><span class="n">pair</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>    <span class="n">pos_df</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>    <span class="n">neg_df</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">merged</span><span class="o">.</span><span class="n">snp_gene_pair</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">neg_training</span><span class="o">.</span><span class="n">pair</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>    <span class="n">neg_df</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>    <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pos_df</span><span class="p">,</span> <span class="n">neg_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="s2">&quot;snp_gene_pair&quot;</span><span class="p">)</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>    <span class="n">final_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">final_df</span><span class="o">.</span><span class="n">CHROM</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>    <span class="n">final_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_csv</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved labeled evaluation set to: </span><span class="si">{</span><span class="n">output_csv</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>    <span class="k">return</span> <span class="n">final_df</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a><span class="k">def</span><span class="w"> </span><span class="nf">_download_and_extract_1000g</span><span class="p">(</span><span class="n">download_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;../data&quot;</span><span class="p">):</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Download and extract 1000 Genomes PLINK and FRQ archives if missing.&quot;&quot;&quot;</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>    <span class="n">download_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">download_dir</span><span class="p">)</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">download_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>    <span class="n">files</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>        <span class="s2">&quot;1000G_EUR_Phase3_plink.tgz&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://zenodo.org/records/8292725/files/1000G_Phase3_plinkfiles.tgz?download=1&quot;</span><span class="p">,</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>            <span class="s2">&quot;extract_dir&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">download_dir</span><span class="p">,</span> <span class="s2">&quot;1000G_EUR_Phase3_plink&quot;</span><span class="p">),</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>        <span class="p">},</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>        <span class="s2">&quot;1000G_Phase3_frq.tgz&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://zenodo.org/records/8292725/files/1000G_Phase3_frq.tgz?download=1&quot;</span><span class="p">,</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>            <span class="s2">&quot;extract_dir&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">download_dir</span><span class="p">,</span> <span class="s2">&quot;1000G_Phase3_frq&quot;</span><span class="p">),</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>        <span class="p">},</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>    <span class="p">}</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>    <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">meta</span> <span class="ow">in</span> <span class="n">files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>        <span class="n">archive_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">download_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>        <span class="n">extract_dir</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;extract_dir&quot;</span><span class="p">]</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>        <span class="n">url</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>        <span class="c1"># check if extracted folder exists</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">extract_dir</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">extract_dir</span><span class="p">):</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found extracted folder: </span><span class="si">{</span><span class="n">extract_dir</span><span class="si">}</span><span class="s2"> — skipping.&quot;</span><span class="p">)</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>            <span class="k">continue</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>        <span class="c1"># otherwise check if .tgz exists, else download</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">archive_path</span><span class="p">):</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> ...&quot;</span><span class="p">)</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>            <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;wget&quot;</span><span class="p">,</span> <span class="s2">&quot;-O&quot;</span><span class="p">,</span> <span class="n">archive_path</span><span class="p">,</span> <span class="n">url</span><span class="p">],</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found archive: </span><span class="si">{</span><span class="n">archive_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>        <span class="c1"># extract if folder missing or empty</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracting </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">download_dir</span><span class="si">}</span><span class="s2"> ...&quot;</span><span class="p">)</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>        <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">archive_path</span><span class="p">,</span> <span class="s2">&quot;r:gz&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tar</span><span class="p">:</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>            <span class="n">tar</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">download_dir</span><span class="p">)</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracted: </span><span class="si">{</span><span class="n">extract_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Both 1000G PLINK and FRQ archives are ready.&quot;</span><span class="p">)</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>    <span class="k">return</span> <span class="p">(</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">download_dir</span><span class="p">,</span> <span class="s2">&quot;1000G_EUR_Phase3_plink&quot;</span><span class="p">),</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">download_dir</span><span class="p">,</span> <span class="s2">&quot;1000G_Phase3_frq&quot;</span><span class="p">),</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>    <span class="p">)</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a><span class="k">def</span><span class="w"> </span><span class="nf">_download_and_extract_gtex</span><span class="p">(</span><span class="n">download_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;../data&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a><span class="sd">    Download and extract GTEx fine-mapping dataset if missing.</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a><span class="sd">    Returns the path to the main GTEx fine-mapping file.</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>    <span class="n">download_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">download_dir</span><span class="p">)</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">download_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>    <span class="n">gtex_zip</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">download_dir</span><span class="p">,</span> <span class="s2">&quot;Public_GTEx_finemapping.zip&quot;</span><span class="p">)</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>    <span class="n">gtex_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">download_dir</span><span class="p">,</span> <span class="s2">&quot;GTEx_49tissues_release1.tsv.bgz&quot;</span><span class="p">)</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://www.dropbox.com/scl/fo/bjp6o8hgixt5occ6ggq2o/ADTTMnyH-4rzDFS6g7oIcEE?rlkey=7558jp42yvmyjhgmcilbhlnu7&amp;e=4&amp;dl=1&quot;</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>    <span class="c1">#  If extracted .bgz file exists — skip everything</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">gtex_file</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">gtex_file</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found extracted GTEx file: </span><span class="si">{</span><span class="n">gtex_file</span><span class="si">}</span><span class="s2"> — skipping download.&quot;</span><span class="p">)</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>        <span class="k">return</span> <span class="n">gtex_file</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>    <span class="c1">#  If zip file exists, use it</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">gtex_zip</span><span class="p">):</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading GTEx fine-mapping dataset ...&quot;</span><span class="p">)</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;wget&quot;</span><span class="p">,</span> <span class="s2">&quot;-O&quot;</span><span class="p">,</span> <span class="n">gtex_zip</span><span class="p">,</span> <span class="n">url</span><span class="p">],</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found archive: </span><span class="si">{</span><span class="n">gtex_zip</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>    <span class="c1">#  Validate and extract</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>    <span class="k">if</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">is_zipfile</span><span class="p">(</span><span class="n">gtex_zip</span><span class="p">):</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracting </span><span class="si">{</span><span class="n">gtex_zip</span><span class="si">}</span><span class="s2"> ...&quot;</span><span class="p">)</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>        <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">gtex_zip</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zip_ref</span><span class="p">:</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>            <span class="n">zip_ref</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">download_dir</span><span class="p">)</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracted GTEx data to: </span><span class="si">{</span><span class="n">download_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">gtex_zip</span><span class="si">}</span><span class="s2"> is not a valid zip archive. Please check the downloaded file.&quot;</span><span class="p">)</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>    <span class="c1">#  Verify extraction result</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">gtex_file</span><span class="p">):</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected file </span><span class="si">{</span><span class="n">gtex_file</span><span class="si">}</span><span class="s2"> not found after extraction.&quot;</span><span class="p">)</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>    
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GTEx fine-mapping data ready: </span><span class="si">{</span><span class="n">gtex_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>    <span class="k">return</span> <span class="n">gtex_file</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a><span class="k">def</span><span class="w"> </span><span class="nf">_download_liftover_resources</span><span class="p">(</span><span class="n">download_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;./data&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure UCSC liftOver binary and hg19→hg38 chain file exist locally.&quot;&quot;&quot;</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>    <span class="n">out_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">download_dir</span><span class="p">)</span> 
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>    <span class="n">out_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>    <span class="n">liftover_bin</span> <span class="o">=</span> <span class="n">out_dir</span> <span class="o">/</span> <span class="s2">&quot;liftOver&quot;</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>    <span class="n">chain_file</span> <span class="o">=</span> <span class="n">out_dir</span> <span class="o">/</span> <span class="s2">&quot;hg19ToHg38.over.chain.gz&quot;</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>    <span class="c1"># Download binary if needed</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">liftover_bin</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>        <span class="n">system</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading UCSC liftOver binary for </span><span class="si">{</span><span class="n">system</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>        <span class="k">if</span> <span class="n">system</span> <span class="o">==</span> <span class="s2">&quot;linux&quot;</span><span class="p">:</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>            <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://hgdownload.soe.ucsc.edu/admin/exe/linux.x86_64/liftOver&quot;</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>        <span class="k">elif</span> <span class="n">system</span> <span class="o">==</span> <span class="s2">&quot;darwin&quot;</span><span class="p">:</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>            <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://hgdownload.soe.ucsc.edu/admin/exe/macOSX.x86_64/liftOver&quot;</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Unsupported OS for automatic liftOver download.&quot;</span><span class="p">)</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>        <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">liftover_bin</span><span class="p">)</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;chmod&quot;</span><span class="p">,</span> <span class="s2">&quot;+x&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">liftover_bin</span><span class="p">)],</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;liftOver binary saved to: </span><span class="si">{</span><span class="n">liftover_bin</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;liftOver binary already present: </span><span class="si">{</span><span class="n">liftover_bin</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>    <span class="c1"># Download chain file if needed</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">chain_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading hg19→hg38 chain file...&quot;</span><span class="p">)</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>        <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://hgdownload.soe.ucsc.edu/goldenPath/hg19/liftOver/hg19ToHg38.over.chain.gz&quot;</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>        <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">chain_file</span><span class="p">)</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Chain file saved to: </span><span class="si">{</span><span class="n">chain_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Chain file already present: </span><span class="si">{</span><span class="n">chain_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">liftover_bin</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">chain_file</span><span class="p">)</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a><span class="k">def</span><span class="w"> </span><span class="nf">_process_1000g_bim_frq</span><span class="p">(</span><span class="n">plink_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">frq_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">maf_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate per-chromosome BED files of common variants (MAF &gt; threshold)</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a><span class="sd">    using 1000 Genomes .bim and .frq files.</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plink_dir</span><span class="p">)</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>    <span class="n">bed_files</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>    <span class="n">expected_files</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;1000G.EUR.</span><span class="si">{</span><span class="n">chrom</span><span class="si">}</span><span class="s2">.filtered.bed&quot;</span><span class="p">)</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>        <span class="k">for</span> <span class="n">chrom</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">23</span><span class="p">)</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>    <span class="p">]</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>    <span class="n">existing_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">expected_files</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing_files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">22</span><span class="p">:</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found existing 1000G filtered BED files — skipping regeneration.&quot;</span><span class="p">)</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>        <span class="k">return</span> <span class="n">existing_files</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>    <span class="k">for</span> <span class="n">chrom</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">23</span><span class="p">):</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>        <span class="c1"># Paths for this chromosome</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>        <span class="n">bim_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plink_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;1000G.EUR.QC.</span><span class="si">{</span><span class="n">chrom</span><span class="si">}</span><span class="s2">.bim&quot;</span><span class="p">)</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>        <span class="n">frq_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">frq_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;1000G.EUR.QC.</span><span class="si">{</span><span class="n">chrom</span><span class="si">}</span><span class="s2">.frq&quot;</span><span class="p">)</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">bim_path</span><span class="p">):</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing BIM for chr</span><span class="si">{</span><span class="n">chrom</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">bim_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>            <span class="k">continue</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">frq_path</span><span class="p">):</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing FRQ for chr</span><span class="si">{</span><span class="n">chrom</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">frq_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>            <span class="k">continue</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>        <span class="c1"># Read .bim (positions and alleles)</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>        <span class="n">bim</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>            <span class="n">bim_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>            <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;CHROM&quot;</span><span class="p">,</span> <span class="s2">&quot;SNP&quot;</span><span class="p">,</span> <span class="s2">&quot;CM&quot;</span><span class="p">,</span> <span class="s2">&quot;POS&quot;</span><span class="p">,</span> <span class="s2">&quot;A1&quot;</span><span class="p">,</span> <span class="s2">&quot;A2&quot;</span><span class="p">]</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>        <span class="p">)</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>        <span class="c1"># Read .frq (allele frequencies)</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>        <span class="n">frq</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">frq_path</span><span class="p">,</span> <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;#&quot;</span><span class="p">)</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>        <span class="c1"># Ensure column names match expected (handle FRQ files that use lowercase or uppercase)</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>        <span class="n">frq</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">frq</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>        <span class="k">if</span> <span class="s2">&quot;MAF&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">frq</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FRQ file </span><span class="si">{</span><span class="n">frq_path</span><span class="si">}</span><span class="s2"> missing &#39;MAF&#39; column&quot;</span><span class="p">)</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>        <span class="c1"># Merge on SNP ID</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>        <span class="n">merged</span> <span class="o">=</span> <span class="n">bim</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">frq</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;SNP&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">)</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>        <span class="c1"># Filter by MAF</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>        <span class="n">filtered</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">merged</span><span class="p">[</span><span class="s2">&quot;MAF&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">maf_threshold</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>        <span class="c1"># BED-style coordinates</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>        <span class="n">bed_df</span> <span class="o">=</span> <span class="n">filtered</span><span class="p">[[</span><span class="s2">&quot;CHROM&quot;</span><span class="p">,</span> <span class="s2">&quot;POS&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;POS&quot;</span><span class="p">:</span> <span class="s2">&quot;START&quot;</span><span class="p">})</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>        <span class="n">bed_df</span><span class="p">[</span><span class="s2">&quot;END&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bed_df</span><span class="p">[</span><span class="s2">&quot;START&quot;</span><span class="p">]</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>        <span class="n">bed_df</span><span class="p">[</span><span class="s2">&quot;START&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bed_df</span><span class="p">[</span><span class="s2">&quot;START&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>        <span class="n">bed_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;1000G.EUR.</span><span class="si">{</span><span class="n">chrom</span><span class="si">}</span><span class="s2">.filtered.bed&quot;</span><span class="p">)</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>        <span class="n">bed_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">bed_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>        <span class="n">bed_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bed_path</span><span class="p">)</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;chr</span><span class="si">{</span><span class="n">chrom</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">bed_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> variants kept (MAF &gt; </span><span class="si">{</span><span class="n">maf_threshold</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">bed_files</span><span class="p">:</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;No valid BIM+FRQ pairs were processed — check extracted directories.&quot;</span><span class="p">)</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished generating </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">bed_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> filtered BED files.&quot;</span><span class="p">)</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>    <span class="k">return</span> <span class="n">bed_files</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a><span class="k">def</span><span class="w"> </span><span class="nf">liftover_df</span><span class="p">(</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>    <span class="n">chain_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>    <span class="n">liftover_bin</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>    <span class="n">out_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;./liftover_tmp&quot;</span><span class="p">,</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>    <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;region&quot;</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;LiftOver genomic coordinates in a DataFrame from one assembly to another.</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a><span class="sd">    Args:</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a><span class="sd">        df (pd.DataFrame): Must contain [&#39;CHROM&#39;, &#39;START&#39;, &#39;END&#39;] columns.</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a><span class="sd">        chain_file (str): Path to UCSC chain file (e.g., hg19ToHg38.over.chain.gz).</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a><span class="sd">        liftover_bin (str): Path to UCSC liftOver executable.</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a><span class="sd">        out_dir (str): Directory to store intermediate and output files.</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a><span class="sd">        prefix (str): Prefix for temp output files.</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a><span class="sd">    Returns:</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a><span class="sd">        pd.DataFrame: Liftover-converted DataFrame with same columns.</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>    <span class="n">out_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>    <span class="n">out_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>    <span class="c1"># File paths</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>    <span class="n">bed_file</span> <span class="o">=</span> <span class="n">out_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">.bed&quot;</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>    <span class="n">out_hg38</span> <span class="o">=</span> <span class="n">out_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_lifted.bed&quot;</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>    <span class="n">out_unmapped</span> <span class="o">=</span> <span class="n">out_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_unmapped.bed&quot;</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>    <span class="c1"># Save input DataFrame as BED</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>    <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;CHROM&quot;</span><span class="p">,</span> <span class="s2">&quot;START&quot;</span><span class="p">,</span> <span class="s2">&quot;END&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">bed_file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>    <span class="c1"># Run liftOver</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">liftover_bin</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">bed_file</span><span class="p">),</span> <span class="n">chain_file</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">out_hg38</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">out_unmapped</span><span class="p">)]</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running: </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>    <span class="c1"># Read lifted BED back in</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>    <span class="n">lifted</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">out_hg38</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;CHROM&quot;</span><span class="p">,</span> <span class="s2">&quot;START&quot;</span><span class="p">,</span> <span class="s2">&quot;END&quot;</span><span class="p">])</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Liftover completed! </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">lifted</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> regions mapped successfully.&quot;</span><span class="p">)</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>    <span class="k">return</span> <span class="n">lifted</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a><span class="k">def</span><span class="w"> </span><span class="nf">_map_ensembl_to_symbol</span><span class="p">(</span><span class="n">gtex_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">gtf_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;../data&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Add GeneSymbol column to gtex_df using Ensembl → gene_name mapping from GENCODE GTF.&quot;&quot;&quot;</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">gtf_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>    <span class="n">gtf_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gtf_dir</span><span class="p">,</span> <span class="s2">&quot;gencode.v44.annotation.gtf.gz&quot;</span><span class="p">)</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>    <span class="c1"># Download GTF if missing</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">gtf_path</span><span class="p">):</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>        <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://ftp.ebi.ac.uk/pub/databases/gencode/Gencode_human/release_44/gencode.v44.annotation.gtf.gz&quot;</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading GENCODE v44 GTF with wget ...&quot;</span><span class="p">)</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;wget&quot;</span><span class="p">,</span> <span class="s2">&quot;-O&quot;</span><span class="p">,</span> <span class="n">gtf_path</span><span class="p">,</span> <span class="n">url</span><span class="p">],</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded: </span><span class="si">{</span><span class="n">gtf_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found existing GTF file — skipping download.&quot;</span><span class="p">)</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>    <span class="c1"># Build mapping only for needed Ensembl IDs</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>    <span class="n">needed</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>    <span class="n">mapping</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>    <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">gtf_path</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fh</span><span class="p">:</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">gene</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>                <span class="k">continue</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>            <span class="n">info</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">8</span><span class="p">]</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>            <span class="n">gene_id</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;gene_id &quot;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>            <span class="k">if</span> <span class="n">gene_id</span> <span class="ow">in</span> <span class="n">needed</span><span class="p">:</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>                <span class="n">gene_name</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;gene_name &quot;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>                <span class="n">mapping</span><span class="p">[</span><span class="n">gene_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">gene_name</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mapping</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">needed</span><span class="p">):</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>                <span class="k">break</span>  <span class="c1"># Stop once all needed genes are found</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>    <span class="c1"># Map to new column</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>    <span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;GeneSymbol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">mapping</span><span class="p">)</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added GeneSymbol for </span><span class="si">{</span><span class="n">gtex_df</span><span class="p">[</span><span class="s1">&#39;GeneSymbol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gtex_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> genes.&quot;</span><span class="p">)</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>    <span class="k">return</span> <span class="n">gtex_df</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a><span class="k">def</span><span class="w"> </span><span class="nf">load_gtex_finemap</span><span class="p">(</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>    <span class="n">gtex_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>    <span class="n">tissue</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Whole_Blood&quot;</span><span class="p">,</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;SUSIE&quot;</span><span class="p">,</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a><span class="sd">    Load and preprocess GTEx fine-mapping results for a selected tissue and method.</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a><span class="sd">    Args:</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a><span class="sd">        gtex_path (str): Path to the GTEx fine-mapping file (e.g. GTEx_49tissues_release1.tsv.bgz).</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a><span class="sd">        tissue (str): GTEx tissue name to filter for (default: &quot;Whole_Blood&quot;).</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a><span class="sd">        method (str): Fine-mapping method (default: &quot;SUSIE&quot;).</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a><span class="sd">    Returns:</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a><span class="sd">        pd.DataFrame: Filtered GTEx fine-mapping DataFrame with columns:</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a><span class="sd">                      [&#39;chr_pos&#39;, &#39;GeneSymbol&#39;, &#39;pair&#39;, &#39;pip&#39;, ...]</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading GTEx fine-mapping data from: </span><span class="si">{</span><span class="n">gtex_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>    <span class="n">gtex_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">gtex_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>    <span class="c1"># Filter for method and tissue</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>    <span class="n">gtex_df</span> <span class="o">=</span> <span class="n">gtex_df</span><span class="p">[(</span><span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">method</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;tissue&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tissue</span><span class="p">)]</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filtered for </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">tissue</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gtex_df</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> entries&quot;</span><span class="p">)</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>    <span class="c1"># Clean gene IDs (remove version suffix)</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>    <span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>    <span class="c1"># Map Ensembl → GeneSymbol if function provided</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>    <span class="n">gtex_df</span> <span class="o">=</span> <span class="n">_map_ensembl_to_symbol</span><span class="p">(</span><span class="n">gtex_df</span><span class="p">)</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>    <span class="n">gtex_df</span> <span class="o">=</span> <span class="n">gtex_df</span><span class="p">[</span><span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;GeneSymbol&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()]</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🔠 Added GeneSymbol for </span><span class="si">{</span><span class="n">gtex_df</span><span class="p">[</span><span class="s1">&#39;GeneSymbol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> genes&quot;</span><span class="p">)</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>    <span class="c1"># Extract chr_pos and build SNP–gene pair ID</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>    <span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;chr_pos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;variant_hg38&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(chr[0-9XYM]+_\d+)&quot;</span><span class="p">)</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>    <span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;pair&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;chr_pos&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;GeneSymbol&quot;</span><span class="p">]</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final GTEx dataset ready with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gtex_df</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> SNP–gene pairs&quot;</span><span class="p">)</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>    <span class="k">return</span> <span class="n">gtex_df</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a><span class="k">def</span><span class="w"> </span><span class="nf">overlap_variants_with_peaks</span><span class="p">(</span><span class="n">candidates</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">variants_bed</span><span class="p">:</span> <span class="n">pr</span><span class="o">.</span><span class="n">PyRanges</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a><span class="sd">    Convert candidate peaks into PyRanges and find overlaps with variant coordinates.</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a><span class="sd">    Args:</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a><span class="sd">        candidates (pd.DataFrame): Must contain a &#39;Peak&#39; column in &#39;chr:start-end&#39; or &#39;chr_start_end&#39; format.</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a><span class="sd">        variants_bed (pr.PyRanges): PyRanges object of variant coordinates.</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a><span class="sd">    Returns:</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a><span class="sd">        pd.DataFrame: DataFrame of overlapping variants and peaks with standardized columns.</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>    <span class="c1"># Parse candidate Peak strings → chrom/start/end</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>    <span class="n">peaks_df</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>        <span class="n">candidates</span><span class="p">[</span><span class="s2">&quot;Peak&quot;</span><span class="p">]</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>        <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;CHROM&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;START&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;END&quot;</span><span class="p">})</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>        <span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s2">&quot;START&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s2">&quot;END&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">})</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>    <span class="p">)</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>    <span class="n">peaks_df</span><span class="p">[</span><span class="s2">&quot;Peak&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">candidates</span><span class="p">[</span><span class="s2">&quot;Peak&quot;</span><span class="p">]</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>    <span class="c1"># Convert to PyRanges</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>    <span class="n">peak_pr</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">PyRanges</span><span class="p">(</span><span class="n">peaks_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>        <span class="s2">&quot;CHROM&quot;</span><span class="p">:</span> <span class="s2">&quot;Chromosome&quot;</span><span class="p">,</span> <span class="s2">&quot;START&quot;</span><span class="p">:</span> <span class="s2">&quot;Start&quot;</span><span class="p">,</span> <span class="s2">&quot;END&quot;</span><span class="p">:</span> <span class="s2">&quot;End&quot;</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>    <span class="p">}))</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>    <span class="c1"># Find overlaps</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>    <span class="n">overlap_df</span> <span class="o">=</span> <span class="n">variants_bed</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">peak_pr</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>        <span class="s2">&quot;Chromosome&quot;</span><span class="p">:</span> <span class="s2">&quot;CHROM&quot;</span><span class="p">,</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>        <span class="s2">&quot;Start&quot;</span><span class="p">:</span> <span class="s2">&quot;POS&quot;</span><span class="p">,</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>        <span class="s2">&quot;End&quot;</span><span class="p">:</span> <span class="s2">&quot;POS2&quot;</span><span class="p">,</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>        <span class="s2">&quot;Start_b&quot;</span><span class="p">:</span> <span class="s2">&quot;START_ANN&quot;</span><span class="p">,</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>        <span class="s2">&quot;End_b&quot;</span><span class="p">:</span> <span class="s2">&quot;END_ANN&quot;</span><span class="p">,</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>    <span class="p">})</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>    <span class="c1"># Standardize Peak ID</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>    <span class="n">overlap_df</span><span class="p">[</span><span class="s2">&quot;Peak&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>        <span class="n">overlap_df</span><span class="p">[</span><span class="s2">&quot;CHROM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>        <span class="n">overlap_df</span><span class="p">[</span><span class="s2">&quot;START_ANN&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>        <span class="n">overlap_df</span><span class="p">[</span><span class="s2">&quot;END_ANN&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>    <span class="p">)</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">overlap_df</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> overlapping variant–peak records.&quot;</span><span class="p">)</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>    <span class="k">return</span> <span class="n">overlap_df</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a><span class="k">def</span><span class="w"> </span><span class="nf">merge_and_label_eqtl_pairs</span><span class="p">(</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>    <span class="n">candidates</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>    <span class="n">overlap_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>    <span class="n">pos_training</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>    <span class="n">neg_training</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Merge overlap results with candidate peaks and label SNP–gene pairs.&quot;&quot;&quot;</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>    <span class="n">merged</span> <span class="o">=</span> <span class="n">candidates</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">overlap_df</span><span class="p">[[</span><span class="s2">&quot;CHROM&quot;</span><span class="p">,</span><span class="s2">&quot;POS&quot;</span><span class="p">,</span><span class="s2">&quot;POS2&quot;</span><span class="p">,</span><span class="s2">&quot;Peak&quot;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Peak&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>    <span class="n">merged</span> <span class="o">=</span> <span class="n">merged</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Gene_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Gene&quot;</span><span class="p">})</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>    <span class="k">if</span> <span class="s2">&quot;Distance_to_TSS&quot;</span> <span class="ow">in</span> <span class="n">merged</span><span class="p">:</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>        <span class="n">merged</span><span class="p">[</span><span class="s2">&quot;1/Distance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">merged</span><span class="p">[</span><span class="s2">&quot;Distance_to_TSS&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">upper</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>    <span class="n">merged</span><span class="p">[</span><span class="s2">&quot;snp_gene_pair&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>        <span class="n">merged</span><span class="p">[</span><span class="s2">&quot;CHROM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>        <span class="n">merged</span><span class="p">[</span><span class="s2">&quot;POS2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a>        <span class="n">merged</span><span class="p">[</span><span class="s2">&quot;Gene&quot;</span><span class="p">]</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>    <span class="p">)</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>    <span class="n">pos_df</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">merged</span><span class="o">.</span><span class="n">snp_gene_pair</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">pos_training</span><span class="p">[</span><span class="s2">&quot;pair&quot;</span><span class="p">])]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a>    <span class="n">neg_df</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">merged</span><span class="o">.</span><span class="n">snp_gene_pair</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">neg_training</span><span class="p">[</span><span class="s2">&quot;pair&quot;</span><span class="p">])]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a>    <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pos_df</span><span class="p">,</span> <span class="n">neg_df</span><span class="p">])</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="s2">&quot;snp_gene_pair&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;CHROM&quot;</span><span class="p">)</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;total </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">final_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> pairs.&quot;</span><span class="p">)</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a>    <span class="k">return</span> <span class="n">final_df</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a><span class="k">def</span><span class="w"> </span><span class="nf">build_crispr_evalset</span><span class="p">(</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a>    <span class="n">candidate</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a>    <span class="n">crispr_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a>    <span class="n">adata_cg_genes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a>    <span class="n">output_csv</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a>    <span class="n">peak_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Peak&quot;</span><span class="p">,</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a>    <span class="n">gene_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Gene_name&quot;</span><span class="p">,</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a>    <span class="n">distance_col</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Distance_to_TSS&quot;</span><span class="p">,</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Construct a CRISPR evaluation set from candidate peak–gene links.</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a><span class="sd">    This overlaps CRISPR enhancer elements with candidate peaks, keeps rows where</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a><span class="sd">    the CRISPR measured gene matches the candidate gene, optionally filters to genes</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a><span class="sd">    present in your RNA modality, and assigns labels from the CRISPR benchmark.</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a><span class="sd">    Args:</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a><span class="sd">        candidate: candidate peak–gene links (BMMC or other).</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a><span class="sd">        crispr_file: Path to CRISPR benchmark TSV (gzipped), with columns</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a><span class="sd">            ``chrom``, ``chromStart``, ``chromEnd``, ``measuredGeneSymbol``, ``Regulated``.</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a><span class="sd">        adata_cg_genes: Optional list of genes detected in RNA</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a><span class="sd">            (to filter CRISPR overlaps to your assay&#39;s gene set).</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a><span class="sd">        output_csv: If provided, write the labeled set to this path.</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a><span class="sd">        peak_col: Column in candidates containing peak coordinates. Defaults to ``&quot;Peak&quot;``.</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a><span class="sd">        gene_col: Column in candidates containing gene ID/symbol. Defaults to ``&quot;Gene_name&quot;``.</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a><span class="sd">        distance_col: Column in candidates with distance to TSS in bp.</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a><span class="sd">            If provided and present, a ``1/Distance`` feature will be added.</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a><span class="sd">    Returns:</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a><span class="sd">        Labeled CRISPR evaluation set with ``Peak``, ``Gene``, ``label`` (1/0),</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a><span class="sd">        and optional ``1/Distance``.</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Building CRISPR evaluation set...&quot;</span><span class="p">)</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>    <span class="n">candidates</span> <span class="o">=</span> <span class="n">_load_and_validate_candidates</span><span class="p">(</span><span class="n">candidate</span><span class="p">,</span> <span class="n">peak_col</span><span class="p">,</span> <span class="n">gene_col</span><span class="p">,</span> <span class="n">distance_col</span><span class="p">)</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>    <span class="n">crispr_eval</span> <span class="o">=</span> <span class="n">_load_and_validate_crispr</span><span class="p">(</span><span class="n">crispr_file</span><span class="p">)</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>    <span class="n">overlap_df</span> <span class="o">=</span> <span class="n">_intersect_crispr_with_candidates</span><span class="p">(</span><span class="n">crispr_eval</span><span class="p">,</span> <span class="n">candidates</span><span class="p">,</span> <span class="n">distance_col</span><span class="p">)</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a>    <span class="k">if</span> <span class="n">adata_cg_genes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a>        <span class="n">overlap_df</span> <span class="o">=</span> <span class="n">overlap_df</span><span class="p">[</span><span class="n">overlap_df</span><span class="p">[</span><span class="s2">&quot;crispr_gene&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">adata_cg_genes</span><span class="p">))]</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a>    <span class="n">overlap_df</span> <span class="o">=</span> <span class="n">overlap_df</span><span class="p">[</span><span class="n">overlap_df</span><span class="p">[</span><span class="s2">&quot;crispr_gene&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">overlap_df</span><span class="p">[</span><span class="s2">&quot;Gene&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a>    <span class="n">overlap_df</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">overlap_df</span><span class="p">[</span><span class="s2">&quot;crispr_regulated&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a>    <span class="k">if</span> <span class="n">distance_col</span> <span class="ow">and</span> <span class="n">distance_col</span> <span class="ow">in</span> <span class="n">overlap_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>        <span class="n">overlap_df</span><span class="p">[</span><span class="s2">&quot;1/Distance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">overlap_df</span><span class="p">[</span><span class="n">distance_col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a>        <span class="n">overlap_df</span><span class="p">[</span><span class="s2">&quot;1/Distance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">overlap_df</span><span class="p">[</span><span class="s2">&quot;1/Distance&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">upper</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a>    <span class="n">overlap_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a>    <span class="k">if</span> <span class="n">output_csv</span><span class="p">:</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a>        <span class="n">overlap_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_csv</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a>    <span class="k">return</span> <span class="n">overlap_df</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a><span class="k">def</span><span class="w"> </span><span class="nf">_load_and_validate_candidates</span><span class="p">(</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a>    <span class="n">candidate</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a>    <span class="n">peak_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a>    <span class="n">gene_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a>    <span class="n">distance_col</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">candidate</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a>    <span class="n">missing</span> <span class="o">=</span> <span class="p">{</span><span class="n">peak_col</span><span class="p">,</span> <span class="n">gene_col</span><span class="p">}</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a>    <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;candidate_csv missing required columns: </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">peak_col</span><span class="p">:</span> <span class="s2">&quot;Peak&quot;</span><span class="p">,</span> <span class="n">gene_col</span><span class="p">:</span> <span class="s2">&quot;Gene&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a>    <span class="n">bed_df</span> <span class="o">=</span> <span class="n">_parse_peak_series_to_bed_df</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Peak&quot;</span><span class="p">])</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a>    <span class="k">if</span> <span class="n">bed_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No valid peaks parsed from candidate_csv; check peak format.&quot;</span><span class="p">)</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a>    <span class="n">bed_df</span><span class="p">[</span><span class="s2">&quot;Peak&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bed_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;Peak&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a>    <span class="n">bed_df</span><span class="p">[</span><span class="s2">&quot;Gene&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bed_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;Gene&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a>    <span class="k">if</span> <span class="n">distance_col</span> <span class="ow">and</span> <span class="n">distance_col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a>        <span class="n">bed_df</span><span class="p">[</span><span class="n">distance_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bed_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">distance_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a>    <span class="k">return</span> <span class="n">bed_df</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a><span class="k">def</span><span class="w"> </span><span class="nf">_load_and_validate_crispr</span><span class="p">(</span><span class="n">crispr_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a>    <span class="n">download_url</span> <span class="o">=</span> <span class="s2">&quot;https://github.com/EngreitzLab/CRISPR_comparison/raw/main/resources/crispr_data/EPCrisprBenchmark_combined_data.training_K562.GRCh38.tsv.gz&quot;</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">crispr_file</span><span class="p">):</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">crispr_file</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading CRISPR benchmark dataset from </span><span class="si">{</span><span class="n">download_url</span><span class="si">}</span><span class="s2"> ...&quot;</span><span class="p">)</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a>        <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">download_url</span><span class="p">,</span> <span class="n">crispr_file</span><span class="p">)</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a>        
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">crispr_file</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a>    <span class="n">required</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;chrom&quot;</span><span class="p">,</span> <span class="s2">&quot;chromStart&quot;</span><span class="p">,</span> <span class="s2">&quot;chromEnd&quot;</span><span class="p">,</span> <span class="s2">&quot;measuredGeneSymbol&quot;</span><span class="p">,</span> <span class="s2">&quot;Regulated&quot;</span><span class="p">}</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a>    <span class="n">missing</span> <span class="o">=</span> <span class="n">required</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a>    <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;crispr_file missing required columns: </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a>    <span class="k">return</span> <span class="n">df</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a><span class="k">def</span><span class="w"> </span><span class="nf">_intersect_crispr_with_candidates</span><span class="p">(</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a>    <span class="n">crispr_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a>    <span class="n">candidate_bed_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a>    <span class="n">distance_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Intersect CRISPR regulatory elements with candidate peak–gene pairs using PyRanges.</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a>
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a><span class="sd">    Args:</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a><span class="sd">        crispr_df (pd.DataFrame):</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a><span class="sd">            DataFrame containing CRISPR regulatory elements.</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a><span class="sd">            Must include columns:</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a><span class="sd">            ``[&quot;chrom&quot;, &quot;chromStart&quot;, &quot;chromEnd&quot;, &quot;measuredGeneSymbol&quot;, &quot;Regulated&quot;]``.</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a><span class="sd">        candidate_bed_df (pd.DataFrame):</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a><span class="sd">            DataFrame of candidate peak–gene regions.</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a><span class="sd">            Must include columns:</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a><span class="sd">            ``[&quot;chrom&quot;, &quot;chromStart&quot;, &quot;chromEnd&quot;, &quot;Peak&quot;, &quot;Gene&quot;]`` and optionally a distance column.</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a><span class="sd">        distance_col (str | None):</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a><span class="sd">            Name of the distance column in ``candidate_bed_df`` to retain in the output.</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a><span class="sd">            If not present or None, it is skipped.</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a>
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a><span class="sd">    Returns:</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a><span class="sd">        pd.DataFrame:</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a><span class="sd">            DataFrame of overlapping CRISPR–peak pairs with columns::</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a>
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a><span class="sd">                [&quot;crispr_chrom&quot;, &quot;crispr_start&quot;, &quot;crispr_end&quot;,</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a><span class="sd">                 &quot;crispr_gene&quot;, &quot;crispr_regulated&quot;,</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos">634</span></a><span class="sd">                 &quot;peak_chrom&quot;, &quot;peak_start&quot;, &quot;peak_end&quot;,</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos">635</span></a><span class="sd">                 &quot;Peak&quot;, &quot;Gene&quot;, (optional distance_col)]</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos">636</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos">637</span></a>    <span class="c1"># Prepare CRISPR dataframe</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos">638</span></a>    <span class="n">crispr_pr_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos">639</span></a>        <span class="s2">&quot;Chromosome&quot;</span><span class="p">:</span> <span class="n">crispr_df</span><span class="p">[</span><span class="s2">&quot;chrom&quot;</span><span class="p">],</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos">640</span></a>        <span class="s2">&quot;Start&quot;</span><span class="p">:</span> <span class="n">crispr_df</span><span class="p">[</span><span class="s2">&quot;chromStart&quot;</span><span class="p">],</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos">641</span></a>        <span class="s2">&quot;End&quot;</span><span class="p">:</span> <span class="n">crispr_df</span><span class="p">[</span><span class="s2">&quot;chromEnd&quot;</span><span class="p">],</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos">642</span></a>        <span class="s2">&quot;crispr_gene&quot;</span><span class="p">:</span> <span class="n">crispr_df</span><span class="p">[</span><span class="s2">&quot;measuredGeneSymbol&quot;</span><span class="p">],</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos">643</span></a>        <span class="s2">&quot;crispr_regulated&quot;</span><span class="p">:</span> <span class="n">crispr_df</span><span class="p">[</span><span class="s2">&quot;Regulated&quot;</span><span class="p">],</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos">644</span></a>    <span class="p">})</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos">645</span></a>
</span><span id="L-646"><a href="#L-646"><span class="linenos">646</span></a>    <span class="c1"># -----------------------------</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos">647</span></a>    <span class="c1"># Prepare candidate dataframe</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos">648</span></a>    <span class="c1"># -----------------------------</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos">649</span></a>    <span class="n">base_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;chrom&quot;</span><span class="p">,</span> <span class="s2">&quot;chromStart&quot;</span><span class="p">,</span> <span class="s2">&quot;chromEnd&quot;</span><span class="p">,</span> <span class="s2">&quot;Peak&quot;</span><span class="p">,</span> <span class="s2">&quot;Gene&quot;</span><span class="p">]</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos">650</span></a>    <span class="n">cols_to_use</span> <span class="o">=</span> <span class="n">base_cols</span> <span class="o">+</span> <span class="p">([</span><span class="n">distance_col</span><span class="p">]</span> <span class="k">if</span> <span class="n">distance_col</span> <span class="ow">and</span> <span class="n">distance_col</span> <span class="ow">in</span> <span class="n">candidate_bed_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="p">[])</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos">651</span></a>    <span class="n">cand_pr_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos">652</span></a>        <span class="s2">&quot;Chromosome&quot;</span><span class="p">:</span> <span class="n">candidate_bed_df</span><span class="p">[</span><span class="s2">&quot;chrom&quot;</span><span class="p">],</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos">653</span></a>        <span class="s2">&quot;Start&quot;</span><span class="p">:</span> <span class="n">candidate_bed_df</span><span class="p">[</span><span class="s2">&quot;chromStart&quot;</span><span class="p">],</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos">654</span></a>        <span class="s2">&quot;End&quot;</span><span class="p">:</span> <span class="n">candidate_bed_df</span><span class="p">[</span><span class="s2">&quot;chromEnd&quot;</span><span class="p">],</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos">655</span></a>        <span class="s2">&quot;Peak&quot;</span><span class="p">:</span> <span class="n">candidate_bed_df</span><span class="p">[</span><span class="s2">&quot;Peak&quot;</span><span class="p">],</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos">656</span></a>        <span class="s2">&quot;Gene&quot;</span><span class="p">:</span> <span class="n">candidate_bed_df</span><span class="p">[</span><span class="s2">&quot;Gene&quot;</span><span class="p">],</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos">657</span></a>        <span class="o">**</span><span class="p">(</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos">658</span></a>            <span class="p">{</span><span class="n">distance_col</span><span class="p">:</span> <span class="n">candidate_bed_df</span><span class="p">[</span><span class="n">distance_col</span><span class="p">]}</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos">659</span></a>            <span class="k">if</span> <span class="n">distance_col</span> <span class="ow">and</span> <span class="n">distance_col</span> <span class="ow">in</span> <span class="n">candidate_bed_df</span><span class="o">.</span><span class="n">columns</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos">660</span></a>            <span class="k">else</span> <span class="p">{}</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos">661</span></a>        <span class="p">),</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos">662</span></a>    <span class="p">})</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos">663</span></a>
</span><span id="L-664"><a href="#L-664"><span class="linenos">664</span></a>    <span class="c1"># Convert to PyRanges and join</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos">665</span></a>    <span class="n">crispr_pr</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">PyRanges</span><span class="p">(</span><span class="n">crispr_pr_df</span><span class="p">)</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos">666</span></a>    <span class="n">cand_pr</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">PyRanges</span><span class="p">(</span><span class="n">cand_pr_df</span><span class="p">)</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos">667</span></a>
</span><span id="L-668"><a href="#L-668"><span class="linenos">668</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Intersecting CRISPR elements with candidate peaks...&quot;</span><span class="p">)</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos">669</span></a>    <span class="n">overlap_pr</span> <span class="o">=</span> <span class="n">crispr_pr</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cand_pr</span><span class="p">)</span>  <span class="c1"># equivalent to bedtools intersect -wa -wb</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos">670</span></a>    <span class="n">ov</span> <span class="o">=</span> <span class="n">overlap_pr</span><span class="o">.</span><span class="n">df</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos">671</span></a>
</span><span id="L-672"><a href="#L-672"><span class="linenos">672</span></a>    <span class="c1"># Standardize output columns</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos">673</span></a>    <span class="n">rename_map</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos">674</span></a>        <span class="s2">&quot;Chromosome&quot;</span><span class="p">:</span> <span class="s2">&quot;crispr_chrom&quot;</span><span class="p">,</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos">675</span></a>        <span class="s2">&quot;Start&quot;</span><span class="p">:</span> <span class="s2">&quot;crispr_start&quot;</span><span class="p">,</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos">676</span></a>        <span class="s2">&quot;End&quot;</span><span class="p">:</span> <span class="s2">&quot;crispr_end&quot;</span><span class="p">,</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos">677</span></a>        <span class="s2">&quot;Start_b&quot;</span><span class="p">:</span> <span class="s2">&quot;peak_start&quot;</span><span class="p">,</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos">678</span></a>        <span class="s2">&quot;End_b&quot;</span><span class="p">:</span> <span class="s2">&quot;peak_end&quot;</span><span class="p">,</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos">679</span></a>    <span class="p">}</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos">680</span></a>    <span class="n">ov</span> <span class="o">=</span> <span class="n">ov</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rename_map</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ov</span><span class="o">.</span><span class="n">columns</span><span class="p">})</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos">681</span></a>    <span class="n">ov</span><span class="p">[</span><span class="s2">&quot;peak_chrom&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ov</span><span class="p">[</span><span class="s2">&quot;crispr_chrom&quot;</span><span class="p">]</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos">682</span></a>
</span><span id="L-683"><a href="#L-683"><span class="linenos">683</span></a>    <span class="c1"># Select and reorder columns</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos">684</span></a>    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos">685</span></a>        <span class="s2">&quot;crispr_chrom&quot;</span><span class="p">,</span> <span class="s2">&quot;crispr_start&quot;</span><span class="p">,</span> <span class="s2">&quot;crispr_end&quot;</span><span class="p">,</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos">686</span></a>        <span class="s2">&quot;crispr_gene&quot;</span><span class="p">,</span> <span class="s2">&quot;crispr_regulated&quot;</span><span class="p">,</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos">687</span></a>        <span class="s2">&quot;peak_chrom&quot;</span><span class="p">,</span> <span class="s2">&quot;peak_start&quot;</span><span class="p">,</span> <span class="s2">&quot;peak_end&quot;</span><span class="p">,</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos">688</span></a>        <span class="s2">&quot;Peak&quot;</span><span class="p">,</span> <span class="s2">&quot;Gene&quot;</span><span class="p">,</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos">689</span></a>    <span class="p">]</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos">690</span></a>    <span class="k">if</span> <span class="n">distance_col</span> <span class="ow">and</span> <span class="n">distance_col</span> <span class="ow">in</span> <span class="n">ov</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos">691</span></a>        <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">distance_col</span><span class="p">)</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos">692</span></a>
</span><span id="L-693"><a href="#L-693"><span class="linenos">693</span></a>    <span class="c1"># Filter only existing columns (for robustness)</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos">694</span></a>    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">ov</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos">695</span></a>
</span><span id="L-696"><a href="#L-696"><span class="linenos">696</span></a>    <span class="k">return</span> <span class="n">ov</span><span class="p">[</span><span class="n">names</span><span class="p">]</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos">697</span></a>
</span><span id="L-698"><a href="#L-698"><span class="linenos">698</span></a>
</span><span id="L-699"><a href="#L-699"><span class="linenos">699</span></a><span class="k">def</span><span class="w"> </span><span class="nf">_parse_peak_series_to_bed_df</span><span class="p">(</span><span class="n">peak_series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos">700</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse a Peak column into BED-like DataFrame.&quot;&quot;&quot;</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos">701</span></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">peak_series</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;([^_]+)_(\d+)_(\d+)&quot;</span><span class="p">)</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos">702</span></a>    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;chrom&quot;</span><span class="p">,</span> <span class="s2">&quot;chromStart&quot;</span><span class="p">,</span> <span class="s2">&quot;chromEnd&quot;</span><span class="p">]</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos">703</span></a>    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;chromStart&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;chromStart&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos">704</span></a>    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;chromEnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;chromEnd&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos">705</span></a>    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;chromStart&quot;</span><span class="p">,</span> <span class="s2">&quot;chromEnd&quot;</span><span class="p">])</span>
</span></pre></div>


            </section>
                <section id="build_eqtl_evalset">
                            <input id="build_eqtl_evalset-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">build_eqtl_evalset</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">candidate_csv</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">output_csv</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">download_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;../data&#39;</span>,</span><span class="param">	<span class="n">pip_pos</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span>,</span><span class="param">	<span class="n">pip_neg</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span>,</span><span class="param">	<span class="n">gtex_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;SUSIE&#39;</span>,</span><span class="param">	<span class="n">gtex_tissue</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Whole_Blood&#39;</span></span><span class="return-annotation">) -> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span>:</span></span>

                <label class="view-source-button" for="build_eqtl_evalset-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#build_eqtl_evalset"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="build_eqtl_evalset-37"><a href="#build_eqtl_evalset-37"><span class="linenos"> 37</span></a><span class="k">def</span><span class="w"> </span><span class="nf">build_eqtl_evalset</span><span class="p">(</span>
</span><span id="build_eqtl_evalset-38"><a href="#build_eqtl_evalset-38"><span class="linenos"> 38</span></a>    <span class="n">candidate_csv</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="build_eqtl_evalset-39"><a href="#build_eqtl_evalset-39"><span class="linenos"> 39</span></a>    <span class="n">output_csv</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="build_eqtl_evalset-40"><a href="#build_eqtl_evalset-40"><span class="linenos"> 40</span></a>    <span class="n">download_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;../data&quot;</span><span class="p">,</span>
</span><span id="build_eqtl_evalset-41"><a href="#build_eqtl_evalset-41"><span class="linenos"> 41</span></a>    <span class="n">pip_pos</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span id="build_eqtl_evalset-42"><a href="#build_eqtl_evalset-42"><span class="linenos"> 42</span></a>    <span class="n">pip_neg</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
</span><span id="build_eqtl_evalset-43"><a href="#build_eqtl_evalset-43"><span class="linenos"> 43</span></a>    <span class="n">gtex_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;SUSIE&quot;</span><span class="p">,</span>
</span><span id="build_eqtl_evalset-44"><a href="#build_eqtl_evalset-44"><span class="linenos"> 44</span></a>    <span class="n">gtex_tissue</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Whole_Blood&quot;</span>
</span><span id="build_eqtl_evalset-45"><a href="#build_eqtl_evalset-45"><span class="linenos"> 45</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="build_eqtl_evalset-46"><a href="#build_eqtl_evalset-46"><span class="linenos"> 46</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Build a GTEx eQTL evaluation set (replicates the notebook logic).</span>
</span><span id="build_eqtl_evalset-47"><a href="#build_eqtl_evalset-47"><span class="linenos"> 47</span></a>
</span><span id="build_eqtl_evalset-48"><a href="#build_eqtl_evalset-48"><span class="linenos"> 48</span></a><span class="sd">    This function downloads and prepares 1000G and GTEx data, overlaps peaks and variants,</span>
</span><span id="build_eqtl_evalset-49"><a href="#build_eqtl_evalset-49"><span class="linenos"> 49</span></a><span class="sd">    computes inverse distance, and labels SNP–gene pairs based on PIP thresholds.</span>
</span><span id="build_eqtl_evalset-50"><a href="#build_eqtl_evalset-50"><span class="linenos"> 50</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="build_eqtl_evalset-51"><a href="#build_eqtl_evalset-51"><span class="linenos"> 51</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">download_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="build_eqtl_evalset-52"><a href="#build_eqtl_evalset-52"><span class="linenos"> 52</span></a>
</span><span id="build_eqtl_evalset-53"><a href="#build_eqtl_evalset-53"><span class="linenos"> 53</span></a>    <span class="c1"># 1️⃣ Download and extract 1000 Genomes PLINK files if not present</span>
</span><span id="build_eqtl_evalset-54"><a href="#build_eqtl_evalset-54"><span class="linenos"> 54</span></a>    <span class="n">plink_dir</span><span class="p">,</span> <span class="n">frq_dir</span> <span class="o">=</span> <span class="n">_download_and_extract_1000g</span><span class="p">(</span><span class="n">download_dir</span><span class="p">)</span>
</span><span id="build_eqtl_evalset-55"><a href="#build_eqtl_evalset-55"><span class="linenos"> 55</span></a>
</span><span id="build_eqtl_evalset-56"><a href="#build_eqtl_evalset-56"><span class="linenos"> 56</span></a>    <span class="c1"># 2️⃣ Download GTEx fine-mapping results if not present</span>
</span><span id="build_eqtl_evalset-57"><a href="#build_eqtl_evalset-57"><span class="linenos"> 57</span></a>    <span class="n">gtex_zip</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">download_dir</span><span class="p">,</span> <span class="s2">&quot;Public_GTEx_finemapping.zip&quot;</span><span class="p">)</span>
</span><span id="build_eqtl_evalset-58"><a href="#build_eqtl_evalset-58"><span class="linenos"> 58</span></a>    <span class="n">gtex_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">download_dir</span><span class="p">,</span> <span class="s2">&quot;GTEx_49tissues_release1.tsv.bgz&quot;</span><span class="p">)</span>
</span><span id="build_eqtl_evalset-59"><a href="#build_eqtl_evalset-59"><span class="linenos"> 59</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">gtex_zip</span><span class="p">):</span>
</span><span id="build_eqtl_evalset-60"><a href="#build_eqtl_evalset-60"><span class="linenos"> 60</span></a>        <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://www.dropbox.com/scl/fo/bjp6o8hgixt5occ6ggq2o/ADTTMnyH-4rzDFS6g7oIcEE?rlkey=7558jp42yvmyjhgmcilbhlnu7&amp;e=4&amp;dl=1&quot;</span>
</span><span id="build_eqtl_evalset-61"><a href="#build_eqtl_evalset-61"><span class="linenos"> 61</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading GTEx fine-mapping dataset...&quot;</span><span class="p">)</span>
</span><span id="build_eqtl_evalset-62"><a href="#build_eqtl_evalset-62"><span class="linenos"> 62</span></a>        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;wget&quot;</span><span class="p">,</span> <span class="s2">&quot;-O&quot;</span><span class="p">,</span> <span class="n">gtex_zip</span><span class="p">,</span> <span class="n">url</span><span class="p">],</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="build_eqtl_evalset-63"><a href="#build_eqtl_evalset-63"><span class="linenos"> 63</span></a>        <span class="k">if</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">is_zipfile</span><span class="p">(</span><span class="n">gtex_zip</span><span class="p">):</span>
</span><span id="build_eqtl_evalset-64"><a href="#build_eqtl_evalset-64"><span class="linenos"> 64</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracting </span><span class="si">{</span><span class="n">gtex_zip</span><span class="si">}</span><span class="s2"> ...&quot;</span><span class="p">)</span>
</span><span id="build_eqtl_evalset-65"><a href="#build_eqtl_evalset-65"><span class="linenos"> 65</span></a>            <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">gtex_zip</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zip_ref</span><span class="p">:</span>
</span><span id="build_eqtl_evalset-66"><a href="#build_eqtl_evalset-66"><span class="linenos"> 66</span></a>                <span class="n">zip_ref</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">download_dir</span><span class="p">)</span>
</span><span id="build_eqtl_evalset-67"><a href="#build_eqtl_evalset-67"><span class="linenos"> 67</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracted GTEx data to: </span><span class="si">{</span><span class="n">download_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="build_eqtl_evalset-68"><a href="#build_eqtl_evalset-68"><span class="linenos"> 68</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="build_eqtl_evalset-69"><a href="#build_eqtl_evalset-69"><span class="linenos"> 69</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">gtex_zip</span><span class="si">}</span><span class="s2"> is not a valid zip archive. Please check the downloaded file.&quot;</span><span class="p">)</span>
</span><span id="build_eqtl_evalset-70"><a href="#build_eqtl_evalset-70"><span class="linenos"> 70</span></a>
</span><span id="build_eqtl_evalset-71"><a href="#build_eqtl_evalset-71"><span class="linenos"> 71</span></a>    <span class="c1"># 3️⃣ Load input candidate peak–gene links</span>
</span><span id="build_eqtl_evalset-72"><a href="#build_eqtl_evalset-72"><span class="linenos"> 72</span></a>    <span class="n">candidates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">candidate_csv</span><span class="p">)</span>
</span><span id="build_eqtl_evalset-73"><a href="#build_eqtl_evalset-73"><span class="linenos"> 73</span></a>    <span class="k">if</span> <span class="s2">&quot;gene_name&quot;</span> <span class="ow">in</span> <span class="n">candidates</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="build_eqtl_evalset-74"><a href="#build_eqtl_evalset-74"><span class="linenos"> 74</span></a>        <span class="n">candidates</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;gene_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Gene_name&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="build_eqtl_evalset-75"><a href="#build_eqtl_evalset-75"><span class="linenos"> 75</span></a>    <span class="n">candidates</span><span class="p">[</span><span class="s2">&quot;peak_gene_pair&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">candidates</span><span class="p">[</span><span class="s2">&quot;Peak&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">candidates</span><span class="p">[</span><span class="s2">&quot;Gene_name&quot;</span><span class="p">]</span>
</span><span id="build_eqtl_evalset-76"><a href="#build_eqtl_evalset-76"><span class="linenos"> 76</span></a>
</span><span id="build_eqtl_evalset-77"><a href="#build_eqtl_evalset-77"><span class="linenos"> 77</span></a>    <span class="c1"># 4️⃣ Load and concatenate 1000G variant BEDs</span>
</span><span id="build_eqtl_evalset-78"><a href="#build_eqtl_evalset-78"><span class="linenos"> 78</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading 1000G variant BED files...&quot;</span><span class="p">)</span>
</span><span id="build_eqtl_evalset-79"><a href="#build_eqtl_evalset-79"><span class="linenos"> 79</span></a>    <span class="n">bed_files</span> <span class="o">=</span> <span class="n">_process_1000g_bim_frq</span><span class="p">(</span><span class="n">plink_dir</span><span class="o">=</span><span class="n">plink_dir</span><span class="p">,</span> <span class="n">frq_dir</span><span class="o">=</span><span class="n">frq_dir</span><span class="p">,</span> <span class="n">maf_threshold</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
</span><span id="build_eqtl_evalset-80"><a href="#build_eqtl_evalset-80"><span class="linenos"> 80</span></a>    <span class="n">genomes_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
</span><span id="build_eqtl_evalset-81"><a href="#build_eqtl_evalset-81"><span class="linenos"> 81</span></a>        <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;CHROM&quot;</span><span class="p">,</span> <span class="s2">&quot;START&quot;</span><span class="p">,</span> <span class="s2">&quot;END&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">bed_files</span><span class="p">],</span>
</span><span id="build_eqtl_evalset-82"><a href="#build_eqtl_evalset-82"><span class="linenos"> 82</span></a>        <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="build_eqtl_evalset-83"><a href="#build_eqtl_evalset-83"><span class="linenos"> 83</span></a>    <span class="p">)</span>
</span><span id="build_eqtl_evalset-84"><a href="#build_eqtl_evalset-84"><span class="linenos"> 84</span></a>    <span class="n">genomes_df</span><span class="p">[</span><span class="s2">&quot;CHROM&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;chr&quot;</span> <span class="o">+</span> <span class="n">genomes_df</span><span class="p">[</span><span class="s2">&quot;CHROM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="build_eqtl_evalset-85"><a href="#build_eqtl_evalset-85"><span class="linenos"> 85</span></a>    <span class="n">valid_chroms</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;chr</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">23</span><span class="p">)]</span>
</span><span id="build_eqtl_evalset-86"><a href="#build_eqtl_evalset-86"><span class="linenos"> 86</span></a>    <span class="n">genomes_df</span> <span class="o">=</span> <span class="n">genomes_df</span><span class="p">[</span><span class="n">genomes_df</span><span class="p">[</span><span class="s1">&#39;CHROM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">valid_chroms</span><span class="p">)]</span>
</span><span id="build_eqtl_evalset-87"><a href="#build_eqtl_evalset-87"><span class="linenos"> 87</span></a>    <span class="n">variants_bed</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">PyRanges</span><span class="p">(</span>
</span><span id="build_eqtl_evalset-88"><a href="#build_eqtl_evalset-88"><span class="linenos"> 88</span></a>        <span class="n">genomes_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;CHROM&quot;</span><span class="p">:</span> <span class="s2">&quot;Chromosome&quot;</span><span class="p">,</span> <span class="s2">&quot;START&quot;</span><span class="p">:</span> <span class="s2">&quot;Start&quot;</span><span class="p">,</span> <span class="s2">&quot;END&quot;</span><span class="p">:</span> <span class="s2">&quot;End&quot;</span><span class="p">})</span>
</span><span id="build_eqtl_evalset-89"><a href="#build_eqtl_evalset-89"><span class="linenos"> 89</span></a>    <span class="p">)</span>
</span><span id="build_eqtl_evalset-90"><a href="#build_eqtl_evalset-90"><span class="linenos"> 90</span></a>
</span><span id="build_eqtl_evalset-91"><a href="#build_eqtl_evalset-91"><span class="linenos"> 91</span></a>    <span class="c1"># 5️⃣ Load and filter GTEx eQTLs</span>
</span><span id="build_eqtl_evalset-92"><a href="#build_eqtl_evalset-92"><span class="linenos"> 92</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading GTEx fine-mapping results...&quot;</span><span class="p">)</span>
</span><span id="build_eqtl_evalset-93"><a href="#build_eqtl_evalset-93"><span class="linenos"> 93</span></a>    <span class="n">gtex_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">gtex_file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
</span><span id="build_eqtl_evalset-94"><a href="#build_eqtl_evalset-94"><span class="linenos"> 94</span></a>    <span class="n">gtex_df</span> <span class="o">=</span> <span class="n">gtex_df</span><span class="p">[(</span><span class="n">gtex_df</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">gtex_method</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gtex_df</span><span class="o">.</span><span class="n">tissue</span> <span class="o">==</span> <span class="n">gtex_tissue</span><span class="p">)]</span>
</span><span id="build_eqtl_evalset-95"><a href="#build_eqtl_evalset-95"><span class="linenos"> 95</span></a>    <span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="build_eqtl_evalset-96"><a href="#build_eqtl_evalset-96"><span class="linenos"> 96</span></a>    <span class="n">gtex_df</span> <span class="o">=</span> <span class="n">_map_ensembl_to_symbol</span><span class="p">(</span><span class="n">gtex_df</span><span class="p">)</span> <span class="c1"># convert Ensembl IDs to gene symbols</span>
</span><span id="build_eqtl_evalset-97"><a href="#build_eqtl_evalset-97"><span class="linenos"> 97</span></a>    <span class="n">gtex_df</span> <span class="o">=</span> <span class="n">gtex_df</span><span class="p">[(</span><span class="o">~</span><span class="n">gtex_df</span><span class="p">[</span><span class="s1">&#39;GeneSymbol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">())]</span>
</span><span id="build_eqtl_evalset-98"><a href="#build_eqtl_evalset-98"><span class="linenos"> 98</span></a>    <span class="n">gtex_df</span> <span class="o">=</span> <span class="n">gtex_df</span><span class="p">[</span><span class="o">~</span><span class="n">gtex_df</span><span class="p">[</span><span class="s1">&#39;GeneSymbol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;ENSG&#39;</span><span class="p">)]</span>
</span><span id="build_eqtl_evalset-99"><a href="#build_eqtl_evalset-99"><span class="linenos"> 99</span></a>    <span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="build_eqtl_evalset-100"><a href="#build_eqtl_evalset-100"><span class="linenos">100</span></a>    <span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="build_eqtl_evalset-101"><a href="#build_eqtl_evalset-101"><span class="linenos">101</span></a>
</span><span id="build_eqtl_evalset-102"><a href="#build_eqtl_evalset-102"><span class="linenos">102</span></a>    <span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;chr_pos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;variant_hg38&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(chr[0-9XYM]+_\d+)&#39;</span><span class="p">)</span>
</span><span id="build_eqtl_evalset-103"><a href="#build_eqtl_evalset-103"><span class="linenos">103</span></a>    <span class="n">gtex_df</span><span class="p">[</span><span class="s1">&#39;pair&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gtex_df</span><span class="p">[</span><span class="s1">&#39;chr_pos&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">gtex_df</span><span class="p">[</span><span class="s1">&#39;GeneSymbol&#39;</span><span class="p">]</span>
</span><span id="build_eqtl_evalset-104"><a href="#build_eqtl_evalset-104"><span class="linenos">104</span></a>    <span class="n">pos_training</span> <span class="o">=</span> <span class="n">gtex_df</span><span class="p">[</span><span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;pip&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">pip_pos</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="s2">&quot;pair&quot;</span><span class="p">)</span>
</span><span id="build_eqtl_evalset-105"><a href="#build_eqtl_evalset-105"><span class="linenos">105</span></a>    <span class="n">neg_training</span> <span class="o">=</span> <span class="n">gtex_df</span><span class="p">[</span><span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;pip&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">pip_neg</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="s2">&quot;pair&quot;</span><span class="p">)</span>
</span><span id="build_eqtl_evalset-106"><a href="#build_eqtl_evalset-106"><span class="linenos">106</span></a>
</span><span id="build_eqtl_evalset-107"><a href="#build_eqtl_evalset-107"><span class="linenos">107</span></a>    <span class="c1"># 6️⃣ Overlap candidate peaks with variants</span>
</span><span id="build_eqtl_evalset-108"><a href="#build_eqtl_evalset-108"><span class="linenos">108</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Overlapping candidate peaks with variants...&quot;</span><span class="p">)</span>
</span><span id="build_eqtl_evalset-109"><a href="#build_eqtl_evalset-109"><span class="linenos">109</span></a>    <span class="n">split_lst</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">[</span><span class="s2">&quot;Peak&quot;</span><span class="p">]]</span>
</span><span id="build_eqtl_evalset-110"><a href="#build_eqtl_evalset-110"><span class="linenos">110</span></a>    <span class="n">ann_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">split_lst</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;CHROM&quot;</span><span class="p">,</span> <span class="s2">&quot;START&quot;</span><span class="p">,</span> <span class="s2">&quot;END&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s2">&quot;START&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s2">&quot;END&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">})</span>
</span><span id="build_eqtl_evalset-111"><a href="#build_eqtl_evalset-111"><span class="linenos">111</span></a>    <span class="n">ann_df</span><span class="p">[</span><span class="s2">&quot;Peak&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">candidates</span><span class="p">[</span><span class="s2">&quot;Peak&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="build_eqtl_evalset-112"><a href="#build_eqtl_evalset-112"><span class="linenos">112</span></a>    <span class="n">ann_pr</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">PyRanges</span><span class="p">(</span><span class="n">ann_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;CHROM&quot;</span><span class="p">:</span> <span class="s2">&quot;Chromosome&quot;</span><span class="p">,</span> <span class="s2">&quot;START&quot;</span><span class="p">:</span> <span class="s2">&quot;Start&quot;</span><span class="p">,</span> <span class="s2">&quot;END&quot;</span><span class="p">:</span> <span class="s2">&quot;End&quot;</span><span class="p">}))</span>
</span><span id="build_eqtl_evalset-113"><a href="#build_eqtl_evalset-113"><span class="linenos">113</span></a>    <span class="n">overlap_pr</span> <span class="o">=</span> <span class="n">variants_bed</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ann_pr</span><span class="p">)</span>
</span><span id="build_eqtl_evalset-114"><a href="#build_eqtl_evalset-114"><span class="linenos">114</span></a>    <span class="n">overlap_df</span> <span class="o">=</span> <span class="n">overlap_pr</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
</span><span id="build_eqtl_evalset-115"><a href="#build_eqtl_evalset-115"><span class="linenos">115</span></a>        <span class="s2">&quot;Chromosome&quot;</span><span class="p">:</span> <span class="s2">&quot;CHROM&quot;</span><span class="p">,</span>
</span><span id="build_eqtl_evalset-116"><a href="#build_eqtl_evalset-116"><span class="linenos">116</span></a>        <span class="s2">&quot;Start&quot;</span><span class="p">:</span> <span class="s2">&quot;POS&quot;</span><span class="p">,</span>
</span><span id="build_eqtl_evalset-117"><a href="#build_eqtl_evalset-117"><span class="linenos">117</span></a>        <span class="s2">&quot;End&quot;</span><span class="p">:</span> <span class="s2">&quot;POS2&quot;</span><span class="p">,</span>
</span><span id="build_eqtl_evalset-118"><a href="#build_eqtl_evalset-118"><span class="linenos">118</span></a>        <span class="s2">&quot;Start_b&quot;</span><span class="p">:</span> <span class="s2">&quot;START_ANN&quot;</span><span class="p">,</span>
</span><span id="build_eqtl_evalset-119"><a href="#build_eqtl_evalset-119"><span class="linenos">119</span></a>        <span class="s2">&quot;End_b&quot;</span><span class="p">:</span> <span class="s2">&quot;END_ANN&quot;</span><span class="p">,</span>
</span><span id="build_eqtl_evalset-120"><a href="#build_eqtl_evalset-120"><span class="linenos">120</span></a>    <span class="p">})</span>
</span><span id="build_eqtl_evalset-121"><a href="#build_eqtl_evalset-121"><span class="linenos">121</span></a>    <span class="n">overlap_df</span><span class="p">[</span><span class="s2">&quot;Peak&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="build_eqtl_evalset-122"><a href="#build_eqtl_evalset-122"><span class="linenos">122</span></a>        <span class="n">overlap_df</span><span class="p">[</span><span class="s2">&quot;CHROM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">overlap_df</span><span class="p">[</span><span class="s2">&quot;START_ANN&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">overlap_df</span><span class="p">[</span><span class="s2">&quot;END_ANN&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="build_eqtl_evalset-123"><a href="#build_eqtl_evalset-123"><span class="linenos">123</span></a>    <span class="p">)</span>
</span><span id="build_eqtl_evalset-124"><a href="#build_eqtl_evalset-124"><span class="linenos">124</span></a>
</span><span id="build_eqtl_evalset-125"><a href="#build_eqtl_evalset-125"><span class="linenos">125</span></a>    <span class="c1"># 7️⃣ Merge with candidate peaks and compute inverse distance</span>
</span><span id="build_eqtl_evalset-126"><a href="#build_eqtl_evalset-126"><span class="linenos">126</span></a>    <span class="n">merged</span> <span class="o">=</span> <span class="n">candidates</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">overlap_df</span><span class="p">[[</span><span class="s2">&quot;CHROM&quot;</span><span class="p">,</span> <span class="s2">&quot;POS&quot;</span><span class="p">,</span> <span class="s2">&quot;POS2&quot;</span><span class="p">,</span> <span class="s2">&quot;Peak&quot;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Peak&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
</span><span id="build_eqtl_evalset-127"><a href="#build_eqtl_evalset-127"><span class="linenos">127</span></a>    <span class="n">merged</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Gene_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Gene&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="build_eqtl_evalset-128"><a href="#build_eqtl_evalset-128"><span class="linenos">128</span></a>    <span class="k">if</span> <span class="s2">&quot;Distance_to_TSS&quot;</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="build_eqtl_evalset-129"><a href="#build_eqtl_evalset-129"><span class="linenos">129</span></a>        <span class="n">merged</span><span class="p">[</span><span class="s2">&quot;1/Distance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">merged</span><span class="p">[</span><span class="s2">&quot;Distance_to_TSS&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">upper</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="build_eqtl_evalset-130"><a href="#build_eqtl_evalset-130"><span class="linenos">130</span></a>    <span class="n">merged</span><span class="p">[</span><span class="s2">&quot;snp_gene_pair&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="s2">&quot;CHROM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">merged</span><span class="p">[</span><span class="s2">&quot;POS2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">merged</span><span class="p">[</span><span class="s2">&quot;Gene&quot;</span><span class="p">]</span>
</span><span id="build_eqtl_evalset-131"><a href="#build_eqtl_evalset-131"><span class="linenos">131</span></a>
</span><span id="build_eqtl_evalset-132"><a href="#build_eqtl_evalset-132"><span class="linenos">132</span></a>    <span class="c1"># 8️⃣ Label positives and negatives</span>
</span><span id="build_eqtl_evalset-133"><a href="#build_eqtl_evalset-133"><span class="linenos">133</span></a>    <span class="n">pos_df</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">merged</span><span class="o">.</span><span class="n">snp_gene_pair</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">pos_training</span><span class="o">.</span><span class="n">pair</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="build_eqtl_evalset-134"><a href="#build_eqtl_evalset-134"><span class="linenos">134</span></a>    <span class="n">pos_df</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="build_eqtl_evalset-135"><a href="#build_eqtl_evalset-135"><span class="linenos">135</span></a>    <span class="n">neg_df</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">merged</span><span class="o">.</span><span class="n">snp_gene_pair</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">neg_training</span><span class="o">.</span><span class="n">pair</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="build_eqtl_evalset-136"><a href="#build_eqtl_evalset-136"><span class="linenos">136</span></a>    <span class="n">neg_df</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="build_eqtl_evalset-137"><a href="#build_eqtl_evalset-137"><span class="linenos">137</span></a>
</span><span id="build_eqtl_evalset-138"><a href="#build_eqtl_evalset-138"><span class="linenos">138</span></a>    <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pos_df</span><span class="p">,</span> <span class="n">neg_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="s2">&quot;snp_gene_pair&quot;</span><span class="p">)</span>
</span><span id="build_eqtl_evalset-139"><a href="#build_eqtl_evalset-139"><span class="linenos">139</span></a>    <span class="n">final_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">final_df</span><span class="o">.</span><span class="n">CHROM</span>
</span><span id="build_eqtl_evalset-140"><a href="#build_eqtl_evalset-140"><span class="linenos">140</span></a>
</span><span id="build_eqtl_evalset-141"><a href="#build_eqtl_evalset-141"><span class="linenos">141</span></a>    <span class="n">final_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_csv</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="build_eqtl_evalset-142"><a href="#build_eqtl_evalset-142"><span class="linenos">142</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved labeled evaluation set to: </span><span class="si">{</span><span class="n">output_csv</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="build_eqtl_evalset-143"><a href="#build_eqtl_evalset-143"><span class="linenos">143</span></a>    <span class="k">return</span> <span class="n">final_df</span>
</span></pre></div>


            <div class="docstring"><p>Build a GTEx eQTL evaluation set (replicates the notebook logic).</p>

<p>This function downloads and prepares 1000G and GTEx data, overlaps peaks and variants,
computes inverse distance, and labels SNP–gene pairs based on PIP thresholds.</p>
</div>


                </section>
                <section id="liftover_df">
                            <input id="liftover_df-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">liftover_df</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">df</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span>,</span><span class="param">	<span class="n">chain_file</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">liftover_bin</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">out_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;./liftover_tmp&#39;</span>,</span><span class="param">	<span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;region&#39;</span></span><span class="return-annotation">) -> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span>:</span></span>

                <label class="view-source-button" for="liftover_df-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#liftover_df"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="liftover_df-329"><a href="#liftover_df-329"><span class="linenos">329</span></a><span class="k">def</span><span class="w"> </span><span class="nf">liftover_df</span><span class="p">(</span>
</span><span id="liftover_df-330"><a href="#liftover_df-330"><span class="linenos">330</span></a>    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
</span><span id="liftover_df-331"><a href="#liftover_df-331"><span class="linenos">331</span></a>    <span class="n">chain_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="liftover_df-332"><a href="#liftover_df-332"><span class="linenos">332</span></a>    <span class="n">liftover_bin</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="liftover_df-333"><a href="#liftover_df-333"><span class="linenos">333</span></a>    <span class="n">out_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;./liftover_tmp&quot;</span><span class="p">,</span>
</span><span id="liftover_df-334"><a href="#liftover_df-334"><span class="linenos">334</span></a>    <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;region&quot;</span>
</span><span id="liftover_df-335"><a href="#liftover_df-335"><span class="linenos">335</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="liftover_df-336"><a href="#liftover_df-336"><span class="linenos">336</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;LiftOver genomic coordinates in a DataFrame from one assembly to another.</span>
</span><span id="liftover_df-337"><a href="#liftover_df-337"><span class="linenos">337</span></a>
</span><span id="liftover_df-338"><a href="#liftover_df-338"><span class="linenos">338</span></a><span class="sd">    Args:</span>
</span><span id="liftover_df-339"><a href="#liftover_df-339"><span class="linenos">339</span></a><span class="sd">        df (pd.DataFrame): Must contain [&#39;CHROM&#39;, &#39;START&#39;, &#39;END&#39;] columns.</span>
</span><span id="liftover_df-340"><a href="#liftover_df-340"><span class="linenos">340</span></a><span class="sd">        chain_file (str): Path to UCSC chain file (e.g., hg19ToHg38.over.chain.gz).</span>
</span><span id="liftover_df-341"><a href="#liftover_df-341"><span class="linenos">341</span></a><span class="sd">        liftover_bin (str): Path to UCSC liftOver executable.</span>
</span><span id="liftover_df-342"><a href="#liftover_df-342"><span class="linenos">342</span></a><span class="sd">        out_dir (str): Directory to store intermediate and output files.</span>
</span><span id="liftover_df-343"><a href="#liftover_df-343"><span class="linenos">343</span></a><span class="sd">        prefix (str): Prefix for temp output files.</span>
</span><span id="liftover_df-344"><a href="#liftover_df-344"><span class="linenos">344</span></a>
</span><span id="liftover_df-345"><a href="#liftover_df-345"><span class="linenos">345</span></a><span class="sd">    Returns:</span>
</span><span id="liftover_df-346"><a href="#liftover_df-346"><span class="linenos">346</span></a><span class="sd">        pd.DataFrame: Liftover-converted DataFrame with same columns.</span>
</span><span id="liftover_df-347"><a href="#liftover_df-347"><span class="linenos">347</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="liftover_df-348"><a href="#liftover_df-348"><span class="linenos">348</span></a>    <span class="n">out_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span>
</span><span id="liftover_df-349"><a href="#liftover_df-349"><span class="linenos">349</span></a>    <span class="n">out_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="liftover_df-350"><a href="#liftover_df-350"><span class="linenos">350</span></a>
</span><span id="liftover_df-351"><a href="#liftover_df-351"><span class="linenos">351</span></a>    <span class="c1"># File paths</span>
</span><span id="liftover_df-352"><a href="#liftover_df-352"><span class="linenos">352</span></a>    <span class="n">bed_file</span> <span class="o">=</span> <span class="n">out_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">.bed&quot;</span>
</span><span id="liftover_df-353"><a href="#liftover_df-353"><span class="linenos">353</span></a>    <span class="n">out_hg38</span> <span class="o">=</span> <span class="n">out_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_lifted.bed&quot;</span>
</span><span id="liftover_df-354"><a href="#liftover_df-354"><span class="linenos">354</span></a>    <span class="n">out_unmapped</span> <span class="o">=</span> <span class="n">out_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_unmapped.bed&quot;</span>
</span><span id="liftover_df-355"><a href="#liftover_df-355"><span class="linenos">355</span></a>
</span><span id="liftover_df-356"><a href="#liftover_df-356"><span class="linenos">356</span></a>    <span class="c1"># Save input DataFrame as BED</span>
</span><span id="liftover_df-357"><a href="#liftover_df-357"><span class="linenos">357</span></a>    <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;CHROM&quot;</span><span class="p">,</span> <span class="s2">&quot;START&quot;</span><span class="p">,</span> <span class="s2">&quot;END&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">bed_file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="liftover_df-358"><a href="#liftover_df-358"><span class="linenos">358</span></a>
</span><span id="liftover_df-359"><a href="#liftover_df-359"><span class="linenos">359</span></a>    <span class="c1"># Run liftOver</span>
</span><span id="liftover_df-360"><a href="#liftover_df-360"><span class="linenos">360</span></a>    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">liftover_bin</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">bed_file</span><span class="p">),</span> <span class="n">chain_file</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">out_hg38</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">out_unmapped</span><span class="p">)]</span>
</span><span id="liftover_df-361"><a href="#liftover_df-361"><span class="linenos">361</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running: </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="liftover_df-362"><a href="#liftover_df-362"><span class="linenos">362</span></a>    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="liftover_df-363"><a href="#liftover_df-363"><span class="linenos">363</span></a>
</span><span id="liftover_df-364"><a href="#liftover_df-364"><span class="linenos">364</span></a>    <span class="c1"># Read lifted BED back in</span>
</span><span id="liftover_df-365"><a href="#liftover_df-365"><span class="linenos">365</span></a>    <span class="n">lifted</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">out_hg38</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;CHROM&quot;</span><span class="p">,</span> <span class="s2">&quot;START&quot;</span><span class="p">,</span> <span class="s2">&quot;END&quot;</span><span class="p">])</span>
</span><span id="liftover_df-366"><a href="#liftover_df-366"><span class="linenos">366</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Liftover completed! </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">lifted</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> regions mapped successfully.&quot;</span><span class="p">)</span>
</span><span id="liftover_df-367"><a href="#liftover_df-367"><span class="linenos">367</span></a>
</span><span id="liftover_df-368"><a href="#liftover_df-368"><span class="linenos">368</span></a>    <span class="k">return</span> <span class="n">lifted</span>
</span></pre></div>


            <div class="docstring"><p>LiftOver genomic coordinates in a DataFrame from one assembly to another.</p>

<p>Args:
    df (pd.DataFrame): Must contain ['CHROM', 'START', 'END'] columns.
    chain_file (str): Path to UCSC chain file (e.g., hg19ToHg38.over.chain.gz).
    liftover_bin (str): Path to UCSC liftOver executable.
    out_dir (str): Directory to store intermediate and output files.
    prefix (str): Prefix for temp output files.</p>

<p>Returns:
    pd.DataFrame: Liftover-converted DataFrame with same columns.</p>
</div>


                </section>
                <section id="load_gtex_finemap">
                            <input id="load_gtex_finemap-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">load_gtex_finemap</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">gtex_path</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">tissue</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Whole_Blood&#39;</span>,</span><span class="param">	<span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;SUSIE&#39;</span></span><span class="return-annotation">) -> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span>:</span></span>

                <label class="view-source-button" for="load_gtex_finemap-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#load_gtex_finemap"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="load_gtex_finemap-405"><a href="#load_gtex_finemap-405"><span class="linenos">405</span></a><span class="k">def</span><span class="w"> </span><span class="nf">load_gtex_finemap</span><span class="p">(</span>
</span><span id="load_gtex_finemap-406"><a href="#load_gtex_finemap-406"><span class="linenos">406</span></a>    <span class="n">gtex_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="load_gtex_finemap-407"><a href="#load_gtex_finemap-407"><span class="linenos">407</span></a>    <span class="n">tissue</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Whole_Blood&quot;</span><span class="p">,</span>
</span><span id="load_gtex_finemap-408"><a href="#load_gtex_finemap-408"><span class="linenos">408</span></a>    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;SUSIE&quot;</span><span class="p">,</span>
</span><span id="load_gtex_finemap-409"><a href="#load_gtex_finemap-409"><span class="linenos">409</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="load_gtex_finemap-410"><a href="#load_gtex_finemap-410"><span class="linenos">410</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="load_gtex_finemap-411"><a href="#load_gtex_finemap-411"><span class="linenos">411</span></a><span class="sd">    Load and preprocess GTEx fine-mapping results for a selected tissue and method.</span>
</span><span id="load_gtex_finemap-412"><a href="#load_gtex_finemap-412"><span class="linenos">412</span></a>
</span><span id="load_gtex_finemap-413"><a href="#load_gtex_finemap-413"><span class="linenos">413</span></a><span class="sd">    Args:</span>
</span><span id="load_gtex_finemap-414"><a href="#load_gtex_finemap-414"><span class="linenos">414</span></a><span class="sd">        gtex_path (str): Path to the GTEx fine-mapping file (e.g. GTEx_49tissues_release1.tsv.bgz).</span>
</span><span id="load_gtex_finemap-415"><a href="#load_gtex_finemap-415"><span class="linenos">415</span></a><span class="sd">        tissue (str): GTEx tissue name to filter for (default: &quot;Whole_Blood&quot;).</span>
</span><span id="load_gtex_finemap-416"><a href="#load_gtex_finemap-416"><span class="linenos">416</span></a><span class="sd">        method (str): Fine-mapping method (default: &quot;SUSIE&quot;).</span>
</span><span id="load_gtex_finemap-417"><a href="#load_gtex_finemap-417"><span class="linenos">417</span></a>
</span><span id="load_gtex_finemap-418"><a href="#load_gtex_finemap-418"><span class="linenos">418</span></a><span class="sd">    Returns:</span>
</span><span id="load_gtex_finemap-419"><a href="#load_gtex_finemap-419"><span class="linenos">419</span></a><span class="sd">        pd.DataFrame: Filtered GTEx fine-mapping DataFrame with columns:</span>
</span><span id="load_gtex_finemap-420"><a href="#load_gtex_finemap-420"><span class="linenos">420</span></a><span class="sd">                      [&#39;chr_pos&#39;, &#39;GeneSymbol&#39;, &#39;pair&#39;, &#39;pip&#39;, ...]</span>
</span><span id="load_gtex_finemap-421"><a href="#load_gtex_finemap-421"><span class="linenos">421</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="load_gtex_finemap-422"><a href="#load_gtex_finemap-422"><span class="linenos">422</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading GTEx fine-mapping data from: </span><span class="si">{</span><span class="n">gtex_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="load_gtex_finemap-423"><a href="#load_gtex_finemap-423"><span class="linenos">423</span></a>    <span class="n">gtex_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">gtex_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">)</span>
</span><span id="load_gtex_finemap-424"><a href="#load_gtex_finemap-424"><span class="linenos">424</span></a>
</span><span id="load_gtex_finemap-425"><a href="#load_gtex_finemap-425"><span class="linenos">425</span></a>    <span class="c1"># Filter for method and tissue</span>
</span><span id="load_gtex_finemap-426"><a href="#load_gtex_finemap-426"><span class="linenos">426</span></a>    <span class="n">gtex_df</span> <span class="o">=</span> <span class="n">gtex_df</span><span class="p">[(</span><span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">method</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;tissue&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tissue</span><span class="p">)]</span>
</span><span id="load_gtex_finemap-427"><a href="#load_gtex_finemap-427"><span class="linenos">427</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filtered for </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">tissue</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gtex_df</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> entries&quot;</span><span class="p">)</span>
</span><span id="load_gtex_finemap-428"><a href="#load_gtex_finemap-428"><span class="linenos">428</span></a>
</span><span id="load_gtex_finemap-429"><a href="#load_gtex_finemap-429"><span class="linenos">429</span></a>    <span class="c1"># Clean gene IDs (remove version suffix)</span>
</span><span id="load_gtex_finemap-430"><a href="#load_gtex_finemap-430"><span class="linenos">430</span></a>    <span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;gene&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="load_gtex_finemap-431"><a href="#load_gtex_finemap-431"><span class="linenos">431</span></a>
</span><span id="load_gtex_finemap-432"><a href="#load_gtex_finemap-432"><span class="linenos">432</span></a>    <span class="c1"># Map Ensembl → GeneSymbol if function provided</span>
</span><span id="load_gtex_finemap-433"><a href="#load_gtex_finemap-433"><span class="linenos">433</span></a>    <span class="n">gtex_df</span> <span class="o">=</span> <span class="n">_map_ensembl_to_symbol</span><span class="p">(</span><span class="n">gtex_df</span><span class="p">)</span>
</span><span id="load_gtex_finemap-434"><a href="#load_gtex_finemap-434"><span class="linenos">434</span></a>    <span class="n">gtex_df</span> <span class="o">=</span> <span class="n">gtex_df</span><span class="p">[</span><span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;GeneSymbol&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()]</span>
</span><span id="load_gtex_finemap-435"><a href="#load_gtex_finemap-435"><span class="linenos">435</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🔠 Added GeneSymbol for </span><span class="si">{</span><span class="n">gtex_df</span><span class="p">[</span><span class="s1">&#39;GeneSymbol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> genes&quot;</span><span class="p">)</span>
</span><span id="load_gtex_finemap-436"><a href="#load_gtex_finemap-436"><span class="linenos">436</span></a>
</span><span id="load_gtex_finemap-437"><a href="#load_gtex_finemap-437"><span class="linenos">437</span></a>    <span class="c1"># Extract chr_pos and build SNP–gene pair ID</span>
</span><span id="load_gtex_finemap-438"><a href="#load_gtex_finemap-438"><span class="linenos">438</span></a>    <span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;chr_pos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;variant_hg38&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(chr[0-9XYM]+_\d+)&quot;</span><span class="p">)</span>
</span><span id="load_gtex_finemap-439"><a href="#load_gtex_finemap-439"><span class="linenos">439</span></a>    <span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;pair&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;chr_pos&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">gtex_df</span><span class="p">[</span><span class="s2">&quot;GeneSymbol&quot;</span><span class="p">]</span>
</span><span id="load_gtex_finemap-440"><a href="#load_gtex_finemap-440"><span class="linenos">440</span></a>
</span><span id="load_gtex_finemap-441"><a href="#load_gtex_finemap-441"><span class="linenos">441</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final GTEx dataset ready with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gtex_df</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> SNP–gene pairs&quot;</span><span class="p">)</span>
</span><span id="load_gtex_finemap-442"><a href="#load_gtex_finemap-442"><span class="linenos">442</span></a>    <span class="k">return</span> <span class="n">gtex_df</span>
</span></pre></div>


            <div class="docstring"><p>Load and preprocess GTEx fine-mapping results for a selected tissue and method.</p>

<p>Args:
    gtex_path (str): Path to the GTEx fine-mapping file (e.g. GTEx_49tissues_release1.tsv.bgz).
    tissue (str): GTEx tissue name to filter for (default: "Whole_Blood").
    method (str): Fine-mapping method (default: "SUSIE").</p>

<p>Returns:
    pd.DataFrame: Filtered GTEx fine-mapping DataFrame with columns:
                  ['chr_pos', 'GeneSymbol', 'pair', 'pip', ...]</p>
</div>


                </section>
                <section id="overlap_variants_with_peaks">
                            <input id="overlap_variants_with_peaks-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">overlap_variants_with_peaks</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">candidates</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span>,</span><span class="param">	<span class="n">variants_bed</span><span class="p">:</span> <span class="n">pyranges</span><span class="o">.</span><span class="n">pyranges_main</span><span class="o">.</span><span class="n">PyRanges</span></span><span class="return-annotation">) -> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span>:</span></span>

                <label class="view-source-button" for="overlap_variants_with_peaks-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#overlap_variants_with_peaks"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="overlap_variants_with_peaks-444"><a href="#overlap_variants_with_peaks-444"><span class="linenos">444</span></a><span class="k">def</span><span class="w"> </span><span class="nf">overlap_variants_with_peaks</span><span class="p">(</span><span class="n">candidates</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">variants_bed</span><span class="p">:</span> <span class="n">pr</span><span class="o">.</span><span class="n">PyRanges</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="overlap_variants_with_peaks-445"><a href="#overlap_variants_with_peaks-445"><span class="linenos">445</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="overlap_variants_with_peaks-446"><a href="#overlap_variants_with_peaks-446"><span class="linenos">446</span></a><span class="sd">    Convert candidate peaks into PyRanges and find overlaps with variant coordinates.</span>
</span><span id="overlap_variants_with_peaks-447"><a href="#overlap_variants_with_peaks-447"><span class="linenos">447</span></a>
</span><span id="overlap_variants_with_peaks-448"><a href="#overlap_variants_with_peaks-448"><span class="linenos">448</span></a><span class="sd">    Args:</span>
</span><span id="overlap_variants_with_peaks-449"><a href="#overlap_variants_with_peaks-449"><span class="linenos">449</span></a><span class="sd">        candidates (pd.DataFrame): Must contain a &#39;Peak&#39; column in &#39;chr:start-end&#39; or &#39;chr_start_end&#39; format.</span>
</span><span id="overlap_variants_with_peaks-450"><a href="#overlap_variants_with_peaks-450"><span class="linenos">450</span></a><span class="sd">        variants_bed (pr.PyRanges): PyRanges object of variant coordinates.</span>
</span><span id="overlap_variants_with_peaks-451"><a href="#overlap_variants_with_peaks-451"><span class="linenos">451</span></a>
</span><span id="overlap_variants_with_peaks-452"><a href="#overlap_variants_with_peaks-452"><span class="linenos">452</span></a><span class="sd">    Returns:</span>
</span><span id="overlap_variants_with_peaks-453"><a href="#overlap_variants_with_peaks-453"><span class="linenos">453</span></a><span class="sd">        pd.DataFrame: DataFrame of overlapping variants and peaks with standardized columns.</span>
</span><span id="overlap_variants_with_peaks-454"><a href="#overlap_variants_with_peaks-454"><span class="linenos">454</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="overlap_variants_with_peaks-455"><a href="#overlap_variants_with_peaks-455"><span class="linenos">455</span></a>    <span class="c1"># Parse candidate Peak strings → chrom/start/end</span>
</span><span id="overlap_variants_with_peaks-456"><a href="#overlap_variants_with_peaks-456"><span class="linenos">456</span></a>    <span class="n">peaks_df</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="overlap_variants_with_peaks-457"><a href="#overlap_variants_with_peaks-457"><span class="linenos">457</span></a>        <span class="n">candidates</span><span class="p">[</span><span class="s2">&quot;Peak&quot;</span><span class="p">]</span>
</span><span id="overlap_variants_with_peaks-458"><a href="#overlap_variants_with_peaks-458"><span class="linenos">458</span></a>        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="overlap_variants_with_peaks-459"><a href="#overlap_variants_with_peaks-459"><span class="linenos">459</span></a>        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="overlap_variants_with_peaks-460"><a href="#overlap_variants_with_peaks-460"><span class="linenos">460</span></a>        <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;CHROM&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;START&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;END&quot;</span><span class="p">})</span>
</span><span id="overlap_variants_with_peaks-461"><a href="#overlap_variants_with_peaks-461"><span class="linenos">461</span></a>        <span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s2">&quot;START&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s2">&quot;END&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">})</span>
</span><span id="overlap_variants_with_peaks-462"><a href="#overlap_variants_with_peaks-462"><span class="linenos">462</span></a>    <span class="p">)</span>
</span><span id="overlap_variants_with_peaks-463"><a href="#overlap_variants_with_peaks-463"><span class="linenos">463</span></a>    <span class="n">peaks_df</span><span class="p">[</span><span class="s2">&quot;Peak&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">candidates</span><span class="p">[</span><span class="s2">&quot;Peak&quot;</span><span class="p">]</span>
</span><span id="overlap_variants_with_peaks-464"><a href="#overlap_variants_with_peaks-464"><span class="linenos">464</span></a>
</span><span id="overlap_variants_with_peaks-465"><a href="#overlap_variants_with_peaks-465"><span class="linenos">465</span></a>    <span class="c1"># Convert to PyRanges</span>
</span><span id="overlap_variants_with_peaks-466"><a href="#overlap_variants_with_peaks-466"><span class="linenos">466</span></a>    <span class="n">peak_pr</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">PyRanges</span><span class="p">(</span><span class="n">peaks_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
</span><span id="overlap_variants_with_peaks-467"><a href="#overlap_variants_with_peaks-467"><span class="linenos">467</span></a>        <span class="s2">&quot;CHROM&quot;</span><span class="p">:</span> <span class="s2">&quot;Chromosome&quot;</span><span class="p">,</span> <span class="s2">&quot;START&quot;</span><span class="p">:</span> <span class="s2">&quot;Start&quot;</span><span class="p">,</span> <span class="s2">&quot;END&quot;</span><span class="p">:</span> <span class="s2">&quot;End&quot;</span>
</span><span id="overlap_variants_with_peaks-468"><a href="#overlap_variants_with_peaks-468"><span class="linenos">468</span></a>    <span class="p">}))</span>
</span><span id="overlap_variants_with_peaks-469"><a href="#overlap_variants_with_peaks-469"><span class="linenos">469</span></a>
</span><span id="overlap_variants_with_peaks-470"><a href="#overlap_variants_with_peaks-470"><span class="linenos">470</span></a>    <span class="c1"># Find overlaps</span>
</span><span id="overlap_variants_with_peaks-471"><a href="#overlap_variants_with_peaks-471"><span class="linenos">471</span></a>    <span class="n">overlap_df</span> <span class="o">=</span> <span class="n">variants_bed</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">peak_pr</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
</span><span id="overlap_variants_with_peaks-472"><a href="#overlap_variants_with_peaks-472"><span class="linenos">472</span></a>        <span class="s2">&quot;Chromosome&quot;</span><span class="p">:</span> <span class="s2">&quot;CHROM&quot;</span><span class="p">,</span>
</span><span id="overlap_variants_with_peaks-473"><a href="#overlap_variants_with_peaks-473"><span class="linenos">473</span></a>        <span class="s2">&quot;Start&quot;</span><span class="p">:</span> <span class="s2">&quot;POS&quot;</span><span class="p">,</span>
</span><span id="overlap_variants_with_peaks-474"><a href="#overlap_variants_with_peaks-474"><span class="linenos">474</span></a>        <span class="s2">&quot;End&quot;</span><span class="p">:</span> <span class="s2">&quot;POS2&quot;</span><span class="p">,</span>
</span><span id="overlap_variants_with_peaks-475"><a href="#overlap_variants_with_peaks-475"><span class="linenos">475</span></a>        <span class="s2">&quot;Start_b&quot;</span><span class="p">:</span> <span class="s2">&quot;START_ANN&quot;</span><span class="p">,</span>
</span><span id="overlap_variants_with_peaks-476"><a href="#overlap_variants_with_peaks-476"><span class="linenos">476</span></a>        <span class="s2">&quot;End_b&quot;</span><span class="p">:</span> <span class="s2">&quot;END_ANN&quot;</span><span class="p">,</span>
</span><span id="overlap_variants_with_peaks-477"><a href="#overlap_variants_with_peaks-477"><span class="linenos">477</span></a>    <span class="p">})</span>
</span><span id="overlap_variants_with_peaks-478"><a href="#overlap_variants_with_peaks-478"><span class="linenos">478</span></a>
</span><span id="overlap_variants_with_peaks-479"><a href="#overlap_variants_with_peaks-479"><span class="linenos">479</span></a>    <span class="c1"># Standardize Peak ID</span>
</span><span id="overlap_variants_with_peaks-480"><a href="#overlap_variants_with_peaks-480"><span class="linenos">480</span></a>    <span class="n">overlap_df</span><span class="p">[</span><span class="s2">&quot;Peak&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="overlap_variants_with_peaks-481"><a href="#overlap_variants_with_peaks-481"><span class="linenos">481</span></a>        <span class="n">overlap_df</span><span class="p">[</span><span class="s2">&quot;CHROM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span>
</span><span id="overlap_variants_with_peaks-482"><a href="#overlap_variants_with_peaks-482"><span class="linenos">482</span></a>        <span class="n">overlap_df</span><span class="p">[</span><span class="s2">&quot;START_ANN&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span>
</span><span id="overlap_variants_with_peaks-483"><a href="#overlap_variants_with_peaks-483"><span class="linenos">483</span></a>        <span class="n">overlap_df</span><span class="p">[</span><span class="s2">&quot;END_ANN&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</span><span id="overlap_variants_with_peaks-484"><a href="#overlap_variants_with_peaks-484"><span class="linenos">484</span></a>    <span class="p">)</span>
</span><span id="overlap_variants_with_peaks-485"><a href="#overlap_variants_with_peaks-485"><span class="linenos">485</span></a>
</span><span id="overlap_variants_with_peaks-486"><a href="#overlap_variants_with_peaks-486"><span class="linenos">486</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">overlap_df</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> overlapping variant–peak records.&quot;</span><span class="p">)</span>
</span><span id="overlap_variants_with_peaks-487"><a href="#overlap_variants_with_peaks-487"><span class="linenos">487</span></a>    <span class="k">return</span> <span class="n">overlap_df</span>
</span></pre></div>


            <div class="docstring"><p>Convert candidate peaks into PyRanges and find overlaps with variant coordinates.</p>

<p>Args:
    candidates (pd.DataFrame): Must contain a 'Peak' column in 'chr:start-end' or 'chr_start_end' format.
    variants_bed (pr.PyRanges): PyRanges object of variant coordinates.</p>

<p>Returns:
    pd.DataFrame: DataFrame of overlapping variants and peaks with standardized columns.</p>
</div>


                </section>
                <section id="merge_and_label_eqtl_pairs">
                            <input id="merge_and_label_eqtl_pairs-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">merge_and_label_eqtl_pairs</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">candidates</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span>,</span><span class="param">	<span class="n">overlap_df</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span>,</span><span class="param">	<span class="n">pos_training</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span>,</span><span class="param">	<span class="n">neg_training</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span></span><span class="return-annotation">) -> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span>:</span></span>

                <label class="view-source-button" for="merge_and_label_eqtl_pairs-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#merge_and_label_eqtl_pairs"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="merge_and_label_eqtl_pairs-489"><a href="#merge_and_label_eqtl_pairs-489"><span class="linenos">489</span></a><span class="k">def</span><span class="w"> </span><span class="nf">merge_and_label_eqtl_pairs</span><span class="p">(</span>
</span><span id="merge_and_label_eqtl_pairs-490"><a href="#merge_and_label_eqtl_pairs-490"><span class="linenos">490</span></a>    <span class="n">candidates</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
</span><span id="merge_and_label_eqtl_pairs-491"><a href="#merge_and_label_eqtl_pairs-491"><span class="linenos">491</span></a>    <span class="n">overlap_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
</span><span id="merge_and_label_eqtl_pairs-492"><a href="#merge_and_label_eqtl_pairs-492"><span class="linenos">492</span></a>    <span class="n">pos_training</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
</span><span id="merge_and_label_eqtl_pairs-493"><a href="#merge_and_label_eqtl_pairs-493"><span class="linenos">493</span></a>    <span class="n">neg_training</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
</span><span id="merge_and_label_eqtl_pairs-494"><a href="#merge_and_label_eqtl_pairs-494"><span class="linenos">494</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="merge_and_label_eqtl_pairs-495"><a href="#merge_and_label_eqtl_pairs-495"><span class="linenos">495</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Merge overlap results with candidate peaks and label SNP–gene pairs.&quot;&quot;&quot;</span>
</span><span id="merge_and_label_eqtl_pairs-496"><a href="#merge_and_label_eqtl_pairs-496"><span class="linenos">496</span></a>    <span class="n">merged</span> <span class="o">=</span> <span class="n">candidates</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">overlap_df</span><span class="p">[[</span><span class="s2">&quot;CHROM&quot;</span><span class="p">,</span><span class="s2">&quot;POS&quot;</span><span class="p">,</span><span class="s2">&quot;POS2&quot;</span><span class="p">,</span><span class="s2">&quot;Peak&quot;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Peak&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
</span><span id="merge_and_label_eqtl_pairs-497"><a href="#merge_and_label_eqtl_pairs-497"><span class="linenos">497</span></a>    <span class="n">merged</span> <span class="o">=</span> <span class="n">merged</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Gene_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Gene&quot;</span><span class="p">})</span>
</span><span id="merge_and_label_eqtl_pairs-498"><a href="#merge_and_label_eqtl_pairs-498"><span class="linenos">498</span></a>
</span><span id="merge_and_label_eqtl_pairs-499"><a href="#merge_and_label_eqtl_pairs-499"><span class="linenos">499</span></a>    <span class="k">if</span> <span class="s2">&quot;Distance_to_TSS&quot;</span> <span class="ow">in</span> <span class="n">merged</span><span class="p">:</span>
</span><span id="merge_and_label_eqtl_pairs-500"><a href="#merge_and_label_eqtl_pairs-500"><span class="linenos">500</span></a>        <span class="n">merged</span><span class="p">[</span><span class="s2">&quot;1/Distance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">merged</span><span class="p">[</span><span class="s2">&quot;Distance_to_TSS&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">upper</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="merge_and_label_eqtl_pairs-501"><a href="#merge_and_label_eqtl_pairs-501"><span class="linenos">501</span></a>
</span><span id="merge_and_label_eqtl_pairs-502"><a href="#merge_and_label_eqtl_pairs-502"><span class="linenos">502</span></a>    <span class="n">merged</span><span class="p">[</span><span class="s2">&quot;snp_gene_pair&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="merge_and_label_eqtl_pairs-503"><a href="#merge_and_label_eqtl_pairs-503"><span class="linenos">503</span></a>        <span class="n">merged</span><span class="p">[</span><span class="s2">&quot;CHROM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span>
</span><span id="merge_and_label_eqtl_pairs-504"><a href="#merge_and_label_eqtl_pairs-504"><span class="linenos">504</span></a>        <span class="n">merged</span><span class="p">[</span><span class="s2">&quot;POS2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span>
</span><span id="merge_and_label_eqtl_pairs-505"><a href="#merge_and_label_eqtl_pairs-505"><span class="linenos">505</span></a>        <span class="n">merged</span><span class="p">[</span><span class="s2">&quot;Gene&quot;</span><span class="p">]</span>
</span><span id="merge_and_label_eqtl_pairs-506"><a href="#merge_and_label_eqtl_pairs-506"><span class="linenos">506</span></a>    <span class="p">)</span>
</span><span id="merge_and_label_eqtl_pairs-507"><a href="#merge_and_label_eqtl_pairs-507"><span class="linenos">507</span></a>
</span><span id="merge_and_label_eqtl_pairs-508"><a href="#merge_and_label_eqtl_pairs-508"><span class="linenos">508</span></a>    <span class="n">pos_df</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">merged</span><span class="o">.</span><span class="n">snp_gene_pair</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">pos_training</span><span class="p">[</span><span class="s2">&quot;pair&quot;</span><span class="p">])]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="merge_and_label_eqtl_pairs-509"><a href="#merge_and_label_eqtl_pairs-509"><span class="linenos">509</span></a>    <span class="n">neg_df</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">merged</span><span class="o">.</span><span class="n">snp_gene_pair</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">neg_training</span><span class="p">[</span><span class="s2">&quot;pair&quot;</span><span class="p">])]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="merge_and_label_eqtl_pairs-510"><a href="#merge_and_label_eqtl_pairs-510"><span class="linenos">510</span></a>
</span><span id="merge_and_label_eqtl_pairs-511"><a href="#merge_and_label_eqtl_pairs-511"><span class="linenos">511</span></a>    <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pos_df</span><span class="p">,</span> <span class="n">neg_df</span><span class="p">])</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="s2">&quot;snp_gene_pair&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;CHROM&quot;</span><span class="p">)</span>
</span><span id="merge_and_label_eqtl_pairs-512"><a href="#merge_and_label_eqtl_pairs-512"><span class="linenos">512</span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;total </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">final_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> pairs.&quot;</span><span class="p">)</span>
</span><span id="merge_and_label_eqtl_pairs-513"><a href="#merge_and_label_eqtl_pairs-513"><span class="linenos">513</span></a>    <span class="k">return</span> <span class="n">final_df</span>
</span></pre></div>


            <div class="docstring"><p>Merge overlap results with candidate peaks and label SNP–gene pairs.</p>
</div>


                </section>
                <section id="build_crispr_evalset">
                            <input id="build_crispr_evalset-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">build_crispr_evalset</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">candidate</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span>,</span><span class="param">	<span class="n">crispr_file</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">adata_cg_genes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">output_csv</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">peak_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Peak&#39;</span>,</span><span class="param">	<span class="n">gene_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Gene_name&#39;</span>,</span><span class="param">	<span class="n">distance_col</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Distance_to_TSS&#39;</span></span><span class="return-annotation">) -> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span>:</span></span>

                <label class="view-source-button" for="build_crispr_evalset-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#build_crispr_evalset"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="build_crispr_evalset-516"><a href="#build_crispr_evalset-516"><span class="linenos">516</span></a><span class="k">def</span><span class="w"> </span><span class="nf">build_crispr_evalset</span><span class="p">(</span>
</span><span id="build_crispr_evalset-517"><a href="#build_crispr_evalset-517"><span class="linenos">517</span></a>    <span class="n">candidate</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
</span><span id="build_crispr_evalset-518"><a href="#build_crispr_evalset-518"><span class="linenos">518</span></a>    <span class="n">crispr_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="build_crispr_evalset-519"><a href="#build_crispr_evalset-519"><span class="linenos">519</span></a>    <span class="n">adata_cg_genes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="build_crispr_evalset-520"><a href="#build_crispr_evalset-520"><span class="linenos">520</span></a>    <span class="n">output_csv</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="build_crispr_evalset-521"><a href="#build_crispr_evalset-521"><span class="linenos">521</span></a>    <span class="n">peak_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Peak&quot;</span><span class="p">,</span>
</span><span id="build_crispr_evalset-522"><a href="#build_crispr_evalset-522"><span class="linenos">522</span></a>    <span class="n">gene_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Gene_name&quot;</span><span class="p">,</span>
</span><span id="build_crispr_evalset-523"><a href="#build_crispr_evalset-523"><span class="linenos">523</span></a>    <span class="n">distance_col</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Distance_to_TSS&quot;</span><span class="p">,</span>
</span><span id="build_crispr_evalset-524"><a href="#build_crispr_evalset-524"><span class="linenos">524</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="build_crispr_evalset-525"><a href="#build_crispr_evalset-525"><span class="linenos">525</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Construct a CRISPR evaluation set from candidate peak–gene links.</span>
</span><span id="build_crispr_evalset-526"><a href="#build_crispr_evalset-526"><span class="linenos">526</span></a>
</span><span id="build_crispr_evalset-527"><a href="#build_crispr_evalset-527"><span class="linenos">527</span></a><span class="sd">    This overlaps CRISPR enhancer elements with candidate peaks, keeps rows where</span>
</span><span id="build_crispr_evalset-528"><a href="#build_crispr_evalset-528"><span class="linenos">528</span></a><span class="sd">    the CRISPR measured gene matches the candidate gene, optionally filters to genes</span>
</span><span id="build_crispr_evalset-529"><a href="#build_crispr_evalset-529"><span class="linenos">529</span></a><span class="sd">    present in your RNA modality, and assigns labels from the CRISPR benchmark.</span>
</span><span id="build_crispr_evalset-530"><a href="#build_crispr_evalset-530"><span class="linenos">530</span></a>
</span><span id="build_crispr_evalset-531"><a href="#build_crispr_evalset-531"><span class="linenos">531</span></a><span class="sd">    Args:</span>
</span><span id="build_crispr_evalset-532"><a href="#build_crispr_evalset-532"><span class="linenos">532</span></a><span class="sd">        candidate: candidate peak–gene links (BMMC or other).</span>
</span><span id="build_crispr_evalset-533"><a href="#build_crispr_evalset-533"><span class="linenos">533</span></a><span class="sd">        crispr_file: Path to CRISPR benchmark TSV (gzipped), with columns</span>
</span><span id="build_crispr_evalset-534"><a href="#build_crispr_evalset-534"><span class="linenos">534</span></a><span class="sd">            ``chrom``, ``chromStart``, ``chromEnd``, ``measuredGeneSymbol``, ``Regulated``.</span>
</span><span id="build_crispr_evalset-535"><a href="#build_crispr_evalset-535"><span class="linenos">535</span></a><span class="sd">        adata_cg_genes: Optional list of genes detected in RNA</span>
</span><span id="build_crispr_evalset-536"><a href="#build_crispr_evalset-536"><span class="linenos">536</span></a><span class="sd">            (to filter CRISPR overlaps to your assay&#39;s gene set).</span>
</span><span id="build_crispr_evalset-537"><a href="#build_crispr_evalset-537"><span class="linenos">537</span></a><span class="sd">        output_csv: If provided, write the labeled set to this path.</span>
</span><span id="build_crispr_evalset-538"><a href="#build_crispr_evalset-538"><span class="linenos">538</span></a><span class="sd">        peak_col: Column in candidates containing peak coordinates. Defaults to ``&quot;Peak&quot;``.</span>
</span><span id="build_crispr_evalset-539"><a href="#build_crispr_evalset-539"><span class="linenos">539</span></a><span class="sd">        gene_col: Column in candidates containing gene ID/symbol. Defaults to ``&quot;Gene_name&quot;``.</span>
</span><span id="build_crispr_evalset-540"><a href="#build_crispr_evalset-540"><span class="linenos">540</span></a><span class="sd">        distance_col: Column in candidates with distance to TSS in bp.</span>
</span><span id="build_crispr_evalset-541"><a href="#build_crispr_evalset-541"><span class="linenos">541</span></a><span class="sd">            If provided and present, a ``1/Distance`` feature will be added.</span>
</span><span id="build_crispr_evalset-542"><a href="#build_crispr_evalset-542"><span class="linenos">542</span></a>
</span><span id="build_crispr_evalset-543"><a href="#build_crispr_evalset-543"><span class="linenos">543</span></a><span class="sd">    Returns:</span>
</span><span id="build_crispr_evalset-544"><a href="#build_crispr_evalset-544"><span class="linenos">544</span></a><span class="sd">        Labeled CRISPR evaluation set with ``Peak``, ``Gene``, ``label`` (1/0),</span>
</span><span id="build_crispr_evalset-545"><a href="#build_crispr_evalset-545"><span class="linenos">545</span></a><span class="sd">        and optional ``1/Distance``.</span>
</span><span id="build_crispr_evalset-546"><a href="#build_crispr_evalset-546"><span class="linenos">546</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="build_crispr_evalset-547"><a href="#build_crispr_evalset-547"><span class="linenos">547</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Building CRISPR evaluation set...&quot;</span><span class="p">)</span>
</span><span id="build_crispr_evalset-548"><a href="#build_crispr_evalset-548"><span class="linenos">548</span></a>    <span class="n">candidates</span> <span class="o">=</span> <span class="n">_load_and_validate_candidates</span><span class="p">(</span><span class="n">candidate</span><span class="p">,</span> <span class="n">peak_col</span><span class="p">,</span> <span class="n">gene_col</span><span class="p">,</span> <span class="n">distance_col</span><span class="p">)</span>
</span><span id="build_crispr_evalset-549"><a href="#build_crispr_evalset-549"><span class="linenos">549</span></a>    <span class="n">crispr_eval</span> <span class="o">=</span> <span class="n">_load_and_validate_crispr</span><span class="p">(</span><span class="n">crispr_file</span><span class="p">)</span>
</span><span id="build_crispr_evalset-550"><a href="#build_crispr_evalset-550"><span class="linenos">550</span></a>
</span><span id="build_crispr_evalset-551"><a href="#build_crispr_evalset-551"><span class="linenos">551</span></a>    <span class="n">overlap_df</span> <span class="o">=</span> <span class="n">_intersect_crispr_with_candidates</span><span class="p">(</span><span class="n">crispr_eval</span><span class="p">,</span> <span class="n">candidates</span><span class="p">,</span> <span class="n">distance_col</span><span class="p">)</span>
</span><span id="build_crispr_evalset-552"><a href="#build_crispr_evalset-552"><span class="linenos">552</span></a>
</span><span id="build_crispr_evalset-553"><a href="#build_crispr_evalset-553"><span class="linenos">553</span></a>    <span class="k">if</span> <span class="n">adata_cg_genes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="build_crispr_evalset-554"><a href="#build_crispr_evalset-554"><span class="linenos">554</span></a>        <span class="n">overlap_df</span> <span class="o">=</span> <span class="n">overlap_df</span><span class="p">[</span><span class="n">overlap_df</span><span class="p">[</span><span class="s2">&quot;crispr_gene&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">adata_cg_genes</span><span class="p">))]</span>
</span><span id="build_crispr_evalset-555"><a href="#build_crispr_evalset-555"><span class="linenos">555</span></a>
</span><span id="build_crispr_evalset-556"><a href="#build_crispr_evalset-556"><span class="linenos">556</span></a>    <span class="n">overlap_df</span> <span class="o">=</span> <span class="n">overlap_df</span><span class="p">[</span><span class="n">overlap_df</span><span class="p">[</span><span class="s2">&quot;crispr_gene&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">overlap_df</span><span class="p">[</span><span class="s2">&quot;Gene&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="build_crispr_evalset-557"><a href="#build_crispr_evalset-557"><span class="linenos">557</span></a>    <span class="n">overlap_df</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">overlap_df</span><span class="p">[</span><span class="s2">&quot;crispr_regulated&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="build_crispr_evalset-558"><a href="#build_crispr_evalset-558"><span class="linenos">558</span></a>
</span><span id="build_crispr_evalset-559"><a href="#build_crispr_evalset-559"><span class="linenos">559</span></a>    <span class="k">if</span> <span class="n">distance_col</span> <span class="ow">and</span> <span class="n">distance_col</span> <span class="ow">in</span> <span class="n">overlap_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="build_crispr_evalset-560"><a href="#build_crispr_evalset-560"><span class="linenos">560</span></a>        <span class="n">overlap_df</span><span class="p">[</span><span class="s2">&quot;1/Distance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">overlap_df</span><span class="p">[</span><span class="n">distance_col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span>
</span><span id="build_crispr_evalset-561"><a href="#build_crispr_evalset-561"><span class="linenos">561</span></a>        <span class="n">overlap_df</span><span class="p">[</span><span class="s2">&quot;1/Distance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">overlap_df</span><span class="p">[</span><span class="s2">&quot;1/Distance&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">upper</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
</span><span id="build_crispr_evalset-562"><a href="#build_crispr_evalset-562"><span class="linenos">562</span></a>
</span><span id="build_crispr_evalset-563"><a href="#build_crispr_evalset-563"><span class="linenos">563</span></a>    <span class="n">overlap_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="build_crispr_evalset-564"><a href="#build_crispr_evalset-564"><span class="linenos">564</span></a>
</span><span id="build_crispr_evalset-565"><a href="#build_crispr_evalset-565"><span class="linenos">565</span></a>    <span class="k">if</span> <span class="n">output_csv</span><span class="p">:</span>
</span><span id="build_crispr_evalset-566"><a href="#build_crispr_evalset-566"><span class="linenos">566</span></a>        <span class="n">overlap_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_csv</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="build_crispr_evalset-567"><a href="#build_crispr_evalset-567"><span class="linenos">567</span></a>
</span><span id="build_crispr_evalset-568"><a href="#build_crispr_evalset-568"><span class="linenos">568</span></a>    <span class="k">return</span> <span class="n">overlap_df</span>
</span></pre></div>


            <div class="docstring"><p>Construct a CRISPR evaluation set from candidate peak–gene links.</p>

<p>This overlaps CRISPR enhancer elements with candidate peaks, keeps rows where
the CRISPR measured gene matches the candidate gene, optionally filters to genes
present in your RNA modality, and assigns labels from the CRISPR benchmark.</p>

<p>Args:
    candidate: candidate peak–gene links (BMMC or other).
    crispr_file: Path to CRISPR benchmark TSV (gzipped), with columns
        <code>chrom</code>, <code>chromStart</code>, <code>chromEnd</code>, <code>measuredGeneSymbol</code>, <code>Regulated</code>.
    adata_cg_genes: Optional list of genes detected in RNA
        (to filter CRISPR overlaps to your assay's gene set).
    output_csv: If provided, write the labeled set to this path.
    peak_col: Column in candidates containing peak coordinates. Defaults to <code>"Peak"</code>.
    gene_col: Column in candidates containing gene ID/symbol. Defaults to <code>"Gene_name"</code>.
    distance_col: Column in candidates with distance to TSS in bp.
        If provided and present, a <code>1/Distance</code> feature will be added.</p>

<p>Returns:
    Labeled CRISPR evaluation set with <code>Peak</code>, <code>Gene</code>, <code>label</code> (1/0),
    and optional <code>1/Distance</code>.</p>
</div>


                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>